<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>éŸŒæ€§ä¸­æ¨ Resilience Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            100: '#eaf3d7',
                            400: '#a6c3ac',
                            600: '#4c826b',
                            700: '#3d6a58',
                        },
                        neutral: {
                            200: '#eee2d3',
                            600: '#8f7e61',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        [x-cloak] { display: none !important; }
        .module-card { transition: transform 0.2s, box-shadow 0.2s; }
        .module-card:active { transform: scale(0.98); }

        /* Traffic light glow effect */
        .light-green { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); box-shadow: 0 0 20px rgba(34, 197, 94, 0.4); }
        .light-yellow { background: linear-gradient(135deg, #eab308 0%, #ca8a04 100%); box-shadow: 0 0 20px rgba(234, 179, 8, 0.4); }
        .light-red { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); box-shadow: 0 0 20px rgba(239, 68, 68, 0.4); }
        .light-gray { background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%); }

        /* Pulse animation for alerts */
        @keyframes pulse-light {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .pulse-alert { animation: pulse-light 2s ease-in-out infinite; }
    </style>
</head>
<body class="bg-primary-100 min-h-screen" x-data="publicBoard()" x-init="init()">
    <!-- Demo Mode Banner -->
    <div id="demo-banner" style="display:none;" class="bg-amber-500 text-white text-center px-4 py-2 text-sm font-bold sticky top-0 z-50">
        ğŸš§ ç·šä¸Šå±•ç¤ºç‰ˆ (Demo Mode) | è³‡æ–™å°‡åœ¨é é¢é‡æ•´å¾Œé‡ç½® |
        <a href="https://github.com/cutemo0953/CIRS" target="_blank" class="underline text-white">ä¸‹è¼‰æ­£å¼ç‰ˆ</a>
    </div>
    <script>
        fetch('/api/demo-status')
            .then(r => r.json())
            .then(data => {
                if (data.is_demo) {
                    document.getElementById('demo-banner').style.display = 'block';
                }
            })
            .catch(() => {});
    </script>
    <div class="max-w-lg mx-auto px-4 py-6">
        <!-- Header with Logo -->
        <header class="text-center mb-6">
            <div class="inline-flex items-center justify-center w-16 h-16 bg-primary-600 rounded-2xl mb-3">
                <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                </svg>
            </div>
            <h1 class="text-2xl font-bold text-primary-600">éŸŒæ€§ä¸­æ¨</h1>
            <p class="text-neutral-600" x-text="siteName">ç¤¾å€é¿é›£ä¸­å¿ƒ</p>
            <p class="text-xs text-gray-400 mt-1">å…¬å…±è³‡è¨Šçœ‹æ¿</p>
        </header>

        <!-- Broadcast Banner -->
        <div x-show="status.broadcast" x-cloak class="bg-amber-50 border-l-4 border-amber-400 p-4 rounded-r-lg mb-6">
            <div class="flex items-start">
                <!-- Heroicon: megaphone -->
                <svg class="w-5 h-5 text-amber-600 mt-0.5 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"/>
                </svg>
                <div class="flex-1">
                    <p class="text-sm font-medium text-amber-800">æœ€æ–°å…¬å‘Š</p>
                    <p class="text-sm text-amber-700" x-text="status.broadcast"></p>
                </div>
            </div>
        </div>

        <!-- Traffic Light Status Cards -->
        <div class="grid grid-cols-2 gap-4 mb-6">
            <!-- Shelter Status -->
            <div class="bg-white rounded-2xl p-5 shadow-sm border border-primary-400/20">
                <div class="flex items-center justify-between mb-3">
                    <div class="w-10 h-10 rounded-xl flex items-center justify-center"
                         :class="getLightClass(status.shelter?.status)">
                        <!-- Heroicon: users -->
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                        </svg>
                    </div>
                    <span class="text-2xl font-bold text-gray-800" x-text="status.shelter?.headcount || 0"></span>
                </div>
                <h3 class="font-medium text-gray-700">æ”¶å®¹äººæ•¸</h3>
                <p class="text-xs text-gray-500">
                    å®¹é‡ <span x-text="status.shelter?.capacity || '-'"></span> äºº
                </p>
            </div>

            <!-- Water Status -->
            <div class="bg-white rounded-2xl p-5 shadow-sm border border-primary-400/20">
                <div class="flex items-center justify-between mb-3">
                    <div class="w-10 h-10 rounded-xl flex items-center justify-center"
                         :class="getLightClass(status.water?.status)"
                         x-bind:class="{ 'pulse-alert': status.water?.status === 'red' }">
                        <!-- Heroicon: beaker -->
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/>
                        </svg>
                    </div>
                    <span class="text-2xl font-bold text-gray-800">
                        <span x-text="status.water?.days || 0"></span>
                        <span class="text-sm font-normal text-gray-500">å¤©</span>
                    </span>
                </div>
                <h3 class="font-medium text-gray-700">é£²ç”¨æ°´</h3>
                <p class="text-xs text-gray-500" x-text="getStatusText(status.water?.status)"></p>
            </div>

            <!-- Food Status -->
            <div class="bg-white rounded-2xl p-5 shadow-sm border border-primary-400/20">
                <div class="flex items-center justify-between mb-3">
                    <div class="w-10 h-10 rounded-xl flex items-center justify-center"
                         :class="getLightClass(status.food?.status)"
                         x-bind:class="{ 'pulse-alert': status.food?.status === 'red' }">
                        <!-- Heroicon: cake -->
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 15.546c-.523 0-1.046.151-1.5.454a2.704 2.704 0 01-3 0 2.704 2.704 0 00-3 0 2.704 2.704 0 01-3 0 2.704 2.704 0 00-3 0 2.704 2.704 0 01-3 0 2.701 2.701 0 00-1.5-.454M9 6v2m3-2v2m3-2v2M9 3h.01M12 3h.01M15 3h.01M21 21v-7a2 2 0 00-2-2H5a2 2 0 00-2 2v7h18zm-3-9v-2a2 2 0 00-2-2H8a2 2 0 00-2 2v2h12z"/>
                        </svg>
                    </div>
                    <span class="text-2xl font-bold text-gray-800">
                        <span x-text="status.food?.days || 0"></span>
                        <span class="text-sm font-normal text-gray-500">å¤©</span>
                    </span>
                </div>
                <h3 class="font-medium text-gray-700">ç³§é£Ÿ</h3>
                <p class="text-xs text-gray-500" x-text="getStatusText(status.food?.status)"></p>
            </div>

            <!-- Equipment Status -->
            <div class="bg-white rounded-2xl p-5 shadow-sm border border-primary-400/20">
                <div class="flex items-center justify-between mb-3">
                    <div class="w-10 h-10 rounded-xl flex items-center justify-center"
                         :class="getLightClass(status.equipment?.status)">
                        <!-- Heroicon: cog -->
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                    </div>
                    <span class="text-lg font-bold" :class="status.equipment?.status === 'green' ? 'text-green-600' : status.equipment?.status === 'yellow' ? 'text-yellow-600' : 'text-red-600'"
                          x-text="status.equipment?.issues > 0 ? status.equipment.issues + ' å¾…ä¿®' : 'æ­£å¸¸'"></span>
                </div>
                <h3 class="font-medium text-gray-700">è¨­å‚™ç‹€æ…‹</h3>
                <p class="text-xs text-gray-500" x-text="getStatusText(status.equipment?.status)"></p>
            </div>
        </div>

        <!-- Traffic Light Legend -->
        <div class="bg-white rounded-xl p-4 shadow-sm border border-primary-400/20 mb-6">
            <h4 class="text-sm font-medium text-gray-700 mb-3 flex items-center">
                <!-- Heroicon: information-circle -->
                <svg class="w-4 h-4 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                ç‹€æ…‹èªªæ˜
            </h4>
            <div class="flex justify-around text-xs">
                <div class="flex items-center">
                    <span class="w-3 h-3 rounded-full bg-green-500 mr-2"></span>
                    <span class="text-gray-600">å……è¶³ (3å¤©+)</span>
                </div>
                <div class="flex items-center">
                    <span class="w-3 h-3 rounded-full bg-yellow-500 mr-2"></span>
                    <span class="text-gray-600">æ³¨æ„ (1-3å¤©)</span>
                </div>
                <div class="flex items-center">
                    <span class="w-3 h-3 rounded-full bg-red-500 mr-2"></span>
                    <span class="text-gray-600">ç·Šæ€¥ (&lt;1å¤©)</span>
                </div>
            </div>
        </div>

        <!-- Quick Links (Read-only resources) -->
        <div class="grid grid-cols-2 gap-3 mb-6">
            <a href="/files/" class="bg-white rounded-xl p-4 shadow-sm border border-primary-400/20 flex items-center hover:shadow-md transition">
                <!-- Heroicon: folder -->
                <svg class="w-6 h-6 text-primary-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 19a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1M5 19h14a2 2 0 002-2v-5a2 2 0 00-2-2H9a2 2 0 00-2 2v5a2 2 0 01-2 2z"/>
                </svg>
                <div>
                    <span class="text-sm font-medium text-gray-700">é˜²ç½è³‡æ–™åº«</span>
                    <p class="text-xs text-gray-400">ç·Šæ€¥æŒ‡å—</p>
                </div>
            </a>
            <a href="/frontend/#messages" class="bg-white rounded-xl p-4 shadow-sm border border-primary-400/20 flex items-center hover:shadow-md transition">
                <!-- Heroicon: chat-alt-2 -->
                <svg class="w-6 h-6 text-primary-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                </svg>
                <div>
                    <span class="text-sm font-medium text-gray-700">äº’åŠ©ç•™è¨€</span>
                    <p class="text-xs text-gray-400">å°‹äºº/å°‹ç‰©</p>
                </div>
            </a>
        </div>

        <!-- Operator Entry (subtle link) -->
        <div class="text-center mb-6">
            <a href="/frontend/" class="text-xs text-gray-400 hover:text-primary-600 transition flex items-center justify-center">
                <!-- Heroicon: terminal -->
                <svg class="w-3.5 h-3.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                å·¥ä½œäººå“¡å…¥å£
            </a>
        </div>

        <!-- Network Status -->
        <div class="bg-white rounded-xl p-3 shadow-sm border border-primary-400/20 mb-6">
            <div class="flex items-center justify-between text-sm">
                <span class="text-gray-500 flex items-center">
                    <!-- Heroicon: wifi -->
                    <svg class="w-4 h-4 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0"/>
                    </svg>
                    ç¶²è·¯ç‹€æ…‹
                </span>
                <span :class="networkStatus.lan ? 'text-green-600' : 'text-red-600'" x-text="networkStatusText"></span>
            </div>
        </div>

        <!-- Last Updated -->
        <div class="text-center text-xs text-gray-400 mb-4">
            <span>æœ€å¾Œæ›´æ–°ï¼š</span>
            <span x-text="lastUpdated || '-'"></span>
        </div>

        <!-- Footer -->
        <footer class="text-center mt-8">
            <img src="/frontend/assets/logo.png" alt="De Novo" class="h-10 mx-auto mb-3 opacity-60">
            <p class="text-xs text-gray-400">By De Novo Orthopedics Inc.</p>
            <p class="text-xs text-gray-300 mt-2">CIRS v1.4</p>
        </footer>
    </div>

    <script>
        function publicBoard() {
            return {
                siteName: 'ç¤¾å€é¿é›£ä¸­å¿ƒ',
                status: {},
                networkStatus: { lan: false, internet: false },
                lastUpdated: null,

                async init() {
                    await this.loadConfig();
                    await this.loadStatus();
                    await this.checkNetwork();

                    // Auto refresh every 30 seconds
                    setInterval(() => this.loadStatus(), 30000);
                    setInterval(() => this.checkNetwork(), 60000);
                },

                async loadConfig() {
                    try {
                        const res = await fetch('/api/system/config');
                        if (res.ok) {
                            const config = await res.json();
                            this.siteName = config.site_name || 'ç¤¾å€é¿é›£ä¸­å¿ƒ';
                        }
                    } catch (e) {}
                },

                async loadStatus() {
                    try {
                        const res = await fetch('/api/public/status');
                        if (res.ok) {
                            this.status = await res.json();
                            this.lastUpdated = new Date().toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
                        }
                    } catch (e) {
                        console.error('Failed to load status:', e);
                    }
                },

                async checkNetwork() {
                    try {
                        const res = await fetch('/api/system/time');
                        this.networkStatus.lan = res.ok;
                    } catch {
                        this.networkStatus.lan = false;
                    }

                    try {
                        await fetch('https://www.google.com/generate_204', { mode: 'no-cors', cache: 'no-store' });
                        this.networkStatus.internet = true;
                    } catch {
                        this.networkStatus.internet = false;
                    }
                },

                get networkStatusText() {
                    if (this.networkStatus.lan && this.networkStatus.internet) return 'å…§ç¶²æ­£å¸¸ Â· å¤–ç¶²æ­£å¸¸';
                    if (this.networkStatus.lan && !this.networkStatus.internet) return 'å…§ç¶²æ­£å¸¸ Â· å¤–ç¶²ä¸­æ–·';
                    if (!this.networkStatus.lan && this.networkStatus.internet) return 'å…§ç¶²ä¸­æ–· Â· å¤–ç¶²æ­£å¸¸';
                    return 'é€£ç·šä¸­...';
                },

                getLightClass(status) {
                    switch (status) {
                        case 'green': return 'light-green';
                        case 'yellow': return 'light-yellow';
                        case 'red': return 'light-red';
                        default: return 'light-gray';
                    }
                },

                getStatusText(status) {
                    switch (status) {
                        case 'green': return 'ç‹€æ…‹è‰¯å¥½';
                        case 'yellow': return 'éœ€è¦æ³¨æ„';
                        case 'red': return 'éœ€è¦è£œå……';
                        default: return 'è¼‰å…¥ä¸­...';
                    }
                }
            };
        }
    </script>
</body>
</html>
