<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#4c826b">
    <title>CIRS - Á§æÂçÄÈüåÊÄßÁâ©Ë≥áÁÆ°ÁêÜ</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="assets/icons/icon-192.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <script src="../shared/irs-schema.js"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            100: '#eaf3d7',
                            400: '#a6c3ac',
                            600: '#4c826b',
                            700: '#3d6a58',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        [x-cloak] { display: none !important; }
        .tab-active { background-color: #4c826b; color: white; }
        .bottom-nav { padding-bottom: env(safe-area-inset-bottom); }
        .card-press:active { transform: scale(0.98); }
        input, select, textarea { font-size: 16px !important; }
    </style>
</head>
<body class="bg-gray-50" x-data="cirsApp()" x-init="init()">
    <!-- Demo Mode Banner -->
    <div id="demo-banner" style="display:none;" class="bg-amber-500 text-white text-center px-4 py-2 text-sm font-bold sticky top-0 z-50">
        üöß Á∑ö‰∏äÂ±ïÁ§∫Áâà (Demo Mode) | Ë≥áÊñôÂ∞áÂú®È†ÅÈù¢ÈáçÊï¥ÂæåÈáçÁΩÆ |
        <a href="https://github.com/cutemo0953/CIRS" target="_blank" class="underline text-white">‰∏ãËºâÊ≠£ÂºèÁâà</a>
        <button onclick="resetDemo()" class="ml-2 px-2 py-0.5 bg-white/20 rounded hover:bg-white/30">ÈáçÁΩÆË≥áÊñô</button>
    </div>
    <script>
        // Demo mode detection
        fetch('/api/demo-status')
            .then(r => r.json())
            .then(data => {
                if (data.is_demo) {
                    document.getElementById('demo-banner').style.display = 'block';
                }
            })
            .catch(() => {});

        // Reset demo data
        function resetDemo() {
            if (confirm('Á¢∫ÂÆöË¶ÅÈáçÁΩÆÊâÄÊúâÂ±ïÁ§∫Ë≥áÊñôÂóéÔºü')) {
                fetch('/api/demo/reset', { method: 'POST' })
                    .then(r => r.json())
                    .then(data => {
                        if (data.success) {
                            alert('Ë≥áÊñôÂ∑≤ÈáçÁΩÆÔºÅÈ†ÅÈù¢Â∞áÈáçÊñ∞ËºâÂÖ•„ÄÇ');
                            location.reload();
                        }
                    })
                    .catch(e => alert('ÈáçÁΩÆÂ§±Êïó: ' + e));
            }
        }
    </script>

    <!-- Top Bar -->
    <header class="bg-primary-600 text-white px-4 py-3 sticky top-0 z-40 shadow-md">
        <div class="flex items-center justify-between max-w-lg mx-auto">
            <div class="flex items-center">
                <a href="/portal" class="mr-3 flex items-center bg-white/20 rounded-lg px-2 py-1 hover:bg-white/30">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                    <span class="text-sm ml-1">È¶ñÈ†Å</span>
                </a>
                <h1 class="text-lg font-semibold" x-text="pageTitle">CIRS</h1>
            </div>
            <div class="flex items-center space-x-3">
                <template x-if="currentUser">
                    <div class="flex items-center space-x-2">
                        <span class="text-sm bg-primary-700 px-2 py-1 rounded" x-text="currentUser.display_name"></span>
                        <button @click="logout()" class="text-xs opacity-75 hover:opacity-100">ÁôªÂá∫</button>
                    </div>
                </template>
                <template x-if="!currentUser">
                    <button @click="showLoginModal = true" class="text-sm bg-primary-700 px-2 py-1 rounded">ÁôªÂÖ•</button>
                </template>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="pb-20 max-w-lg mx-auto">
        <!-- Global Stats Bar (Gray) -->
        <div class="bg-gray-100 px-4 py-3 border-b border-gray-200">
            <div class="flex justify-around text-center max-w-lg mx-auto">
                <div>
                    <p class="text-2xl font-bold text-gray-700" x-text="stats.headcount?.checked_in || 0"></p>
                    <p class="text-xs text-gray-500">Âú®Â†¥‰∫∫Êï∏</p>
                </div>
                <div>
                    <p class="text-2xl font-bold text-gray-700" x-text="stats.inventory_total || 0"></p>
                    <p class="text-xs text-gray-500">Áâ©Ë≥áÂìÅÈ†Ö</p>
                </div>
                <div>
                    <p class="text-2xl font-bold text-gray-700" x-text="stats.equipment_ok || 0"></p>
                    <p class="text-xs text-gray-500">Ë®≠ÂÇôÊ≠£Â∏∏</p>
                </div>
                <div>
                    <p class="text-2xl font-bold text-gray-700" x-text="stats.messages_pending || 0"></p>
                    <p class="text-xs text-gray-500">ÂæÖËß£Ê±∫</p>
                </div>
                <!-- System Button (Admin only) -->
                <div x-show="currentUser && currentUser.role === 'admin'" class="relative">
                    <button @click="showSystemMenu = !showSystemMenu" class="flex flex-col items-center">
                        <span class="w-8 h-8 bg-gray-200 rounded-lg flex items-center justify-center hover:bg-gray-300 transition">
                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                        </span>
                        <p class="text-xs text-gray-500 mt-1">Á≥ªÁµ±</p>
                    </button>
                    <!-- System Dropdown -->
                    <div x-show="showSystemMenu" x-cloak @click.away="showSystemMenu = false"
                         class="absolute right-0 mt-2 w-40 bg-white rounded-lg shadow-lg border border-gray-200 py-1 z-50">
                        <button @click="showBackupModal = true; showSystemMenu = false"
                                class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center">
                            <svg class="w-4 h-4 mr-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2 1 3 3 3h10c2 0 3-1 3-3V7c0-2-1-3-3-3H7c-2 0-3 1-3 3zm0 5h16m-8 5v-5"/>
                            </svg>
                            Ë≥áÊñôÂÇô‰ªΩ
                        </button>
                        <button @click="showBroadcastModal = true; showSystemMenu = false"
                                class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center">
                            <svg class="w-4 h-4 mr-2 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"/>
                            </svg>
                            Áôº‰ΩàÂÖ¨Âëä
                        </button>
                        <button @click="showSettingsModal = true; showSystemMenu = false"
                                class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center">
                            <svg class="w-4 h-4 mr-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/>
                            </svg>
                            Á´ôÈªûË®≠ÂÆö
                        </button>
                        <a href="/docs" target="_blank"
                           class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center">
                            <svg class="w-4 h-4 mr-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/>
                            </svg>
                            API Êñá‰ª∂
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== ‰∫∫Âì° Tab ==================== -->
        <div x-show="currentTab === 'people'" x-cloak class="p-4">
            <!-- Quick Check-in Card -->
            <div class="bg-white rounded-xl p-4 shadow-sm mb-4 border-2 border-primary-400" x-show="currentUser">
                <h3 class="font-semibold mb-3 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/>
                    </svg>
                    Âø´ÈÄüÂ†±Âà∞
                </h3>
                <div class="space-y-3">
                    <input type="text" x-model="newPerson.display_name" placeholder="ÂßìÂêç *" class="w-full border border-gray-200 rounded-lg px-3 py-2">
                    <div class="grid grid-cols-2 gap-2">
                        <input type="text" x-model="newPerson.national_id" placeholder="Ë∫´ÂàÜË≠â (ÈÅ∏Â°´)" class="border border-gray-200 rounded-lg px-3 py-2 uppercase" maxlength="10">
                        <input type="tel" x-model="newPerson.phone" placeholder="ÈõªË©± (ÈÅ∏Â°´)" class="border border-gray-200 rounded-lg px-3 py-2">
                    </div>
                    <!-- ÂçÄÂüüÈÅ∏Êìá -->
                    <div class="relative">
                        <select x-model="newPerson.current_location" class="w-full border border-gray-200 rounded-lg px-3 py-2 appearance-none bg-white">
                            <option value="">ÈÅ∏ÊìáÂçÄÂüü (ÈÅ∏Â°´)</option>
                            <optgroup label="Êî∂ÂÆπÂçÄ">
                                <template x-for="z in zones.filter(z => z.zone_type === 'shelter')" :key="z.id">
                                    <option :value="z.id" x-text="z.name"></option>
                                </template>
                            </optgroup>
                            <optgroup label="ÈÜ´ÁôÇÂçÄ">
                                <template x-for="z in zones.filter(z => z.zone_type === 'medical')" :key="z.id">
                                    <option :value="z.id" x-text="z.name"></option>
                                </template>
                            </optgroup>
                            <optgroup label="ÊúçÂãôÂçÄ">
                                <template x-for="z in zones.filter(z => z.zone_type === 'service')" :key="z.id">
                                    <option :value="z.id" x-text="z.name"></option>
                                </template>
                            </optgroup>
                        </select>
                        <svg class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </div>
                    <!-- Photo capture for unidentified persons -->
                    <div x-show="!newPerson.national_id" class="border border-dashed border-gray-300 rounded-lg p-3">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm text-gray-600">ÁÑ°Ê≥ïËæ®Ë≠òË∫´ÂàÜÊôÇÊãçÁÖß</span>
                            <button type="button" @click="capturePhoto()" class="text-xs bg-blue-500 text-white px-3 py-1 rounded-lg">
                                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                                ÊãçÁÖß
                            </button>
                        </div>
                        <div x-show="newPerson.photo_data" class="mb-2">
                            <img :src="newPerson.photo_data" class="w-24 h-24 object-cover rounded-lg mx-auto">
                            <button @click="newPerson.photo_data = ''" class="text-xs text-red-500 block mx-auto mt-1">ÁßªÈô§ÁÖßÁâá</button>
                        </div>
                        <input type="text" x-model="newPerson.physical_desc" placeholder="Â§ñËßÄÁâπÂæµÊèèËø∞ (ÈÅ∏Â°´)" class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm">
                    </div>
                    <!-- Triage Selection (light bg + dark text, like filter tags) -->
                    <div class="grid grid-cols-4 gap-2">
                        <button @click="newPerson.triage_status = 'GREEN'" :class="newPerson.triage_status === 'GREEN' ? 'bg-green-500 text-white' : 'bg-green-100 text-green-700'" class="rounded-lg py-2 text-sm font-medium">ËºïÂÇ∑</button>
                        <button @click="newPerson.triage_status = 'YELLOW'" :class="newPerson.triage_status === 'YELLOW' ? 'bg-yellow-500 text-white' : 'bg-yellow-100 text-yellow-700'" class="rounded-lg py-2 text-sm font-medium">Âª∂ÈÅ≤</button>
                        <button @click="newPerson.triage_status = 'RED'" :class="newPerson.triage_status === 'RED' ? 'bg-red-500 text-white' : 'bg-red-100 text-red-700'" class="rounded-lg py-2 text-sm font-medium">Á´ãÂç≥</button>
                        <button @click="newPerson.triage_status = 'BLACK'" :class="newPerson.triage_status === 'BLACK' ? 'bg-gray-800 text-white' : 'bg-gray-200 text-gray-700'" class="rounded-lg py-2 text-sm font-medium">Ê≠ª‰∫°</button>
                    </div>
                    <button @click="doQuickCheckIn()" class="w-full bg-primary-600 text-white rounded-lg py-2 font-medium">Â†±Âà∞ÁôªË®ò</button>
                    <p class="text-xs text-gray-400 text-center">ÁÑ°Ë∫´ÂàÜË≠âÊôÇÁ≥ªÁµ±Ëá™ÂãïÁî¢ÁîüÂ∫èËôü</p>
                </div>
            </div>

            <!-- Section Divider -->
            <div class="relative mb-4" x-show="currentUser">
                <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-300"></div></div>
                <div class="relative flex justify-center"><span class="bg-gray-50 px-3 text-sm text-gray-500">ÊêúÂ∞ã‰∫∫Âì°</span></div>
            </div>

            <!-- Zone Overview (Collapsible) -->
            <div class="bg-white rounded-xl shadow-sm mb-4 overflow-hidden">
                <!-- Header Row: Â±ïÈñãÊåâÈàïÂ∑¶ÂÅ¥ÔºåÁÆ°ÁêÜÊåâÈàïÂè≥ÂÅ¥ -->
                <div class="flex items-center justify-between px-4 py-3 border-b border-gray-100">
                    <!-- Â∑¶ÂÅ¥ÔºöÂ±ïÈñãÊåâÈàï -->
                    <button @click="showZoneOverview = !showZoneOverview" class="flex items-center text-left hover:text-primary-600 transition">
                        <svg class="w-5 h-5 mr-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                        </svg>
                        <span class="font-semibold">ÂçÄÂüüÁ∏ΩË¶Ω</span>
                        <span class="ml-2 text-xs text-gray-500" x-text="zones.length + ' ÂçÄ'"></span>
                        <svg class="w-4 h-4 ml-1 text-gray-400 transition-transform" :class="showZoneOverview ? 'rotate-180' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>
                    <!-- Âè≥ÂÅ¥ÔºöÁÆ°ÁêÜÊåâÈàï (Áç®Á´ã) -->
                    <button x-show="currentUser && currentUser.role === 'admin'"
                            @click="openZoneManageModal()"
                            class="flex items-center text-xs bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 py-1.5 rounded-lg transition">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                        ÁÆ°ÁêÜ
                    </button>
                </div>
                <div x-show="showZoneOverview" x-collapse class="px-4 pb-4 pt-3">
                    <!-- Zone Type Tabs (ÂñÆËâ≤È¢®Ê†º) -->
                    <div class="flex space-x-1 mb-3 overflow-x-auto">
                        <button @click="zoneTypeFilter = ''" :class="zoneTypeFilter === '' ? 'bg-primary-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'" class="px-3 py-1 rounded-full text-xs whitespace-nowrap transition">ÂÖ®ÈÉ®</button>
                        <button @click="zoneTypeFilter = 'shelter'" :class="zoneTypeFilter === 'shelter' ? 'bg-primary-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'" class="px-3 py-1 rounded-full text-xs whitespace-nowrap transition">Êî∂ÂÆπÂçÄ</button>
                        <button @click="zoneTypeFilter = 'medical'" :class="zoneTypeFilter === 'medical' ? 'bg-primary-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'" class="px-3 py-1 rounded-full text-xs whitespace-nowrap transition">ÈÜ´ÁôÇÂçÄ</button>
                        <button @click="zoneTypeFilter = 'service'" :class="zoneTypeFilter === 'service' ? 'bg-primary-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'" class="px-3 py-1 rounded-full text-xs whitespace-nowrap transition">ÊúçÂãôÂçÄ</button>
                        <button @click="zoneTypeFilter = 'restricted'" :class="zoneTypeFilter === 'restricted' ? 'bg-primary-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'" class="px-3 py-1 rounded-full text-xs whitespace-nowrap transition">ÁÆ°Âà∂ÂçÄ</button>
                    </div>
                    <!-- Zone Cards Grid (ÂñÆËâ≤ + heroicon) -->
                    <div class="grid grid-cols-2 gap-2">
                        <template x-for="zone in filteredZones" :key="zone.id">
                            <div @click="filterByZone(zone.id)" class="bg-gray-50 rounded-lg p-3 cursor-pointer hover:bg-gray-100 transition"
                                 :class="zoneFilter === zone.id ? 'ring-2 ring-primary-500 bg-primary-50' : ''">
                                <div class="flex items-center mb-1">
                                    <!-- Zone Icon (heroicon based on zone.icon) -->
                                    <span class="w-5 h-5 mr-2 text-gray-500 flex-shrink-0" x-html="getZoneIcon(zone.icon)"></span>
                                    <span class="font-medium text-sm truncate" x-text="zone.name"></span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-lg font-bold text-gray-700" x-text="zone.current_count || 0"></span>
                                    <span x-show="zone.capacity > 0" class="text-xs text-gray-400" x-text="'/' + zone.capacity"></span>
                                </div>
                                <!-- Capacity Bar (ÂñÆËâ≤Ôºöprimary) -->
                                <div x-show="zone.capacity > 0" class="mt-1 h-1 bg-gray-200 rounded-full overflow-hidden">
                                    <div class="h-full bg-primary-500 rounded-full transition-all"
                                         :style="'width: ' + Math.min(100, (zone.current_count || 0) / zone.capacity * 100) + '%'"></div>
                                </div>
                            </div>
                        </template>
                    </div>
                    <!-- Batch Move Button -->
                    <button x-show="currentUser && selectedPeople.length > 0"
                            @click="openBatchMoveModal()"
                            class="w-full mt-3 bg-primary-600 text-white rounded-lg py-2 text-sm font-medium flex items-center justify-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
                        </svg>
                        ÁßªÂãï <span x-text="selectedPeople.length"></span> ‰∫∫
                    </button>
                </div>
            </div>

            <!-- Search -->
            <div class="flex space-x-2 mb-4">
                <input type="text" x-model="peopleSearch" placeholder="ÊêúÂ∞ãÂßìÂêç/ID..." class="flex-1 bg-white border border-gray-200 rounded-lg px-3 py-2">
            </div>

            <!-- Triage Filter with Stats -->
            <div class="flex space-x-2 mb-4 overflow-x-auto">
                <button @click="triageFilter = ''" :class="triageFilter === '' ? 'bg-primary-600 text-white' : 'bg-white text-gray-700 border'" class="px-3 py-1.5 rounded-full text-sm whitespace-nowrap font-medium">
                    ÂÖ®ÈÉ® <span class="ml-1 opacity-75" x-text="stats.headcount?.total || 0"></span>
                </button>
                <button @click="triageFilter = 'GREEN'" :class="triageFilter === 'GREEN' ? 'bg-green-500 text-white' : 'bg-green-100 text-green-700'" class="px-3 py-1.5 rounded-full text-sm whitespace-nowrap font-medium">
                    ËºïÂÇ∑ <span class="ml-1 opacity-75" x-text="stats.headcount?.green || 0"></span>
                </button>
                <button @click="triageFilter = 'YELLOW'" :class="triageFilter === 'YELLOW' ? 'bg-yellow-500 text-white' : 'bg-yellow-100 text-yellow-700'" class="px-3 py-1.5 rounded-full text-sm whitespace-nowrap font-medium">
                    Âª∂ÈÅ≤ <span class="ml-1 opacity-75" x-text="stats.headcount?.yellow || 0"></span>
                </button>
                <button @click="triageFilter = 'RED'" :class="triageFilter === 'RED' ? 'bg-red-500 text-white' : 'bg-red-100 text-red-700'" class="px-3 py-1.5 rounded-full text-sm whitespace-nowrap font-medium">
                    Á´ãÂç≥ <span class="ml-1 opacity-75" x-text="stats.headcount?.red || 0"></span>
                </button>
                <button @click="triageFilter = 'BLACK'" :class="triageFilter === 'BLACK' ? 'bg-gray-800 text-white' : 'bg-gray-200 text-gray-700'" class="px-3 py-1.5 rounded-full text-sm whitespace-nowrap font-medium">
                    Ê≠ª‰∫° <span class="ml-1 opacity-75" x-text="stats.headcount?.black || 0"></span>
                </button>
            </div>

            <!-- People List Header with Select All -->
            <div x-show="currentUser" class="flex items-center justify-between mb-2">
                <button @click="selectAllFiltered()" class="text-xs text-primary-600 flex items-center">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    ÂÖ®ÈÅ∏/ÂèñÊ∂à
                </button>
                <span x-show="selectedPeople.length > 0" class="text-xs text-gray-500">
                    Â∑≤ÈÅ∏ <span class="font-semibold text-primary-600" x-text="selectedPeople.length"></span> ‰∫∫
                    <button @click="openBatchMoveModal()" class="ml-2 text-primary-600 underline">ÁßªÂãï</button>
                    <button @click="openBatchCheckoutModal()" class="ml-2 text-red-600 underline">ÈÄÄÂ†¥</button>
                </span>
            </div>

            <!-- People List -->
            <div class="space-y-2">
                <template x-for="person in filteredPeople" :key="person.id">
                    <div class="bg-white rounded-xl p-3 shadow-sm flex items-center"
                         :class="selectedPeople.includes(person.id) ? 'ring-2 ring-primary-500' : ''">
                        <!-- Checkbox for selection -->
                        <input x-show="currentUser" type="checkbox"
                               :checked="selectedPeople.includes(person.id)"
                               @change="togglePersonSelect(person.id)"
                               class="w-4 h-4 mr-2 rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold mr-3"
                             :class="{
                                 'bg-green-500': person.triage_status === 'GREEN',
                                 'bg-yellow-500': person.triage_status === 'YELLOW',
                                 'bg-red-500': person.triage_status === 'RED',
                                 'bg-gray-800': person.triage_status === 'BLACK',
                                 'bg-gray-300': !person.triage_status
                             }">
                            <span x-text="person.display_name?.charAt(0) || '?'"></span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h4 class="font-semibold truncate" x-text="person.display_name"></h4>
                            <p class="text-xs text-gray-500 truncate">
                                <span x-text="person.id"></span>
                                <span x-show="person.current_location" class="ml-1">¬∑ <span x-text="zones.find(z => z.id === person.current_location)?.name || person.current_location"></span></span>
                            </p>
                        </div>
                        <div class="flex items-center space-x-1">
                            <!-- Zone/Location Button (ÁßªÂãïÂçÄÂüü) - Ê∑∫Ëâ≤ primary -->
                            <button @click="openPersonMoveModal(person)" x-show="currentUser"
                                    class="p-2 bg-primary-100 hover:bg-primary-200 rounded-lg transition"
                                    title="ÁßªÂãïÂçÄÂüü">
                                <svg class="w-5 h-5 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                            </button>
                            <!-- Triage Button (Ê™¢ÂÇ∑ÂàÜÈ°û) - Ê∑±Ëâ≤ primary -->
                            <button @click="startTriage(person)" x-show="currentUser && (currentUser.role === 'admin' || currentUser.role === 'medic')"
                                    class="p-2 bg-primary-600 hover:bg-primary-700 rounded-lg transition"
                                    title="Ê™¢ÂÇ∑ÂàÜÈ°û">
                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </template>
                <p x-show="filteredPeople.length === 0" class="text-center text-gray-400 py-8">ÁÑ°‰∫∫Âì°Ë≥áÊñô</p>
            </div>

            <!-- Zone Filter Clear Button -->
            <div x-show="zoneFilter" class="mt-4 text-center">
                <button @click="zoneFilter = ''" class="text-sm text-primary-600 underline">
                    Ê∏ÖÈô§ÂçÄÂüüÁØ©ÈÅ∏
                </button>
            </div>
        </div>

        <!-- ==================== Áâ©Ë≥á Tab ==================== -->
        <div x-show="currentTab === 'inventory'" x-cloak class="p-4 pb-28">

            <!-- Expiry Alerts -->
            <div x-show="expiringItems.length > 0" class="bg-amber-50 rounded-xl p-3 border border-amber-200 mb-4">
                <h4 class="font-semibold text-amber-800 text-sm mb-2 flex items-center">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    Âç≥Â∞áÂà∞Êúü
                </h4>
                <div class="space-y-1">
                    <template x-for="item in expiringItems.slice(0, 3)" :key="item.id">
                        <p class="text-xs text-amber-700">
                            <span x-text="item.name"></span>
                            <span x-show="item.specification" class="text-amber-500">(<span x-text="item.specification"></span>)</span>
                            - <span x-text="item.expiry_date"></span>
                        </p>
                    </template>
                </div>
            </div>

            <!-- Low Stock Alerts -->
            <div x-show="stats.inventory_alerts?.length > 0" class="bg-red-50 rounded-xl p-3 border border-red-200 mb-4">
                <h4 class="font-semibold text-red-800 text-sm mb-2 flex items-center">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                    Â∫´Â≠ò‰∏çË∂≥
                </h4>
                <div class="space-y-1">
                    <template x-for="alert in stats.inventory_alerts?.slice(0, 3)" :key="alert.id">
                        <p class="text-xs text-red-700">
                            <span x-text="alert.name"></span>: Ââ© <span class="font-medium" x-text="alert.quantity"></span> <span x-text="alert.unit || 'ÂÄã'"></span>
                        </p>
                    </template>
                </div>
            </div>

            <!-- Search & Filter -->
            <div class="flex space-x-2 mb-3">
                <input type="text" x-model="inventorySearch" placeholder="ÊêúÂ∞ãÁâ©Ë≥á..." class="flex-1 bg-white border border-gray-200 rounded-lg px-3 py-2">
                <button @click="showDonationModal = true" x-show="currentUser" class="bg-pink-500 text-white px-3 py-2 rounded-lg" title="Êé•Êî∂ÊçêË¥à">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                    </svg>
                </button>
                <button @click="showAddInventoryModal = true" x-show="currentUser" class="bg-primary-600 text-white px-3 py-2 rounded-lg" title="Êñ∞Â¢ûÂ∫´Â≠ò">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                </button>
            </div>

            <!-- Category Filter -->
            <div class="flex space-x-2 overflow-x-auto pb-2 mb-3">
                <button @click="inventoryCategory = ''" :class="inventoryCategory === '' ? 'bg-primary-600 text-white' : 'bg-white text-gray-700'" class="px-3 py-1 rounded-full text-sm whitespace-nowrap">ÂÖ®ÈÉ®</button>
                <button @click="inventoryCategory = 'water'" :class="inventoryCategory === 'water' ? 'bg-primary-600 text-white' : 'bg-white text-gray-700'" class="px-3 py-1 rounded-full text-sm whitespace-nowrap">Ê∞¥</button>
                <button @click="inventoryCategory = 'food'" :class="inventoryCategory === 'food' ? 'bg-primary-600 text-white' : 'bg-white text-gray-700'" class="px-3 py-1 rounded-full text-sm whitespace-nowrap">È£üÁâ©</button>
                <button @click="inventoryCategory = 'medical'" :class="inventoryCategory === 'medical' ? 'bg-primary-600 text-white' : 'bg-white text-gray-700'" class="px-3 py-1 rounded-full text-sm whitespace-nowrap">ÈÜ´ÁôÇ</button>
                <button @click="inventoryCategory = 'power'" :class="inventoryCategory === 'power' ? 'bg-primary-600 text-white' : 'bg-white text-gray-700'" class="px-3 py-1 rounded-full text-sm whitespace-nowrap">ÈõªÂäõ</button>
                <button @click="inventoryCategory = 'daily'" :class="inventoryCategory === 'daily' ? 'bg-primary-600 text-white' : 'bg-white text-gray-700'" class="px-3 py-1 rounded-full text-sm whitespace-nowrap">Êó•Áî®ÂìÅ</button>
            </div>

            <!-- Inventory List -->
            <div class="space-y-2">
                <template x-for="item in filteredInventory" :key="item.id">
                    <div class="bg-white rounded-xl p-3 shadow-sm" :class="item.quantity < item.min_quantity && item.min_quantity > 0 ? 'border-l-4 border-red-500' : ''">
                        <div class="flex justify-between items-start">
                            <div class="flex-1 min-w-0">
                                <h4 class="font-semibold truncate">
                                    <span x-text="item.name"></span>
                                    <span x-show="item.specification" class="text-gray-500 font-normal text-sm">(<span x-text="item.specification"></span>)</span>
                                </h4>
                                <p class="text-sm text-gray-600">
                                    <span class="font-medium" x-text="item.quantity"></span> <span x-text="item.unit || 'ÂÄã'"></span>
                                    <span x-show="item.location" class="text-gray-400 ml-2">¬∑ <span x-text="item.location"></span></span>
                                </p>
                                <p x-show="item.expiry_date" class="text-xs text-gray-400">
                                    ÊïàÊúü: <span x-text="item.expiry_date"></span>
                                </p>
                            </div>
                            <div class="flex space-x-1" x-show="currentUser">
                                <button @click="quickIntake(item)" class="text-emerald-600 p-1.5 bg-emerald-50 rounded-lg">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                    </svg>
                                </button>
                                <button @click="startDistribute(item)" class="text-orange-600 p-1.5 bg-orange-50 rounded-lg">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </template>
                <p x-show="filteredInventory.length === 0" class="text-center text-gray-400 py-8">ÁÑ°Áâ©Ë≥áË≥áÊñô</p>
            </div>

            <!-- Fixed Bottom Buttons for Inventory -->
            <div x-show="currentUser && currentTab === 'inventory'" class="fixed bottom-16 left-0 right-0 bg-white border-t border-gray-200 px-4 py-3 z-40">
                <div class="grid grid-cols-4 gap-2 max-w-lg mx-auto">
                    <button @click="showIntakeModal = true" class="rounded-xl py-3 text-center card-press shadow-sm font-medium" style="background-color: #4c826b; color: white;">
                        <svg class="w-5 h-5 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        ÂÖ•Â∫´
                    </button>
                    <button @click="openBundleModal()" class="rounded-xl py-3 text-center card-press shadow-sm font-medium" style="background-color: #e0f2f1; color: #00695c;">
                        <svg class="w-5 h-5 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                        </svg>
                        ÁµÑÂ•ó
                    </button>
                    <button @click="showDistributeSelectModal = true" class="rounded-xl py-3 text-center card-press shadow-sm font-medium" style="background-color: #fee39a; color: #333;">
                        <svg class="w-5 h-5 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"/>
                        </svg>
                        ÁôºÊîæ
                    </button>
                    <button x-show="currentUser.role === 'admin'" @click="openInventoryHistory()" class="rounded-xl py-3 text-center card-press shadow-sm font-medium bg-gray-100 text-gray-700">
                        <svg class="w-5 h-5 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Á¥ÄÈåÑ
                    </button>
                </div>
            </div>
        </div>

        <!-- ==================== Ë®≠ÂÇô Tab ==================== -->
        <div x-show="currentTab === 'equipment'" x-cloak class="p-4 pb-28">
            <!-- Equipment Stats Summary -->
            <div class="grid grid-cols-3 gap-2 mb-4">
                <div class="bg-green-50 rounded-xl p-3 text-center border border-green-200">
                    <p class="text-2xl font-bold text-green-700" x-text="equipment.filter(e => e.check_status === 'OK').length"></p>
                    <p class="text-xs text-green-600">Ê≠£Â∏∏</p>
                </div>
                <div class="bg-yellow-50 rounded-xl p-3 text-center border border-yellow-200">
                    <p class="text-2xl font-bold text-yellow-700" x-text="equipment.filter(e => e.check_status === 'NEEDS_REPAIR').length"></p>
                    <p class="text-xs text-yellow-600">ÂæÖ‰øÆ</p>
                </div>
                <div class="bg-red-50 rounded-xl p-3 text-center border border-red-200">
                    <p class="text-2xl font-bold text-red-700" x-text="equipment.filter(e => e.check_status === 'OUT_OF_SERVICE').length"></p>
                    <p class="text-xs text-red-600">ÂÅúÁî®</p>
                </div>
            </div>

            <!-- Pending Checks Alert -->
            <div x-show="equipmentPending.length > 0" class="bg-orange-50 rounded-xl p-4 border border-orange-200 mb-4">
                <h3 class="font-semibold text-orange-800 mb-2 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    ÂæÖÊ™¢Ë®≠ÂÇô (<span x-text="equipmentPending.length"></span>)
                </h3>
                <div class="space-y-2">
                    <template x-for="eq in equipmentPending" :key="eq.id">
                        <div class="bg-white rounded-lg p-3 flex items-center justify-between">
                            <div>
                                <p class="font-medium" x-text="eq.name"></p>
                                <p class="text-xs text-gray-500">
                                    ‰∏äÊ¨°Ê™¢Êü•: <span x-text="eq.last_check_date || 'ÂæûÊú™'"></span>
                                </p>
                            </div>
                            <button @click="startEquipmentCheck(eq)" x-show="currentUser" class="bg-primary-600 text-white px-3 py-1.5 rounded-lg text-sm">
                                Ê™¢Êü•
                            </button>
                        </div>
                    </template>
                </div>
            </div>

            <!-- All Equipment -->
            <h3 class="font-semibold mb-3">ÊâÄÊúâË®≠ÂÇô</h3>
            <div class="space-y-2">
                <template x-for="eq in equipment" :key="eq.id">
                    <div class="bg-white rounded-xl p-3 shadow-sm">
                        <div class="flex justify-between items-start">
                            <div class="flex items-start">
                                <!-- Equipment Icon -->
                                <div class="w-8 h-8 mr-3 bg-primary-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                    <svg class="w-5 h-5 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path :d="getEquipmentIconPath(eq.name)" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/>
                                    </svg>
                                </div>
                                <div>
                                    <h4 class="font-semibold">
                                        <span x-text="eq.name"></span>
                                        <span x-show="eq.specification" class="text-gray-500 font-normal text-sm">(<span x-text="eq.specification"></span>)</span>
                                    </h4>
                                <p class="text-sm text-gray-600">
                                    Êï∏Èáè: <span x-text="eq.quantity"></span> <span x-text="eq.unit || 'Âè∞'"></span>
                                    <span x-show="eq.location" class="text-gray-400">¬∑ <span x-text="eq.location"></span></span>
                                </p>
                                <div class="flex items-center mt-1 text-xs">
                                    <span class="px-2 py-0.5 rounded-full mr-2"
                                          :class="{
                                              'bg-green-100 text-green-700': eq.check_status === 'OK',
                                              'bg-yellow-100 text-yellow-700': eq.check_status === 'NEEDS_REPAIR',
                                              'bg-red-100 text-red-700': eq.check_status === 'OUT_OF_SERVICE',
                                              'bg-gray-100 text-gray-500': !eq.check_status
                                          }"
                                          x-text="getCheckStatusText(eq.check_status)"></span>
                                    <span class="text-gray-400">
                                        Ê™¢Êü•ÈÄ±Êúü: <span x-text="eq.check_interval_days || '-'"></span>Â§©
                                    </span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex space-x-1" x-show="currentUser">
                                <button @click="startEquipmentCheck(eq)" class="text-primary-600 p-1.5 bg-primary-50 rounded-lg" title="Ê™¢Êü•">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                </button>
                                <button @click="startEditEquipment(eq)" class="text-blue-600 p-1.5 bg-blue-50 rounded-lg" title="Á∑®ËºØ">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                    </svg>
                                </button>
                                <button @click="confirmDeleteEquipment(eq)" x-show="currentUser.role === 'admin'" class="text-red-600 p-1.5 bg-red-50 rounded-lg" title="Âà™Èô§">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </template>
                <p x-show="equipment.length === 0" class="text-center text-gray-400 py-8">ÁÑ°Ë®≠ÂÇôË≥áÊñô</p>
            </div>

            <!-- Fixed Bottom Buttons for Equipment -->
            <div x-show="currentUser && currentTab === 'equipment'" class="fixed bottom-16 left-0 right-0 bg-white border-t border-gray-200 px-4 py-3 z-40">
                <div class="grid grid-cols-2 gap-2 max-w-lg mx-auto">
                    <button @click="showAddEquipmentModal = true" class="rounded-xl py-3 text-center card-press shadow-sm font-medium bg-primary-600 text-white">
                        <svg class="w-5 h-5 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        Êñ∞Â¢ûË®≠ÂÇô
                    </button>
                    <button @click="openEquipmentTemplateModal()" class="rounded-xl py-3 text-center card-press shadow-sm font-medium bg-primary-100 text-primary-700">
                        <svg class="w-5 h-5 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                        </svg>
                        ÁØÑÊú¨
                    </button>
                </div>
            </div>
        </div>

        <!-- ==================== ÁïôË®ÄÊùø Tab ==================== -->
        <div x-show="currentTab === 'messages'" x-cloak class="p-4">
            <!-- Broadcast -->
            <div x-show="broadcast" class="bg-amber-50 border-l-4 border-amber-400 p-3 rounded-r-lg mb-4">
                <div class="flex items-start">
                    <svg class="w-5 h-5 text-amber-600 mt-0.5 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"/>
                    </svg>
                    <div>
                        <p class="text-sm font-medium text-amber-800">ÂÖ¨Âëä</p>
                        <p class="text-sm text-amber-700" x-text="broadcast"></p>
                    </div>
                </div>
            </div>

            <!-- Category Filter -->
            <div class="flex space-x-2 overflow-x-auto pb-2 mb-4">
                <button @click="messageCategory = ''" :class="messageCategory === '' ? 'bg-primary-600 text-white' : 'bg-white text-gray-700'" class="px-3 py-1 rounded-full text-sm whitespace-nowrap">ÂÖ®ÈÉ®</button>
                <button @click="messageCategory = 'seek_person'" :class="messageCategory === 'seek_person' ? 'bg-primary-600 text-white' : 'bg-white text-gray-700'" class="px-3 py-1 rounded-full text-sm whitespace-nowrap">Â∞ã‰∫∫</button>
                <button @click="messageCategory = 'seek_item'" :class="messageCategory === 'seek_item' ? 'bg-primary-600 text-white' : 'bg-white text-gray-700'" class="px-3 py-1 rounded-full text-sm whitespace-nowrap">ÊâæÁâ©</button>
                <button @click="messageCategory = 'offer_help'" :class="messageCategory === 'offer_help' ? 'bg-primary-600 text-white' : 'bg-white text-gray-700'" class="px-3 py-1 rounded-full text-sm whitespace-nowrap">‰∫íÂä©</button>
                <button @click="messageCategory = 'report'" :class="messageCategory === 'report' ? 'bg-primary-600 text-white' : 'bg-white text-gray-700'" class="px-3 py-1 rounded-full text-sm whitespace-nowrap">ÂõûÂ†±</button>
            </div>

            <!-- Messages List -->
            <div class="space-y-3 mb-20">
                <template x-for="msg in filteredMessages" :key="msg.id">
                    <div class="bg-white rounded-xl p-4 shadow-sm" :class="{'opacity-60': msg.is_resolved, 'ring-2 ring-amber-400 bg-amber-50': msg.is_pinned}">
                        <div class="flex items-start justify-between mb-2">
                            <div class="flex items-center space-x-2">
                                <!-- ÁΩÆÈ†ÇÊ®ôÁ§∫ -->
                                <span x-show="msg.is_pinned" class="text-amber-500" title="ÁΩÆÈ†Ç">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M16 4h2a2 2 0 012 2v14a2 2 0 01-2 2H6a2 2 0 01-2-2V6a2 2 0 012-2h2m4-2a2 2 0 110 4 2 2 0 010-4z"/>
                                    </svg>
                                </span>
                                <span class="text-xs px-2 py-0.5 rounded-full"
                                      :class="{
                                          'bg-blue-100 text-blue-700': msg.category === 'seek_person',
                                          'bg-purple-100 text-purple-700': msg.category === 'seek_item',
                                          'bg-green-100 text-green-700': msg.category === 'offer_help',
                                          'bg-amber-100 text-amber-700': msg.category === 'report',
                                          'bg-gray-100 text-gray-700': !msg.category || msg.category === 'general'
                                      }"
                                      x-text="getCategoryName(msg.category)"></span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span x-show="msg.is_resolved" class="text-xs text-green-600">Â∑≤Ëß£Ê±∫</span>
                                <!-- Admin Controls -->
                                <template x-if="currentUser && currentUser.role === 'admin'">
                                    <div class="flex space-x-1">
                                        <!-- ÁΩÆÈ†Ç/ÂèñÊ∂àÁΩÆÈ†ÇÊåâÈàï -->
                                        <button @click="toggleMessagePinned(msg)" class="text-xs px-2 py-1 rounded" :class="msg.is_pinned ? 'bg-amber-100 text-amber-600' : 'bg-gray-100 text-gray-600'" :title="msg.is_pinned ? 'ÂèñÊ∂àÁΩÆÈ†Ç' : 'ÁΩÆÈ†Ç'">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/>
                                            </svg>
                                        </button>
                                        <button @click="toggleMessageResolved(msg)" class="text-xs px-2 py-1 rounded" :class="msg.is_resolved ? 'bg-gray-100 text-gray-600' : 'bg-green-100 text-green-600'">
                                            <span x-text="msg.is_resolved ? 'ÂèñÊ∂àËß£Ê±∫' : 'Ê®ôÁÇ∫Â∑≤Ëß£Ê±∫'"></span>
                                        </button>
                                        <button @click="confirmDeleteMessage(msg)" class="text-red-500 p-1">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                            </svg>
                                        </button>
                                    </div>
                                </template>
                            </div>
                        </div>
                        <p class="text-gray-800" x-text="msg.content"></p>
                        <div class="flex justify-between items-center mt-2 text-xs text-gray-400">
                            <span x-text="msg.author_name || 'ÂåøÂêç'"></span>
                            <div class="flex items-center space-x-2">
                                <span x-text="formatTime(msg.created_at)"></span>
                                <button @click="startReply(msg)" class="text-primary-600 hover:underline">ÂõûË¶Ü</button>
                            </div>
                        </div>
                        <!-- Replies -->
                        <div x-show="msg.replies && msg.replies.length > 0" class="mt-3 pt-3 border-t border-gray-100 space-y-2">
                            <template x-for="reply in msg.replies" :key="reply.id">
                                <div class="bg-gray-50 rounded-lg p-2 text-sm">
                                    <p class="text-gray-700" x-text="reply.content"></p>
                                    <p class="text-xs text-gray-400 mt-1"><span x-text="reply.author_name || 'ÂåøÂêç'"></span> ¬∑ <span x-text="formatTime(reply.created_at)"></span></p>
                                </div>
                            </template>
                        </div>
                    </div>
                </template>
                <p x-show="filteredMessages.length === 0" class="text-center text-gray-400 py-8">Êö´ÁÑ°ÁïôË®Ä</p>
            </div>

            <!-- New Message FAB -->
            <button @click="showAddMessage = true" class="fixed bottom-24 right-4 w-14 h-14 bg-primary-600 text-white rounded-full shadow-lg flex items-center justify-center">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
            </button>
        </div>
    </main>

    <!-- Bottom Navigation (4 tabs) -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 bottom-nav z-50">
        <div class="flex justify-around max-w-lg mx-auto">
            <button @click="switchTab('people')" :class="currentTab === 'people' ? 'text-primary-600' : 'text-gray-400'" class="flex-1 py-3 flex flex-col items-center">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                <span class="text-xs mt-1">‰∫∫Âì°</span>
            </button>
            <button @click="switchTab('inventory')" :class="currentTab === 'inventory' ? 'text-primary-600' : 'text-gray-400'" class="flex-1 py-3 flex flex-col items-center">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                </svg>
                <span class="text-xs mt-1">Áâ©Ë≥á</span>
            </button>
            <button @click="switchTab('equipment')" :class="currentTab === 'equipment' ? 'text-primary-600' : 'text-gray-400'" class="flex-1 py-3 flex flex-col items-center">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                <span class="text-xs mt-1">Ë®≠ÂÇô</span>
            </button>
            <button @click="switchTab('messages')" :class="currentTab === 'messages' ? 'text-primary-600' : 'text-gray-400'" class="flex-1 py-3 flex flex-col items-center">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                </svg>
                <span class="text-xs mt-1">ÁïôË®ÄÊùø</span>
            </button>
        </div>
    </nav>

    <!-- ==================== Modals ==================== -->

    <!-- Login Modal -->
    <div x-show="showLoginModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showLoginModal = false">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-semibold mb-4">ÁôªÂÖ•</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-600 mb-1">‰ΩøÁî®ËÄÖ ID</label>
                    <input type="text" x-model="loginForm.person_id" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="admin001">
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">PIN</label>
                    <input type="password" x-model="loginForm.pin" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="****" inputmode="numeric" maxlength="6">
                </div>
                <p x-show="loginError" class="text-red-500 text-sm" x-text="loginError"></p>
                <!-- Demo Credentials Hint -->
                <div id="demo-login-hint" style="display:none;" class="bg-amber-50 border border-amber-200 rounded-lg p-3 text-xs">
                    <p class="font-medium text-amber-700 mb-2">üìã Ê∏¨Ë©¶Â∏≥Ëôü (PIN ÁöÜÁÇ∫ 1234)</p>
                    <div class="space-y-1 text-amber-600">
                        <p><code class="bg-amber-100 px-1 rounded">admin001</code> ÁÆ°ÁêÜÂì° - ÂÖ®ÂäüËÉΩ</p>
                        <p><code class="bg-amber-100 px-1 rounded">staff001</code> ÂøóÂ∑• - ÂÖ•Â∫´/Â†±Âà∞</p>
                        <p><code class="bg-amber-100 px-1 rounded">medic001</code> ÈÜ´Ë≠∑ - Ê™¢ÂÇ∑ÂàÜÈ°û</p>
                    </div>
                </div>
                <script>
                    fetch('/api/demo-status').then(r=>r.json()).then(d=>{if(d.is_demo)document.getElementById('demo-login-hint').style.display='block';}).catch(()=>{});
                </script>
                <div class="flex space-x-3">
                    <button @click="showLoginModal = false" class="flex-1 px-4 py-2 border border-gray-200 rounded-lg">ÂèñÊ∂à</button>
                    <button @click="doLogin()" class="flex-1 px-4 py-2 bg-primary-600 text-white rounded-lg">ÁôªÂÖ•</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Triage Modal -->
    <div x-show="showTriageModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showTriageModal = false">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-semibold mb-4">Ê™¢ÂÇ∑ÂàÜÈ°û: <span x-text="triageTarget?.display_name"></span></h3>
            <div class="grid grid-cols-2 gap-3 mb-4">
                <button @click="doTriage('GREEN')" class="bg-green-500 text-white rounded-xl p-6 text-center">
                    <span class="text-2xl font-bold">ËºïÂÇ∑</span>
                    <p class="text-sm opacity-80">Minor</p>
                </button>
                <button @click="doTriage('YELLOW')" class="bg-yellow-500 text-white rounded-xl p-6 text-center">
                    <span class="text-2xl font-bold">Âª∂ÈÅ≤</span>
                    <p class="text-sm opacity-80">Delayed</p>
                </button>
                <button @click="doTriage('RED')" class="bg-red-500 text-white rounded-xl p-6 text-center">
                    <span class="text-2xl font-bold">Á´ãÂç≥</span>
                    <p class="text-sm opacity-80">Immediate</p>
                </button>
                <button @click="doTriage('BLACK')" class="bg-gray-800 text-white rounded-xl p-6 text-center">
                    <span class="text-2xl font-bold">Ê≠ª‰∫°</span>
                    <p class="text-sm opacity-80">Deceased</p>
                </button>
            </div>
            <button @click="showTriageModal = false" class="w-full px-4 py-2 border border-gray-200 rounded-lg">ÂèñÊ∂à</button>
        </div>
    </div>

    <!-- Intake Modal -->
    <div x-show="showIntakeModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showIntakeModal = false">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm max-h-[90vh] overflow-hidden flex flex-col">
            <h3 class="text-lg font-semibold mb-4">ÂÖ•Â∫´</h3>
            <div class="space-y-4 overflow-y-auto flex-1">
                <div>
                    <label class="block text-sm text-gray-600 mb-1">ÊêúÂ∞ã‰∏¶ÈÅ∏ÊìáÁâ©Ë≥á</label>
                    <input type="text" x-model="intakeSearch" placeholder="Ëº∏ÂÖ•ÂêçÁ®±ÊêúÂ∞ã..."
                           class="w-full border border-gray-200 rounded-lg px-3 py-2 mb-2 text-sm">
                    <div class="max-h-32 overflow-y-auto border border-gray-200 rounded-lg">
                        <template x-for="item in inventory.filter(i => i.category !== 'equipment' && (!intakeSearch || i.name.toLowerCase().includes(intakeSearch.toLowerCase())))" :key="item.id">
                            <button @click="intakeForm.item_id = item.id; intakeSearch = ''"
                                    class="w-full px-3 py-2 text-left text-sm hover:bg-gray-50 border-b border-gray-100 last:border-0"
                                    :class="intakeForm.item_id === item.id ? 'bg-primary-50 text-primary-700' : ''">
                                <span x-text="item.name + (item.specification ? ' (' + item.specification + ')' : '')"></span>
                                <span class="text-gray-400 ml-1">Â∫´Â≠ò: <span x-text="item.quantity"></span></span>
                            </button>
                        </template>
                        <p x-show="inventory.filter(i => i.category !== 'equipment' && (!intakeSearch || i.name.toLowerCase().includes(intakeSearch.toLowerCase()))).length === 0"
                           class="text-center text-gray-400 py-2 text-xs">Ê≤íÊúâÁ¨¶ÂêàÁöÑÁâ©Ë≥á</p>
                    </div>
                    <p x-show="intakeForm.item_id" class="text-xs text-primary-600 mt-1">
                        Â∑≤ÈÅ∏: <span x-text="inventory.find(i => i.id === intakeForm.item_id)?.name || ''"></span>
                    </p>
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">ÂÖ•Â∫´Êï∏Èáè</label>
                    <div class="flex items-center space-x-3">
                        <button @click="intakeForm.quantity = Math.max(1, intakeForm.quantity - 1)" class="w-10 h-10 bg-gray-100 rounded-lg text-lg">-</button>
                        <input type="number" x-model.number="intakeForm.quantity" class="flex-1 border border-gray-200 rounded-lg px-3 py-2 text-center" min="1">
                        <button @click="intakeForm.quantity++" class="w-10 h-10 bg-gray-100 rounded-lg text-lg">+</button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">ÂÇôË®ª</label>
                    <input type="text" x-model="intakeForm.notes" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="ÈÅ∏Â°´">
                </div>
                <div class="flex space-x-3">
                    <button @click="showIntakeModal = false" class="flex-1 px-4 py-2 border border-gray-200 rounded-lg">ÂèñÊ∂à</button>
                    <button @click="doIntake()" class="flex-1 px-4 py-2 bg-primary-600 text-white rounded-lg">Á¢∫Ë™çÂÖ•Â∫´</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Distribute Select Modal -->
    <div x-show="showDistributeSelectModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showDistributeSelectModal = false">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm max-h-[85vh] flex flex-col">
            <h3 class="text-lg font-semibold mb-3">ÈÅ∏ÊìáÁôºÊîæÁâ©Ë≥á</h3>
            <!-- ÊêúÂ∞ãÊ¨Ñ -->
            <input type="text" x-model="distributeSearch" placeholder="ÊêúÂ∞ãÁâ©Ë≥áÂêçÁ®±..."
                   class="w-full border border-gray-200 rounded-lg px-3 py-2 mb-3 text-sm"
                   @input="$event.target.focus()">
            <div class="space-y-2 overflow-y-auto flex-1">
                <template x-for="item in inventory.filter(i => i.category !== 'equipment' && i.quantity > 0 && (!distributeSearch || i.name.toLowerCase().includes(distributeSearch.toLowerCase())))" :key="item.id">
                    <button @click="startDistribute(item); showDistributeSelectModal = false; distributeSearch = ''" class="w-full bg-gray-50 hover:bg-gray-100 rounded-lg p-3 text-left">
                        <p class="font-medium" x-text="item.name + (item.specification ? ' (' + item.specification + ')' : '')"></p>
                        <p class="text-sm text-gray-500">Â∫´Â≠ò: <span x-text="item.quantity"></span> <span x-text="item.unit || 'ÂÄã'"></span></p>
                    </button>
                </template>
                <p x-show="inventory.filter(i => i.category !== 'equipment' && i.quantity > 0 && (!distributeSearch || i.name.toLowerCase().includes(distributeSearch.toLowerCase()))).length === 0"
                   class="text-center text-gray-400 py-4 text-sm">Ê≤íÊúâÁ¨¶ÂêàÁöÑÁâ©Ë≥á</p>
            </div>
            <button @click="showDistributeSelectModal = false; distributeSearch = ''" class="w-full mt-4 px-4 py-2 border border-gray-200 rounded-lg">ÂèñÊ∂à</button>
        </div>
    </div>

    <!-- Distribute Modal -->
    <div x-show="showDistributeModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showDistributeModal = false">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-semibold mb-4">ÁôºÊîæ: <span x-text="distributeItem?.name"></span></h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-600 mb-1">È†òÂèñ‰∫∫ ID</label>
                    <input type="text" x-model="distributeForm.person_id" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="Ëº∏ÂÖ• ID">
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">Êï∏Èáè (Â∫´Â≠ò: <span x-text="distributeItem?.quantity"></span>)</label>
                    <div class="flex items-center space-x-3">
                        <button @click="distributeForm.quantity = Math.max(1, distributeForm.quantity - 1)" class="w-10 h-10 bg-gray-100 rounded-lg">-</button>
                        <input type="number" x-model.number="distributeForm.quantity" class="flex-1 border border-gray-200 rounded-lg px-3 py-2 text-center" min="1">
                        <button @click="distributeForm.quantity++" class="w-10 h-10 bg-gray-100 rounded-lg">+</button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">ÂÇôË®ª</label>
                    <input type="text" x-model="distributeForm.notes" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="ÈÅ∏Â°´">
                </div>
                <div class="flex space-x-3">
                    <button @click="showDistributeModal = false" class="flex-1 px-4 py-2 border border-gray-200 rounded-lg">ÂèñÊ∂à</button>
                    <button @click="doDistribute()" class="flex-1 px-4 py-2 bg-amber-600 text-white rounded-lg">Á¢∫Ë™çÁôºÊîæ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Inventory Modal -->
    <div x-show="showAddInventoryModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showAddInventoryModal = false">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-semibold mb-4">Êñ∞Â¢ûÁâ©Ë≥á</h3>
            <div class="space-y-3">
                <div>
                    <label class="block text-sm text-gray-600 mb-1">ÂêçÁ®± *</label>
                    <input type="text" x-model="newInventory.name" @input="checkSimilarItems()" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="‰æã: Á§¶Ê≥âÊ∞¥">
                </div>
                <!-- Similar Items Suggestion -->
                <div x-show="similarItems.length > 0" class="bg-blue-50 rounded-lg p-3">
                    <p class="text-sm text-blue-700 mb-2">ÊâæÂà∞È°û‰ººÁâ©Ë≥áÔºåÊòØÂê¶Áõ¥Êé•ÂÖ•Â∫´Ôºü</p>
                    <template x-for="si in similarItems" :key="si.id">
                        <button @click="quickIntake(si); showAddInventoryModal = false" class="w-full bg-white rounded p-2 mb-1 text-left text-sm hover:bg-blue-100">
                            <span x-text="si.name"></span>
                            <span x-show="si.specification" class="text-gray-500">(<span x-text="si.specification"></span>)</span>
                            - <span x-text="si.quantity"></span> <span x-text="si.unit || 'ÂÄã'"></span>
                        </button>
                    </template>
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">Ë¶èÊ†º</label>
                    <input type="text" x-model="newInventory.specification" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="‰æã: 600ml, 5ÂÖ¨Êñ§Ë£ù">
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">ÂàÜÈ°û *</label>
                    <select x-model="newInventory.category" class="w-full border border-gray-200 rounded-lg px-3 py-2">
                        <option value="water">Ê∞¥</option>
                        <option value="food">È£üÁâ©</option>
                        <option value="medical">ÈÜ´ÁôÇ</option>
                        <option value="power">ÈõªÂäõ</option>
                        <option value="daily">Êó•Áî®ÂìÅ</option>
                        <option value="other">ÂÖ∂‰ªñ</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">Êï∏Èáè</label>
                        <input type="number" x-model.number="newInventory.quantity" class="w-full border border-gray-200 rounded-lg px-3 py-2" min="0">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">ÂñÆ‰Ωç</label>
                        <input type="text" x-model="newInventory.unit" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="Áì∂/ÁÆ±/ÂÄã">
                    </div>
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">‰ΩçÁΩÆ</label>
                    <input type="text" x-model="newInventory.location" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="ÂÄâÂ∫´A">
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">ÊïàÊúü</label>
                    <input type="date" x-model="newInventory.expiry_date" class="w-full border border-gray-200 rounded-lg px-3 py-2">
                </div>
                <div class="flex space-x-3">
                    <button @click="showAddInventoryModal = false" class="flex-1 px-4 py-2 border border-gray-200 rounded-lg">ÂèñÊ∂à</button>
                    <button @click="doAddInventory()" class="flex-1 px-4 py-2 bg-primary-600 text-white rounded-lg">Êñ∞Â¢û</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Equipment Check Modal -->
    <div x-show="showEquipmentCheckModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showEquipmentCheckModal = false">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-semibold mb-4">Ë®≠ÂÇôÊ™¢Êü•: <span x-text="checkTarget?.name"></span></h3>
            <div class="space-y-4">
                <div class="grid grid-cols-3 gap-2">
                    <button @click="equipmentCheckForm.status = 'OK'" :class="equipmentCheckForm.status === 'OK' ? 'ring-2 ring-green-500' : ''" class="bg-green-100 text-green-700 rounded-xl p-4 text-center">
                        <svg class="w-8 h-8 mx-auto mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        <span class="text-sm font-medium">Ê≠£Â∏∏</span>
                    </button>
                    <button @click="equipmentCheckForm.status = 'NEEDS_REPAIR'" :class="equipmentCheckForm.status === 'NEEDS_REPAIR' ? 'ring-2 ring-yellow-500' : ''" class="bg-yellow-100 text-yellow-700 rounded-xl p-4 text-center">
                        <svg class="w-8 h-8 mx-auto mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                        <span class="text-sm font-medium">ÂæÖ‰øÆ</span>
                    </button>
                    <button @click="equipmentCheckForm.status = 'OUT_OF_SERVICE'" :class="equipmentCheckForm.status === 'OUT_OF_SERVICE' ? 'ring-2 ring-red-500' : ''" class="bg-red-100 text-red-700 rounded-xl p-4 text-center">
                        <svg class="w-8 h-8 mx-auto mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                        <span class="text-sm font-medium">ÂÅúÁî®</span>
                    </button>
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">ÂÇôË®ª</label>
                    <input type="text" x-model="equipmentCheckForm.notes" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="ÈÅ∏Â°´">
                </div>
                <div class="flex space-x-3">
                    <button @click="showEquipmentCheckModal = false" class="flex-1 px-4 py-2 border border-gray-200 rounded-lg">ÂèñÊ∂à</button>
                    <button @click="doEquipmentCheck()" class="flex-1 px-4 py-2 bg-primary-600 text-white rounded-lg">Á¢∫Ë™ç</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Equipment Modal -->
    <div x-show="showAddEquipmentModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showAddEquipmentModal = false">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-semibold mb-4">Êñ∞Â¢ûË®≠ÂÇô</h3>
            <div class="space-y-3">
                <div>
                    <label class="block text-sm text-gray-600 mb-1">ÂêçÁ®± *</label>
                    <input type="text" x-model="newEquipment.name" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="‰æã: ÁôºÈõªÊ©ü">
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">Ë¶èÊ†º</label>
                    <input type="text" x-model="newEquipment.specification" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="‰æã: 3kW">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">Êï∏Èáè</label>
                        <input type="number" x-model.number="newEquipment.quantity" class="w-full border border-gray-200 rounded-lg px-3 py-2" min="1" value="1">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">ÂñÆ‰Ωç</label>
                        <input type="text" x-model="newEquipment.unit" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="Âè∞">
                    </div>
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">‰ΩçÁΩÆ</label>
                    <input type="text" x-model="newEquipment.location" class="w-full border border-gray-200 rounded-lg px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">Ê™¢Êü•ÈÄ±Êúü (Â§©)</label>
                    <input type="number" x-model.number="newEquipment.check_interval_days" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="1 = ÊØèÊó•Ê™¢Êü•" min="1">
                </div>
                <div class="flex space-x-3">
                    <button @click="showAddEquipmentModal = false" class="flex-1 px-4 py-2 border border-gray-200 rounded-lg">ÂèñÊ∂à</button>
                    <button @click="doAddEquipment()" class="flex-1 px-4 py-2 bg-primary-600 text-white rounded-lg">Êñ∞Â¢û</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Equipment Modal -->
    <div x-show="showEditEquipmentModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showEditEquipmentModal = false">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-semibold mb-4">Á∑®ËºØË®≠ÂÇô</h3>
            <div class="space-y-3">
                <div>
                    <label class="block text-sm text-gray-600 mb-1">ÂêçÁ®± *</label>
                    <input type="text" x-model="editEquipment.name" class="w-full border border-gray-200 rounded-lg px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">Ë¶èÊ†º</label>
                    <input type="text" x-model="editEquipment.specification" class="w-full border border-gray-200 rounded-lg px-3 py-2">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">Êï∏Èáè</label>
                        <input type="number" x-model.number="editEquipment.quantity" class="w-full border border-gray-200 rounded-lg px-3 py-2" min="1">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">ÂñÆ‰Ωç</label>
                        <input type="text" x-model="editEquipment.unit" class="w-full border border-gray-200 rounded-lg px-3 py-2">
                    </div>
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">‰ΩçÁΩÆ</label>
                    <input type="text" x-model="editEquipment.location" class="w-full border border-gray-200 rounded-lg px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">Ê™¢Êü•ÈÄ±Êúü (Â§©)</label>
                    <input type="number" x-model.number="editEquipment.check_interval_days" class="w-full border border-gray-200 rounded-lg px-3 py-2" min="1">
                </div>
                <div class="flex space-x-3">
                    <button @click="showEditEquipmentModal = false" class="flex-1 px-4 py-2 border border-gray-200 rounded-lg">ÂèñÊ∂à</button>
                    <button @click="doEditEquipment()" class="flex-1 px-4 py-2 bg-primary-600 text-white rounded-lg">ÂÑ≤Â≠ò</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div x-show="showDeleteConfirmModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showDeleteConfirmModal = false">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-semibold mb-2 text-red-600">Á¢∫Ë™çÂà™Èô§</h3>
            <p class="text-gray-600 mb-4">Á¢∫ÂÆöË¶ÅÂà™Èô§„Äå<span x-text="deleteTarget?.name"></span>„ÄçÂóéÔºüÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©Âéü„ÄÇ</p>
            <div class="flex space-x-3">
                <button @click="showDeleteConfirmModal = false" class="flex-1 px-4 py-2 border border-gray-200 rounded-lg">ÂèñÊ∂à</button>
                <button @click="doDelete()" class="flex-1 px-4 py-2 bg-red-500 text-white rounded-lg">Âà™Èô§</button>
            </div>
        </div>
    </div>

    <!-- Add Message Modal -->
    <div x-show="showAddMessage" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showAddMessage = false">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-semibold mb-4">ÁôºÂ∏ÉÁïôË®Ä</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-600 mb-1">ÂàÜÈ°û</label>
                    <select x-model="newMessage.category" class="w-full border border-gray-200 rounded-lg px-3 py-2">
                        <option value="general">‰∏ÄËà¨</option>
                        <option value="seek_person">Â∞ã‰∫∫</option>
                        <option value="seek_item">Â∞ãÁâ©</option>
                        <option value="offer_help">‰∫íÂä©</option>
                        <option value="report">ÁãÄÊ≥ÅÂõûÂ†±</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">ÂÖßÂÆπ *</label>
                    <textarea x-model="newMessage.content" class="w-full border border-gray-200 rounded-lg px-3 py-2 h-24" placeholder="Ëº∏ÂÖ•ÁïôË®ÄÂÖßÂÆπ..."></textarea>
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">È°ØÁ§∫ÂêçÁ®±</label>
                    <input type="text" x-model="newMessage.author_name" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="ÂåøÂêç">
                </div>
                <div class="flex space-x-3">
                    <button @click="showAddMessage = false" class="flex-1 px-4 py-2 border border-gray-200 rounded-lg">ÂèñÊ∂à</button>
                    <button @click="doAddMessage()" class="flex-1 px-4 py-2 bg-primary-600 text-white rounded-lg">ÁôºÂ∏É</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reply Modal -->
    <div x-show="showReplyModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showReplyModal = false">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-semibold mb-2">ÂõûË¶ÜÁïôË®Ä</h3>
            <p class="text-sm text-gray-500 mb-4 truncate" x-text="replyTarget?.content"></p>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-600 mb-1">ÂõûË¶ÜÂÖßÂÆπ *</label>
                    <textarea x-model="replyForm.content" class="w-full border border-gray-200 rounded-lg px-3 py-2 h-24" placeholder="Ëº∏ÂÖ•ÂõûË¶ÜÂÖßÂÆπ..."></textarea>
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">È°ØÁ§∫ÂêçÁ®±</label>
                    <input type="text" x-model="replyForm.author_name" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="ÂåøÂêç">
                </div>
                <div class="flex space-x-3">
                    <button @click="showReplyModal = false" class="flex-1 px-4 py-2 border border-gray-200 rounded-lg">ÂèñÊ∂à</button>
                    <button @click="doReply()" class="flex-1 px-4 py-2 bg-primary-600 text-white rounded-lg">ÂõûË¶Ü</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bundle Select Modal (ÁµÑÂ•óÈÅ∏Êìá) -->
    <div x-show="showBundleModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showBundleModal = false">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm max-h-[80vh] overflow-hidden flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">ÈÅ∏ÊìáÁµÑÂ•óÂÖ•Â∫´</h3>
                <button x-show="currentUser && currentUser.role === 'admin'" @click="showBundleModal = false; openBundleManage()" class="text-xs text-primary-600 hover:underline">ÁÆ°ÁêÜÁµÑÂ•ó</button>
            </div>
            <div class="space-y-2 overflow-y-auto flex-1">
                <template x-for="bundle in bundles" :key="bundle.id">
                    <button @click="selectBundle(bundle)" class="w-full bg-gray-50 hover:bg-primary-50 rounded-xl p-4 text-left transition-colors border border-gray-100 hover:border-primary-200">
                        <div class="flex items-center">
                            <div class="w-10 h-10 mr-3 bg-primary-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                <svg class="w-6 h-6 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path :d="getBundleIconPath(bundle.icon)" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <p class="font-medium text-gray-800" x-text="bundle.name"></p>
                                <p class="text-sm text-gray-500" x-text="bundle.description"></p>
                                <p class="text-xs text-gray-400 mt-1">
                                    ÂåÖÂê´ <span x-text="bundle.items?.length || 0"></span> È†ÖÁâ©Ë≥á
                                </p>
                            </div>
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                        </div>
                    </button>
                </template>
                <p x-show="bundles.length === 0" class="text-center text-gray-400 py-8">ÁÑ°ÁµÑÂ•óË≥áÊñô</p>
            </div>
            <button @click="showBundleModal = false" class="w-full mt-4 px-4 py-2 border border-gray-200 rounded-lg">ÂèñÊ∂à</button>
        </div>
    </div>

    <!-- Bundle Manage Modal (ÁµÑÂ•óÁÆ°ÁêÜ - Admin) -->
    <div x-show="showBundleManageModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showBundleManageModal = false">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm max-h-[80vh] overflow-hidden flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">ÁÆ°ÁêÜÁµÑÂ•ó</h3>
                <button @click="startCreateBundle()" class="bg-primary-600 text-white px-3 py-1 rounded-lg text-sm">Êñ∞Â¢ûÁµÑÂ•ó</button>
            </div>
            <div class="space-y-2 overflow-y-auto flex-1">
                <template x-for="bundle in bundles" :key="bundle.id">
                    <div class="bg-gray-50 rounded-xl p-4 border border-gray-100">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center flex-1 min-w-0">
                                <div class="w-10 h-10 mr-3 bg-primary-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                    <svg class="w-6 h-6 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path :d="getBundleIconPath(bundle.icon)" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/>
                                    </svg>
                                </div>
                                <div class="min-w-0">
                                    <p class="font-medium text-gray-800 truncate" x-text="bundle.name"></p>
                                    <p class="text-xs text-gray-400"><span x-text="bundle.items?.length || 0"></span> È†ÖÁâ©Ë≥á</p>
                                </div>
                            </div>
                            <div class="flex space-x-1 ml-2">
                                <button @click="startEditBundle(bundle)" class="text-blue-600 p-1.5 bg-blue-50 rounded-lg" title="Á∑®ËºØ">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                    </svg>
                                </button>
                                <button @click="confirmDeleteBundle(bundle)" class="text-red-600 p-1.5 bg-red-50 rounded-lg" title="Âà™Èô§">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </template>
                <p x-show="bundles.length === 0" class="text-center text-gray-400 py-8">Â∞öÁÑ°ÁµÑÂ•óÔºåÈªûÊìä‰∏äÊñπÊñ∞Â¢û</p>
            </div>
            <button @click="showBundleManageModal = false" class="w-full mt-4 px-4 py-2 border border-gray-200 rounded-lg">ÈóúÈñâ</button>
        </div>
    </div>

    <!-- Zone Manage Modal (ÂçÄÂüüÁÆ°ÁêÜ - Admin) -->
    <div x-show="showZoneManageModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showZoneManageModal = false">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md max-h-[85vh] overflow-hidden flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">ÂçÄÂüüÁÆ°ÁêÜ</h3>
                <button @click="showZoneManageModal = false" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <!-- New Zone Form -->
            <div class="bg-gray-50 rounded-xl p-4 mb-4">
                <h4 class="font-medium text-sm mb-3">Êñ∞Â¢ûÂçÄÂüü</h4>
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <input type="text" x-model="newZone.id" placeholder="ÂçÄÂüü‰ª£Á¢º *" class="border border-gray-200 rounded-lg px-3 py-2 text-sm">
                    <input type="text" x-model="newZone.name" placeholder="ÂçÄÂüüÂêçÁ®± *" class="border border-gray-200 rounded-lg px-3 py-2 text-sm">
                </div>
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <select x-model="newZone.zone_type" class="border border-gray-200 rounded-lg px-3 py-2 text-sm">
                        <option value="shelter">Êî∂ÂÆπÂçÄÂüü</option>
                        <option value="medical">ÈÜ´ÁôÇÂçÄÂüü</option>
                        <option value="service">ÊúçÂãôÂçÄÂüü</option>
                        <option value="restricted">ÁÆ°Âà∂ÂçÄÂüü</option>
                    </select>
                    <input type="number" x-model="newZone.capacity" placeholder="ÂÆπÈáè (0=ÁÑ°Èôê)" class="border border-gray-200 rounded-lg px-3 py-2 text-sm" min="0">
                </div>
                <input type="text" x-model="newZone.description" placeholder="Ë™™Êòé (ÈÅ∏Â°´)" class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm mb-2">
                <button @click="createZone()" class="w-full bg-primary-600 text-white rounded-lg py-2 text-sm font-medium">Êñ∞Â¢ûÂçÄÂüü</button>
            </div>

            <!-- Zone List -->
            <div class="space-y-2 overflow-y-auto flex-1">
                <template x-for="zoneType in ['shelter', 'medical', 'service', 'restricted']" :key="zoneType">
                    <div>
                        <h4 class="text-xs font-semibold text-gray-500 uppercase mb-2 flex items-center">
                            <span :class="{
                                'bg-blue-100 text-blue-600': zoneType === 'shelter',
                                'bg-red-100 text-red-600': zoneType === 'medical',
                                'bg-green-100 text-green-600': zoneType === 'service',
                                'bg-gray-200 text-gray-600': zoneType === 'restricted'
                            }" class="px-2 py-0.5 rounded mr-2" x-text="zoneTypeLabels[zoneType]"></span>
                        </h4>
                        <template x-for="zone in zones.filter(z => z.zone_type === zoneType)" :key="zone.id">
                            <div class="bg-white border border-gray-100 rounded-lg p-3 mb-2 flex items-center justify-between">
                                <div class="flex-1 min-w-0">
                                    <p class="font-medium text-sm truncate" x-text="zone.name"></p>
                                    <p class="text-xs text-gray-400">
                                        <span x-text="zone.id"></span>
                                        <span x-show="zone.capacity > 0"> ¬∑ ÂÆπÈáè: <span x-text="zone.capacity"></span></span>
                                    </p>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span class="text-sm font-semibold text-primary-600" x-text="zone.current_count || 0"></span>
                                    <button @click="deleteZone(zone.id)" class="text-red-500 p-1.5 hover:bg-red-50 rounded-lg" title="Âà™Èô§">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </template>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <!-- Batch Move Modal (ÊâπÊ¨°ÁßªÂãï‰∫∫Âì°) -->
    <div x-show="showBatchMoveModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showBatchMoveModal = false">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-semibold mb-4">ÊâπÊ¨°ÁßªÂãï‰∫∫Âì°</h3>
            <p class="text-sm text-gray-600 mb-4">
                Â∞á <span class="font-semibold text-primary-600" x-text="selectedPeople.length"></span> ‰∫∫ÁßªÂãïËá≥...
            </p>

            <!-- Target Zone Selection -->
            <div class="space-y-2 max-h-60 overflow-y-auto mb-4">
                <template x-for="zone in zones" :key="zone.id">
                    <label class="flex items-center p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition"
                           :class="batchMoveForm.target_zone_id === zone.id ? 'ring-2 ring-primary-500 bg-primary-50' : ''">
                        <input type="radio" name="target_zone" :value="zone.id" x-model="batchMoveForm.target_zone_id" class="mr-3">
                        <div class="flex-1">
                            <p class="font-medium text-sm" x-text="zone.name"></p>
                            <p class="text-xs text-gray-400">
                                <span x-text="zone.current_count || 0"></span>
                                <span x-show="zone.capacity > 0">/<span x-text="zone.capacity"></span></span>
                            </p>
                        </div>
                        <span class="text-xs px-2 py-0.5 rounded"
                              :class="{
                                  'bg-blue-100 text-blue-600': zone.zone_type === 'shelter',
                                  'bg-red-100 text-red-600': zone.zone_type === 'medical',
                                  'bg-green-100 text-green-600': zone.zone_type === 'service',
                                  'bg-gray-200 text-gray-600': zone.zone_type === 'restricted'
                              }"
                              x-text="zoneTypeLabels[zone.zone_type]"></span>
                    </label>
                </template>
            </div>

            <!-- Notes -->
            <input type="text" x-model="batchMoveForm.notes" placeholder="ÂÇôË®ª (ÈÅ∏Â°´)" class="w-full border border-gray-200 rounded-lg px-3 py-2 mb-4 text-sm">

            <!-- Actions -->
            <div class="grid grid-cols-2 gap-2">
                <button @click="showBatchMoveModal = false" class="px-4 py-2 border border-gray-200 rounded-lg">ÂèñÊ∂à</button>
                <button @click="doBatchMove()" class="px-4 py-2 bg-primary-600 text-white rounded-lg font-medium">Á¢∫Ë™çÁßªÂãï</button>
            </div>
        </div>
    </div>

    <!-- Batch Checkout Modal (ÊâπÊ¨°ÈÄÄÂ†¥) -->
    <div x-show="showBatchCheckoutModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showBatchCheckoutModal = false">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md">
            <h3 class="text-lg font-semibold mb-2 flex items-center text-red-600">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                </svg>
                ÊâπÊ¨°ÈÄÄÂ†¥
            </h3>
            <p class="text-gray-600 mb-4">
                Â∞á <span class="font-semibold text-red-600" x-text="selectedPeople.length"></span> ‰∫∫Ëæ¶ÁêÜÈõ¢Á´ôÊâãÁ∫å
            </p>

            <!-- Selected People Preview -->
            <div class="bg-gray-50 rounded-lg p-3 mb-4 max-h-32 overflow-y-auto">
                <p class="text-xs text-gray-500 mb-2">Âç≥Â∞áÈÄÄÂ†¥‰∫∫Âì°Ôºö</p>
                <div class="flex flex-wrap gap-1">
                    <template x-for="pid in selectedPeople.slice(0, 10)" :key="pid">
                        <span class="text-xs bg-white px-2 py-1 rounded border" x-text="people.find(p => p.id === pid)?.display_name || pid"></span>
                    </template>
                    <span x-show="selectedPeople.length > 10" class="text-xs text-gray-400">...Á≠â <span x-text="selectedPeople.length"></span> ‰∫∫</span>
                </div>
            </div>

            <!-- Checkout Reason -->
            <div class="mb-4">
                <label class="block text-sm text-gray-600 mb-2">ÈÄÄÂ†¥ÂéüÂõ†</label>
                <div class="grid grid-cols-3 gap-2">
                    <button @click="batchCheckoutForm.reason = 'DISCHARGE'"
                            :class="batchCheckoutForm.reason === 'DISCHARGE' ? 'bg-primary-600 text-white' : 'bg-gray-100 text-gray-700'"
                            class="px-3 py-2 rounded-lg text-sm font-medium transition">
                        Ê≠£Â∏∏Èõ¢Á´ô
                    </button>
                    <button @click="batchCheckoutForm.reason = 'TRANSFER'"
                            :class="batchCheckoutForm.reason === 'TRANSFER' ? 'bg-amber-500 text-white' : 'bg-gray-100 text-gray-700'"
                            class="px-3 py-2 rounded-lg text-sm font-medium transition">
                        ËΩâÈÄÅÈÜ´Èô¢
                    </button>
                    <button @click="batchCheckoutForm.reason = 'OTHER'"
                            :class="batchCheckoutForm.reason === 'OTHER' ? 'bg-gray-600 text-white' : 'bg-gray-100 text-gray-700'"
                            class="px-3 py-2 rounded-lg text-sm font-medium transition">
                        ÂÖ∂‰ªñ
                    </button>
                </div>
            </div>

            <!-- Destination -->
            <div class="mb-4">
                <label class="block text-sm text-gray-600 mb-1">ÂéªÂêëÔºàÈÅ∏Â°´Ôºâ</label>
                <input type="text" x-model="batchCheckoutForm.destination" placeholder="‰æãÔºöËøîÂÆ∂„ÄÅXXÈÜ´Èô¢"
                       class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm">
            </div>

            <!-- Notes -->
            <input type="text" x-model="batchCheckoutForm.notes" placeholder="ÂÇôË®ªÔºàÈÅ∏Â°´Ôºâ"
                   class="w-full border border-gray-200 rounded-lg px-3 py-2 mb-4 text-sm">

            <!-- Actions -->
            <div class="grid grid-cols-2 gap-2">
                <button @click="showBatchCheckoutModal = false" class="px-4 py-2 border border-gray-200 rounded-lg">ÂèñÊ∂à</button>
                <button @click="doBatchCheckout()" class="px-4 py-2 bg-red-600 text-white rounded-lg font-medium">Á¢∫Ë™çÈÄÄÂ†¥</button>
            </div>
        </div>
    </div>

    <!-- Backup Modal (Ë≥áÊñôÂÇô‰ªΩ) -->
    <div x-show="showBackupModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showBackupModal = false">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md max-h-[85vh] overflow-y-auto">
            <h3 class="text-lg font-semibold mb-4 flex items-center">
                <svg class="w-6 h-6 text-primary-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2 1 3 3 3h10c2 0 3-1 3-3V7c0-2-1-3-3-3H7c-2 0-3 1-3 3zm0 5h16m-8 5v-5"/>
                </svg>
                Ë≥áÊñôÂÇô‰ªΩÁÆ°ÁêÜ
            </h3>

            <!-- Last Backup Info -->
            <div class="bg-gray-50 rounded-lg p-4 mb-4">
                <p class="text-sm text-gray-600 mb-1">ÊúÄËøëÂÇô‰ªΩ</p>
                <template x-if="backupStatus.last_backup">
                    <div>
                        <p class="font-medium" x-text="formatBackupTime(backupStatus.last_backup.timestamp)"></p>
                        <p class="text-xs text-gray-500" x-text="backupStatus.last_backup.backup_type + ' ¬∑ ' + (backupStatus.last_backup.encrypted ? 'Â∑≤Âä†ÂØÜ' : 'Êú™Âä†ÂØÜ')"></p>
                    </div>
                </template>
                <template x-if="!backupStatus.last_backup">
                    <p class="text-gray-400">Â∞öÁÑ°ÂÇô‰ªΩË®òÈåÑ</p>
                </template>
            </div>

            <!-- Create Backup Section -->
            <div class="border border-gray-200 rounded-lg p-4 mb-4">
                <h4 class="font-medium mb-3">Âª∫Á´ãÊñ∞ÂÇô‰ªΩ</h4>

                <!-- Backup Target -->
                <div class="mb-3">
                    <label class="block text-sm text-gray-600 mb-2">ÂÇô‰ªΩÁõÆÊ®ô</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button @click="backupForm.target = 'local'"
                                :class="backupForm.target === 'local' ? 'bg-primary-600 text-white' : 'bg-gray-100 text-gray-700'"
                                class="px-3 py-2 rounded-lg text-sm font-medium transition">
                            Êú¨Ê©ü
                        </button>
                        <button @click="backupForm.target = 'download'"
                                :class="backupForm.target === 'download' ? 'bg-primary-600 text-white' : 'bg-gray-100 text-gray-700'"
                                class="px-3 py-2 rounded-lg text-sm font-medium transition">
                            ‰∏ãËºâ
                        </button>
                        <button @click="backupForm.target = 'usb'"
                                :class="backupForm.target === 'usb' ? 'bg-primary-600 text-white' : 'bg-gray-100 text-gray-700'"
                                class="px-3 py-2 rounded-lg text-sm font-medium transition">
                            USB
                        </button>
                    </div>
                </div>

                <!-- Encryption -->
                <div class="mb-3">
                    <label class="flex items-center">
                        <input type="checkbox" x-model="backupForm.encrypt" class="rounded border-gray-300 text-primary-600 mr-2">
                        <span class="text-sm text-gray-700">Âä†ÂØÜÂÇô‰ªΩ</span>
                    </label>
                </div>

                <!-- Password (if encrypted) -->
                <div x-show="backupForm.encrypt" class="mb-3">
                    <label class="block text-sm text-gray-600 mb-1">Âä†ÂØÜÂØÜÁ¢º</label>
                    <input type="password" x-model="backupForm.password" placeholder="Ë´ãËº∏ÂÖ•ÂØÜÁ¢º"
                           class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm">
                </div>

                <!-- Notes -->
                <input type="text" x-model="backupForm.notes" placeholder="ÂÇôË®ªÔºàÈÅ∏Â°´Ôºâ"
                       class="w-full border border-gray-200 rounded-lg px-3 py-2 mb-3 text-sm">

                <button @click="createBackup()" :disabled="backupLoading"
                        class="w-full bg-primary-600 text-white rounded-lg py-2 font-medium disabled:opacity-50">
                    <span x-show="!backupLoading">Âª∫Á´ãÂÇô‰ªΩ</span>
                    <span x-show="backupLoading">ÂÇô‰ªΩ‰∏≠...</span>
                </button>
            </div>

            <!-- Backup History -->
            <div class="border border-gray-200 rounded-lg p-4">
                <h4 class="font-medium mb-3">ÂÇô‰ªΩË®òÈåÑ</h4>
                <div class="space-y-2 max-h-40 overflow-y-auto">
                    <template x-for="backup in backupStatus.local_backups?.slice(0, 5)" :key="backup.filename">
                        <div class="flex items-center justify-between bg-gray-50 rounded-lg p-2 text-sm">
                            <div>
                                <p class="font-medium truncate max-w-[200px]" x-text="backup.filename"></p>
                                <p class="text-xs text-gray-500">
                                    <span x-text="backup.size_mb + ' MB'"></span>
                                    <span x-show="backup.encrypted" class="ml-1 text-primary-600">
                                        <svg class="w-3 h-3 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                                        </svg>
                                    </span>
                                </p>
                            </div>
                            <span class="text-xs text-gray-400" x-text="formatBackupTime(backup.modified)"></span>
                        </div>
                    </template>
                    <p x-show="!backupStatus.local_backups?.length" class="text-gray-400 text-sm text-center py-2">Êö´ÁÑ°Êú¨Ê©üÂÇô‰ªΩ</p>
                </div>
            </div>

            <!-- Close Button -->
            <button @click="showBackupModal = false" class="w-full mt-4 px-4 py-2 border border-gray-200 rounded-lg">
                ÈóúÈñâ
            </button>
        </div>
    </div>

    <!-- Settings Modal (Á´ôÈªûË®≠ÂÆö) -->
    <div x-show="showSettingsModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showSettingsModal = false">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-semibold mb-4 flex items-center">
                <svg class="w-6 h-6 text-primary-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/>
                </svg>
                Á´ôÈªûË®≠ÂÆö
            </h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-600 mb-1">Á´ôÈªûÂêçÁ®±</label>
                    <input type="text" x-model="settingsForm.site_name" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="Á§æÂçÄÈÅøÈõ£‰∏≠ÂøÉ">
                </div>
                <div class="flex space-x-3">
                    <button @click="showSettingsModal = false" class="flex-1 px-4 py-2 border border-gray-200 rounded-lg">ÂèñÊ∂à</button>
                    <button @click="saveSiteName()" class="flex-1 px-4 py-2 bg-primary-600 text-white rounded-lg">ÂÑ≤Â≠ò</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Broadcast Modal (Áôº‰ΩàÂÖ¨Âëä) -->
    <div x-show="showBroadcastModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showBroadcastModal = false">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md">
            <h3 class="text-lg font-semibold mb-4 flex items-center">
                <svg class="w-6 h-6 text-amber-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"/>
                </svg>
                Áôº‰ΩàÂÖ¨Âëä
            </h3>

            <!-- Current Broadcast -->
            <div x-show="broadcast" class="bg-amber-50 border border-amber-200 rounded-lg p-3 mb-4">
                <p class="text-xs text-amber-600 mb-1">ÁõÆÂâçÂÖ¨ÂëäÔºö</p>
                <p class="text-sm text-amber-800" x-text="broadcast"></p>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-600 mb-1">ÂÖ¨ÂëäÂÖßÂÆπ</label>
                    <textarea x-model="broadcastForm.content" rows="3"
                              class="w-full border border-gray-200 rounded-lg px-3 py-2 resize-none"
                              placeholder="Ëº∏ÂÖ•Ë¶ÅÁôº‰ΩàÂà∞ Portal ÁöÑÂÖ¨ÂëäË®äÊÅØ..."></textarea>
                </div>
                <p class="text-xs text-gray-500">
                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    ÂÖ¨ÂëäÊúÉÈ°ØÁ§∫Âú® Portal ÂÖ¨ÈñãÁúãÊùøÔºåÊâÄÊúâ‰∫∫ÈÉΩËÉΩÁúãÂà∞
                </p>
                <div class="flex space-x-3">
                    <button @click="showBroadcastModal = false" class="flex-1 px-4 py-2 border border-gray-200 rounded-lg">ÂèñÊ∂à</button>
                    <button @click="publishBroadcast()"
                            :disabled="!broadcastForm.content.trim()"
                            :class="broadcastForm.content.trim() ? 'bg-amber-500 hover:bg-amber-600' : 'bg-gray-300 cursor-not-allowed'"
                            class="flex-1 px-4 py-2 text-white rounded-lg transition-colors">
                        Áôº‰Ωà
                    </button>
                </div>
                <button x-show="broadcast" @click="clearBroadcast()"
                        class="w-full px-4 py-2 text-red-600 border border-red-200 rounded-lg hover:bg-red-50">
                    Ê∏ÖÈô§ÁõÆÂâçÂÖ¨Âëä
                </button>
            </div>
        </div>
    </div>

    <!-- Single Person Move Modal (ÂñÆ‰∫∫ÂçÄÂüüÁßªÂãï) -->
    <div x-show="showPersonMoveModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showPersonMoveModal = false">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm">
            <div class="flex items-center mb-4">
                <div class="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold mr-3"
                     :class="{
                         'bg-green-500': personToMove?.triage_status === 'GREEN',
                         'bg-yellow-500': personToMove?.triage_status === 'YELLOW',
                         'bg-red-500': personToMove?.triage_status === 'RED',
                         'bg-gray-800': personToMove?.triage_status === 'BLACK',
                         'bg-gray-300': !personToMove?.triage_status
                     }">
                    <span x-text="personToMove?.display_name?.charAt(0) || '?'"></span>
                </div>
                <div>
                    <h3 class="font-semibold" x-text="personToMove?.display_name"></h3>
                    <p class="text-xs text-gray-500">
                        ÁõÆÂâç‰ΩçÁΩÆÔºö<span x-text="zones.find(z => z.id === personToMove?.current_location)?.name || 'Êú™ÊåáÂÆö'"></span>
                    </p>
                </div>
            </div>

            <p class="text-sm text-gray-600 mb-3">ÈÅ∏ÊìáÁõÆÊ®ôÂçÄÂüüÔºö</p>

            <!-- Target Zone Selection -->
            <div class="space-y-2 max-h-52 overflow-y-auto mb-4">
                <template x-for="zone in zones" :key="zone.id">
                    <label class="flex items-center p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition"
                           :class="batchMoveForm.target_zone_id === zone.id ? 'ring-2 ring-primary-500 bg-primary-50' : ''">
                        <input type="radio" name="person_target_zone" :value="zone.id" x-model="batchMoveForm.target_zone_id" class="mr-3">
                        <div class="flex-1">
                            <p class="font-medium text-sm" x-text="zone.name"></p>
                            <p class="text-xs text-gray-400">
                                <span x-text="zone.current_count || 0"></span>
                                <span x-show="zone.capacity > 0">/<span x-text="zone.capacity"></span></span>
                            </p>
                        </div>
                        <span class="text-xs px-2 py-0.5 rounded"
                              :class="{
                                  'bg-blue-100 text-blue-600': zone.zone_type === 'shelter',
                                  'bg-red-100 text-red-600': zone.zone_type === 'medical',
                                  'bg-green-100 text-green-600': zone.zone_type === 'service',
                                  'bg-gray-200 text-gray-600': zone.zone_type === 'restricted'
                              }"
                              x-text="zoneTypeLabels[zone.zone_type]"></span>
                    </label>
                </template>
            </div>

            <!-- Actions -->
            <div class="grid grid-cols-2 gap-2">
                <button @click="showPersonMoveModal = false" class="px-4 py-2 border border-gray-200 rounded-lg">ÂèñÊ∂à</button>
                <button @click="doPersonMove()" class="px-4 py-2 bg-primary-600 text-white rounded-lg font-medium">Á¢∫Ë™çÁßªÂãï</button>
            </div>
        </div>
    </div>

    <!-- Bundle Edit Modal (Êñ∞Â¢û/Á∑®ËºØÁµÑÂ•ó) -->
    <div x-show="showBundleEditModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showBundleEditModal = false">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md max-h-[90vh] overflow-hidden flex flex-col">
            <h3 class="text-lg font-semibold mb-4" x-text="editingBundle ? 'Á∑®ËºØÁµÑÂ•ó' : 'Êñ∞Â¢ûÁµÑÂ•ó'"></h3>

            <div class="space-y-3 overflow-y-auto flex-1">
                <!-- Basic Info -->
                <div>
                    <label class="block text-xs text-gray-600 mb-1">ÂêçÁ®± *</label>
                    <input type="text" x-model="bundleForm.name" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="‰æã: Èò≤ÁÅΩÂåÖ">
                </div>
                <div>
                    <label class="block text-xs text-gray-600 mb-1">Ë™™Êòé</label>
                    <input type="text" x-model="bundleForm.description" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="‰æã: Ê®ôÊ∫ñÁ∑äÊÄ•ÈÅøÈõ£ÂåÖ">
                </div>

                <!-- Icon Selector (heroicon grid) -->
                <div>
                    <label class="block text-xs text-gray-600 mb-2">ÈÅ∏ÊìáÂúñÁ§∫</label>
                    <div class="grid grid-cols-8 gap-1.5">
                        <template x-for="icon in bundleIconOptions" :key="icon.id">
                            <button type="button"
                                    @click="bundleForm.icon = icon.id"
                                    class="p-2 rounded-lg border-2 transition flex items-center justify-center"
                                    :class="bundleForm.icon === icon.id ? 'border-primary-600 bg-primary-100' : 'border-gray-200 hover:border-gray-300'"
                                    :title="icon.name">
                                <svg class="w-5 h-5" :class="bundleForm.icon === icon.id ? 'text-primary-600' : 'text-gray-500'" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path :d="icon.path" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/>
                                </svg>
                            </button>
                        </template>
                    </div>
                </div>

                <!-- Items List with move buttons and quantity edit -->
                <div class="border-t pt-3">
                    <p class="text-sm font-medium text-gray-700 mb-2">Áâ©Ë≥áÊ∏ÖÂñÆ (<span x-text="bundleForm.items.length"></span> È†Ö)</p>
                    <div class="space-y-1 max-h-40 overflow-y-auto mb-3">
                        <template x-for="(item, idx) in bundleForm.items" :key="idx">
                            <div class="flex items-center bg-gray-50 rounded-lg px-2 py-2 text-sm">
                                <!-- Move buttons -->
                                <div class="flex flex-col mr-2">
                                    <button @click="moveBundleItem(idx, -1)" :disabled="idx === 0"
                                            class="text-gray-400 hover:text-gray-600 disabled:opacity-30 disabled:cursor-not-allowed p-0.5">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                                        </svg>
                                    </button>
                                    <button @click="moveBundleItem(idx, 1)" :disabled="idx === bundleForm.items.length - 1"
                                            class="text-gray-400 hover:text-gray-600 disabled:opacity-30 disabled:cursor-not-allowed p-0.5">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                        </svg>
                                    </button>
                                </div>
                                <span class="flex-1 truncate">
                                    <span x-text="item.name"></span>
                                    <span x-show="item.specification" class="text-gray-400">(<span x-text="item.specification"></span>)</span>
                                </span>
                                <!-- Quantity editor -->
                                <div class="flex items-center mx-2">
                                    <button @click="item.quantity = Math.max(1, item.quantity - 1)"
                                            class="w-5 h-5 bg-gray-200 rounded text-xs flex items-center justify-center hover:bg-gray-300">-</button>
                                    <input type="number" x-model.number="item.quantity" min="1"
                                           class="w-10 text-center text-sm border-0 bg-transparent mx-1">
                                    <button @click="item.quantity++"
                                            class="w-5 h-5 bg-gray-200 rounded text-xs flex items-center justify-center hover:bg-gray-300">+</button>
                                </div>
                                <button @click="removeBundleItem(idx)" class="text-red-500 p-1">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                    </svg>
                                </button>
                            </div>
                        </template>
                        <p x-show="bundleForm.items.length === 0" class="text-xs text-gray-400 text-center py-2">Â∞öÁÑ°Áâ©Ë≥á</p>
                    </div>

                    <!-- Add Item Form -->
                    <div class="bg-primary-100 rounded-xl p-3">
                        <p class="text-xs font-medium text-primary-700 mb-2">Êñ∞Â¢ûÁâ©Ë≥á</p>
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <input type="text" x-model="newBundleItem.name" class="border border-gray-200 rounded-lg px-2 py-1.5 text-sm bg-white" placeholder="ÂêçÁ®± *">
                            <input type="text" x-model="newBundleItem.specification" class="border border-gray-200 rounded-lg px-2 py-1.5 text-sm bg-white" placeholder="Ë¶èÊ†º">
                        </div>
                        <div class="grid grid-cols-4 gap-2 mb-2">
                            <select x-model="newBundleItem.category" class="col-span-2 border border-gray-200 rounded-lg px-2 py-1.5 text-sm bg-white">
                                <option value="water">Ê∞¥</option>
                                <option value="food">È£üÁâ©</option>
                                <option value="medical">ÈÜ´ÁôÇ</option>
                                <option value="power">ÈõªÂäõ</option>
                                <option value="daily">Êó•Áî®ÂìÅ</option>
                                <option value="equipment">Ë®≠ÂÇô</option>
                                <option value="other">ÂÖ∂‰ªñ</option>
                            </select>
                            <input type="number" x-model.number="newBundleItem.quantity" class="border border-gray-200 rounded-lg px-2 py-1.5 text-sm text-center bg-white" min="1" placeholder="Êï∏Èáè">
                            <input type="text" x-model="newBundleItem.unit" class="border border-gray-200 rounded-lg px-2 py-1.5 text-sm bg-white" placeholder="ÂñÆ‰Ωç">
                        </div>
                        <button @click="addBundleItem()" class="w-full bg-primary-600 text-white rounded-lg py-1.5 text-sm font-medium">+ Âä†ÂÖ•Áâ©Ë≥á</button>
                    </div>
                </div>
            </div>

            <div class="flex space-x-3 mt-4 pt-3 border-t">
                <button @click="showBundleEditModal = false; showBundleManageModal = true" class="flex-1 px-4 py-2 border border-gray-200 rounded-lg">ÂèñÊ∂à</button>
                <button @click="saveBundle()" class="flex-1 px-4 py-2 bg-primary-600 text-white rounded-lg font-medium">ÂÑ≤Â≠ò</button>
            </div>
        </div>
    </div>

    <!-- Bundle Detail Modal (ÁµÑÂ•óË©≥ÊÉÖËàáÂÖ•Â∫´) -->
    <div x-show="showBundleDetailModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showBundleDetailModal = false">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm max-h-[85vh] flex flex-col">
            <div class="flex items-center mb-4 flex-shrink-0">
                <div class="w-12 h-12 mr-3 bg-primary-100 rounded-xl flex items-center justify-center">
                    <svg class="w-7 h-7 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path :d="getBundleIconPath(selectedBundle?.icon)" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/>
                    </svg>
                </div>
                <div>
                    <h3 class="text-lg font-semibold" x-text="selectedBundle?.name"></h3>
                    <p class="text-sm text-gray-500" x-text="selectedBundle?.description"></p>
                </div>
            </div>

            <!-- Bundle Items List with Checkboxes -->
            <div class="bg-gray-50 rounded-xl p-3 mb-4 overflow-y-auto min-h-0 flex-1">
                <div class="flex justify-between items-center mb-2">
                    <p class="text-xs text-gray-500 font-medium">ÂãæÈÅ∏Ë¶ÅÂÖ•Â∫´ÁöÑÁâ©Ë≥áÔºö</p>
                    <button @click="toggleAllBundleItems()" class="text-xs text-primary-600 hover:underline">
                        <span x-text="selectedBundleItems.length === (selectedBundle?.items?.length || 0) ? 'ÂèñÊ∂àÂÖ®ÈÅ∏' : 'ÂÖ®ÈÅ∏'"></span>
                    </button>
                </div>
                <div class="space-y-1">
                    <template x-for="(item, idx) in selectedBundle?.items || []" :key="idx">
                        <label class="flex items-center p-2 rounded-lg cursor-pointer hover:bg-gray-100 transition-colors"
                               :class="selectedBundleItems.includes(idx) ? 'bg-primary-50' : ''">
                            <input type="checkbox"
                                   :checked="selectedBundleItems.includes(idx)"
                                   @change="toggleBundleItem(idx)"
                                   class="w-4 h-4 text-primary-600 border-gray-300 rounded focus:ring-primary-500 mr-3">
                            <span class="flex-1 text-sm text-gray-700">
                                <span x-text="item.name"></span>
                                <span x-show="item.specification" class="text-gray-400">(<span x-text="item.specification"></span>)</span>
                            </span>
                            <span class="text-sm text-gray-500">
                                <span x-text="item.quantity"></span> <span x-text="item.unit || 'ÂÄã'"></span>
                            </span>
                        </label>
                    </template>
                </div>
            </div>

            <!-- Multiplier & Location -->
            <div class="space-y-3 mb-4 flex-shrink-0">
                <div>
                    <label class="block text-sm text-gray-600 mb-1">ÂÖ•Â∫´Â•óÊï∏</label>
                    <div class="flex items-center space-x-3">
                        <button @click="bundleIntakeForm.multiplier = Math.max(1, bundleIntakeForm.multiplier - 1)" class="w-10 h-10 bg-gray-100 rounded-lg text-lg font-medium">-</button>
                        <input type="number" x-model.number="bundleIntakeForm.multiplier" class="flex-1 border border-gray-200 rounded-lg px-3 py-2 text-center text-lg font-medium" min="1">
                        <button @click="bundleIntakeForm.multiplier++" class="w-10 h-10 bg-gray-100 rounded-lg text-lg font-medium">+</button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">Â≠òÊîæ‰ΩçÁΩÆ</label>
                    <input type="text" x-model="bundleIntakeForm.location" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="ÂÄâÂ∫´A (ÈÅ∏Â°´)">
                </div>
            </div>

            <!-- Summary -->
            <div class="bg-primary-100 rounded-lg p-3 mb-4 text-sm flex-shrink-0">
                <p class="text-primary-800">
                    Â∞áÂÖ•Â∫´ <span class="font-bold" x-text="bundleIntakeForm.multiplier"></span> Â•óÔºå
                    ÂÖ± <span class="font-bold" x-text="selectedBundleItems.length * bundleIntakeForm.multiplier"></span> È†ÖÁâ©Ë≥á
                    <span x-show="selectedBundleItems.length < (selectedBundle?.items?.length || 0)" class="text-primary-600">
                        (Â∑≤ÈÅ∏ <span x-text="selectedBundleItems.length"></span>/<span x-text="selectedBundle?.items?.length || 0"></span>)
                    </span>
                </p>
            </div>

            <div class="flex space-x-3 flex-shrink-0">
                <button @click="showBundleDetailModal = false" class="flex-1 px-4 py-2 border border-gray-200 rounded-lg">ËøîÂõû</button>
                <button @click="doBundleIntake()" class="flex-1 px-4 py-2 bg-primary-600 text-white rounded-lg font-medium"
                        :disabled="selectedBundleItems.length === 0"
                        :class="selectedBundleItems.length === 0 ? 'opacity-50 cursor-not-allowed' : ''">Á¢∫Ë™çÂÖ•Â∫´</button>
            </div>
        </div>
    </div>

    <!-- Distribute QR Code Modal (z-60 to show above other modals) -->
    <div x-show="showDistributeQRModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-[60] p-4" @click.self="showDistributeQRModal = false">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm text-center">
            <h3 class="text-lg font-semibold mb-2">ÁôºÊîæË®òÈåÑ QR Code</h3>
            <p class="text-sm text-gray-600 mb-4">
                <span x-text="lastDistributeResult?.item?.name"></span>
                <span x-show="lastDistributeResult?.item?.specification" class="text-gray-400">(<span x-text="lastDistributeResult?.item?.specification"></span>)</span>
                x <span x-text="lastDistributeResult?.quantity"></span>
                <span x-show="lastDistributeResult?.person_id" class="block text-xs text-gray-400 mt-1">
                    È†òÂèñ‰∫∫: <span x-text="lastDistributeResult?.person_id"></span>
                </span>
            </p>
            <div id="distribute-qrcode" class="flex justify-center mb-4"></div>
            <p class="text-sm text-gray-500 mb-4">ËÆìÈ†òÂèñ‰∫∫Áî® HIRS App ÊéÉÊèèÊ≠§ QR Code ÂêåÊ≠•Âà∞ÂÆ∂Â∫≠Áâ©Ë≥á</p>
            <button @click="showDistributeQRModal = false" class="w-full py-2 bg-primary-600 text-white rounded-lg font-medium">ÈóúÈñâ</button>
        </div>
    </div>

    <!-- Donation Inbound Modal (Êé•Êî∂ÊçêË¥à) -->
    <div x-show="showDonationModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showDonationModal = false">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md max-h-[85vh] overflow-hidden flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold flex items-center gap-2">
                    <svg class="w-6 h-6 text-pink-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                    </svg>
                    Êé•Êî∂ÊçêË¥à
                </h3>
                <button @click="showDonationModal = false" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <!-- Donor Info -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">ÊçêË¥àËÄÖÂßìÂêç (ÈÅ∏Â°´)</label>
                <input type="text" x-model="donationDonorName" placeholder="‰æãÔºöÁéãÂÖàÁîü" class="w-full border border-gray-200 rounded-lg px-3 py-2">
            </div>

            <!-- Item Selection -->
            <div class="flex-1 overflow-y-auto mb-4">
                <div class="flex justify-between items-center mb-2">
                    <label class="block text-sm font-medium text-gray-700">ÊçêË¥àÁâ©Ë≥á</label>
                    <button @click="addDonationItem()" class="text-sm text-primary-600 hover:underline">+ Êñ∞Â¢ûÂìÅÈ†Ö</button>
                </div>

                <div class="space-y-3">
                    <template x-for="(item, index) in donationItems" :key="index">
                        <div class="bg-gray-50 rounded-lg p-3">
                            <div class="flex items-center gap-2 mb-2">
                                <select x-model="item.item_id" @change="onDonationItemSelect(index)" class="flex-1 border border-gray-200 rounded px-2 py-1 text-sm">
                                    <option value="">-- ÈÅ∏ÊìáÁèæÊúâÁâ©ÂìÅÊàñÊñ∞Â¢û --</option>
                                    <template x-for="inv in inventory" :key="inv.id">
                                        <option :value="inv.id" x-text="inv.name + (inv.specification ? ' (' + inv.specification + ')' : '')"></option>
                                    </template>
                                    <option value="new">+ Êñ∞Â¢ûÁâ©ÂìÅ</option>
                                </select>
                                <button @click="removeDonationItem(index)" class="text-red-500 hover:text-red-700">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                    </svg>
                                </button>
                            </div>

                            <!-- New Item Fields -->
                            <div x-show="item.item_id === 'new'" class="space-y-2 mb-2">
                                <input type="text" x-model="item.name" placeholder="Áâ©ÂìÅÂêçÁ®±" class="w-full border border-gray-200 rounded px-2 py-1 text-sm">
                                <div class="flex gap-2">
                                    <select x-model="item.category" class="flex-1 border border-gray-200 rounded px-2 py-1 text-sm">
                                        <option value="water">Ê∞¥</option>
                                        <option value="food">È£üÁâ©</option>
                                        <option value="medical">ÈÜ´ÁôÇ</option>
                                        <option value="power">ÈõªÂäõ</option>
                                        <option value="daily">Êó•Áî®ÂìÅ</option>
                                        <option value="other">ÂÖ∂‰ªñ</option>
                                    </select>
                                    <input type="text" x-model="item.unit" placeholder="ÂñÆ‰Ωç" class="w-20 border border-gray-200 rounded px-2 py-1 text-sm">
                                </div>
                            </div>

                            <!-- Quantity -->
                            <div class="flex items-center gap-2">
                                <label class="text-sm text-gray-600">Êï∏Èáè:</label>
                                <input type="number" x-model.number="item.quantity" min="0.1" step="0.1" class="w-24 border border-gray-200 rounded px-2 py-1 text-sm">
                                <span class="text-sm text-gray-500" x-text="item.unit || 'ÂÄã'"></span>
                            </div>
                        </div>
                    </template>

                    <div x-show="donationItems.length === 0" class="text-center py-8 text-gray-400">
                        <p>ÈªûÊìä„ÄåÊñ∞Â¢ûÂìÅÈ†Ö„ÄçÈñãÂßãÁôªË®òÊçêË¥àÁâ©Ë≥á</p>
                    </div>
                </div>
            </div>

            <!-- Notes -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">ÂÇôË®ª</label>
                <input type="text" x-model="donationNotes" placeholder="ÈÅ∏Â°´" class="w-full border border-gray-200 rounded-lg px-3 py-2">
            </div>

            <!-- Actions -->
            <div class="flex gap-2">
                <button @click="showDonationModal = false" class="flex-1 px-4 py-2 border border-gray-200 rounded-lg">ÂèñÊ∂à</button>
                <button @click="submitDonation()" :disabled="donationItems.length === 0" class="flex-1 px-4 py-2 bg-pink-500 text-white rounded-lg disabled:opacity-50">
                    Á¢∫Ë™çÂÖ•Â∫´
                </button>
            </div>
        </div>
    </div>

    <!-- Donation Receipt QR Modal -->
    <div x-show="showDonationReceiptModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-[60] p-4" @click.self="showDonationReceiptModal = false">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm text-center">
            <h3 class="text-lg font-semibold mb-2 flex items-center justify-center gap-2">
                <svg class="w-6 h-6 text-pink-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                ÊçêË¥àÊî∂Êìö
            </h3>
            <p class="text-sm text-gray-600 mb-4">
                ÊÑüË¨ù <span class="font-semibold" x-text="lastDonationReceipt?.payload?.donor_name || 'ÊÑõÂøÉ‰∫∫Â£´'"></span> ÁöÑÊçêË¥àÔºÅ
            </p>
            <div id="donation-receipt-qrcode" class="flex justify-center mb-4"></div>
            <p class="text-sm text-gray-500 mb-2">ÊçêË¥àËÄÖÂèØÁî® HIRS App ÊéÉÊèèÊ≠§ QR Code</p>
            <p class="text-xs text-gray-400 mb-4">Êî∂ÊìöÁ∑®Ëôü: <span x-text="lastDonationReceipt?.payload?.receipt_id"></span></p>
            <button @click="showDonationReceiptModal = false" class="w-full py-2 bg-pink-500 text-white rounded-lg font-medium">ÈóúÈñâ</button>
        </div>
    </div>

    <!-- Inventory History Modal (ÂÖ•Â∫´/ÁôºÊîæÁ¥ÄÈåÑ) -->
    <div x-show="showInventoryHistoryModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showInventoryHistoryModal = false">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md max-h-[85vh] overflow-hidden flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Áâ©Ë≥áÈÄ≤Âá∫Á¥ÄÈåÑ</h3>
                <button @click="showInventoryHistoryModal = false" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <!-- Filter Tabs -->
            <div class="flex space-x-2 mb-3">
                <button @click="historyFilter = ''" :class="historyFilter === '' ? 'bg-primary-600 text-white' : 'bg-gray-100 text-gray-600'" class="px-3 py-1 rounded-full text-xs">ÂÖ®ÈÉ®</button>
                <button @click="historyFilter = 'RESOURCE_IN'" :class="historyFilter === 'RESOURCE_IN' ? 'bg-primary-600 text-white' : 'bg-gray-100 text-gray-600'" class="px-3 py-1 rounded-full text-xs">ÂÖ•Â∫´</button>
                <button @click="historyFilter = 'RESOURCE_OUT'" :class="historyFilter === 'RESOURCE_OUT' ? 'bg-primary-600 text-white' : 'bg-gray-100 text-gray-600'" class="px-3 py-1 rounded-full text-xs">ÁôºÊîæ</button>
            </div>

            <!-- History List -->
            <div class="space-y-2 overflow-y-auto flex-1">
                <template x-for="event in filteredHistory" :key="event.id">
                    <div class="bg-gray-50 rounded-lg p-3 text-sm">
                        <div class="flex items-center justify-between mb-1">
                            <span class="font-medium" x-text="event.item_name || 'Êú™Áü•Áâ©Ë≥á'"></span>
                            <div class="flex items-center gap-2">
                                <!-- QR Code button for RESOURCE_OUT events -->
                                <button x-show="event.event_type === 'RESOURCE_OUT'"
                                        @click="regenerateDistributeQR(event)"
                                        class="p-1 text-primary-600 hover:bg-primary-50 rounded"
                                        title="Áî¢Áîü QR Code">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"/>
                                    </svg>
                                </button>
                                <span class="text-xs px-2 py-0.5 rounded"
                                      :class="event.event_type === 'RESOURCE_IN' ? 'bg-green-100 text-green-700' : 'bg-amber-100 text-amber-700'"
                                      x-text="event.event_type === 'RESOURCE_IN' ? 'ÂÖ•Â∫´' : 'ÁôºÊîæ'"></span>
                            </div>
                        </div>
                        <div class="flex items-center justify-between text-gray-500">
                            <span>
                                <span :class="event.quantity_change > 0 ? 'text-green-600' : 'text-amber-600'" x-text="(event.quantity_change > 0 ? '+' : '') + event.quantity_change"></span>
                                <span x-show="event.person_name" class="ml-2">‚Üí <span x-text="event.person_name"></span></span>
                            </span>
                            <span class="text-xs" x-text="new Date(event.timestamp).toLocaleString('zh-TW', {month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit'})"></span>
                        </div>
                        <p x-show="event.notes" class="text-xs text-gray-400 mt-1" x-text="event.notes"></p>
                    </div>
                </template>
                <p x-show="inventoryHistory.length === 0" class="text-center text-gray-400 py-8">Â∞öÁÑ°Á¥ÄÈåÑ</p>
                <p x-show="inventoryHistory.length > 0 && filteredHistory.length === 0" class="text-center text-gray-400 py-8">ÁÑ°Á¨¶ÂêàÊ¢ù‰ª∂ÁöÑÁ¥ÄÈåÑ</p>
            </div>

            <!-- Load More -->
            <button x-show="inventoryHistory.length >= 50" @click="loadMoreHistory()" class="mt-3 w-full py-2 text-sm text-primary-600 hover:underline">ËºâÂÖ•Êõ¥Â§ö</button>
        </div>
    </div>

    <!-- Equipment Template Select Modal (Ë®≠ÂÇôÁØÑÊú¨ÈÅ∏Êìá) -->
    <div x-show="showEquipmentTemplateModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showEquipmentTemplateModal = false">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm max-h-[80vh] flex flex-col">
            <!-- Ê≠•È©ü‰∏ÄÔºöÈÅ∏ÊìáÁØÑÊú¨ -->
            <template x-if="!selectedEquipmentTemplate">
                <div class="flex flex-col min-h-0 flex-1">
                    <div class="flex justify-between items-center mb-4 flex-shrink-0">
                        <h3 class="text-lg font-semibold">Ë®≠ÂÇôÁØÑÊú¨</h3>
                        <button x-show="currentUser && currentUser.role === 'admin'" @click="showEquipmentTemplateModal = false; openEquipmentTemplateManage()" class="text-xs text-primary-600 hover:underline">ÁÆ°ÁêÜÁØÑÊú¨</button>
                    </div>
                    <div class="space-y-2 overflow-y-auto min-h-0 flex-1">
                        <template x-for="template in equipmentTemplates" :key="template.id">
                            <button @click="selectEquipmentTemplate(template)" class="w-full bg-gray-50 hover:bg-primary-50 rounded-xl p-4 text-left transition-colors border border-gray-100 hover:border-primary-200">
                                <div class="flex items-center">
                                    <div class="w-10 h-10 mr-3 bg-primary-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                        <svg class="w-6 h-6 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path :d="getEquipmentTemplateIconPath(template.icon)" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/>
                                        </svg>
                                    </div>
                                    <div class="flex-1">
                                        <p class="font-medium text-gray-800" x-text="template.name"></p>
                                        <p class="text-sm text-gray-500" x-text="template.description"></p>
                                        <p class="text-xs text-gray-400 mt-1">
                                            ÂåÖÂê´ <span x-text="template.items?.length || 0"></span> È†ÖË®≠ÂÇô
                                        </p>
                                    </div>
                                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                    </svg>
                                </div>
                            </button>
                        </template>
                        <p x-show="equipmentTemplates.length === 0" class="text-center text-gray-400 py-8">ÁÑ°ÁØÑÊú¨Ë≥áÊñô<br><span class="text-xs">Ë´ãÂÖàÂª∫Á´ãÁØÑÊú¨</span></p>
                    </div>
                    <button @click="showEquipmentTemplateModal = false" class="w-full mt-4 px-4 py-2 border border-gray-200 rounded-lg flex-shrink-0">ÂèñÊ∂à</button>
                </div>
            </template>
            <!-- Ê≠•È©ü‰∫åÔºöÂãæÈÅ∏Ë¶ÅÂª∫Á´ãÁöÑË®≠ÂÇô -->
            <template x-if="selectedEquipmentTemplate">
                <div class="flex flex-col min-h-0 flex-1">
                    <div class="flex items-center mb-4 flex-shrink-0">
                        <button @click="selectedEquipmentTemplate = null; selectedTemplateItems = []" class="p-1 mr-2 hover:bg-gray-100 rounded">
                            <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                            </svg>
                        </button>
                        <div class="flex-1">
                            <h3 class="text-lg font-semibold" x-text="selectedEquipmentTemplate.name"></h3>
                            <p class="text-xs text-gray-500">ÂãæÈÅ∏Ë¶ÅÂª∫Á´ãÁöÑË®≠ÂÇô</p>
                        </div>
                    </div>
                    <!-- ÂÖ®ÈÅ∏/ÂèñÊ∂àÂÖ®ÈÅ∏ -->
                    <div class="flex justify-between items-center mb-2 px-1 flex-shrink-0">
                        <span class="text-sm text-gray-600">
                            Â∑≤ÈÅ∏ <span class="font-medium text-primary-600" x-text="selectedTemplateItems.length"></span> / <span x-text="selectedEquipmentTemplate.items?.length || 0"></span> È†Ö
                        </span>
                        <button @click="toggleAllTemplateItems()" class="text-xs text-primary-600 hover:underline">
                            <span x-text="selectedTemplateItems.length === (selectedEquipmentTemplate.items?.length || 0) ? 'ÂèñÊ∂àÂÖ®ÈÅ∏' : 'ÂÖ®ÈÅ∏'"></span>
                        </button>
                    </div>
                    <!-- Ë®≠ÂÇôÊ∏ÖÂñÆ -->
                    <div class="space-y-2 overflow-y-auto min-h-0 flex-1">
                        <template x-for="(item, idx) in selectedEquipmentTemplate.items" :key="idx">
                            <label class="flex items-center p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-primary-50 transition-colors"
                                   :class="selectedTemplateItems.includes(idx) ? 'bg-primary-50 border border-primary-200' : 'border border-transparent'">
                                <input type="checkbox" class="w-5 h-5 text-primary-600 rounded border-gray-300 focus:ring-primary-500"
                                       :checked="selectedTemplateItems.includes(idx)"
                                       @change="toggleTemplateItem(idx)">
                                <div class="ml-3 flex-1">
                                    <p class="font-medium text-gray-800 text-sm" x-text="item.name"></p>
                                    <p class="text-xs text-gray-500">
                                        <span x-text="item.specification || '-'"></span>
                                        ¬∑ <span x-text="item.quantity"></span> <span x-text="item.unit"></span>
                                        ¬∑ ÊØè <span x-text="item.check_interval_days"></span> Â§©Ê™¢Êü•
                                    </p>
                                </div>
                            </label>
                        </template>
                    </div>
                    <!-- ÊåâÈàï -->
                    <div class="flex space-x-2 mt-4 flex-shrink-0">
                        <button @click="selectedEquipmentTemplate = null; selectedTemplateItems = []" class="flex-1 px-4 py-2 border border-gray-200 rounded-lg">ËøîÂõû</button>
                        <button @click="applySelectedTemplateItems()" :disabled="selectedTemplateItems.length === 0"
                                class="flex-1 px-4 py-2 bg-primary-600 text-white rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed">
                            Âª∫Á´ã (<span x-text="selectedTemplateItems.length"></span> È†Ö)
                        </button>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <!-- Equipment Template Manage Modal (Ë®≠ÂÇôÁØÑÊú¨ÁÆ°ÁêÜ - Admin) -->
    <div x-show="showEquipmentTemplateManageModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showEquipmentTemplateManageModal = false">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h3 class="text-lg font-semibold">ÁÆ°ÁêÜË®≠ÂÇôÁØÑÊú¨</h3>
                <button @click="startCreateEquipmentTemplate()" class="bg-primary-600 text-white px-3 py-1 rounded-lg text-sm">Êñ∞Â¢ûÁØÑÊú¨</button>
            </div>
            <div class="space-y-2 overflow-y-auto min-h-0 flex-1">
                <template x-for="template in equipmentTemplates" :key="template.id">
                    <div class="bg-gray-50 rounded-xl p-4 border border-gray-100">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center flex-1 min-w-0">
                                <div class="w-10 h-10 mr-3 bg-primary-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                    <svg class="w-6 h-6 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path :d="getEquipmentTemplateIconPath(template.icon)" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/>
                                    </svg>
                                </div>
                                <div class="min-w-0">
                                    <p class="font-medium text-gray-800 truncate" x-text="template.name"></p>
                                    <p class="text-xs text-gray-400"><span x-text="template.items?.length || 0"></span> È†ÖË®≠ÂÇô</p>
                                </div>
                            </div>
                            <div class="flex space-x-1 ml-2">
                                <button @click="startEditEquipmentTemplate(template)" class="text-blue-600 p-1.5 bg-blue-50 rounded-lg" title="Á∑®ËºØ">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                    </svg>
                                </button>
                                <button @click="confirmDeleteEquipmentTemplate(template)" class="text-red-600 p-1.5 bg-red-50 rounded-lg" title="Âà™Èô§">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </template>
                <p x-show="equipmentTemplates.length === 0" class="text-center text-gray-400 py-8">Â∞öÁÑ°ÁØÑÊú¨ÔºåÈªûÊìä‰∏äÊñπÊñ∞Â¢û</p>
            </div>
            <button @click="showEquipmentTemplateManageModal = false" class="w-full mt-4 px-4 py-2 border border-gray-200 rounded-lg flex-shrink-0">ÈóúÈñâ</button>
        </div>
    </div>

    <!-- Equipment Template Edit Modal (Êñ∞Â¢û/Á∑®ËºØË®≠ÂÇôÁØÑÊú¨) -->
    <div x-show="showEquipmentTemplateEditModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showEquipmentTemplateEditModal = false">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md max-h-[90vh] flex flex-col">
            <h3 class="text-lg font-semibold mb-4 flex-shrink-0" x-text="editingEquipmentTemplate ? 'Á∑®ËºØË®≠ÂÇôÁØÑÊú¨' : 'Êñ∞Â¢ûË®≠ÂÇôÁØÑÊú¨'"></h3>

            <div class="space-y-3 overflow-y-auto min-h-0 flex-1">
                <!-- Basic Info -->
                <div>
                    <label class="block text-xs text-gray-600 mb-1">ÂêçÁ®± *</label>
                    <input type="text" x-model="equipmentTemplateForm.name" class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm" placeholder="‰æãÔºöÁôºÈõªÊ©üÁµÑ">
                </div>
                <div>
                    <label class="block text-xs text-gray-600 mb-1">Ë™™Êòé</label>
                    <input type="text" x-model="equipmentTemplateForm.description" class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm" placeholder="‰æãÔºöÁ∑äÊÄ•‰æõÈõªË®≠ÂÇô">
                </div>

                <!-- Icon Selector -->
                <div>
                    <label class="block text-xs text-gray-600 mb-2">ÈÅ∏ÊìáÂúñÁ§∫</label>
                    <div class="grid grid-cols-8 gap-1.5">
                        <template x-for="icon in equipmentTemplateIconOptions" :key="icon.id">
                            <button type="button"
                                    @click="equipmentTemplateForm.icon = icon.id"
                                    class="p-2 rounded-lg border-2 transition flex items-center justify-center"
                                    :class="equipmentTemplateForm.icon === icon.id ? 'border-primary-600 bg-primary-100' : 'border-gray-200 hover:border-gray-300'"
                                    :title="icon.name">
                                <svg class="w-5 h-5" :class="equipmentTemplateForm.icon === icon.id ? 'text-primary-600' : 'text-gray-500'" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path :d="icon.path" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/>
                                </svg>
                            </button>
                        </template>
                    </div>
                </div>

                <!-- Items List -->
                <div class="border-t pt-3">
                    <p class="text-sm font-medium text-gray-700 mb-2">Ë®≠ÂÇôÊ∏ÖÂñÆ (<span x-text="equipmentTemplateForm.items.length"></span> È†Ö)</p>
                    <div class="space-y-1 max-h-40 overflow-y-auto mb-3">
                        <template x-for="(item, idx) in equipmentTemplateForm.items" :key="idx">
                            <div class="flex items-center bg-gray-50 rounded-lg px-2 py-2 text-sm">
                                <!-- Move buttons -->
                                <div class="flex flex-col mr-2">
                                    <button @click="moveEquipmentTemplateItem(idx, -1)" :disabled="idx === 0"
                                            class="text-gray-400 hover:text-gray-600 disabled:opacity-30 disabled:cursor-not-allowed p-0.5">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                                        </svg>
                                    </button>
                                    <button @click="moveEquipmentTemplateItem(idx, 1)" :disabled="idx === equipmentTemplateForm.items.length - 1"
                                            class="text-gray-400 hover:text-gray-600 disabled:opacity-30 disabled:cursor-not-allowed p-0.5">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                        </svg>
                                    </button>
                                </div>
                                <span class="flex-1 truncate">
                                    <span x-text="item.name"></span>
                                    <span x-show="item.specification" class="text-gray-400">(<span x-text="item.specification"></span>)</span>
                                </span>
                                <!-- Quantity editor -->
                                <div class="flex items-center mx-2">
                                    <button @click="item.quantity = Math.max(1, item.quantity - 1)"
                                            class="w-5 h-5 bg-gray-200 rounded text-xs flex items-center justify-center hover:bg-gray-300">-</button>
                                    <input type="number" x-model.number="item.quantity" min="1"
                                           class="w-10 text-center text-sm border-0 bg-transparent mx-1">
                                    <button @click="item.quantity++"
                                            class="w-5 h-5 bg-gray-200 rounded text-xs flex items-center justify-center hover:bg-gray-300">+</button>
                                </div>
                                <button @click="removeEquipmentTemplateItem(idx)" class="text-red-500 p-1">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                    </svg>
                                </button>
                            </div>
                        </template>
                        <p x-show="equipmentTemplateForm.items.length === 0" class="text-xs text-gray-400 text-center py-2">Â∞öÁÑ°Ë®≠ÂÇô</p>
                    </div>

                    <!-- Add Item Form -->
                    <div class="bg-primary-100 rounded-xl p-3">
                        <p class="text-xs font-medium text-primary-700 mb-2">Êñ∞Â¢ûË®≠ÂÇô</p>
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <input type="text" x-model="newEquipmentTemplateItem.name" class="border border-gray-200 rounded-lg px-2 py-1.5 text-sm bg-white" placeholder="ÂêçÁ®± *">
                            <input type="text" x-model="newEquipmentTemplateItem.specification" class="border border-gray-200 rounded-lg px-2 py-1.5 text-sm bg-white" placeholder="Ë¶èÊ†º">
                        </div>
                        <div class="grid grid-cols-3 gap-2 mb-2">
                            <input type="number" x-model.number="newEquipmentTemplateItem.quantity" class="border border-gray-200 rounded-lg px-2 py-1.5 text-sm text-center bg-white" min="1" placeholder="Êï∏Èáè">
                            <input type="text" x-model="newEquipmentTemplateItem.unit" class="border border-gray-200 rounded-lg px-2 py-1.5 text-sm bg-white" placeholder="ÂñÆ‰Ωç">
                            <input type="number" x-model.number="newEquipmentTemplateItem.check_interval_days" class="border border-gray-200 rounded-lg px-2 py-1.5 text-sm text-center bg-white" min="1" placeholder="Ê™¢Êü•ÈÄ±Êúü">
                        </div>
                        <button @click="addEquipmentTemplateItem()" class="w-full bg-primary-600 text-white rounded-lg py-1.5 text-sm font-medium">+ Âä†ÂÖ•Ë®≠ÂÇô</button>
                    </div>
                </div>
            </div>

            <div class="flex space-x-3 mt-4 pt-3 border-t flex-shrink-0">
                <button @click="showEquipmentTemplateEditModal = false; showEquipmentTemplateManageModal = true" class="flex-1 px-4 py-2 border border-gray-200 rounded-lg">ÂèñÊ∂à</button>
                <button @click="saveEquipmentTemplate()" class="flex-1 px-4 py-2 bg-primary-600 text-white rounded-lg font-medium">ÂÑ≤Â≠ò</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div x-show="toast.show" x-cloak
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0 translate-y-2"
         x-transition:enter-end="opacity-100 translate-y-0"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100 translate-y-0"
         x-transition:leave-end="opacity-0 translate-y-2"
         class="fixed bottom-28 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded-lg shadow-lg z-50"
         :class="toast.type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'"
         x-text="toast.message">
    </div>

    <script>
        function cirsApp() {
            return {
                currentTab: 'people',
                currentUser: null,
                token: null,

                // Data
                stats: {},
                broadcast: null,
                inventory: [],
                equipment: [],
                equipmentPending: [],
                expiringItems: [],
                people: [],
                messages: [],
                similarItems: [],
                bundles: [],
                inventoryHistory: [],
                equipmentTemplates: [],

                // Filters
                historyFilter: '',
                inventorySearch: '',
                inventoryCategory: '',
                peopleSearch: '',
                triageFilter: '',
                messageCategory: '',

                // Zone data
                zones: [],
                zoneTypeFilter: '',
                zoneFilter: '',
                showZoneOverview: false,
                selectedPeople: [],
                zoneTypeLabels: { shelter: 'Êî∂ÂÆπ', medical: 'ÈÜ´ÁôÇ', service: 'ÊúçÂãô', restricted: 'ÁÆ°Âà∂' },

                // Modals
                showLoginModal: false,
                showTriageModal: false,
                showIntakeModal: false,
                showDistributeModal: false,
                showDistributeSelectModal: false,
                showAddInventoryModal: false,
                showEquipmentCheckModal: false,
                showAddEquipmentModal: false,
                showEditEquipmentModal: false,
                showDeleteConfirmModal: false,
                showAddMessage: false,
                showReplyModal: false,
                showDistributeQRModal: false,
                showDonationModal: false,
                showDonationReceiptModal: false,
                donationItems: [],
                donationDonorName: '',
                donationNotes: '',
                lastDonationReceipt: null,
                showBundleModal: false,
                showBundleDetailModal: false,
                showBundleManageModal: false,
                showBundleEditModal: false,
                showZoneManageModal: false,
                showBatchMoveModal: false,
                showBatchCheckoutModal: false,
                showPersonMoveModal: false,
                showInventoryHistoryModal: false,
                showEquipmentTemplateModal: false,
                showEquipmentTemplateManageModal: false,
                showEquipmentTemplateEditModal: false,
                showSystemMenu: false,
                showBackupModal: false,
                showSettingsModal: false,
                showBroadcastModal: false,
                editingEquipmentTemplate: null,
                selectedEquipmentTemplate: null,
                selectedTemplateItems: [],
                selectedBundleItems: [],
                personToMove: null,
                lastDistributeResult: null,
                deleteTarget: null,
                deleteType: null,
                replyTarget: null,
                selectedBundle: null,
                editingBundle: null,

                // Forms
                loginForm: { person_id: '', pin: '' },
                loginError: '',
                triageTarget: null,
                newPerson: { display_name: '', national_id: '', phone: '', current_location: '', triage_status: 'GREEN', photo_data: '', physical_desc: '' },
                intakeForm: { item_id: '', quantity: 1, notes: '' },
                distributeItem: null,
                distributeForm: { person_id: '', quantity: 1, notes: '' },
                newInventory: { name: '', specification: '', category: 'water', quantity: 0, unit: '', location: '', expiry_date: '' },
                checkTarget: null,
                equipmentCheckForm: { status: 'OK', notes: '' },
                newEquipment: { name: '', specification: '', quantity: 1, unit: 'Âè∞', location: '', check_interval_days: 1 },
                editEquipment: { id: '', name: '', specification: '', quantity: 1, unit: '', location: '', check_interval_days: 1 },
                newMessage: { category: 'general', content: '', author_name: '' },
                replyForm: { content: '', author_name: '' },
                bundleIntakeForm: { bundle_id: '', multiplier: 1, location: '' },
                bundleForm: { name: '', description: '', icon: 'backpack', items: [] },
                newBundleItem: { name: '', specification: '', category: 'other', quantity: 1, unit: 'ÂÄã' },
                equipmentTemplateForm: { name: '', description: '', icon: 'cog', items: [] },
                newEquipmentTemplateItem: { name: '', specification: '', quantity: 1, unit: 'Âè∞', check_interval_days: 7 },
                batchMoveForm: { target_zone_id: '', notes: '' },
                batchCheckoutForm: { reason: 'DISCHARGE', destination: '', notes: '' },
                broadcastForm: { content: '' },
                newZone: { id: '', name: '', zone_type: 'shelter', capacity: 0, description: '' },

                // System / Backup
                siteName: 'Á§æÂçÄÈÅøÈõ£‰∏≠ÂøÉ',
                backupStatus: {},
                backupLoading: false,
                backupForm: { target: 'local', encrypt: true, password: '', notes: '' },
                settingsForm: { site_name: '' },

                // Search filters
                intakeSearch: '',
                distributeSearch: '',

                // Bundle icon options (heroicons)
                bundleIconOptions: [
                    { id: 'backpack', name: 'ËÉåÂåÖ', path: 'M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4' },
                    { id: 'home', name: 'Â±ÖÂÆ∂', path: 'M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6' },
                    { id: 'heart', name: 'ÈÜ´ÁôÇ', path: 'M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z' },
                    { id: 'truck', name: 'ËªäÁî®', path: 'M8 7h12m0 0l-4-4m4 4l-4 4m-8 6H4m0 0l4 4m-4-4l4-4' },
                    { id: 'baby', name: 'Â¨∞ÂÖí', path: 'M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z' },
                    { id: 'elderly', name: 'Èï∑ËÄÖ', path: 'M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z' },
                    { id: 'office', name: 'Ëæ¶ÂÖ¨', path: 'M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z' },
                    { id: 'camping', name: 'Èú≤Ááü', path: 'M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z' },
                    { id: 'shield', name: 'Èò≤Ë≠∑', path: 'M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z' },
                    { id: 'fire', name: 'Ê∂àÈò≤', path: 'M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z' },
                    { id: 'water', name: 'Ê∞¥Ë≥áÊ∫ê', path: 'M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z' },
                    { id: 'food', name: 'Á≥ßÈ£ü', path: 'M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4' },
                    { id: 'sun', name: 'Êà∂Â§ñ', path: 'M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z' },
                    { id: 'bolt', name: 'ÈõªÂäõ', path: 'M13 10V3L4 14h7v7l9-11h-7z' },
                    { id: 'gift', name: 'Á¶ÆÁâ©', path: 'M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7' },
                    { id: 'cube', name: 'Áâ©Ë≥á', path: 'M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4' }
                ],

                // Equipment template icon options (heroicons)
                equipmentTemplateIconOptions: [
                    { id: 'cog', name: 'ÈΩíËº™', path: 'M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z M15 12a3 3 0 11-6 0 3 3 0 016 0z' },
                    { id: 'bolt', name: 'ÈõªÂäõ', path: 'M13 10V3L4 14h7v7l9-11h-7z' },
                    { id: 'signal', name: 'ÈÄöË®ä', path: 'M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0' },
                    { id: 'truck', name: 'ËªäËºõ', path: 'M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0' },
                    { id: 'beaker', name: 'Ê™¢Ê∏¨', path: 'M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z' },
                    { id: 'wrench', name: 'Â∑•ÂÖ∑', path: 'M14.7 6.3a1 1 0 000 1.4l1.6 1.6a1 1 0 001.4 0l3.77-3.77a6 6 0 01-7.94 7.94l-6.91 6.91a2.12 2.12 0 01-3-3l6.91-6.91a6 6 0 017.94-7.94l-3.76 3.76z' },
                    { id: 'fire', name: 'Ê∂àÈò≤', path: 'M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z' },
                    { id: 'light', name: 'ÁÖßÊòé', path: 'M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z' },
                    { id: 'speaker', name: 'Èü≥Èüø', path: 'M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z' },
                    { id: 'computer', name: 'ÈõªËÖ¶', path: 'M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z' },
                    { id: 'camera', name: 'ÊîùÂΩ±', path: 'M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z M15 13a3 3 0 11-6 0 3 3 0 016 0z' },
                    { id: 'medical', name: 'ÈÜ´ÁôÇ', path: 'M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z' },
                    { id: 'shield', name: 'Èò≤Ë≠∑', path: 'M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z' },
                    { id: 'water', name: 'Ê∞¥Ê∫ê', path: 'M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z' },
                    { id: 'home', name: 'Ë®≠ÊñΩ', path: 'M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6' },
                    { id: 'cube', name: 'ÂÖ∂‰ªñ', path: 'M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4' }
                ],

                // Toast
                toast: { show: false, message: '', type: 'success' },

                async init() {
                    // Check URL hash for tab
                    const hash = window.location.hash.replace('#', '');
                    if (['people', 'inventory', 'equipment', 'messages'].includes(hash)) {
                        this.currentTab = hash;
                    }

                    // Check for saved token
                    const savedToken = localStorage.getItem('cirs_token');
                    if (savedToken) {
                        this.token = savedToken;
                        await this.verifyToken();
                    }

                    await this.loadStats();
                    await this.loadBroadcast();
                    await this.loadSiteConfig();
                    if (this.isAdmin) {
                        await this.loadBackupStatus();
                    }
                    this.loadTabData();

                    // Polling every 30 seconds
                    setInterval(() => {
                        this.loadStats();
                        this.loadBroadcast();
                    }, 30000);
                },

                switchTab(tab) {
                    this.currentTab = tab;
                    window.location.hash = tab;
                    this.loadTabData();
                },

                loadTabData() {
                    switch(this.currentTab) {
                        case 'people': this.loadPeople(); this.loadZones(); break;
                        case 'inventory': this.loadInventory(); this.loadExpiringItems(); this.loadBundles(); break;
                        case 'equipment': this.loadEquipment(); this.loadEquipmentPending(); this.loadEquipmentTemplates(); break;
                        case 'messages': this.loadMessages(); break;
                    }
                },

                get pageTitle() {
                    const titles = { 'people': '‰∫∫Âì°ÁÆ°ÁêÜ', 'inventory': 'Áâ©Ë≥áÁÆ°ÁêÜ', 'equipment': 'Ë®≠ÂÇôÊ™¢Êü•', 'messages': '‰∫íÂä©ÁïôË®ÄÊùø' };
                    return titles[this.currentTab] || 'CIRS';
                },

                get filteredInventory() {
                    return this.inventory.filter(item => {
                        if (item.category === 'equipment') return false;
                        const matchSearch = !this.inventorySearch || item.name.toLowerCase().includes(this.inventorySearch.toLowerCase());
                        const matchCategory = !this.inventoryCategory || item.category === this.inventoryCategory;
                        return matchSearch && matchCategory;
                    });
                },

                get filteredHistory() {
                    if (!this.historyFilter) return this.inventoryHistory;
                    return this.inventoryHistory.filter(e => e.event_type === this.historyFilter);
                },

                get filteredPeople() {
                    return this.people.filter(p => {
                        if (p.role !== 'public') return false;
                        const matchSearch = !this.peopleSearch || p.display_name.toLowerCase().includes(this.peopleSearch.toLowerCase()) || p.id.includes(this.peopleSearch);
                        const matchTriage = !this.triageFilter || p.triage_status === this.triageFilter;
                        const matchZone = !this.zoneFilter || p.current_location === this.zoneFilter;
                        return matchSearch && matchTriage && matchZone;
                    });
                },

                get filteredZones() {
                    return this.zones.filter(z => !this.zoneTypeFilter || z.zone_type === this.zoneTypeFilter);
                },

                get filteredMessages() {
                    const filtered = this.messages.filter(m => !this.messageCategory || m.category === this.messageCategory);
                    // ÁΩÆÈ†ÇÁïôË®ÄÊéíÂú®ÊúÄÂâçÈù¢
                    return filtered.sort((a, b) => {
                        if (a.is_pinned && !b.is_pinned) return -1;
                        if (!a.is_pinned && b.is_pinned) return 1;
                        return 0; // ‰øùÊåÅÂéüÊú¨ÁöÑÊôÇÈñìÊéíÂ∫è
                    });
                },

                async apiCall(url, options = {}) {
                    if (this.token) {
                        options.headers = { ...options.headers, 'Authorization': `Bearer ${this.token}` };
                    }
                    if (options.body && typeof options.body === 'object') {
                        options.headers = { ...options.headers, 'Content-Type': 'application/json' };
                        options.body = JSON.stringify(options.body);
                    }
                    return await fetch(url, options);
                },

                async verifyToken() {
                    try {
                        const res = await this.apiCall('/api/auth/verify', { method: 'POST' });
                        if (res.ok) {
                            const data = await res.json();
                            if (data.valid) this.currentUser = data.person;
                            else this.logout();
                        }
                    } catch (e) { console.error('Token verify failed:', e); }
                },

                async doLogin() {
                    this.loginError = '';
                    try {
                        const res = await fetch('/api/auth/login', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.loginForm)
                        });
                        const data = await res.json();
                        if (res.ok) {
                            this.token = data.token;
                            this.currentUser = data.person;
                            localStorage.setItem('cirs_token', data.token);
                            this.showLoginModal = false;
                            this.showToast('ÁôªÂÖ•ÊàêÂäü', 'success');
                        } else {
                            this.loginError = data.detail || 'ÁôªÂÖ•Â§±Êïó';
                        }
                    } catch (e) { this.loginError = 'Á∂≤Ë∑ØÈåØË™§'; }
                },

                logout() {
                    this.token = null;
                    this.currentUser = null;
                    localStorage.removeItem('cirs_token');
                },

                async loadStats() {
                    try {
                        const res = await fetch('/api/stats');
                        if (res.ok) this.stats = await res.json();
                    } catch (e) {}
                },

                async loadBroadcast() {
                    try {
                        const res = await fetch('/api/messages/broadcast');
                        if (res.ok) {
                            const data = await res.json();
                            this.broadcast = data.broadcast?.content || null;
                        }
                    } catch (e) {}
                },

                async loadInventory() {
                    try {
                        const res = await fetch('/api/inventory');
                        if (res.ok) {
                            const data = await res.json();
                            this.inventory = data.items || [];
                        }
                    } catch (e) {}
                },

                async loadExpiringItems() {
                    try {
                        const res = await fetch('/api/inventory/expiring?days=7');
                        if (res.ok) {
                            const data = await res.json();
                            this.expiringItems = data.items || [];
                        }
                    } catch (e) {}
                },

                async loadEquipment() {
                    try {
                        const res = await fetch('/api/inventory?category=equipment');
                        if (res.ok) {
                            const data = await res.json();
                            this.equipment = data.items || [];
                        }
                    } catch (e) {}
                },

                async loadEquipmentPending() {
                    try {
                        const res = await fetch('/api/inventory/equipment-pending');
                        if (res.ok) {
                            const data = await res.json();
                            this.equipmentPending = data.items || [];
                        }
                    } catch (e) {}
                },

                // Equipment Template methods
                getDefaultEquipmentTemplates() {
                    return [
                        {
                            id: 'power_station',
                            name: 'ÈõªÂäõË®≠ÂÇôÁµÑ',
                            description: 'ÁôºÈõªÊ©ü„ÄÅÂª∂Èï∑Á∑ö„ÄÅÁÖßÊòéÁ≠â‰æõÈõªË®≠ÂÇô',
                            icon: 'bolt',
                            items: [
                                { name: 'Ê±ΩÊ≤πÁôºÈõªÊ©ü', specification: '3500W', quantity: 2, unit: 'Âè∞', check_interval_days: 30 },
                                { name: 'UPS‰∏çÊñ∑ÈõªÁ≥ªÁµ±', specification: '1000VA', quantity: 2, unit: 'Âè∞', check_interval_days: 90 },
                                { name: 'LEDÂ∑•‰ΩúÁáà', specification: '50W', quantity: 6, unit: 'ÁµÑ', check_interval_days: 30 },
                                { name: 'Â∑•Ê•≠Âª∂Èï∑Á∑ö', specification: '10Á±≥', quantity: 4, unit: 'Ê¢ù', check_interval_days: 30 },
                                { name: 'ÊâãÈõªÁ≠í', specification: 'LEDÂÖÖÈõªÂºè', quantity: 10, unit: 'ÊîØ', check_interval_days: 30 }
                            ]
                        },
                        {
                            id: 'comm_station',
                            name: 'ÈÄöË®äË®≠ÂÇôÁµÑ',
                            description: 'ÁÑ°Á∑öÈõª„ÄÅÊì¥Èü≥Âô®Á≠âÈÄöË®äË®≠ÂÇô',
                            icon: 'signal',
                            items: [
                                { name: 'Â∞çË¨õÊ©ü', specification: 'VHF/UHF ÈõôÈ†ª', quantity: 6, unit: 'Âè∞', check_interval_days: 30 },
                                { name: 'ÊâãÊåÅÊì¥Èü≥Âô®', specification: '25W', quantity: 2, unit: 'Âè∞', check_interval_days: 30 },
                                { name: 'Ë°åÂãïÈõªÊ∫ê', specification: '20000mAh', quantity: 10, unit: 'ÂÄã', check_interval_days: 90 },
                                { name: 'USBÂÖÖÈõªÁ´ô', specification: '10Â≠î', quantity: 2, unit: 'Âè∞', check_interval_days: 90 }
                            ]
                        },
                        {
                            id: 'medical_station',
                            name: 'ÈÜ´ÁôÇË®≠ÂÇôÁµÑ',
                            description: 'Ë°ÄÂ£ìË®à„ÄÅËº™Ê§ÖÁ≠âÂü∫Êú¨ÈÜ´ÁôÇË®≠ÂÇô',
                            icon: 'heart',
                            items: [
                                { name: 'ÈõªÂ≠êË°ÄÂ£ìË®à', specification: 'ËáÇÂºè', quantity: 3, unit: 'Âè∞', check_interval_days: 30 },
                                { name: 'È°çÊ∫´Êßç', specification: 'ÈùûÊé•Ëß∏Âºè', quantity: 5, unit: 'ÊîØ', check_interval_days: 30 },
                                { name: 'Ë°ÄÊ∞ßÊ©ü', specification: 'ÊåáÂ§æÂºè', quantity: 3, unit: 'Âè∞', check_interval_days: 30 },
                                { name: 'Ëº™Ê§Ö', specification: 'Ê®ôÊ∫ñÂûã', quantity: 4, unit: 'Âè∞', check_interval_days: 90 },
                                { name: 'ÊìîÊû∂', specification: 'ÊäòÁñäÂºè', quantity: 2, unit: 'ÁµÑ', check_interval_days: 90 },
                                { name: 'AED', specification: 'Ëá™ÂãïÈ´îÂ§ñÂøÉËáüÈõªÊìäÂô®', quantity: 1, unit: 'Âè∞', check_interval_days: 30 }
                            ]
                        },
                        {
                            id: 'shelter_basic',
                            name: 'Êî∂ÂÆπÂü∫Êú¨Ë®≠ÂÇô',
                            description: 'Â∏≥ÁØ∑„ÄÅÁù°Ë¢ã„ÄÅÊ°åÊ§ÖÁ≠âÊî∂ÂÆπÂøÖÈúÄÂìÅ',
                            icon: 'home',
                            items: [
                                { name: 'ÊäòÁñäÂ∫ä', specification: 'Ê®ôÊ∫ñÂñÆ‰∫∫', quantity: 50, unit: 'Âºµ', check_interval_days: 180 },
                                { name: 'Áù°Ë¢ã', specification: 'Êàê‰∫∫Ê¨æ', quantity: 50, unit: 'ÂÄã', check_interval_days: 180 },
                                { name: 'ÊØõÊØØ', specification: '150x200cm', quantity: 100, unit: 'Ê¢ù', check_interval_days: 180 },
                                { name: 'ÊäòÁñäÊ°å', specification: '180cmÈï∑Ê°å', quantity: 10, unit: 'Âºµ', check_interval_days: 180 },
                                { name: 'ÊäòÁñäÊ§Ö', specification: 'Â°ëËÜ†Ê¨æ', quantity: 50, unit: 'Âºµ', check_interval_days: 180 }
                            ]
                        },
                        {
                            id: 'kitchen_set',
                            name: 'ÁÇä‰∫ãË®≠ÂÇôÁµÑ',
                            description: 'Áì¶ÊñØÁàê„ÄÅÈçãÂÖ∑Á≠âÁÇä‰∫ãË®≠ÂÇô',
                            icon: 'fire',
                            items: [
                                { name: 'Âç°ÂºèÁì¶ÊñØÁàê', specification: 'ÂñÆÂè£', quantity: 4, unit: 'Âè∞', check_interval_days: 30 },
                                { name: 'Â§ßÂûãÊπØÈçã', specification: '50L', quantity: 2, unit: 'ÂÄã', check_interval_days: 90 },
                                { name: '‰øùÊ∫´Ê°∂', specification: '20L', quantity: 4, unit: 'ÂÄã', check_interval_days: 90 },
                                { name: 'È£≤Ê∞¥Ê©ü', specification: 'Ê°∂Ë£ùÊ∞¥Áî®', quantity: 2, unit: 'Âè∞', check_interval_days: 30 }
                            ]
                        },
                        {
                            id: 'sanitation_set',
                            name: 'Ë°õÁîüË®≠ÂÇôÁµÑ',
                            description: 'Á∞°ÊòìÂªÅÊâÄ„ÄÅÊ∂àÊØíË®≠ÂÇôÁ≠â',
                            icon: 'beaker',
                            items: [
                                { name: 'ÁßªÂãïÂºèÂªÅÊâÄ', specification: 'ÂñÆ‰∫∫Â∫ß', quantity: 4, unit: 'Â∫ß', check_interval_days: 7 },
                                { name: 'Ê∂àÊØíÂô¥ÈúßÂô®', specification: 'ÊâãÂ£ìÂºè8L', quantity: 4, unit: 'Âè∞', check_interval_days: 30 },
                                { name: 'ÂûÉÂúæÊ°∂', specification: '120LÊúâËìã', quantity: 10, unit: 'ÂÄã', check_interval_days: 90 }
                            ]
                        },
                        {
                            id: 'rescue_tools',
                            name: 'ÊïëÊè¥Â∑•ÂÖ∑ÁµÑ',
                            description: 'Á†¥Â£ûÂô®Êùê„ÄÅÁπ©Á¥¢Á≠âÊïëÊè¥Â∑•ÂÖ∑',
                            icon: 'wrench',
                            items: [
                                { name: 'Ê≤πÂ£ìÂâ™', specification: 'ÊâãÂãïÂºè', quantity: 1, unit: 'Âè∞', check_interval_days: 90 },
                                { name: 'ÈêµÊí¨', specification: '90cm', quantity: 2, unit: 'ÊîØ', check_interval_days: 90 },
                                { name: 'ÊïëÊè¥Áπ©', specification: '50Á±≥', quantity: 2, unit: 'Êç≤', check_interval_days: 90 },
                                { name: 'ÂÆâÂÖ®Â∏Ω', specification: 'Â∑•Á®ãÁî®', quantity: 10, unit: 'È†Ç', check_interval_days: 180 },
                                { name: 'Â∑•‰ΩúÊâãÂ•ó', specification: 'Èò≤Êªë', quantity: 20, unit: 'Èõô', check_interval_days: 90 }
                            ]
                        }
                    ];
                },

                loadEquipmentTemplates() {
                    const saved = localStorage.getItem('cirs_equipment_templates');
                    if (saved) {
                        try {
                            this.equipmentTemplates = JSON.parse(saved);
                            // Â¶ÇÊûúÊòØÁ©∫Èô£ÂàóÔºåËºâÂÖ•È†êË®≠ÁØÑÊú¨
                            if (this.equipmentTemplates.length === 0) {
                                this.equipmentTemplates = this.getDefaultEquipmentTemplates();
                                this.saveEquipmentTemplatesToStorage();
                            }
                        } catch (e) {
                            this.equipmentTemplates = this.getDefaultEquipmentTemplates();
                            this.saveEquipmentTemplatesToStorage();
                        }
                    } else {
                        // È¶ñÊ¨°ËºâÂÖ•Ôºå‰ΩøÁî®È†êË®≠ÁØÑÊú¨
                        this.equipmentTemplates = this.getDefaultEquipmentTemplates();
                        this.saveEquipmentTemplatesToStorage();
                    }
                },

                saveEquipmentTemplatesToStorage() {
                    localStorage.setItem('cirs_equipment_templates', JSON.stringify(this.equipmentTemplates));
                },

                openEquipmentTemplateModal() {
                    this.loadEquipmentTemplates();
                    this.showEquipmentTemplateModal = true;
                },

                openEquipmentTemplateManage() {
                    this.loadEquipmentTemplates();
                    this.showEquipmentTemplateManageModal = true;
                },

                startCreateEquipmentTemplate() {
                    this.editingEquipmentTemplate = null;
                    this.equipmentTemplateForm = { name: '', description: '', icon: 'cog', items: [] };
                    this.newEquipmentTemplateItem = { name: '', specification: '', quantity: 1, unit: 'Âè∞', check_interval_days: 7 };
                    this.showEquipmentTemplateManageModal = false;
                    this.showEquipmentTemplateEditModal = true;
                },

                startEditEquipmentTemplate(template) {
                    this.editingEquipmentTemplate = template;
                    this.equipmentTemplateForm = {
                        name: template.name,
                        description: template.description || '',
                        icon: template.icon || 'cog',
                        items: JSON.parse(JSON.stringify(template.items || []))
                    };
                    this.newEquipmentTemplateItem = { name: '', specification: '', quantity: 1, unit: 'Âè∞', check_interval_days: 7 };
                    this.showEquipmentTemplateManageModal = false;
                    this.showEquipmentTemplateEditModal = true;
                },

                addEquipmentTemplateItem() {
                    if (!this.newEquipmentTemplateItem.name.trim()) {
                        this.showToast('Ë´ãËº∏ÂÖ•Ë®≠ÂÇôÂêçÁ®±', 'error');
                        return;
                    }
                    this.equipmentTemplateForm.items.push({
                        name: this.newEquipmentTemplateItem.name.trim(),
                        specification: this.newEquipmentTemplateItem.specification.trim(),
                        quantity: this.newEquipmentTemplateItem.quantity || 1,
                        unit: this.newEquipmentTemplateItem.unit || 'Âè∞',
                        check_interval_days: this.newEquipmentTemplateItem.check_interval_days || 7
                    });
                    this.newEquipmentTemplateItem = { name: '', specification: '', quantity: 1, unit: 'Âè∞', check_interval_days: 7 };
                },

                removeEquipmentTemplateItem(index) {
                    this.equipmentTemplateForm.items.splice(index, 1);
                },

                moveEquipmentTemplateItem(index, direction) {
                    const newIndex = index + direction;
                    if (newIndex < 0 || newIndex >= this.equipmentTemplateForm.items.length) return;
                    const items = [...this.equipmentTemplateForm.items];
                    const [item] = items.splice(index, 1);
                    items.splice(newIndex, 0, item);
                    this.equipmentTemplateForm.items = items;
                },

                saveEquipmentTemplate() {
                    if (!this.equipmentTemplateForm.name.trim()) {
                        this.showToast('Ë´ãËº∏ÂÖ•ÁØÑÊú¨ÂêçÁ®±', 'error');
                        return;
                    }
                    if (this.equipmentTemplateForm.items.length === 0) {
                        this.showToast('Ë´ãËá≥Â∞ëÂä†ÂÖ•‰∏ÄÈ†ÖË®≠ÂÇô', 'error');
                        return;
                    }

                    if (this.editingEquipmentTemplate) {
                        // Update existing
                        const index = this.equipmentTemplates.findIndex(t => t.id === this.editingEquipmentTemplate.id);
                        if (index !== -1) {
                            this.equipmentTemplates[index] = {
                                ...this.editingEquipmentTemplate,
                                name: this.equipmentTemplateForm.name.trim(),
                                description: this.equipmentTemplateForm.description.trim(),
                                icon: this.equipmentTemplateForm.icon,
                                items: this.equipmentTemplateForm.items
                            };
                        }
                    } else {
                        // Create new
                        this.equipmentTemplates.push({
                            id: 'eq_tpl_' + Date.now(),
                            name: this.equipmentTemplateForm.name.trim(),
                            description: this.equipmentTemplateForm.description.trim(),
                            icon: this.equipmentTemplateForm.icon,
                            items: this.equipmentTemplateForm.items
                        });
                    }

                    this.saveEquipmentTemplatesToStorage();
                    this.showEquipmentTemplateEditModal = false;
                    this.showEquipmentTemplateManageModal = true;
                    this.showToast(this.editingEquipmentTemplate ? 'ÁØÑÊú¨Â∑≤Êõ¥Êñ∞' : 'ÁØÑÊú¨Â∑≤Âª∫Á´ã', 'success');
                },

                confirmDeleteEquipmentTemplate(template) {
                    if (!confirm(`Á¢∫ÂÆöË¶ÅÂà™Èô§„Äå${template.name}„ÄçÁØÑÊú¨ÂóéÔºü`)) return;
                    this.equipmentTemplates = this.equipmentTemplates.filter(t => t.id !== template.id);
                    this.saveEquipmentTemplatesToStorage();
                    this.showToast('ÁØÑÊú¨Â∑≤Âà™Èô§', 'success');
                },

                selectEquipmentTemplate(template) {
                    this.selectedEquipmentTemplate = template;
                    // È†êË®≠ÂÖ®ÈÅ∏
                    this.selectedTemplateItems = template.items ? template.items.map((_, idx) => idx) : [];
                },

                toggleTemplateItem(idx) {
                    const index = this.selectedTemplateItems.indexOf(idx);
                    if (index > -1) {
                        this.selectedTemplateItems.splice(index, 1);
                    } else {
                        this.selectedTemplateItems.push(idx);
                    }
                },

                toggleAllTemplateItems() {
                    if (!this.selectedEquipmentTemplate?.items) return;
                    const allCount = this.selectedEquipmentTemplate.items.length;
                    if (this.selectedTemplateItems.length === allCount) {
                        this.selectedTemplateItems = [];
                    } else {
                        this.selectedTemplateItems = this.selectedEquipmentTemplate.items.map((_, idx) => idx);
                    }
                },

                async applySelectedTemplateItems() {
                    if (!this.selectedEquipmentTemplate || this.selectedTemplateItems.length === 0) return;

                    this.showEquipmentTemplateModal = false;
                    const template = this.selectedEquipmentTemplate;
                    const selectedItems = this.selectedTemplateItems.map(idx => template.items[idx]);

                    let successCount = 0;
                    let failCount = 0;

                    for (const item of selectedItems) {
                        try {
                            const res = await this.apiCall('/api/inventory', {
                                method: 'POST',
                                body: {
                                    name: item.name,
                                    specification: item.specification || '',
                                    category: 'equipment',
                                    quantity: item.quantity || 1,
                                    unit: item.unit || 'Âè∞',
                                    check_interval_days: item.check_interval_days || 7
                                }
                            });
                            if (res.ok) successCount++;
                            else failCount++;
                        } catch (e) { failCount++; }
                    }

                    // Reset selection state
                    this.selectedEquipmentTemplate = null;
                    this.selectedTemplateItems = [];

                    await this.loadEquipment();
                    await this.loadEquipmentPending();
                    await this.loadStats();

                    if (failCount === 0) {
                        this.showToast(`Â∑≤Êñ∞Â¢û ${successCount} È†ÖË®≠ÂÇô`, 'success');
                    } else {
                        this.showToast(`Êñ∞Â¢û ${successCount} È†ÖÔºå${failCount} È†ÖÂ§±Êïó`, 'error');
                    }
                },

                async applyEquipmentTemplate(template) {
                    if (!template.items || template.items.length === 0) {
                        this.showToast('Ê≠§ÁØÑÊú¨ÁÑ°Ë®≠ÂÇô', 'error');
                        return;
                    }

                    this.showEquipmentTemplateModal = false;
                    let successCount = 0;
                    let failCount = 0;

                    for (const item of template.items) {
                        try {
                            const res = await this.apiCall('/api/inventory', {
                                method: 'POST',
                                body: {
                                    name: item.name,
                                    specification: item.specification || '',
                                    category: 'equipment',
                                    quantity: item.quantity || 1,
                                    unit: item.unit || 'Âè∞',
                                    check_interval_days: item.check_interval_days || 7
                                }
                            });
                            if (res.ok) successCount++;
                            else failCount++;
                        } catch (e) { failCount++; }
                    }

                    await this.loadEquipment();
                    await this.loadEquipmentPending();

                    if (failCount === 0) {
                        this.showToast(`Â∑≤Êñ∞Â¢û ${successCount} È†ÖË®≠ÂÇô`, 'success');
                    } else {
                        this.showToast(`Êñ∞Â¢û ${successCount} È†ÖÔºå${failCount} È†ÖÂ§±Êïó`, 'error');
                    }
                },

                getEquipmentTemplateIconPath(iconId) {
                    const icon = this.equipmentTemplateIconOptions.find(i => i.id === iconId);
                    return icon ? icon.path : this.equipmentTemplateIconOptions[0].path;
                },

                getEquipmentIconPath(name) {
                    // Ê†πÊìöË®≠ÂÇôÂêçÁ®±ÈóúÈçµÂ≠óÂà§Êñ∑ÂúñÁ§∫
                    const n = (name || '').toLowerCase();

                    // ÈõªÂäõÁõ∏Èóú
                    if (n.includes('ÁôºÈõª') || n.includes('ups') || n.includes('ÈõªÊ∫ê') || n.includes('ËÆäÂ£ì') || n.includes('ÂÖÖÈõª')) {
                        return this.getEquipmentTemplateIconPath('bolt');
                    }
                    // ÁÖßÊòéÁõ∏Èóú
                    if (n.includes('Ááà') || n.includes('ÁÖßÊòé') || n.includes('ÊâãÈõª')) {
                        return this.getEquipmentTemplateIconPath('sun');
                    }
                    // ÈÄöË®äÁõ∏Èóú
                    if (n.includes('Â∞çË¨õ') || n.includes('ÁÑ°Á∑öÈõª') || n.includes('ÈÄöË®ä') || n.includes('Êì¥Èü≥') || n.includes('ÂñáÂè≠')) {
                        return this.getEquipmentTemplateIconPath('signal');
                    }
                    // ÈÜ´ÁôÇÁõ∏Èóú
                    if (n.includes('Ë°ÄÂ£ì') || n.includes('È´îÊ∫´') || n.includes('È°çÊ∫´') || n.includes('Ë°ÄÊ∞ß') || n.includes('aed') ||
                        n.includes('Ëº™Ê§Ö') || n.includes('ÊìîÊû∂') || n.includes('ÊÄ•Êïë')) {
                        return this.getEquipmentTemplateIconPath('heart');
                    }
                    // Êî∂ÂÆπ/‰ΩèÂÆø
                    if (n.includes('Â∫ä') || n.includes('Áù°Ë¢ã') || n.includes('ÊØõÊØØ') || n.includes('Â∏≥ÁØ∑') || n.includes('Ê°å') || n.includes('Ê§Ö')) {
                        return this.getEquipmentTemplateIconPath('home');
                    }
                    // ÁÇä‰∫ãÁõ∏Èóú
                    if (n.includes('Áì¶ÊñØ') || n.includes('Áàê') || n.includes('Èçã') || n.includes('È£≤Ê∞¥') || n.includes('‰øùÊ∫´')) {
                        return this.getEquipmentTemplateIconPath('fire');
                    }
                    // Ë°õÁîüÁõ∏Èóú
                    if (n.includes('ÂªÅÊâÄ') || n.includes('Ê∂àÊØí') || n.includes('ÂûÉÂúæ') || n.includes('Ê∏ÖÊΩî')) {
                        return this.getEquipmentTemplateIconPath('beaker');
                    }
                    // Â∑•ÂÖ∑Áõ∏Èóú
                    if (n.includes('Ââ™') || n.includes('Êí¨') || n.includes('Áπ©') || n.includes('Â∑•ÂÖ∑') || n.includes('Êâ≥Êâã')) {
                        return this.getEquipmentTemplateIconPath('wrench');
                    }
                    // ÂÆâÂÖ®Èò≤Ë≠∑
                    if (n.includes('ÂÆâÂÖ®Â∏Ω') || n.includes('ÊâãÂ•ó') || n.includes('Ë≠∑ÂÖ∑') || n.includes('Èò≤Ë≠∑')) {
                        return this.getEquipmentTemplateIconPath('shield');
                    }
                    // ÈõªËÖ¶/ÈõªÂ≠ê
                    if (n.includes('ÈõªËÖ¶') || n.includes('Á≠ÜÈõª') || n.includes('Ëû¢Âπï') || n.includes('ÊäïÂΩ±')) {
                        return this.getEquipmentTemplateIconPath('computer');
                    }
                    // ËªäËºõ
                    if (n.includes('Ëªä') || n.includes('Êé®Ëªä') || n.includes('ÊãñËªä')) {
                        return this.getEquipmentTemplateIconPath('truck');
                    }
                    // È†êË®≠ÔºöÈΩíËº™ÂúñÁ§∫
                    return this.getEquipmentTemplateIconPath('cog');
                },

                async loadPeople() {
                    try {
                        const res = await this.apiCall('/api/person');
                        if (res.ok) {
                            const data = await res.json();
                            this.people = data.persons || [];
                        }
                    } catch (e) {}
                },

                async loadMessages() {
                    try {
                        const res = await fetch('/api/messages');
                        if (res.ok) {
                            const data = await res.json();
                            this.messages = data.messages || [];
                        }
                    } catch (e) {}
                },

                async loadBundles() {
                    try {
                        const res = await fetch('/api/inventory/bundles');
                        if (res.ok) {
                            const data = await res.json();
                            this.bundles = data.bundles || [];
                        }
                    } catch (e) {}
                },

                // Zone methods
                async loadZones() {
                    try {
                        const res = await fetch('/api/zone');
                        if (res.ok) {
                            const data = await res.json();
                            this.zones = data.zones || [];
                        }
                    } catch (e) { console.error('Failed to load zones:', e); }
                },

                // Heroicon SVG map for zone icons
                getZoneIcon(iconName) {
                    const icons = {
                        'moon': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>',
                        'cake': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 15.546c-.523 0-1.046.151-1.5.454a2.704 2.704 0 01-3 0 2.704 2.704 0 00-3 0 2.704 2.704 0 01-3 0 2.704 2.704 0 00-3 0 2.704 2.704 0 01-3 0A1.75 1.75 0 003 15.546v3.954a1.5 1.5 0 001.5 1.5h15a1.5 1.5 0 001.5-1.5v-3.954zM3 15.546v-3.796a1.5 1.5 0 011.5-1.5h15a1.5 1.5 0 011.5 1.5v3.796M12 3v6"/></svg>',
                        'user-group': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>',
                        'heart': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>',
                        'face-smile': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>',
                        'clipboard-document-check': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>',
                        'check-circle': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>',
                        'exclamation-triangle': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>',
                        'exclamation-circle': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>',
                        'eye': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>',
                        'clipboard-document-list': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/></svg>',
                        'cube': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>',
                        'information-circle': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>',
                        'building-storefront': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.5 21v-7.5a.75.75 0 01.75-.75h3a.75.75 0 01.75.75V21m-4.5 0H2.36m11.14 0H18m0 0h3.64m-1.39 0V9.349m-16.5 11.65V9.35m0 0a3.001 3.001 0 003.75-.615A2.993 2.993 0 009.75 9.75c.896 0 1.7-.393 2.25-1.016a2.993 2.993 0 002.25 1.016c.896 0 1.7-.393 2.25-1.016a3.001 3.001 0 003.75.614m-16.5 0a3.004 3.004 0 01-.621-4.72L4.318 3.44A1.5 1.5 0 015.378 3h13.243a1.5 1.5 0 011.06.44l1.19 1.189a3 3 0 01-.621 4.72m-13.5 8.65h3.75a.75.75 0 00.75-.75V13.5a.75.75 0 00-.75-.75H6.75a.75.75 0 00-.75.75v3.75c0 .415.336.75.75.75z"/></svg>',
                        'building-office': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>',
                        'cog-6-tooth': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>',
                        'home': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>',
                        'lock-closed': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>'
                    };
                    return icons[iconName] || icons['home'];
                },

                filterByZone(zoneId) {
                    this.zoneFilter = this.zoneFilter === zoneId ? '' : zoneId;
                },

                openZoneManageModal() {
                    this.showZoneManageModal = true;
                },

                openBatchMoveModal() {
                    this.batchMoveForm = { target_zone_id: '', notes: '' };
                    this.showBatchMoveModal = true;
                },

                async doBatchMove() {
                    if (!this.batchMoveForm.target_zone_id) {
                        this.showToast('Ë´ãÈÅ∏ÊìáÁõÆÊ®ôÂçÄÂüü', 'error');
                        return;
                    }
                    if (this.selectedPeople.length === 0) {
                        this.showToast('Ë´ãÈÅ∏ÊìáË¶ÅÁßªÂãïÁöÑ‰∫∫Âì°', 'error');
                        return;
                    }
                    try {
                        const res = await this.apiCall('/api/zone/move', {
                            method: 'POST',
                            body: {
                                person_ids: this.selectedPeople,
                                target_zone_id: this.batchMoveForm.target_zone_id,
                                operator_id: this.currentUser.id,
                                notes: this.batchMoveForm.notes
                            }
                        });
                        if (res.ok) {
                            const data = await res.json();
                            this.showToast(data.message, 'success');
                            this.showBatchMoveModal = false;
                            this.selectedPeople = [];
                            await this.loadPeople();
                            await this.loadZones();
                        } else {
                            const err = await res.json();
                            this.showToast(err.detail || 'ÁßªÂãïÂ§±Êïó', 'error');
                        }
                    } catch (e) { this.showToast('ÁßªÂãïÂ§±Êïó', 'error'); }
                },

                openBatchCheckoutModal() {
                    if (this.selectedPeople.length === 0) {
                        this.showToast('Ë´ãÈÅ∏ÊìáË¶ÅÈÄÄÂ†¥ÁöÑ‰∫∫Âì°', 'error');
                        return;
                    }
                    this.batchCheckoutForm = { reason: 'DISCHARGE', destination: '', notes: '' };
                    this.showBatchCheckoutModal = true;
                },

                async doBatchCheckout() {
                    if (this.selectedPeople.length === 0) {
                        this.showToast('Ë´ãÈÅ∏ÊìáË¶ÅÈÄÄÂ†¥ÁöÑ‰∫∫Âì°', 'error');
                        return;
                    }
                    try {
                        const res = await this.apiCall('/api/person/batch-checkout', {
                            method: 'POST',
                            body: {
                                person_ids: this.selectedPeople,
                                reason: this.batchCheckoutForm.reason,
                                destination: this.batchCheckoutForm.destination,
                                notes: this.batchCheckoutForm.notes
                            }
                        });
                        if (res.ok) {
                            const data = await res.json();
                            this.showToast(data.message, 'success');
                            this.showBatchCheckoutModal = false;
                            this.selectedPeople = [];
                            await this.loadPeople();
                            await this.loadZones();
                            await this.loadStats();
                        } else {
                            const err = await res.json();
                            this.showToast(err.detail || 'ÈÄÄÂ†¥Â§±Êïó', 'error');
                        }
                    } catch (e) { this.showToast('ÈÄÄÂ†¥Â§±Êïó', 'error'); }
                },

                // System: Backup & Settings
                async loadBackupStatus() {
                    try {
                        const res = await this.apiCall('/api/backup/status');
                        if (res.ok) {
                            this.backupStatus = await res.json();
                        }
                    } catch (e) { console.error('Failed to load backup status:', e); }
                },

                async createBackup() {
                    if (this.backupForm.encrypt && !this.backupForm.password) {
                        this.showToast('Âä†ÂØÜÂÇô‰ªΩÈúÄË¶ÅË®≠ÂÆöÂØÜÁ¢º', 'error');
                        return;
                    }

                    this.backupLoading = true;
                    try {
                        const res = await this.apiCall('/api/backup/create', {
                            method: 'POST',
                            body: {
                                operator_id: this.currentUser.id,
                                target: this.backupForm.target,
                                encrypt: this.backupForm.encrypt,
                                password: this.backupForm.password || null,
                                notes: this.backupForm.notes || null
                            }
                        });

                        if (this.backupForm.target === 'download' && res.ok) {
                            const blob = await res.blob();
                            const filename = res.headers.get('Content-Disposition')?.split('filename=')[1] || 'cirs_backup.db.gz';
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = filename;
                            a.click();
                            window.URL.revokeObjectURL(url);
                            this.showToast('ÂÇô‰ªΩÂ∑≤‰∏ãËºâ', 'success');
                        } else if (res.ok) {
                            const data = await res.json();
                            this.showToast(`ÂÇô‰ªΩÊàêÂäü: ${data.filename}`, 'success');
                        } else {
                            const err = await res.json();
                            this.showToast(err.detail || 'ÂÇô‰ªΩÂ§±Êïó', 'error');
                        }

                        await this.loadBackupStatus();
                        this.backupForm.password = '';
                        this.backupForm.notes = '';
                    } catch (e) {
                        this.showToast('ÂÇô‰ªΩÂ§±Êïó: ' + e.message, 'error');
                    } finally {
                        this.backupLoading = false;
                    }
                },

                async loadSiteConfig() {
                    try {
                        const res = await fetch('/api/system/config');
                        if (res.ok) {
                            const config = await res.json();
                            this.siteName = config.site_name || 'Á§æÂçÄÈÅøÈõ£‰∏≠ÂøÉ';
                            this.settingsForm.site_name = this.siteName;
                        }
                    } catch (e) {}
                },

                async saveSiteName() {
                    try {
                        const res = await this.apiCall('/api/system/config', {
                            method: 'PUT',
                            body: { key: 'site_name', value: this.settingsForm.site_name }
                        });
                        if (res.ok) {
                            this.siteName = this.settingsForm.site_name;
                            this.showSettingsModal = false;
                            this.showToast('Á´ôÈªûÂêçÁ®±Â∑≤Êõ¥Êñ∞', 'success');
                        } else {
                            this.showToast('Êõ¥Êñ∞Â§±Êïó', 'error');
                        }
                    } catch (e) { this.showToast('Êìç‰ΩúÂ§±Êïó', 'error'); }
                },

                async publishBroadcast() {
                    if (!this.broadcastForm.content.trim()) return;
                    try {
                        const res = await this.apiCall('/api/messages/broadcast', {
                            method: 'POST',
                            body: {
                                content: this.broadcastForm.content.trim(),
                                is_pinned: true
                            }
                        });
                        if (res.ok) {
                            this.broadcast = this.broadcastForm.content.trim();
                            this.broadcastForm.content = '';
                            this.showBroadcastModal = false;
                            this.showToast('ÂÖ¨ÂëäÂ∑≤Áôº‰Ωà', 'success');
                        } else {
                            this.showToast('Áôº‰ΩàÂ§±Êïó', 'error');
                        }
                    } catch (e) { this.showToast('Êìç‰ΩúÂ§±Êïó', 'error'); }
                },

                async clearBroadcast() {
                    // Get current broadcast and unpin it
                    try {
                        const res = await fetch('/api/messages/broadcast');
                        if (res.ok) {
                            const data = await res.json();
                            if (data.broadcast?.id) {
                                await this.apiCall(`/api/messages/${data.broadcast.id}/pin`, {
                                    method: 'POST',
                                    body: { is_pinned: false }
                                });
                                this.broadcast = null;
                                this.showBroadcastModal = false;
                                this.showToast('ÂÖ¨ÂëäÂ∑≤Ê∏ÖÈô§', 'success');
                            }
                        }
                    } catch (e) { this.showToast('Êìç‰ΩúÂ§±Êïó', 'error'); }
                },

                formatBackupTime(isoStr) {
                    if (!isoStr) return '';
                    const d = new Date(isoStr);
                    const now = new Date();
                    const diff = (now - d) / 1000;
                    if (diff < 60) return 'ÂâõÂâõ';
                    if (diff < 3600) return `${Math.floor(diff/60)} ÂàÜÈêòÂâç`;
                    if (diff < 86400) return `${Math.floor(diff/3600)} Â∞èÊôÇÂâç`;
                    if (diff < 604800) return `${Math.floor(diff/86400)} Â§©Ââç`;
                    return d.toLocaleDateString('zh-TW');
                },

                togglePersonSelect(personId) {
                    const idx = this.selectedPeople.indexOf(personId);
                    if (idx > -1) {
                        this.selectedPeople.splice(idx, 1);
                    } else {
                        this.selectedPeople.push(personId);
                    }
                },

                selectAllFiltered() {
                    const filtered = this.filteredPeople.map(p => p.id);
                    if (filtered.every(id => this.selectedPeople.includes(id))) {
                        this.selectedPeople = this.selectedPeople.filter(id => !filtered.includes(id));
                    } else {
                        this.selectedPeople = [...new Set([...this.selectedPeople, ...filtered])];
                    }
                },

                async createZone() {
                    if (!this.newZone.id || !this.newZone.name) {
                        this.showToast('Ë´ãËº∏ÂÖ•ÂçÄÂüü‰ª£Á¢ºÂíåÂêçÁ®±', 'error');
                        return;
                    }
                    try {
                        const res = await this.apiCall('/api/zone', {
                            method: 'POST',
                            body: this.newZone
                        });
                        if (res.ok) {
                            this.showToast('ÂçÄÂüüÊñ∞Â¢ûÊàêÂäü', 'success');
                            this.newZone = { id: '', name: '', zone_type: 'shelter', capacity: 0, description: '' };
                            await this.loadZones();
                        } else {
                            const err = await res.json();
                            this.showToast(err.detail || 'Êñ∞Â¢ûÂ§±Êïó', 'error');
                        }
                    } catch (e) { this.showToast('Êñ∞Â¢ûÂ§±Êïó', 'error'); }
                },

                async deleteZone(zoneId) {
                    if (!confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§ÂçÄÂüüÂóéÔºü')) return;
                    try {
                        const res = await this.apiCall(`/api/zone/${zoneId}`, { method: 'DELETE' });
                        if (res.ok) {
                            this.showToast('ÂçÄÂüüÂ∑≤Âà™Èô§', 'success');
                            await this.loadZones();
                        } else {
                            const err = await res.json();
                            this.showToast(err.detail || 'Âà™Èô§Â§±Êïó', 'error');
                        }
                    } catch (e) { this.showToast('Âà™Èô§Â§±Êïó', 'error'); }
                },

                // Quick check-in with triage
                async doQuickCheckIn() {
                    if (!this.newPerson.display_name) {
                        this.showToast('Ë´ãËº∏ÂÖ•ÂßìÂêç', 'error');
                        return;
                    }
                    try {
                        const res = await this.apiCall('/api/person', {
                            method: 'POST',
                            body: {
                                display_name: this.newPerson.display_name,
                                national_id: this.newPerson.national_id || null,
                                phone: this.newPerson.phone || null,
                                current_location: this.newPerson.current_location,
                                triage_status: this.newPerson.triage_status,
                                photo_data: this.newPerson.photo_data || null,
                                physical_desc: this.newPerson.physical_desc || null
                            }
                        });
                        if (res.ok) {
                            const data = await res.json();
                            const msg = data.existing
                                ? `Â∑≤ÁôªË®ò: ${data.id} (${data.message})`
                                : `Â†±Âà∞ÊàêÂäü Â∫èËôü: ${data.id}`;
                            this.showToast(msg, data.existing ? 'info' : 'success');
                            this.newPerson = { display_name: '', national_id: '', phone: '', current_location: '', triage_status: 'GREEN', photo_data: '', physical_desc: '' };
                            await this.loadPeople();
                            await this.loadStats();
                        }
                    } catch (e) { this.showToast('Êìç‰ΩúÂ§±Êïó', 'error'); }
                },

                // Capture photo for unidentified person
                async capturePhoto() {
                    try {
                        const input = document.createElement('input');
                        input.type = 'file';
                        input.accept = 'image/*';
                        input.capture = 'environment';
                        input.onchange = async (e) => {
                            const file = e.target.files[0];
                            if (file) {
                                // Compress and convert to base64
                                const canvas = document.createElement('canvas');
                                const ctx = canvas.getContext('2d');
                                const img = new Image();
                                img.onload = () => {
                                    // Max 400px for thumbnail
                                    const maxSize = 400;
                                    let w = img.width, h = img.height;
                                    if (w > h && w > maxSize) { h = h * maxSize / w; w = maxSize; }
                                    else if (h > maxSize) { w = w * maxSize / h; h = maxSize; }
                                    canvas.width = w;
                                    canvas.height = h;
                                    ctx.drawImage(img, 0, 0, w, h);
                                    this.newPerson.photo_data = canvas.toDataURL('image/jpeg', 0.7);
                                };
                                img.src = URL.createObjectURL(file);
                            }
                        };
                        input.click();
                    } catch (e) {
                        this.showToast('ÁÑ°Ê≥ïÂ≠òÂèñÁõ∏Ê©ü', 'error');
                    }
                },

                startTriage(person) {
                    this.triageTarget = person;
                    this.showTriageModal = true;
                },

                // Single person move (ÂçÄÂüüÁßªÂãï)
                openPersonMoveModal(person) {
                    this.personToMove = person;
                    this.batchMoveForm.target_zone_id = person.current_location || '';
                    this.batchMoveForm.notes = '';
                    this.showPersonMoveModal = true;
                },

                async doPersonMove() {
                    if (!this.batchMoveForm.target_zone_id) {
                        this.showToast('Ë´ãÈÅ∏ÊìáÁõÆÊ®ôÂçÄÂüü', 'error');
                        return;
                    }
                    try {
                        const res = await this.apiCall('/api/zone/move', {
                            method: 'POST',
                            body: {
                                person_ids: [this.personToMove.id],
                                target_zone_id: this.batchMoveForm.target_zone_id,
                                operator_id: this.currentUser.id,
                                notes: this.batchMoveForm.notes
                            }
                        });
                        if (res.ok) {
                            this.showPersonMoveModal = false;
                            this.showToast('ÁßªÂãïÊàêÂäü', 'success');
                            await this.loadPeople();
                            await this.loadZones();
                        } else {
                            const err = await res.json();
                            this.showToast(err.detail || 'ÁßªÂãïÂ§±Êïó', 'error');
                        }
                    } catch (e) { this.showToast('ÁßªÂãïÂ§±Êïó', 'error'); }
                },

                async doTriage(status) {
                    try {
                        const res = await this.apiCall(`/api/person/${this.triageTarget.id}/triage`, {
                            method: 'POST',
                            body: { status }
                        });
                        if (res.ok) {
                            this.showTriageModal = false;
                            this.showToast('Ê™¢ÂÇ∑ÂàÜÈ°ûÂÆåÊàê', 'success');
                            await this.loadPeople();
                            await this.loadStats();
                        }
                    } catch (e) { this.showToast('Êìç‰ΩúÂ§±Êïó', 'error'); }
                },

                // Inventory operations
                async openInventoryHistory() {
                    this.historyFilter = '';
                    this.inventoryHistory = [];
                    this.showInventoryHistoryModal = true;
                    await this.loadInventoryHistory();
                },

                async loadInventoryHistory(offset = 0) {
                    try {
                        const res = await this.apiCall(`/api/events?event_type=RESOURCE_IN&limit=50&offset=${offset}`);
                        const inEvents = res.ok ? (await res.json()).events : [];

                        const res2 = await this.apiCall(`/api/events?event_type=RESOURCE_OUT&limit=50&offset=${offset}`);
                        const outEvents = res2.ok ? (await res2.json()).events : [];

                        const combined = [...inEvents, ...outEvents].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                        if (offset === 0) {
                            this.inventoryHistory = combined;
                        } else {
                            this.inventoryHistory = [...this.inventoryHistory, ...combined];
                        }
                    } catch (e) { console.error('Failed to load history', e); }
                },

                async loadMoreHistory() {
                    await this.loadInventoryHistory(this.inventoryHistory.length);
                },

                quickIntake(item) {
                    this.intakeForm = { item_id: item.id, quantity: 1, notes: '' };
                    this.showIntakeModal = true;
                },

                async doIntake() {
                    if (!this.intakeForm.item_id) {
                        this.showToast('Ë´ãÈÅ∏ÊìáÁâ©Ë≥á', 'error');
                        return;
                    }
                    try {
                        const res = await this.apiCall(`/api/inventory/${this.intakeForm.item_id}/intake`, {
                            method: 'POST',
                            body: { quantity: this.intakeForm.quantity, notes: this.intakeForm.notes }
                        });
                        if (res.ok) {
                            this.showIntakeModal = false;
                            this.showToast('ÂÖ•Â∫´ÊàêÂäü', 'success');
                            await this.loadInventory();
                        } else {
                            const err = await res.json();
                            this.showToast(err.detail || 'ÂÖ•Â∫´Â§±Êïó', 'error');
                        }
                    } catch (e) { this.showToast('Êìç‰ΩúÂ§±Êïó', 'error'); }
                },

                startDistribute(item) {
                    this.distributeItem = item;
                    this.distributeForm = { person_id: '', quantity: 1, notes: '' };
                    this.showDistributeModal = true;
                },

                async doDistribute() {
                    if (!this.distributeForm.person_id) {
                        this.showToast('Ë´ãËº∏ÂÖ•È†òÂèñ‰∫∫ ID', 'error');
                        return;
                    }
                    try {
                        const res = await this.apiCall(`/api/inventory/${this.distributeItem.id}/distribute`, {
                            method: 'POST',
                            body: this.distributeForm
                        });
                        if (res.ok) {
                            const result = await res.json();
                            this.showDistributeModal = false;

                            // ÂÑ≤Â≠òÁôºÊîæÁµêÊûúÔºåÊ∫ñÂÇôÁî¢Áîü QR Code
                            this.lastDistributeResult = {
                                item: this.distributeItem,
                                quantity: this.distributeForm.quantity,
                                person_id: this.distributeForm.person_id,
                                timestamp: new Date().toISOString()
                            };

                            // È°ØÁ§∫ QR Code modal
                            this.generateDistributeQR();

                            await this.loadInventory();
                            await this.loadStats();
                        } else {
                            const err = await res.json();
                            this.showToast(err.detail || 'ÁôºÊîæÂ§±Êïó', 'error');
                        }
                    } catch (e) { this.showToast('Êìç‰ΩúÂ§±Êïó', 'error'); }
                },

                async generateDistributeQR() {
                    if (!this.lastDistributeResult) return;

                    const r = this.lastDistributeResult;

                    // ‰ΩøÁî® IRS Interop Spec v1.0 ‰ø°Â∞ÅÊ†ºÂºè
                    const envelope = IRSSchema.createDistributionEnvelope({
                        issuer: {
                            system: 'CIRS',
                            site_id: this.siteConfig?.site_id || 'CIRS-DEFAULT',
                            site_name: this.siteConfig?.site_name || 'CIRS Á§æÂçÄÁâ©Ë≥áÁ´ô'
                        },
                        recipient: {
                            display_name: r.person?.display_name || 'ÂåøÂêç',
                            household_size: r.person?.household_size || 1
                        },
                        items: [{
                            item_code: r.item.item_code || `CUSTOM-${r.item.id}`,
                            name: r.item.name,
                            qty: r.quantity,
                            unit: r.item.unit || 'ÂÄã',
                            category: r.item.category || 'other',
                            expiry_date: r.item.expiry_date || null
                        }],
                        notes: `ÁôºÊîæÊôÇÈñì: ${r.timestamp}`
                    });

                    const jsonStr = JSON.stringify(envelope);
                    console.log('[IRS] Distribution envelope:', envelope);

                    try {
                        // ÂÖàÈ°ØÁ§∫ modalÔºåÁ¢∫‰øù DOM ÂÖÉÁ¥†ÂèØË¶ã
                        this.showDistributeQRModal = true;

                        // Á≠âÂæÖ DOM Êõ¥Êñ∞ÂÆåÊàê
                        await this.$nextTick();

                        // Â∞á UTF-8 Â≠ó‰∏≤ËΩâÊèõÁÇ∫ Byte Èô£ÂàóÔºåÁ¢∫‰øù‰∏≠ÊñáÊ≠£Á¢∫Á∑®Á¢º
                        const utf8Bytes = new TextEncoder().encode(jsonStr);
                        const byteString = Array.from(utf8Bytes).map(b => String.fromCharCode(b)).join('');

                        const qr = qrcode(0, 'L');
                        qr.addData(byteString, 'Byte');
                        qr.make();

                        const container = document.getElementById('distribute-qrcode');
                        if (container) {
                            container.innerHTML = qr.createImgTag(5);
                        } else {
                            console.error('distribute-qrcode container not found');
                            throw new Error('Container not found');
                        }
                    } catch (e) {
                        console.error('QR generation error:', e);
                        this.showDistributeQRModal = false;
                        this.showToast('ÁôºÊîæÊàêÂäüÔºåQR Code Áî¢ÁîüÂ§±Êïó', 'info');
                    }
                },

                // ÂæûÁôºÊîæÁ¥ÄÈåÑÈáçÊñ∞Áî¢Áîü QR Code
                async regenerateDistributeQR(event) {
                    // ÈúÄË¶ÅÂæû API ÂèñÂæóÂÆåÊï¥ÁöÑÁâ©ÂìÅË≥áË®ä
                    try {
                        const res = await fetch(`/api/inventory/${event.item_id}`);
                        if (!res.ok) {
                            this.showToast('ÁÑ°Ê≥ïÂèñÂæóÁâ©ÂìÅË≥áË®ä', 'error');
                            return;
                        }
                        const item = await res.json();

                        // Ë®≠ÂÆö lastDistributeResult ‰∏¶Áî¢Áîü QR Code
                        this.lastDistributeResult = {
                            item: item,
                            quantity: Math.abs(event.quantity_change),
                            person_id: event.person_id,
                            person: event.person || { display_name: 'ÂåøÂêç', household_size: 1 },
                            timestamp: event.timestamp
                        };

                        this.generateDistributeQR();
                    } catch (e) {
                        console.error('regenerateDistributeQR error:', e);
                        this.showToast('Áî¢Áîü QR Code Â§±Êïó', 'error');
                    }
                },

                // ============================================
                // Donation Functions (ÊçêË¥àÂäüËÉΩ)
                // ============================================

                addDonationItem() {
                    this.donationItems.push({
                        item_id: '',
                        name: '',
                        quantity: 1,
                        unit: 'ÂÄã',
                        category: 'other'
                    });
                },

                removeDonationItem(index) {
                    this.donationItems.splice(index, 1);
                },

                onDonationItemSelect(index) {
                    const item = this.donationItems[index];
                    if (item.item_id && item.item_id !== 'new') {
                        // ÊâæÂà∞ÈÅ∏‰∏≠ÁöÑÂ∫´Â≠òÁâ©ÂìÅ
                        const inv = this.inventory.find(i => i.id == item.item_id);
                        if (inv) {
                            item.name = inv.name;
                            item.unit = inv.unit || 'ÂÄã';
                            item.category = inv.category || 'other';
                        }
                    } else if (item.item_id === 'new') {
                        item.name = '';
                        item.unit = 'ÂÄã';
                        item.category = 'other';
                    }
                },

                async submitDonation() {
                    if (this.donationItems.length === 0) {
                        this.showToast('Ë´ãÊñ∞Â¢ûËá≥Â∞ë‰∏ÄÈ†ÖÁâ©Ë≥á', 'error');
                        return;
                    }

                    // Ê™¢Êü•ÊØèÈ†ÖÊòØÂê¶ÊúâÊïà
                    for (const item of this.donationItems) {
                        if (item.item_id === 'new' && !item.name) {
                            this.showToast('Ë´ãÂ°´ÂØ´Êñ∞Â¢ûÁâ©ÂìÅÁöÑÂêçÁ®±', 'error');
                            return;
                        }
                        if (!item.quantity || item.quantity <= 0) {
                            this.showToast('Ë´ãÂ°´ÂØ´ÊúâÊïàÁöÑÊï∏Èáè', 'error');
                            return;
                        }
                    }

                    try {
                        const payload = {
                            items: this.donationItems.map(item => ({
                                item_id: item.item_id && item.item_id !== 'new' ? parseInt(item.item_id) : null,
                                name: item.name,
                                quantity: item.quantity,
                                unit: item.unit,
                                category: item.category
                            })),
                            donor_name: this.donationDonorName || null,
                            notes: this.donationNotes || null
                        };

                        const res = await this.apiCall('/api/inventory/donation/inbound', {
                            method: 'POST',
                            body: payload
                        });

                        if (res.ok) {
                            const data = await res.json();
                            this.showToast(`ÊçêË¥àÂÖ•Â∫´ÊàêÂäüÔºÅÂÖ± ${data.total_items} È†Ö`, 'success');

                            // ÈóúÈñâÊçêË¥àÊ®°ÊÖãÊ°Ü
                            this.showDonationModal = false;

                            // ‰øùÂ≠òÊî∂Êìö‰∏¶È°ØÁ§∫ QR Code
                            this.lastDonationReceipt = data.receipt;
                            await this.loadInventory();

                            // Áî¢ÁîüÊî∂Êìö QR Code
                            this.generateDonationReceiptQR();
                        }
                    } catch (e) {
                        console.error('submitDonation error:', e);
                        this.showToast('ÊçêË¥àÂÖ•Â∫´Â§±Êïó', 'error');
                    }
                },

                async generateDonationReceiptQR() {
                    if (!this.lastDonationReceipt) return;

                    const jsonStr = JSON.stringify(this.lastDonationReceipt);
                    console.log('[IRS] Donation receipt envelope:', this.lastDonationReceipt);

                    try {
                        this.showDonationReceiptModal = true;
                        await this.$nextTick();

                        // UTF-8 Á∑®Á¢º
                        const utf8Bytes = new TextEncoder().encode(jsonStr);
                        const byteString = Array.from(utf8Bytes).map(b => String.fromCharCode(b)).join('');

                        const qr = qrcode(0, 'L');
                        qr.addData(byteString, 'Byte');
                        qr.make();

                        const container = document.getElementById('donation-receipt-qrcode');
                        if (container) {
                            container.innerHTML = qr.createImgTag(5);
                        }
                    } catch (e) {
                        console.error('QR generation error:', e);
                        this.showToast('Êî∂Êìö QR Code Áî¢ÁîüÂ§±Êïó', 'error');
                    }

                    // ÈáçÁΩÆË°®ÂñÆ
                    this.donationItems = [];
                    this.donationDonorName = '';
                    this.donationNotes = '';
                },

                async checkSimilarItems() {
                    if (this.newInventory.name.length < 2) {
                        this.similarItems = [];
                        return;
                    }
                    try {
                        const res = await fetch(`/api/inventory/similar?name=${encodeURIComponent(this.newInventory.name)}`);
                        if (res.ok) {
                            const data = await res.json();
                            this.similarItems = data.items || [];
                        }
                    } catch (e) {}
                },

                async doAddInventory() {
                    if (!this.newInventory.name) {
                        this.showToast('Ë´ãËº∏ÂÖ•ÂêçÁ®±', 'error');
                        return;
                    }
                    try {
                        const res = await this.apiCall('/api/inventory', {
                            method: 'POST',
                            body: this.newInventory
                        });
                        if (res.ok) {
                            this.showAddInventoryModal = false;
                            this.newInventory = { name: '', specification: '', category: 'water', quantity: 0, unit: '', location: '', expiry_date: '' };
                            this.similarItems = [];
                            this.showToast('Êñ∞Â¢ûÊàêÂäü', 'success');
                            await this.loadInventory();
                        }
                    } catch (e) { this.showToast('Êìç‰ΩúÂ§±Êïó', 'error'); }
                },

                // Bundle operations
                openBundleModal() {
                    this.bundleIntakeForm = { bundle_id: '', multiplier: 1, location: '' };
                    this.showBundleModal = true;
                },

                selectBundle(bundle) {
                    this.selectedBundle = bundle;
                    this.bundleIntakeForm.bundle_id = bundle.id;
                    // È†êË®≠ÂÖ®ÈÅ∏ÊâÄÊúâÈ†ÖÁõÆ
                    this.selectedBundleItems = bundle.items ? bundle.items.map((_, idx) => idx) : [];
                    this.showBundleDetailModal = true;
                },

                toggleBundleItem(idx) {
                    const index = this.selectedBundleItems.indexOf(idx);
                    if (index > -1) {
                        this.selectedBundleItems.splice(index, 1);
                    } else {
                        this.selectedBundleItems.push(idx);
                    }
                },

                toggleAllBundleItems() {
                    if (!this.selectedBundle?.items) return;
                    const allCount = this.selectedBundle.items.length;
                    if (this.selectedBundleItems.length === allCount) {
                        this.selectedBundleItems = [];
                    } else {
                        this.selectedBundleItems = this.selectedBundle.items.map((_, idx) => idx);
                    }
                },

                async doBundleIntake() {
                    if (!this.bundleIntakeForm.bundle_id) {
                        this.showToast('Ë´ãÈÅ∏ÊìáÁµÑÂ•ó', 'error');
                        return;
                    }
                    if (this.selectedBundleItems.length === 0) {
                        this.showToast('Ë´ãËá≥Â∞ëÂãæÈÅ∏‰∏ÄÈ†ÖÁâ©Ë≥á', 'error');
                        return;
                    }
                    try {
                        const requestBody = {
                            ...this.bundleIntakeForm,
                            selected_indices: this.selectedBundleItems
                        };
                        const res = await this.apiCall('/api/inventory/bundles/intake', {
                            method: 'POST',
                            body: requestBody
                        });
                        if (res.ok) {
                            const data = await res.json();
                            this.showBundleDetailModal = false;
                            this.showBundleModal = false;
                            this.showToast(`${this.selectedBundle.name} ÂÖ•Â∫´ÊàêÂäü (${data.total_items} È†ÖÁâ©Ë≥á)`, 'success');
                            await this.loadInventory();
                        } else {
                            const err = await res.json();
                            this.showToast(err.detail || 'ÂÖ•Â∫´Â§±Êïó', 'error');
                        }
                    } catch (e) { this.showToast('Êìç‰ΩúÂ§±Êïó', 'error'); }
                },

                // Bundle Management (Admin)
                openBundleManage() {
                    this.showBundleManageModal = true;
                },

                startCreateBundle() {
                    this.editingBundle = null;
                    this.bundleForm = { name: '', description: '', icon: 'backpack', items: [] };
                    this.showBundleManageModal = false;
                    this.showBundleEditModal = true;
                },

                startEditBundle(bundle) {
                    this.editingBundle = bundle;
                    // Convert emoji icon to heroicon id if needed
                    let iconId = bundle.icon || 'backpack';
                    if (iconId.length > 10 || /[\u{1F300}-\u{1F9FF}]/u.test(iconId)) {
                        iconId = 'backpack'; // Default if old emoji format
                    }
                    this.bundleForm = {
                        name: bundle.name,
                        description: bundle.description || '',
                        icon: iconId,
                        items: JSON.parse(JSON.stringify(bundle.items || []))
                    };
                    this.showBundleManageModal = false;
                    this.showBundleEditModal = true;
                },

                addBundleItem() {
                    if (!this.newBundleItem.name) {
                        this.showToast('Ë´ãËº∏ÂÖ•Áâ©Ë≥áÂêçÁ®±', 'error');
                        return;
                    }
                    this.bundleForm.items.push({...this.newBundleItem});
                    this.newBundleItem = { name: '', specification: '', category: 'other', quantity: 1, unit: 'ÂÄã' };
                },

                removeBundleItem(index) {
                    this.bundleForm.items.splice(index, 1);
                },

                moveBundleItem(index, direction) {
                    const newIndex = index + direction;
                    if (newIndex < 0 || newIndex >= this.bundleForm.items.length) return;
                    const items = [...this.bundleForm.items];
                    const [item] = items.splice(index, 1);
                    items.splice(newIndex, 0, item);
                    this.bundleForm.items = items;
                },

                // Get bundle icon SVG path by id
                getBundleIconPath(iconId) {
                    const icon = this.bundleIconOptions.find(i => i.id === iconId);
                    return icon ? icon.path : this.bundleIconOptions[0].path;
                },

                async saveBundle() {
                    if (!this.bundleForm.name) {
                        this.showToast('Ë´ãËº∏ÂÖ•ÁµÑÂ•óÂêçÁ®±', 'error');
                        return;
                    }
                    if (this.bundleForm.items.length === 0) {
                        this.showToast('Ë´ãËá≥Â∞ëÊñ∞Â¢û‰∏ÄÈ†ÖÁâ©Ë≥á', 'error');
                        return;
                    }

                    try {
                        let res;
                        if (this.editingBundle) {
                            // Update existing
                            res = await this.apiCall(`/api/inventory/bundles/${this.editingBundle.id}`, {
                                method: 'PUT',
                                body: this.bundleForm
                            });
                        } else {
                            // Create new
                            res = await this.apiCall('/api/inventory/bundles', {
                                method: 'POST',
                                body: this.bundleForm
                            });
                        }

                        if (res.ok) {
                            this.showBundleEditModal = false;
                            this.showToast(this.editingBundle ? 'ÁµÑÂ•óÊõ¥Êñ∞ÊàêÂäü' : 'ÁµÑÂ•óÂª∫Á´ãÊàêÂäü', 'success');
                            await this.loadBundles();
                            this.showBundleManageModal = true;
                        } else {
                            const err = await res.json();
                            this.showToast(err.detail || 'ÂÑ≤Â≠òÂ§±Êïó', 'error');
                        }
                    } catch (e) { this.showToast('Êìç‰ΩúÂ§±Êïó', 'error'); }
                },

                confirmDeleteBundle(bundle) {
                    this.deleteTarget = bundle;
                    this.deleteType = 'bundle';
                    this.showDeleteConfirmModal = true;
                },

                async doDeleteBundle() {
                    try {
                        const res = await this.apiCall(`/api/inventory/bundles/${this.deleteTarget.id}`, {
                            method: 'DELETE'
                        });
                        if (res.ok) {
                            this.showDeleteConfirmModal = false;
                            this.showToast('ÁµÑÂ•óÂà™Èô§ÊàêÂäü', 'success');
                            await this.loadBundles();
                        } else {
                            const err = await res.json();
                            this.showToast(err.detail || 'Âà™Èô§Â§±Êïó', 'error');
                        }
                    } catch (e) { this.showToast('Êìç‰ΩúÂ§±Êïó', 'error'); }
                },

                // Equipment operations
                startEquipmentCheck(eq) {
                    this.checkTarget = eq;
                    this.equipmentCheckForm = { status: eq.check_status || 'OK', notes: '' };
                    this.showEquipmentCheckModal = true;
                },

                async doEquipmentCheck() {
                    try {
                        const res = await this.apiCall(`/api/inventory/${this.checkTarget.id}/check`, {
                            method: 'POST',
                            body: this.equipmentCheckForm
                        });
                        if (res.ok) {
                            this.showEquipmentCheckModal = false;
                            this.showToast('Ê™¢Êü•ÂÆåÊàê', 'success');
                            await this.loadEquipment();
                            await this.loadEquipmentPending();
                            await this.loadStats();
                        }
                    } catch (e) { this.showToast('Êìç‰ΩúÂ§±Êïó', 'error'); }
                },

                async doAddEquipment() {
                    if (!this.newEquipment.name) {
                        this.showToast('Ë´ãËº∏ÂÖ•ÂêçÁ®±', 'error');
                        return;
                    }
                    try {
                        const res = await this.apiCall('/api/inventory', {
                            method: 'POST',
                            body: {
                                ...this.newEquipment,
                                category: 'equipment',
                                check_status: 'OK'
                            }
                        });
                        if (res.ok) {
                            this.showAddEquipmentModal = false;
                            this.newEquipment = { name: '', specification: '', quantity: 1, unit: 'Âè∞', location: '', check_interval_days: 1 };
                            this.showToast('Êñ∞Â¢ûÊàêÂäü', 'success');
                            await this.loadEquipment();
                            await this.loadEquipmentPending();
                        }
                    } catch (e) { this.showToast('Êìç‰ΩúÂ§±Êïó', 'error'); }
                },

                startEditEquipment(eq) {
                    this.editEquipment = {
                        id: eq.id,
                        name: eq.name,
                        specification: eq.specification || '',
                        quantity: eq.quantity,
                        unit: eq.unit || 'Âè∞',
                        location: eq.location || '',
                        check_interval_days: eq.check_interval_days || 1
                    };
                    this.showEditEquipmentModal = true;
                },

                async doEditEquipment() {
                    if (!this.editEquipment.name) {
                        this.showToast('Ë´ãËº∏ÂÖ•ÂêçÁ®±', 'error');
                        return;
                    }
                    try {
                        const res = await this.apiCall(`/api/inventory/${this.editEquipment.id}`, {
                            method: 'PUT',
                            body: {
                                name: this.editEquipment.name,
                                specification: this.editEquipment.specification,
                                quantity: this.editEquipment.quantity,
                                unit: this.editEquipment.unit,
                                location: this.editEquipment.location,
                                check_interval_days: this.editEquipment.check_interval_days
                            }
                        });
                        if (res.ok) {
                            this.showEditEquipmentModal = false;
                            this.showToast('Êõ¥Êñ∞ÊàêÂäü', 'success');
                            await this.loadEquipment();
                            await this.loadEquipmentPending();
                        } else {
                            const err = await res.json();
                            this.showToast(err.detail || 'Êõ¥Êñ∞Â§±Êïó', 'error');
                        }
                    } catch (e) { this.showToast('Êìç‰ΩúÂ§±Êïó', 'error'); }
                },

                confirmDeleteEquipment(eq) {
                    this.deleteTarget = eq;
                    this.deleteType = 'equipment';
                    this.showDeleteConfirmModal = true;
                },

                async doDelete() {
                    // Handle bundle deletion separately
                    if (this.deleteType === 'bundle') {
                        await this.doDeleteBundle();
                        return;
                    }

                    try {
                        const endpoint = this.deleteType === 'message'
                            ? `/api/messages/${this.deleteTarget.id}`
                            : `/api/inventory/${this.deleteTarget.id}`;
                        const res = await this.apiCall(endpoint, {
                            method: 'DELETE'
                        });
                        if (res.ok) {
                            this.showDeleteConfirmModal = false;
                            this.showToast('Âà™Èô§ÊàêÂäü', 'success');
                            if (this.deleteType === 'equipment') {
                                await this.loadEquipment();
                                await this.loadEquipmentPending();
                            } else if (this.deleteType === 'message') {
                                await this.loadMessages();
                            }
                        } else {
                            const err = await res.json();
                            this.showToast(err.detail || 'Âà™Èô§Â§±Êïó', 'error');
                        }
                    } catch (e) { this.showToast('Êìç‰ΩúÂ§±Êïó', 'error'); }
                },

                // Messages
                async doAddMessage() {
                    if (!this.newMessage.content) {
                        this.showToast('Ë´ãËº∏ÂÖ•ÂÖßÂÆπ', 'error');
                        return;
                    }
                    try {
                        const res = await fetch('/api/messages', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.newMessage)
                        });
                        if (res.ok) {
                            this.showAddMessage = false;
                            this.newMessage = { category: 'general', content: '', author_name: '' };
                            this.showToast('ÁôºÂ∏ÉÊàêÂäü', 'success');
                            await this.loadMessages();
                        }
                    } catch (e) { this.showToast('Êìç‰ΩúÂ§±Êïó', 'error'); }
                },

                startReply(msg) {
                    this.replyTarget = msg;
                    this.replyForm = { content: '', author_name: '' };
                    this.showReplyModal = true;
                },

                async doReply() {
                    if (!this.replyForm.content) {
                        this.showToast('Ë´ãËº∏ÂÖ•ÂÖßÂÆπ', 'error');
                        return;
                    }
                    try {
                        const res = await fetch(`/api/messages/${this.replyTarget.id}/reply`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.replyForm)
                        });
                        if (res.ok) {
                            this.showReplyModal = false;
                            this.replyForm = { content: '', author_name: '' };
                            this.showToast('ÂõûË¶ÜÊàêÂäü', 'success');
                            await this.loadMessages();
                        } else {
                            const err = await res.json();
                            this.showToast(err.detail || 'ÂõûË¶ÜÂ§±Êïó', 'error');
                        }
                    } catch (e) { this.showToast('Êìç‰ΩúÂ§±Êïó', 'error'); }
                },

                confirmDeleteMessage(msg) {
                    this.deleteTarget = msg;
                    this.deleteType = 'message';
                    this.showDeleteConfirmModal = true;
                },

                async toggleMessageResolved(msg) {
                    try {
                        const res = await this.apiCall(`/api/messages/${msg.id}/resolve`, {
                            method: 'POST',
                            body: { is_resolved: !msg.is_resolved }
                        });
                        if (res.ok) {
                            this.showToast(msg.is_resolved ? 'Â∑≤ÂèñÊ∂àËß£Ê±∫' : 'Â∑≤Ê®ôÁÇ∫Ëß£Ê±∫', 'success');
                            await this.loadMessages();
                        }
                    } catch (e) { this.showToast('Êìç‰ΩúÂ§±Êïó', 'error'); }
                },

                async toggleMessagePinned(msg) {
                    try {
                        const res = await this.apiCall(`/api/messages/${msg.id}/pin`, {
                            method: 'POST',
                            body: { is_pinned: !msg.is_pinned }
                        });
                        if (res.ok) {
                            this.showToast(msg.is_pinned ? 'Â∑≤ÂèñÊ∂àÁΩÆÈ†Ç' : 'Â∑≤ÁΩÆÈ†Ç', 'success');
                            await this.loadMessages();
                        }
                    } catch (e) { this.showToast('Êìç‰ΩúÂ§±Êïó', 'error'); }
                },

                // Helpers
                getCategoryName(cat) {
                    const names = { 'seek_person': 'Â∞ã‰∫∫', 'seek_item': 'Â∞ãÁâ©', 'offer_help': '‰∫íÂä©', 'report': 'ÂõûÂ†±', 'general': '‰∏ÄËà¨' };
                    return names[cat] || '‰∏ÄËà¨';
                },

                getCheckStatusText(status) {
                    const texts = { 'OK': 'Ê≠£Â∏∏', 'NEEDS_REPAIR': 'ÂæÖ‰øÆ', 'OUT_OF_SERVICE': 'ÂÅúÁî®' };
                    return texts[status] || 'Êú™Ê™¢Êü•';
                },

                formatTime(isoStr) {
                    if (!isoStr) return '';
                    const d = new Date(isoStr);
                    const now = new Date();
                    const diff = (now - d) / 1000;
                    if (diff < 60) return 'ÂâõÂâõ';
                    if (diff < 3600) return `${Math.floor(diff/60)} ÂàÜÈêòÂâç`;
                    if (diff < 86400) return `${Math.floor(diff/3600)} Â∞èÊôÇÂâç`;
                    return `${Math.floor(diff/86400)} Â§©Ââç`;
                },

                showToast(message, type = 'success') {
                    this.toast = { show: true, message, type };
                    setTimeout(() => this.toast.show = false, 3000);
                }
            };
        }
    </script>
</body>
</html>
