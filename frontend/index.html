<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#4c826b">
    <title>CIRS - 社區韌性物資管理</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="assets/icons/icon-192.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            100: '#eaf3d7',
                            400: '#a6c3ac',
                            600: '#4c826b',
                            700: '#3d6a58',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        [x-cloak] { display: none !important; }
        .tab-active { background-color: #4c826b; color: white; }
        .bottom-nav { padding-bottom: env(safe-area-inset-bottom); }
        .card-press:active { transform: scale(0.98); }
        input, select, textarea { font-size: 16px !important; }
    </style>
</head>
<body class="bg-gray-50" x-data="cirsApp()" x-init="init()">
    <!-- Top Bar -->
    <header class="bg-primary-600 text-white px-4 py-3 sticky top-0 z-40 shadow-md">
        <div class="flex items-center justify-between max-w-lg mx-auto">
            <div class="flex items-center">
                <a href="/portal" class="mr-3 flex items-center bg-white/20 rounded-lg px-2 py-1 hover:bg-white/30">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                    <span class="text-sm ml-1">首頁</span>
                </a>
                <h1 class="text-lg font-semibold" x-text="pageTitle">CIRS</h1>
            </div>
            <div class="flex items-center space-x-3">
                <template x-if="currentUser">
                    <div class="flex items-center space-x-2">
                        <span class="text-sm bg-primary-700 px-2 py-1 rounded" x-text="currentUser.display_name"></span>
                        <button @click="logout()" class="text-xs opacity-75 hover:opacity-100">登出</button>
                    </div>
                </template>
                <template x-if="!currentUser">
                    <button @click="showLoginModal = true" class="text-sm bg-primary-700 px-2 py-1 rounded">登入</button>
                </template>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="pb-20 max-w-lg mx-auto">
        <!-- Global Stats Bar (Gray) -->
        <div class="bg-gray-100 px-4 py-3 border-b border-gray-200">
            <div class="flex justify-around text-center max-w-lg mx-auto">
                <div>
                    <p class="text-2xl font-bold text-gray-700" x-text="stats.headcount?.total || 0"></p>
                    <p class="text-xs text-gray-500">收容人數</p>
                </div>
                <div>
                    <p class="text-2xl font-bold text-gray-700" x-text="stats.inventory_total || 0"></p>
                    <p class="text-xs text-gray-500">物資品項</p>
                </div>
                <div>
                    <p class="text-2xl font-bold text-gray-700" x-text="stats.equipment_ok || 0"></p>
                    <p class="text-xs text-gray-500">設備正常</p>
                </div>
                <div>
                    <p class="text-2xl font-bold text-gray-700" x-text="stats.messages_today || 0"></p>
                    <p class="text-xs text-gray-500">今日留言</p>
                </div>
            </div>
        </div>

        <!-- ==================== 人員 Tab ==================== -->
        <div x-show="currentTab === 'people'" x-cloak class="p-4">
            <!-- Quick Check-in Card -->
            <div class="bg-white rounded-xl p-4 shadow-sm mb-4 border-2 border-primary-400" x-show="currentUser">
                <h3 class="font-semibold mb-3 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/>
                    </svg>
                    快速報到
                </h3>
                <div class="space-y-3">
                    <input type="text" x-model="newPerson.display_name" placeholder="姓名 *" class="w-full border border-gray-200 rounded-lg px-3 py-2">
                    <div class="grid grid-cols-2 gap-2">
                        <input type="text" x-model="newPerson.national_id" placeholder="身分證 (選填)" class="border border-gray-200 rounded-lg px-3 py-2 uppercase" maxlength="10">
                        <input type="tel" x-model="newPerson.phone" placeholder="電話 (選填)" class="border border-gray-200 rounded-lg px-3 py-2">
                    </div>
                    <!-- 區域選擇 -->
                    <div class="relative">
                        <select x-model="newPerson.current_location" class="w-full border border-gray-200 rounded-lg px-3 py-2 appearance-none bg-white">
                            <option value="">選擇區域 (選填)</option>
                            <optgroup label="收容區">
                                <template x-for="z in zones.filter(z => z.zone_type === 'shelter')" :key="z.id">
                                    <option :value="z.id" x-text="z.name"></option>
                                </template>
                            </optgroup>
                            <optgroup label="醫療區">
                                <template x-for="z in zones.filter(z => z.zone_type === 'medical')" :key="z.id">
                                    <option :value="z.id" x-text="z.name"></option>
                                </template>
                            </optgroup>
                            <optgroup label="服務區">
                                <template x-for="z in zones.filter(z => z.zone_type === 'service')" :key="z.id">
                                    <option :value="z.id" x-text="z.name"></option>
                                </template>
                            </optgroup>
                        </select>
                        <svg class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </div>
                    <!-- Photo capture for unidentified persons -->
                    <div x-show="!newPerson.national_id" class="border border-dashed border-gray-300 rounded-lg p-3">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm text-gray-600">無法辨識身分時拍照</span>
                            <button type="button" @click="capturePhoto()" class="text-xs bg-blue-500 text-white px-3 py-1 rounded-lg">
                                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                                拍照
                            </button>
                        </div>
                        <div x-show="newPerson.photo_data" class="mb-2">
                            <img :src="newPerson.photo_data" class="w-24 h-24 object-cover rounded-lg mx-auto">
                            <button @click="newPerson.photo_data = ''" class="text-xs text-red-500 block mx-auto mt-1">移除照片</button>
                        </div>
                        <input type="text" x-model="newPerson.physical_desc" placeholder="外觀特徵描述 (選填)" class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm">
                    </div>
                    <!-- Triage Selection (light bg + dark text, like filter tags) -->
                    <div class="grid grid-cols-4 gap-2">
                        <button @click="newPerson.triage_status = 'GREEN'" :class="newPerson.triage_status === 'GREEN' ? 'bg-green-500 text-white' : 'bg-green-100 text-green-700'" class="rounded-lg py-2 text-sm font-medium">輕傷</button>
                        <button @click="newPerson.triage_status = 'YELLOW'" :class="newPerson.triage_status === 'YELLOW' ? 'bg-yellow-500 text-white' : 'bg-yellow-100 text-yellow-700'" class="rounded-lg py-2 text-sm font-medium">延遲</button>
                        <button @click="newPerson.triage_status = 'RED'" :class="newPerson.triage_status === 'RED' ? 'bg-red-500 text-white' : 'bg-red-100 text-red-700'" class="rounded-lg py-2 text-sm font-medium">立即</button>
                        <button @click="newPerson.triage_status = 'BLACK'" :class="newPerson.triage_status === 'BLACK' ? 'bg-gray-800 text-white' : 'bg-gray-200 text-gray-700'" class="rounded-lg py-2 text-sm font-medium">死亡</button>
                    </div>
                    <button @click="doQuickCheckIn()" class="w-full bg-primary-600 text-white rounded-lg py-2 font-medium">報到登記</button>
                    <p class="text-xs text-gray-400 text-center">無身分證時系統自動產生序號</p>
                </div>
            </div>

            <!-- Section Divider -->
            <div class="relative mb-4" x-show="currentUser">
                <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-300"></div></div>
                <div class="relative flex justify-center"><span class="bg-gray-50 px-3 text-sm text-gray-500">搜尋人員</span></div>
            </div>

            <!-- Zone Overview (Collapsible) -->
            <div class="bg-white rounded-xl shadow-sm mb-4 overflow-hidden">
                <!-- Header Row: 展開按鈕左側，管理按鈕右側 -->
                <div class="flex items-center justify-between px-4 py-3 border-b border-gray-100">
                    <!-- 左側：展開按鈕 -->
                    <button @click="showZoneOverview = !showZoneOverview" class="flex items-center text-left hover:text-primary-600 transition">
                        <svg class="w-5 h-5 mr-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                        </svg>
                        <span class="font-semibold">區域總覽</span>
                        <span class="ml-2 text-xs text-gray-500" x-text="zones.length + ' 區'"></span>
                        <svg class="w-4 h-4 ml-1 text-gray-400 transition-transform" :class="showZoneOverview ? 'rotate-180' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>
                    <!-- 右側：管理按鈕 (獨立) -->
                    <button x-show="currentUser && currentUser.role === 'admin'"
                            @click="openZoneManageModal()"
                            class="flex items-center text-xs bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 py-1.5 rounded-lg transition">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                        管理
                    </button>
                </div>
                <div x-show="showZoneOverview" x-collapse class="px-4 pb-4 pt-3">
                    <!-- Zone Type Tabs (單色風格) -->
                    <div class="flex space-x-1 mb-3 overflow-x-auto">
                        <button @click="zoneTypeFilter = ''" :class="zoneTypeFilter === '' ? 'bg-primary-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'" class="px-3 py-1 rounded-full text-xs whitespace-nowrap transition">全部</button>
                        <button @click="zoneTypeFilter = 'shelter'" :class="zoneTypeFilter === 'shelter' ? 'bg-primary-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'" class="px-3 py-1 rounded-full text-xs whitespace-nowrap transition">收容區</button>
                        <button @click="zoneTypeFilter = 'medical'" :class="zoneTypeFilter === 'medical' ? 'bg-primary-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'" class="px-3 py-1 rounded-full text-xs whitespace-nowrap transition">醫療區</button>
                        <button @click="zoneTypeFilter = 'service'" :class="zoneTypeFilter === 'service' ? 'bg-primary-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'" class="px-3 py-1 rounded-full text-xs whitespace-nowrap transition">服務區</button>
                        <button @click="zoneTypeFilter = 'restricted'" :class="zoneTypeFilter === 'restricted' ? 'bg-primary-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'" class="px-3 py-1 rounded-full text-xs whitespace-nowrap transition">管制區</button>
                    </div>
                    <!-- Zone Cards Grid (單色 + heroicon) -->
                    <div class="grid grid-cols-2 gap-2">
                        <template x-for="zone in filteredZones" :key="zone.id">
                            <div @click="filterByZone(zone.id)" class="bg-gray-50 rounded-lg p-3 cursor-pointer hover:bg-gray-100 transition"
                                 :class="zoneFilter === zone.id ? 'ring-2 ring-primary-500 bg-primary-50' : ''">
                                <div class="flex items-center mb-1">
                                    <!-- Zone Icon (heroicon based on zone.icon) -->
                                    <span class="w-5 h-5 mr-2 text-gray-500 flex-shrink-0" x-html="getZoneIcon(zone.icon)"></span>
                                    <span class="font-medium text-sm truncate" x-text="zone.name"></span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-lg font-bold text-gray-700" x-text="zone.current_count || 0"></span>
                                    <span x-show="zone.capacity > 0" class="text-xs text-gray-400" x-text="'/' + zone.capacity"></span>
                                </div>
                                <!-- Capacity Bar (單色：primary) -->
                                <div x-show="zone.capacity > 0" class="mt-1 h-1 bg-gray-200 rounded-full overflow-hidden">
                                    <div class="h-full bg-primary-500 rounded-full transition-all"
                                         :style="'width: ' + Math.min(100, (zone.current_count || 0) / zone.capacity * 100) + '%'"></div>
                                </div>
                            </div>
                        </template>
                    </div>
                    <!-- Batch Move Button -->
                    <button x-show="currentUser && selectedPeople.length > 0"
                            @click="openBatchMoveModal()"
                            class="w-full mt-3 bg-primary-600 text-white rounded-lg py-2 text-sm font-medium flex items-center justify-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
                        </svg>
                        移動 <span x-text="selectedPeople.length"></span> 人
                    </button>
                </div>
            </div>

            <!-- Search -->
            <div class="flex space-x-2 mb-4">
                <input type="text" x-model="peopleSearch" placeholder="搜尋姓名/ID..." class="flex-1 bg-white border border-gray-200 rounded-lg px-3 py-2">
            </div>

            <!-- Triage Filter with Stats -->
            <div class="flex space-x-2 mb-4 overflow-x-auto">
                <button @click="triageFilter = ''" :class="triageFilter === '' ? 'bg-primary-600 text-white' : 'bg-white text-gray-700 border'" class="px-3 py-1.5 rounded-full text-sm whitespace-nowrap font-medium">
                    全部 <span class="ml-1 opacity-75" x-text="stats.headcount?.total || 0"></span>
                </button>
                <button @click="triageFilter = 'GREEN'" :class="triageFilter === 'GREEN' ? 'bg-green-500 text-white' : 'bg-green-100 text-green-700'" class="px-3 py-1.5 rounded-full text-sm whitespace-nowrap font-medium">
                    輕傷 <span class="ml-1 opacity-75" x-text="stats.headcount?.green || 0"></span>
                </button>
                <button @click="triageFilter = 'YELLOW'" :class="triageFilter === 'YELLOW' ? 'bg-yellow-500 text-white' : 'bg-yellow-100 text-yellow-700'" class="px-3 py-1.5 rounded-full text-sm whitespace-nowrap font-medium">
                    延遲 <span class="ml-1 opacity-75" x-text="stats.headcount?.yellow || 0"></span>
                </button>
                <button @click="triageFilter = 'RED'" :class="triageFilter === 'RED' ? 'bg-red-500 text-white' : 'bg-red-100 text-red-700'" class="px-3 py-1.5 rounded-full text-sm whitespace-nowrap font-medium">
                    立即 <span class="ml-1 opacity-75" x-text="stats.headcount?.red || 0"></span>
                </button>
                <button @click="triageFilter = 'BLACK'" :class="triageFilter === 'BLACK' ? 'bg-gray-800 text-white' : 'bg-gray-200 text-gray-700'" class="px-3 py-1.5 rounded-full text-sm whitespace-nowrap font-medium">
                    死亡 <span class="ml-1 opacity-75" x-text="stats.headcount?.black || 0"></span>
                </button>
            </div>

            <!-- People List Header with Select All -->
            <div x-show="currentUser" class="flex items-center justify-between mb-2">
                <button @click="selectAllFiltered()" class="text-xs text-primary-600 flex items-center">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    全選/取消
                </button>
                <span x-show="selectedPeople.length > 0" class="text-xs text-gray-500">
                    已選 <span class="font-semibold text-primary-600" x-text="selectedPeople.length"></span> 人
                    <button @click="openBatchMoveModal()" class="ml-2 text-primary-600 underline">移動</button>
                </span>
            </div>

            <!-- People List -->
            <div class="space-y-2">
                <template x-for="person in filteredPeople" :key="person.id">
                    <div class="bg-white rounded-xl p-3 shadow-sm flex items-center"
                         :class="selectedPeople.includes(person.id) ? 'ring-2 ring-primary-500' : ''">
                        <!-- Checkbox for selection -->
                        <input x-show="currentUser" type="checkbox"
                               :checked="selectedPeople.includes(person.id)"
                               @change="togglePersonSelect(person.id)"
                               class="w-4 h-4 mr-2 rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold mr-3"
                             :class="{
                                 'bg-green-500': person.triage_status === 'GREEN',
                                 'bg-yellow-500': person.triage_status === 'YELLOW',
                                 'bg-red-500': person.triage_status === 'RED',
                                 'bg-gray-800': person.triage_status === 'BLACK',
                                 'bg-gray-300': !person.triage_status
                             }">
                            <span x-text="person.display_name?.charAt(0) || '?'"></span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h4 class="font-semibold truncate" x-text="person.display_name"></h4>
                            <p class="text-xs text-gray-500 truncate">
                                <span x-text="person.id"></span>
                                <span x-show="person.current_location" class="ml-1">· <span x-text="zones.find(z => z.id === person.current_location)?.name || person.current_location"></span></span>
                            </p>
                        </div>
                        <div class="flex items-center space-x-1">
                            <!-- MIRS Link for RED/YELLOW patients -->
                            <a x-show="person.triage_status === 'RED' || person.triage_status === 'YELLOW'"
                               :href="'/mirs/#patient/' + person.id"
                               class="text-blue-600 p-2 bg-blue-50 rounded-lg"
                               title="查看 MIRS 處置記錄">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                            </a>
                            <!-- Triage Button -->
                            <button @click="startTriage(person)" x-show="currentUser && (currentUser.role === 'admin' || currentUser.role === 'medic')" class="text-primary-600 p-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </template>
                <p x-show="filteredPeople.length === 0" class="text-center text-gray-400 py-8">無人員資料</p>
            </div>

            <!-- Zone Filter Clear Button -->
            <div x-show="zoneFilter" class="mt-4 text-center">
                <button @click="zoneFilter = ''" class="text-sm text-primary-600 underline">
                    清除區域篩選
                </button>
            </div>
        </div>

        <!-- ==================== 物資 Tab ==================== -->
        <div x-show="currentTab === 'inventory'" x-cloak class="p-4 pb-28">

            <!-- Expiry Alerts -->
            <div x-show="expiringItems.length > 0" class="bg-amber-50 rounded-xl p-3 border border-amber-200 mb-4">
                <h4 class="font-semibold text-amber-800 text-sm mb-2 flex items-center">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    即將到期
                </h4>
                <div class="space-y-1">
                    <template x-for="item in expiringItems.slice(0, 3)" :key="item.id">
                        <p class="text-xs text-amber-700">
                            <span x-text="item.name"></span>
                            <span x-show="item.specification" class="text-amber-500">(<span x-text="item.specification"></span>)</span>
                            - <span x-text="item.expiry_date"></span>
                        </p>
                    </template>
                </div>
            </div>

            <!-- Low Stock Alerts -->
            <div x-show="stats.inventory_alerts?.length > 0" class="bg-red-50 rounded-xl p-3 border border-red-200 mb-4">
                <h4 class="font-semibold text-red-800 text-sm mb-2 flex items-center">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                    庫存不足
                </h4>
                <div class="space-y-1">
                    <template x-for="alert in stats.inventory_alerts?.slice(0, 3)" :key="alert.id">
                        <p class="text-xs text-red-700">
                            <span x-text="alert.name"></span>: 剩 <span class="font-medium" x-text="alert.quantity"></span> <span x-text="alert.unit || '個'"></span>
                        </p>
                    </template>
                </div>
            </div>

            <!-- Search & Filter -->
            <div class="flex space-x-2 mb-3">
                <input type="text" x-model="inventorySearch" placeholder="搜尋物資..." class="flex-1 bg-white border border-gray-200 rounded-lg px-3 py-2">
                <button @click="showAddInventoryModal = true" x-show="currentUser" class="bg-primary-600 text-white px-3 py-2 rounded-lg">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                </button>
            </div>

            <!-- Category Filter -->
            <div class="flex space-x-2 overflow-x-auto pb-2 mb-3">
                <button @click="inventoryCategory = ''" :class="inventoryCategory === '' ? 'bg-primary-600 text-white' : 'bg-white text-gray-700'" class="px-3 py-1 rounded-full text-sm whitespace-nowrap">全部</button>
                <button @click="inventoryCategory = 'water'" :class="inventoryCategory === 'water' ? 'bg-primary-600 text-white' : 'bg-white text-gray-700'" class="px-3 py-1 rounded-full text-sm whitespace-nowrap">水</button>
                <button @click="inventoryCategory = 'food'" :class="inventoryCategory === 'food' ? 'bg-primary-600 text-white' : 'bg-white text-gray-700'" class="px-3 py-1 rounded-full text-sm whitespace-nowrap">食物</button>
                <button @click="inventoryCategory = 'medical'" :class="inventoryCategory === 'medical' ? 'bg-primary-600 text-white' : 'bg-white text-gray-700'" class="px-3 py-1 rounded-full text-sm whitespace-nowrap">醫療</button>
                <button @click="inventoryCategory = 'power'" :class="inventoryCategory === 'power' ? 'bg-primary-600 text-white' : 'bg-white text-gray-700'" class="px-3 py-1 rounded-full text-sm whitespace-nowrap">電力</button>
                <button @click="inventoryCategory = 'daily'" :class="inventoryCategory === 'daily' ? 'bg-primary-600 text-white' : 'bg-white text-gray-700'" class="px-3 py-1 rounded-full text-sm whitespace-nowrap">日用品</button>
            </div>

            <!-- Inventory List -->
            <div class="space-y-2">
                <template x-for="item in filteredInventory" :key="item.id">
                    <div class="bg-white rounded-xl p-3 shadow-sm" :class="item.quantity < item.min_quantity && item.min_quantity > 0 ? 'border-l-4 border-red-500' : ''">
                        <div class="flex justify-between items-start">
                            <div class="flex-1 min-w-0">
                                <h4 class="font-semibold truncate">
                                    <span x-text="item.name"></span>
                                    <span x-show="item.specification" class="text-gray-500 font-normal text-sm">(<span x-text="item.specification"></span>)</span>
                                </h4>
                                <p class="text-sm text-gray-600">
                                    <span class="font-medium" x-text="item.quantity"></span> <span x-text="item.unit || '個'"></span>
                                    <span x-show="item.location" class="text-gray-400 ml-2">· <span x-text="item.location"></span></span>
                                </p>
                                <p x-show="item.expiry_date" class="text-xs text-gray-400">
                                    效期: <span x-text="item.expiry_date"></span>
                                </p>
                            </div>
                            <div class="flex space-x-1" x-show="currentUser">
                                <button @click="quickIntake(item)" class="text-emerald-600 p-1.5 bg-emerald-50 rounded-lg">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                    </svg>
                                </button>
                                <button @click="startDistribute(item)" class="text-orange-600 p-1.5 bg-orange-50 rounded-lg">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </template>
                <p x-show="filteredInventory.length === 0" class="text-center text-gray-400 py-8">無物資資料</p>
            </div>

            <!-- Fixed Bottom Buttons for Inventory -->
            <div x-show="currentUser && currentTab === 'inventory'" class="fixed bottom-16 left-0 right-0 bg-white border-t border-gray-200 px-4 py-3 z-40">
                <div class="grid grid-cols-3 gap-2 max-w-lg mx-auto">
                    <button @click="showIntakeModal = true" class="rounded-xl py-3 text-center card-press shadow-sm font-medium" style="background-color: #4c826b; color: white;">
                        <svg class="w-5 h-5 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        入庫
                    </button>
                    <button @click="openBundleModal()" class="rounded-xl py-3 text-center card-press shadow-sm font-medium" style="background-color: #e0f2f1; color: #00695c;">
                        <svg class="w-5 h-5 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                        </svg>
                        組套
                    </button>
                    <button @click="showDistributeSelectModal = true" class="rounded-xl py-3 text-center card-press shadow-sm font-medium" style="background-color: #fee39a; color: #333;">
                        <svg class="w-5 h-5 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"/>
                        </svg>
                        發放
                    </button>
                </div>
            </div>
        </div>

        <!-- ==================== 設備 Tab ==================== -->
        <div x-show="currentTab === 'equipment'" x-cloak class="p-4">
            <!-- Equipment Stats Summary -->
            <div class="grid grid-cols-3 gap-2 mb-4">
                <div class="bg-green-50 rounded-xl p-3 text-center border border-green-200">
                    <p class="text-2xl font-bold text-green-700" x-text="equipment.filter(e => e.check_status === 'OK').length"></p>
                    <p class="text-xs text-green-600">正常</p>
                </div>
                <div class="bg-yellow-50 rounded-xl p-3 text-center border border-yellow-200">
                    <p class="text-2xl font-bold text-yellow-700" x-text="equipment.filter(e => e.check_status === 'NEEDS_REPAIR').length"></p>
                    <p class="text-xs text-yellow-600">待修</p>
                </div>
                <div class="bg-red-50 rounded-xl p-3 text-center border border-red-200">
                    <p class="text-2xl font-bold text-red-700" x-text="equipment.filter(e => e.check_status === 'OUT_OF_SERVICE').length"></p>
                    <p class="text-xs text-red-600">停用</p>
                </div>
            </div>

            <!-- Pending Checks Alert -->
            <div x-show="equipmentPending.length > 0" class="bg-orange-50 rounded-xl p-4 border border-orange-200 mb-4">
                <h3 class="font-semibold text-orange-800 mb-2 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    待檢設備 (<span x-text="equipmentPending.length"></span>)
                </h3>
                <div class="space-y-2">
                    <template x-for="eq in equipmentPending" :key="eq.id">
                        <div class="bg-white rounded-lg p-3 flex items-center justify-between">
                            <div>
                                <p class="font-medium" x-text="eq.name"></p>
                                <p class="text-xs text-gray-500">
                                    上次檢查: <span x-text="eq.last_check_date || '從未'"></span>
                                </p>
                            </div>
                            <button @click="startEquipmentCheck(eq)" x-show="currentUser" class="bg-primary-600 text-white px-3 py-1.5 rounded-lg text-sm">
                                檢查
                            </button>
                        </div>
                    </template>
                </div>
            </div>

            <!-- All Equipment -->
            <h3 class="font-semibold mb-3">所有設備</h3>
            <div class="space-y-2">
                <template x-for="eq in equipment" :key="eq.id">
                    <div class="bg-white rounded-xl p-3 shadow-sm">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-semibold">
                                    <span x-text="eq.name"></span>
                                    <span x-show="eq.specification" class="text-gray-500 font-normal text-sm">(<span x-text="eq.specification"></span>)</span>
                                </h4>
                                <p class="text-sm text-gray-600">
                                    數量: <span x-text="eq.quantity"></span> <span x-text="eq.unit || '台'"></span>
                                    <span x-show="eq.location" class="text-gray-400">· <span x-text="eq.location"></span></span>
                                </p>
                                <div class="flex items-center mt-1 text-xs">
                                    <span class="px-2 py-0.5 rounded-full mr-2"
                                          :class="{
                                              'bg-green-100 text-green-700': eq.check_status === 'OK',
                                              'bg-yellow-100 text-yellow-700': eq.check_status === 'NEEDS_REPAIR',
                                              'bg-red-100 text-red-700': eq.check_status === 'OUT_OF_SERVICE',
                                              'bg-gray-100 text-gray-500': !eq.check_status
                                          }"
                                          x-text="getCheckStatusText(eq.check_status)"></span>
                                    <span class="text-gray-400">
                                        檢查週期: <span x-text="eq.check_interval_days || '-'"></span>天
                                    </span>
                                </div>
                            </div>
                            <div class="flex space-x-1" x-show="currentUser">
                                <button @click="startEquipmentCheck(eq)" class="text-primary-600 p-1.5 bg-primary-50 rounded-lg" title="檢查">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                </button>
                                <button @click="startEditEquipment(eq)" class="text-blue-600 p-1.5 bg-blue-50 rounded-lg" title="編輯">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                    </svg>
                                </button>
                                <button @click="confirmDeleteEquipment(eq)" x-show="currentUser.role === 'admin'" class="text-red-600 p-1.5 bg-red-50 rounded-lg" title="刪除">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </template>
                <p x-show="equipment.length === 0" class="text-center text-gray-400 py-8">無設備資料</p>
            </div>

            <!-- Add Equipment Button -->
            <button @click="showAddEquipmentModal = true" x-show="currentUser" class="fixed bottom-24 right-4 w-14 h-14 bg-primary-600 text-white rounded-full shadow-lg flex items-center justify-center">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
            </button>
        </div>

        <!-- ==================== 留言板 Tab ==================== -->
        <div x-show="currentTab === 'messages'" x-cloak class="p-4">
            <!-- Broadcast -->
            <div x-show="broadcast" class="bg-amber-50 border-l-4 border-amber-400 p-3 rounded-r-lg mb-4">
                <div class="flex items-start">
                    <svg class="w-5 h-5 text-amber-600 mt-0.5 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"/>
                    </svg>
                    <div>
                        <p class="text-sm font-medium text-amber-800">公告</p>
                        <p class="text-sm text-amber-700" x-text="broadcast"></p>
                    </div>
                </div>
            </div>

            <!-- Category Filter -->
            <div class="flex space-x-2 overflow-x-auto pb-2 mb-4">
                <button @click="messageCategory = ''" :class="messageCategory === '' ? 'bg-primary-600 text-white' : 'bg-white text-gray-700'" class="px-3 py-1 rounded-full text-sm whitespace-nowrap">全部</button>
                <button @click="messageCategory = 'seek_person'" :class="messageCategory === 'seek_person' ? 'bg-primary-600 text-white' : 'bg-white text-gray-700'" class="px-3 py-1 rounded-full text-sm whitespace-nowrap">尋人</button>
                <button @click="messageCategory = 'offer_help'" :class="messageCategory === 'offer_help' ? 'bg-primary-600 text-white' : 'bg-white text-gray-700'" class="px-3 py-1 rounded-full text-sm whitespace-nowrap">互助</button>
                <button @click="messageCategory = 'report'" :class="messageCategory === 'report' ? 'bg-primary-600 text-white' : 'bg-white text-gray-700'" class="px-3 py-1 rounded-full text-sm whitespace-nowrap">回報</button>
            </div>

            <!-- Messages List -->
            <div class="space-y-3 mb-20">
                <template x-for="msg in filteredMessages" :key="msg.id">
                    <div class="bg-white rounded-xl p-4 shadow-sm" :class="msg.is_resolved ? 'opacity-60' : ''">
                        <div class="flex items-start justify-between mb-2">
                            <span class="text-xs px-2 py-0.5 rounded-full"
                                  :class="{
                                      'bg-blue-100 text-blue-700': msg.category === 'seek_person',
                                      'bg-green-100 text-green-700': msg.category === 'offer_help',
                                      'bg-amber-100 text-amber-700': msg.category === 'report',
                                      'bg-gray-100 text-gray-700': !msg.category || msg.category === 'general'
                                  }"
                                  x-text="getCategoryName(msg.category)"></span>
                            <div class="flex items-center space-x-2">
                                <span x-show="msg.is_resolved" class="text-xs text-green-600">已解決</span>
                                <!-- Admin Controls -->
                                <template x-if="currentUser && currentUser.role === 'admin'">
                                    <div class="flex space-x-1">
                                        <button @click="toggleMessageResolved(msg)" class="text-xs px-2 py-1 rounded" :class="msg.is_resolved ? 'bg-gray-100 text-gray-600' : 'bg-green-100 text-green-600'">
                                            <span x-text="msg.is_resolved ? '取消解決' : '標為已解決'"></span>
                                        </button>
                                        <button @click="confirmDeleteMessage(msg)" class="text-red-500 p-1">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                            </svg>
                                        </button>
                                    </div>
                                </template>
                            </div>
                        </div>
                        <p class="text-gray-800" x-text="msg.content"></p>
                        <div class="flex justify-between items-center mt-2 text-xs text-gray-400">
                            <span x-text="msg.author_name || '匿名'"></span>
                            <div class="flex items-center space-x-2">
                                <span x-text="formatTime(msg.created_at)"></span>
                                <button @click="startReply(msg)" class="text-primary-600 hover:underline">回覆</button>
                            </div>
                        </div>
                        <!-- Replies -->
                        <div x-show="msg.replies && msg.replies.length > 0" class="mt-3 pt-3 border-t border-gray-100 space-y-2">
                            <template x-for="reply in msg.replies" :key="reply.id">
                                <div class="bg-gray-50 rounded-lg p-2 text-sm">
                                    <p class="text-gray-700" x-text="reply.content"></p>
                                    <p class="text-xs text-gray-400 mt-1"><span x-text="reply.author_name || '匿名'"></span> · <span x-text="formatTime(reply.created_at)"></span></p>
                                </div>
                            </template>
                        </div>
                    </div>
                </template>
                <p x-show="filteredMessages.length === 0" class="text-center text-gray-400 py-8">暫無留言</p>
            </div>

            <!-- New Message FAB -->
            <button @click="showAddMessage = true" class="fixed bottom-24 right-4 w-14 h-14 bg-primary-600 text-white rounded-full shadow-lg flex items-center justify-center">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
            </button>
        </div>
    </main>

    <!-- Bottom Navigation (4 tabs) -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 bottom-nav z-50">
        <div class="flex justify-around max-w-lg mx-auto">
            <button @click="switchTab('people')" :class="currentTab === 'people' ? 'text-primary-600' : 'text-gray-400'" class="flex-1 py-3 flex flex-col items-center">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                <span class="text-xs mt-1">人員</span>
            </button>
            <button @click="switchTab('inventory')" :class="currentTab === 'inventory' ? 'text-primary-600' : 'text-gray-400'" class="flex-1 py-3 flex flex-col items-center">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                </svg>
                <span class="text-xs mt-1">物資</span>
            </button>
            <button @click="switchTab('equipment')" :class="currentTab === 'equipment' ? 'text-primary-600' : 'text-gray-400'" class="flex-1 py-3 flex flex-col items-center">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                <span class="text-xs mt-1">設備</span>
            </button>
            <button @click="switchTab('messages')" :class="currentTab === 'messages' ? 'text-primary-600' : 'text-gray-400'" class="flex-1 py-3 flex flex-col items-center">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                </svg>
                <span class="text-xs mt-1">留言板</span>
            </button>
        </div>
    </nav>

    <!-- ==================== Modals ==================== -->

    <!-- Login Modal -->
    <div x-show="showLoginModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showLoginModal = false">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-semibold mb-4">登入</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-600 mb-1">使用者 ID</label>
                    <input type="text" x-model="loginForm.person_id" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="admin001">
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">PIN</label>
                    <input type="password" x-model="loginForm.pin" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="****" inputmode="numeric" maxlength="6">
                </div>
                <p x-show="loginError" class="text-red-500 text-sm" x-text="loginError"></p>
                <div class="flex space-x-3">
                    <button @click="showLoginModal = false" class="flex-1 px-4 py-2 border border-gray-200 rounded-lg">取消</button>
                    <button @click="doLogin()" class="flex-1 px-4 py-2 bg-primary-600 text-white rounded-lg">登入</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Triage Modal -->
    <div x-show="showTriageModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showTriageModal = false">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-semibold mb-4">檢傷分類: <span x-text="triageTarget?.display_name"></span></h3>
            <div class="grid grid-cols-2 gap-3 mb-4">
                <button @click="doTriage('GREEN')" class="bg-green-500 text-white rounded-xl p-6 text-center">
                    <span class="text-2xl font-bold">輕傷</span>
                    <p class="text-sm opacity-80">Minor</p>
                </button>
                <button @click="doTriage('YELLOW')" class="bg-yellow-500 text-white rounded-xl p-6 text-center">
                    <span class="text-2xl font-bold">延遲</span>
                    <p class="text-sm opacity-80">Delayed</p>
                </button>
                <button @click="doTriage('RED')" class="bg-red-500 text-white rounded-xl p-6 text-center">
                    <span class="text-2xl font-bold">立即</span>
                    <p class="text-sm opacity-80">Immediate</p>
                </button>
                <button @click="doTriage('BLACK')" class="bg-gray-800 text-white rounded-xl p-6 text-center">
                    <span class="text-2xl font-bold">死亡</span>
                    <p class="text-sm opacity-80">Deceased</p>
                </button>
            </div>
            <button @click="showTriageModal = false" class="w-full px-4 py-2 border border-gray-200 rounded-lg">取消</button>
        </div>
    </div>

    <!-- Intake Modal -->
    <div x-show="showIntakeModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showIntakeModal = false">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm max-h-[90vh] overflow-hidden flex flex-col">
            <h3 class="text-lg font-semibold mb-4">入庫</h3>
            <div class="space-y-4 overflow-y-auto flex-1">
                <div>
                    <label class="block text-sm text-gray-600 mb-1">搜尋並選擇物資</label>
                    <input type="text" x-model="intakeSearch" placeholder="輸入名稱搜尋..."
                           class="w-full border border-gray-200 rounded-lg px-3 py-2 mb-2 text-sm">
                    <div class="max-h-32 overflow-y-auto border border-gray-200 rounded-lg">
                        <template x-for="item in inventory.filter(i => i.category !== 'equipment' && (!intakeSearch || i.name.toLowerCase().includes(intakeSearch.toLowerCase())))" :key="item.id">
                            <button @click="intakeForm.item_id = item.id; intakeSearch = ''"
                                    class="w-full px-3 py-2 text-left text-sm hover:bg-gray-50 border-b border-gray-100 last:border-0"
                                    :class="intakeForm.item_id === item.id ? 'bg-primary-50 text-primary-700' : ''">
                                <span x-text="item.name + (item.specification ? ' (' + item.specification + ')' : '')"></span>
                                <span class="text-gray-400 ml-1">庫存: <span x-text="item.quantity"></span></span>
                            </button>
                        </template>
                        <p x-show="inventory.filter(i => i.category !== 'equipment' && (!intakeSearch || i.name.toLowerCase().includes(intakeSearch.toLowerCase()))).length === 0"
                           class="text-center text-gray-400 py-2 text-xs">沒有符合的物資</p>
                    </div>
                    <p x-show="intakeForm.item_id" class="text-xs text-primary-600 mt-1">
                        已選: <span x-text="inventory.find(i => i.id === intakeForm.item_id)?.name || ''"></span>
                    </p>
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">入庫數量</label>
                    <div class="flex items-center space-x-3">
                        <button @click="intakeForm.quantity = Math.max(1, intakeForm.quantity - 1)" class="w-10 h-10 bg-gray-100 rounded-lg text-lg">-</button>
                        <input type="number" x-model.number="intakeForm.quantity" class="flex-1 border border-gray-200 rounded-lg px-3 py-2 text-center" min="1">
                        <button @click="intakeForm.quantity++" class="w-10 h-10 bg-gray-100 rounded-lg text-lg">+</button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">備註</label>
                    <input type="text" x-model="intakeForm.notes" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="選填">
                </div>
                <div class="flex space-x-3">
                    <button @click="showIntakeModal = false" class="flex-1 px-4 py-2 border border-gray-200 rounded-lg">取消</button>
                    <button @click="doIntake()" class="flex-1 px-4 py-2 bg-primary-600 text-white rounded-lg">確認入庫</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Distribute Select Modal -->
    <div x-show="showDistributeSelectModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showDistributeSelectModal = false">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm max-h-[85vh] flex flex-col">
            <h3 class="text-lg font-semibold mb-3">選擇發放物資</h3>
            <!-- 搜尋欄 -->
            <input type="text" x-model="distributeSearch" placeholder="搜尋物資名稱..."
                   class="w-full border border-gray-200 rounded-lg px-3 py-2 mb-3 text-sm"
                   @input="$event.target.focus()">
            <div class="space-y-2 overflow-y-auto flex-1">
                <template x-for="item in inventory.filter(i => i.category !== 'equipment' && i.quantity > 0 && (!distributeSearch || i.name.toLowerCase().includes(distributeSearch.toLowerCase())))" :key="item.id">
                    <button @click="startDistribute(item); showDistributeSelectModal = false; distributeSearch = ''" class="w-full bg-gray-50 hover:bg-gray-100 rounded-lg p-3 text-left">
                        <p class="font-medium" x-text="item.name + (item.specification ? ' (' + item.specification + ')' : '')"></p>
                        <p class="text-sm text-gray-500">庫存: <span x-text="item.quantity"></span> <span x-text="item.unit || '個'"></span></p>
                    </button>
                </template>
                <p x-show="inventory.filter(i => i.category !== 'equipment' && i.quantity > 0 && (!distributeSearch || i.name.toLowerCase().includes(distributeSearch.toLowerCase()))).length === 0"
                   class="text-center text-gray-400 py-4 text-sm">沒有符合的物資</p>
            </div>
            <button @click="showDistributeSelectModal = false; distributeSearch = ''" class="w-full mt-4 px-4 py-2 border border-gray-200 rounded-lg">取消</button>
        </div>
    </div>

    <!-- Distribute Modal -->
    <div x-show="showDistributeModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showDistributeModal = false">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-semibold mb-4">發放: <span x-text="distributeItem?.name"></span></h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-600 mb-1">領取人 ID</label>
                    <input type="text" x-model="distributeForm.person_id" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="輸入 ID">
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">數量 (庫存: <span x-text="distributeItem?.quantity"></span>)</label>
                    <div class="flex items-center space-x-3">
                        <button @click="distributeForm.quantity = Math.max(1, distributeForm.quantity - 1)" class="w-10 h-10 bg-gray-100 rounded-lg">-</button>
                        <input type="number" x-model.number="distributeForm.quantity" class="flex-1 border border-gray-200 rounded-lg px-3 py-2 text-center" min="1">
                        <button @click="distributeForm.quantity++" class="w-10 h-10 bg-gray-100 rounded-lg">+</button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">備註</label>
                    <input type="text" x-model="distributeForm.notes" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="選填">
                </div>
                <div class="flex space-x-3">
                    <button @click="showDistributeModal = false" class="flex-1 px-4 py-2 border border-gray-200 rounded-lg">取消</button>
                    <button @click="doDistribute()" class="flex-1 px-4 py-2 bg-primary-600 text-white rounded-lg">確認發放</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Inventory Modal -->
    <div x-show="showAddInventoryModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showAddInventoryModal = false">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-semibold mb-4">新增物資</h3>
            <div class="space-y-3">
                <div>
                    <label class="block text-sm text-gray-600 mb-1">名稱 *</label>
                    <input type="text" x-model="newInventory.name" @input="checkSimilarItems()" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="例: 礦泉水">
                </div>
                <!-- Similar Items Suggestion -->
                <div x-show="similarItems.length > 0" class="bg-blue-50 rounded-lg p-3">
                    <p class="text-sm text-blue-700 mb-2">找到類似物資，是否直接入庫？</p>
                    <template x-for="si in similarItems" :key="si.id">
                        <button @click="quickIntake(si); showAddInventoryModal = false" class="w-full bg-white rounded p-2 mb-1 text-left text-sm hover:bg-blue-100">
                            <span x-text="si.name"></span>
                            <span x-show="si.specification" class="text-gray-500">(<span x-text="si.specification"></span>)</span>
                            - <span x-text="si.quantity"></span> <span x-text="si.unit || '個'"></span>
                        </button>
                    </template>
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">規格</label>
                    <input type="text" x-model="newInventory.specification" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="例: 600ml, 5公斤裝">
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">分類 *</label>
                    <select x-model="newInventory.category" class="w-full border border-gray-200 rounded-lg px-3 py-2">
                        <option value="water">水</option>
                        <option value="food">食物</option>
                        <option value="medical">醫療</option>
                        <option value="power">電力</option>
                        <option value="daily">日用品</option>
                        <option value="other">其他</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">數量</label>
                        <input type="number" x-model.number="newInventory.quantity" class="w-full border border-gray-200 rounded-lg px-3 py-2" min="0">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">單位</label>
                        <input type="text" x-model="newInventory.unit" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="瓶/箱/個">
                    </div>
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">位置</label>
                    <input type="text" x-model="newInventory.location" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="倉庫A">
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">效期</label>
                    <input type="date" x-model="newInventory.expiry_date" class="w-full border border-gray-200 rounded-lg px-3 py-2">
                </div>
                <div class="flex space-x-3">
                    <button @click="showAddInventoryModal = false" class="flex-1 px-4 py-2 border border-gray-200 rounded-lg">取消</button>
                    <button @click="doAddInventory()" class="flex-1 px-4 py-2 bg-primary-600 text-white rounded-lg">新增</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Equipment Check Modal -->
    <div x-show="showEquipmentCheckModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showEquipmentCheckModal = false">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-semibold mb-4">設備檢查: <span x-text="checkTarget?.name"></span></h3>
            <div class="space-y-4">
                <div class="grid grid-cols-3 gap-2">
                    <button @click="equipmentCheckForm.status = 'OK'" :class="equipmentCheckForm.status === 'OK' ? 'ring-2 ring-green-500' : ''" class="bg-green-100 text-green-700 rounded-xl p-4 text-center">
                        <svg class="w-8 h-8 mx-auto mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        <span class="text-sm font-medium">正常</span>
                    </button>
                    <button @click="equipmentCheckForm.status = 'NEEDS_REPAIR'" :class="equipmentCheckForm.status === 'NEEDS_REPAIR' ? 'ring-2 ring-yellow-500' : ''" class="bg-yellow-100 text-yellow-700 rounded-xl p-4 text-center">
                        <svg class="w-8 h-8 mx-auto mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                        <span class="text-sm font-medium">待修</span>
                    </button>
                    <button @click="equipmentCheckForm.status = 'OUT_OF_SERVICE'" :class="equipmentCheckForm.status === 'OUT_OF_SERVICE' ? 'ring-2 ring-red-500' : ''" class="bg-red-100 text-red-700 rounded-xl p-4 text-center">
                        <svg class="w-8 h-8 mx-auto mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                        <span class="text-sm font-medium">停用</span>
                    </button>
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">備註</label>
                    <input type="text" x-model="equipmentCheckForm.notes" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="選填">
                </div>
                <div class="flex space-x-3">
                    <button @click="showEquipmentCheckModal = false" class="flex-1 px-4 py-2 border border-gray-200 rounded-lg">取消</button>
                    <button @click="doEquipmentCheck()" class="flex-1 px-4 py-2 bg-primary-600 text-white rounded-lg">確認</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Equipment Modal -->
    <div x-show="showAddEquipmentModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showAddEquipmentModal = false">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-semibold mb-4">新增設備</h3>
            <div class="space-y-3">
                <div>
                    <label class="block text-sm text-gray-600 mb-1">名稱 *</label>
                    <input type="text" x-model="newEquipment.name" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="例: 發電機">
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">規格</label>
                    <input type="text" x-model="newEquipment.specification" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="例: 3kW">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">數量</label>
                        <input type="number" x-model.number="newEquipment.quantity" class="w-full border border-gray-200 rounded-lg px-3 py-2" min="1" value="1">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">單位</label>
                        <input type="text" x-model="newEquipment.unit" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="台">
                    </div>
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">位置</label>
                    <input type="text" x-model="newEquipment.location" class="w-full border border-gray-200 rounded-lg px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">檢查週期 (天)</label>
                    <input type="number" x-model.number="newEquipment.check_interval_days" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="1 = 每日檢查" min="1">
                </div>
                <div class="flex space-x-3">
                    <button @click="showAddEquipmentModal = false" class="flex-1 px-4 py-2 border border-gray-200 rounded-lg">取消</button>
                    <button @click="doAddEquipment()" class="flex-1 px-4 py-2 bg-primary-600 text-white rounded-lg">新增</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Equipment Modal -->
    <div x-show="showEditEquipmentModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showEditEquipmentModal = false">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-semibold mb-4">編輯設備</h3>
            <div class="space-y-3">
                <div>
                    <label class="block text-sm text-gray-600 mb-1">名稱 *</label>
                    <input type="text" x-model="editEquipment.name" class="w-full border border-gray-200 rounded-lg px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">規格</label>
                    <input type="text" x-model="editEquipment.specification" class="w-full border border-gray-200 rounded-lg px-3 py-2">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">數量</label>
                        <input type="number" x-model.number="editEquipment.quantity" class="w-full border border-gray-200 rounded-lg px-3 py-2" min="1">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">單位</label>
                        <input type="text" x-model="editEquipment.unit" class="w-full border border-gray-200 rounded-lg px-3 py-2">
                    </div>
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">位置</label>
                    <input type="text" x-model="editEquipment.location" class="w-full border border-gray-200 rounded-lg px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">檢查週期 (天)</label>
                    <input type="number" x-model.number="editEquipment.check_interval_days" class="w-full border border-gray-200 rounded-lg px-3 py-2" min="1">
                </div>
                <div class="flex space-x-3">
                    <button @click="showEditEquipmentModal = false" class="flex-1 px-4 py-2 border border-gray-200 rounded-lg">取消</button>
                    <button @click="doEditEquipment()" class="flex-1 px-4 py-2 bg-primary-600 text-white rounded-lg">儲存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div x-show="showDeleteConfirmModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showDeleteConfirmModal = false">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-semibold mb-2 text-red-600">確認刪除</h3>
            <p class="text-gray-600 mb-4">確定要刪除「<span x-text="deleteTarget?.name"></span>」嗎？此操作無法復原。</p>
            <div class="flex space-x-3">
                <button @click="showDeleteConfirmModal = false" class="flex-1 px-4 py-2 border border-gray-200 rounded-lg">取消</button>
                <button @click="doDelete()" class="flex-1 px-4 py-2 bg-red-500 text-white rounded-lg">刪除</button>
            </div>
        </div>
    </div>

    <!-- Add Message Modal -->
    <div x-show="showAddMessage" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showAddMessage = false">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-semibold mb-4">發布留言</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-600 mb-1">分類</label>
                    <select x-model="newMessage.category" class="w-full border border-gray-200 rounded-lg px-3 py-2">
                        <option value="general">一般</option>
                        <option value="seek_person">尋人</option>
                        <option value="seek_item">尋物</option>
                        <option value="offer_help">互助</option>
                        <option value="report">狀況回報</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">內容 *</label>
                    <textarea x-model="newMessage.content" class="w-full border border-gray-200 rounded-lg px-3 py-2 h-24" placeholder="輸入留言內容..."></textarea>
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">顯示名稱</label>
                    <input type="text" x-model="newMessage.author_name" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="匿名">
                </div>
                <div class="flex space-x-3">
                    <button @click="showAddMessage = false" class="flex-1 px-4 py-2 border border-gray-200 rounded-lg">取消</button>
                    <button @click="doAddMessage()" class="flex-1 px-4 py-2 bg-primary-600 text-white rounded-lg">發布</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reply Modal -->
    <div x-show="showReplyModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showReplyModal = false">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-semibold mb-2">回覆留言</h3>
            <p class="text-sm text-gray-500 mb-4 truncate" x-text="replyTarget?.content"></p>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-600 mb-1">回覆內容 *</label>
                    <textarea x-model="replyForm.content" class="w-full border border-gray-200 rounded-lg px-3 py-2 h-24" placeholder="輸入回覆內容..."></textarea>
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">顯示名稱</label>
                    <input type="text" x-model="replyForm.author_name" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="匿名">
                </div>
                <div class="flex space-x-3">
                    <button @click="showReplyModal = false" class="flex-1 px-4 py-2 border border-gray-200 rounded-lg">取消</button>
                    <button @click="doReply()" class="flex-1 px-4 py-2 bg-primary-600 text-white rounded-lg">回覆</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bundle Select Modal (組套選擇) -->
    <div x-show="showBundleModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showBundleModal = false">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm max-h-[80vh] overflow-hidden flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">選擇組套入庫</h3>
                <button x-show="currentUser && currentUser.role === 'admin'" @click="showBundleModal = false; openBundleManage()" class="text-xs text-primary-600 hover:underline">管理組套</button>
            </div>
            <div class="space-y-2 overflow-y-auto flex-1">
                <template x-for="bundle in bundles" :key="bundle.id">
                    <button @click="selectBundle(bundle)" class="w-full bg-gray-50 hover:bg-primary-50 rounded-xl p-4 text-left transition-colors border border-gray-100 hover:border-primary-200">
                        <div class="flex items-center">
                            <div class="w-10 h-10 mr-3 bg-primary-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                <svg class="w-6 h-6 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path :d="getBundleIconPath(bundle.icon)" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <p class="font-medium text-gray-800" x-text="bundle.name"></p>
                                <p class="text-sm text-gray-500" x-text="bundle.description"></p>
                                <p class="text-xs text-gray-400 mt-1">
                                    包含 <span x-text="bundle.items?.length || 0"></span> 項物資
                                </p>
                            </div>
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                        </div>
                    </button>
                </template>
                <p x-show="bundles.length === 0" class="text-center text-gray-400 py-8">無組套資料</p>
            </div>
            <button @click="showBundleModal = false" class="w-full mt-4 px-4 py-2 border border-gray-200 rounded-lg">取消</button>
        </div>
    </div>

    <!-- Bundle Manage Modal (組套管理 - Admin) -->
    <div x-show="showBundleManageModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showBundleManageModal = false">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm max-h-[80vh] overflow-hidden flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">管理組套</h3>
                <button @click="startCreateBundle()" class="bg-primary-600 text-white px-3 py-1 rounded-lg text-sm">新增組套</button>
            </div>
            <div class="space-y-2 overflow-y-auto flex-1">
                <template x-for="bundle in bundles" :key="bundle.id">
                    <div class="bg-gray-50 rounded-xl p-4 border border-gray-100">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center flex-1 min-w-0">
                                <div class="w-10 h-10 mr-3 bg-primary-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                    <svg class="w-6 h-6 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path :d="getBundleIconPath(bundle.icon)" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/>
                                    </svg>
                                </div>
                                <div class="min-w-0">
                                    <p class="font-medium text-gray-800 truncate" x-text="bundle.name"></p>
                                    <p class="text-xs text-gray-400"><span x-text="bundle.items?.length || 0"></span> 項物資</p>
                                </div>
                            </div>
                            <div class="flex space-x-1 ml-2">
                                <button @click="startEditBundle(bundle)" class="text-blue-600 p-1.5 bg-blue-50 rounded-lg" title="編輯">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                    </svg>
                                </button>
                                <button @click="confirmDeleteBundle(bundle)" class="text-red-600 p-1.5 bg-red-50 rounded-lg" title="刪除">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </template>
                <p x-show="bundles.length === 0" class="text-center text-gray-400 py-8">尚無組套，點擊上方新增</p>
            </div>
            <button @click="showBundleManageModal = false" class="w-full mt-4 px-4 py-2 border border-gray-200 rounded-lg">關閉</button>
        </div>
    </div>

    <!-- Zone Manage Modal (區域管理 - Admin) -->
    <div x-show="showZoneManageModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showZoneManageModal = false">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md max-h-[85vh] overflow-hidden flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">區域管理</h3>
                <button @click="showZoneManageModal = false" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <!-- New Zone Form -->
            <div class="bg-gray-50 rounded-xl p-4 mb-4">
                <h4 class="font-medium text-sm mb-3">新增區域</h4>
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <input type="text" x-model="newZone.id" placeholder="區域代碼 *" class="border border-gray-200 rounded-lg px-3 py-2 text-sm">
                    <input type="text" x-model="newZone.name" placeholder="區域名稱 *" class="border border-gray-200 rounded-lg px-3 py-2 text-sm">
                </div>
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <select x-model="newZone.zone_type" class="border border-gray-200 rounded-lg px-3 py-2 text-sm">
                        <option value="shelter">收容區域</option>
                        <option value="medical">醫療區域</option>
                        <option value="service">服務區域</option>
                        <option value="restricted">管制區域</option>
                    </select>
                    <input type="number" x-model="newZone.capacity" placeholder="容量 (0=無限)" class="border border-gray-200 rounded-lg px-3 py-2 text-sm" min="0">
                </div>
                <input type="text" x-model="newZone.description" placeholder="說明 (選填)" class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm mb-2">
                <button @click="createZone()" class="w-full bg-primary-600 text-white rounded-lg py-2 text-sm font-medium">新增區域</button>
            </div>

            <!-- Zone List -->
            <div class="space-y-2 overflow-y-auto flex-1">
                <template x-for="zoneType in ['shelter', 'medical', 'service', 'restricted']" :key="zoneType">
                    <div>
                        <h4 class="text-xs font-semibold text-gray-500 uppercase mb-2 flex items-center">
                            <span :class="{
                                'bg-blue-100 text-blue-600': zoneType === 'shelter',
                                'bg-red-100 text-red-600': zoneType === 'medical',
                                'bg-green-100 text-green-600': zoneType === 'service',
                                'bg-gray-200 text-gray-600': zoneType === 'restricted'
                            }" class="px-2 py-0.5 rounded mr-2" x-text="zoneTypeLabels[zoneType]"></span>
                        </h4>
                        <template x-for="zone in zones.filter(z => z.zone_type === zoneType)" :key="zone.id">
                            <div class="bg-white border border-gray-100 rounded-lg p-3 mb-2 flex items-center justify-between">
                                <div class="flex-1 min-w-0">
                                    <p class="font-medium text-sm truncate" x-text="zone.name"></p>
                                    <p class="text-xs text-gray-400">
                                        <span x-text="zone.id"></span>
                                        <span x-show="zone.capacity > 0"> · 容量: <span x-text="zone.capacity"></span></span>
                                    </p>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span class="text-sm font-semibold text-primary-600" x-text="zone.current_count || 0"></span>
                                    <button @click="deleteZone(zone.id)" class="text-red-500 p-1.5 hover:bg-red-50 rounded-lg" title="刪除">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </template>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <!-- Batch Move Modal (批次移動人員) -->
    <div x-show="showBatchMoveModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showBatchMoveModal = false">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-semibold mb-4">批次移動人員</h3>
            <p class="text-sm text-gray-600 mb-4">
                將 <span class="font-semibold text-primary-600" x-text="selectedPeople.length"></span> 人移動至...
            </p>

            <!-- Target Zone Selection -->
            <div class="space-y-2 max-h-60 overflow-y-auto mb-4">
                <template x-for="zone in zones" :key="zone.id">
                    <label class="flex items-center p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition"
                           :class="batchMoveForm.target_zone_id === zone.id ? 'ring-2 ring-primary-500 bg-primary-50' : ''">
                        <input type="radio" name="target_zone" :value="zone.id" x-model="batchMoveForm.target_zone_id" class="mr-3">
                        <div class="flex-1">
                            <p class="font-medium text-sm" x-text="zone.name"></p>
                            <p class="text-xs text-gray-400">
                                <span x-text="zone.current_count || 0"></span>
                                <span x-show="zone.capacity > 0">/<span x-text="zone.capacity"></span></span>
                            </p>
                        </div>
                        <span class="text-xs px-2 py-0.5 rounded"
                              :class="{
                                  'bg-blue-100 text-blue-600': zone.zone_type === 'shelter',
                                  'bg-red-100 text-red-600': zone.zone_type === 'medical',
                                  'bg-green-100 text-green-600': zone.zone_type === 'service',
                                  'bg-gray-200 text-gray-600': zone.zone_type === 'restricted'
                              }"
                              x-text="zoneTypeLabels[zone.zone_type]"></span>
                    </label>
                </template>
            </div>

            <!-- Notes -->
            <input type="text" x-model="batchMoveForm.notes" placeholder="備註 (選填)" class="w-full border border-gray-200 rounded-lg px-3 py-2 mb-4 text-sm">

            <!-- Actions -->
            <div class="grid grid-cols-2 gap-2">
                <button @click="showBatchMoveModal = false" class="px-4 py-2 border border-gray-200 rounded-lg">取消</button>
                <button @click="doBatchMove()" class="px-4 py-2 bg-primary-600 text-white rounded-lg font-medium">確認移動</button>
            </div>
        </div>
    </div>

    <!-- Bundle Edit Modal (新增/編輯組套) -->
    <div x-show="showBundleEditModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showBundleEditModal = false">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md max-h-[90vh] overflow-hidden flex flex-col">
            <h3 class="text-lg font-semibold mb-4" x-text="editingBundle ? '編輯組套' : '新增組套'"></h3>

            <div class="space-y-3 overflow-y-auto flex-1">
                <!-- Basic Info -->
                <div>
                    <label class="block text-xs text-gray-600 mb-1">名稱 *</label>
                    <input type="text" x-model="bundleForm.name" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="例: 防災包">
                </div>
                <div>
                    <label class="block text-xs text-gray-600 mb-1">說明</label>
                    <input type="text" x-model="bundleForm.description" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="例: 標準緊急避難包">
                </div>

                <!-- Icon Selector (heroicon grid) -->
                <div>
                    <label class="block text-xs text-gray-600 mb-2">選擇圖示</label>
                    <div class="grid grid-cols-8 gap-1.5">
                        <template x-for="icon in bundleIconOptions" :key="icon.id">
                            <button type="button"
                                    @click="bundleForm.icon = icon.id"
                                    class="p-2 rounded-lg border-2 transition flex items-center justify-center"
                                    :class="bundleForm.icon === icon.id ? 'border-primary-600 bg-primary-100' : 'border-gray-200 hover:border-gray-300'"
                                    :title="icon.name">
                                <svg class="w-5 h-5" :class="bundleForm.icon === icon.id ? 'text-primary-600' : 'text-gray-500'" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path :d="icon.path" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/>
                                </svg>
                            </button>
                        </template>
                    </div>
                </div>

                <!-- Items List with move buttons and quantity edit -->
                <div class="border-t pt-3">
                    <p class="text-sm font-medium text-gray-700 mb-2">物資清單 (<span x-text="bundleForm.items.length"></span> 項)</p>
                    <div class="space-y-1 max-h-40 overflow-y-auto mb-3">
                        <template x-for="(item, idx) in bundleForm.items" :key="idx">
                            <div class="flex items-center bg-gray-50 rounded-lg px-2 py-2 text-sm">
                                <!-- Move buttons -->
                                <div class="flex flex-col mr-2">
                                    <button @click="moveBundleItem(idx, -1)" :disabled="idx === 0"
                                            class="text-gray-400 hover:text-gray-600 disabled:opacity-30 disabled:cursor-not-allowed p-0.5">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                                        </svg>
                                    </button>
                                    <button @click="moveBundleItem(idx, 1)" :disabled="idx === bundleForm.items.length - 1"
                                            class="text-gray-400 hover:text-gray-600 disabled:opacity-30 disabled:cursor-not-allowed p-0.5">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                        </svg>
                                    </button>
                                </div>
                                <span class="flex-1 truncate">
                                    <span x-text="item.name"></span>
                                    <span x-show="item.specification" class="text-gray-400">(<span x-text="item.specification"></span>)</span>
                                </span>
                                <!-- Quantity editor -->
                                <div class="flex items-center mx-2">
                                    <button @click="item.quantity = Math.max(1, item.quantity - 1)"
                                            class="w-5 h-5 bg-gray-200 rounded text-xs flex items-center justify-center hover:bg-gray-300">-</button>
                                    <input type="number" x-model.number="item.quantity" min="1"
                                           class="w-10 text-center text-sm border-0 bg-transparent mx-1">
                                    <button @click="item.quantity++"
                                            class="w-5 h-5 bg-gray-200 rounded text-xs flex items-center justify-center hover:bg-gray-300">+</button>
                                </div>
                                <button @click="removeBundleItem(idx)" class="text-red-500 p-1">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                    </svg>
                                </button>
                            </div>
                        </template>
                        <p x-show="bundleForm.items.length === 0" class="text-xs text-gray-400 text-center py-2">尚無物資</p>
                    </div>

                    <!-- Add Item Form -->
                    <div class="bg-primary-100 rounded-xl p-3">
                        <p class="text-xs font-medium text-primary-700 mb-2">新增物資</p>
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <input type="text" x-model="newBundleItem.name" class="border border-gray-200 rounded-lg px-2 py-1.5 text-sm bg-white" placeholder="名稱 *">
                            <input type="text" x-model="newBundleItem.specification" class="border border-gray-200 rounded-lg px-2 py-1.5 text-sm bg-white" placeholder="規格">
                        </div>
                        <div class="grid grid-cols-4 gap-2 mb-2">
                            <select x-model="newBundleItem.category" class="col-span-2 border border-gray-200 rounded-lg px-2 py-1.5 text-sm bg-white">
                                <option value="water">水</option>
                                <option value="food">食物</option>
                                <option value="medical">醫療</option>
                                <option value="power">電力</option>
                                <option value="daily">日用品</option>
                                <option value="equipment">設備</option>
                                <option value="other">其他</option>
                            </select>
                            <input type="number" x-model.number="newBundleItem.quantity" class="border border-gray-200 rounded-lg px-2 py-1.5 text-sm text-center bg-white" min="1" placeholder="數量">
                            <input type="text" x-model="newBundleItem.unit" class="border border-gray-200 rounded-lg px-2 py-1.5 text-sm bg-white" placeholder="單位">
                        </div>
                        <button @click="addBundleItem()" class="w-full bg-primary-600 text-white rounded-lg py-1.5 text-sm font-medium">+ 加入物資</button>
                    </div>
                </div>
            </div>

            <div class="flex space-x-3 mt-4 pt-3 border-t">
                <button @click="showBundleEditModal = false; showBundleManageModal = true" class="flex-1 px-4 py-2 border border-gray-200 rounded-lg">取消</button>
                <button @click="saveBundle()" class="flex-1 px-4 py-2 bg-primary-600 text-white rounded-lg font-medium">儲存</button>
            </div>
        </div>
    </div>

    <!-- Bundle Detail Modal (組套詳情與入庫) -->
    <div x-show="showBundleDetailModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showBundleDetailModal = false">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm max-h-[85vh] overflow-hidden flex flex-col">
            <div class="flex items-center mb-4">
                <div class="w-12 h-12 mr-3 bg-primary-100 rounded-xl flex items-center justify-center">
                    <svg class="w-7 h-7 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path :d="getBundleIconPath(selectedBundle?.icon)" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/>
                    </svg>
                </div>
                <div>
                    <h3 class="text-lg font-semibold" x-text="selectedBundle?.name"></h3>
                    <p class="text-sm text-gray-500" x-text="selectedBundle?.description"></p>
                </div>
            </div>

            <!-- Bundle Items List -->
            <div class="bg-gray-50 rounded-xl p-3 mb-4 max-h-48 overflow-y-auto">
                <p class="text-xs text-gray-500 mb-2 font-medium">包含物資：</p>
                <div class="space-y-1">
                    <template x-for="(item, idx) in selectedBundle?.items || []" :key="idx">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-700">
                                <span x-text="item.name"></span>
                                <span x-show="item.specification" class="text-gray-400">(<span x-text="item.specification"></span>)</span>
                            </span>
                            <span class="text-gray-500">
                                <span x-text="item.quantity"></span> <span x-text="item.unit || '個'"></span>
                            </span>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Multiplier & Location -->
            <div class="space-y-3 mb-4">
                <div>
                    <label class="block text-sm text-gray-600 mb-1">入庫套數</label>
                    <div class="flex items-center space-x-3">
                        <button @click="bundleIntakeForm.multiplier = Math.max(1, bundleIntakeForm.multiplier - 1)" class="w-10 h-10 bg-gray-100 rounded-lg text-lg font-medium">-</button>
                        <input type="number" x-model.number="bundleIntakeForm.multiplier" class="flex-1 border border-gray-200 rounded-lg px-3 py-2 text-center text-lg font-medium" min="1">
                        <button @click="bundleIntakeForm.multiplier++" class="w-10 h-10 bg-gray-100 rounded-lg text-lg font-medium">+</button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">存放位置</label>
                    <input type="text" x-model="bundleIntakeForm.location" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="倉庫A (選填)">
                </div>
            </div>

            <!-- Summary -->
            <div class="bg-primary-100 rounded-lg p-3 mb-4 text-sm">
                <p class="text-primary-800">
                    將入庫 <span class="font-bold" x-text="bundleIntakeForm.multiplier"></span> 套
                    「<span x-text="selectedBundle?.name"></span>」，
                    共 <span class="font-bold" x-text="(selectedBundle?.items?.length || 0) * bundleIntakeForm.multiplier"></span> 項物資
                </p>
            </div>

            <div class="flex space-x-3">
                <button @click="showBundleDetailModal = false" class="flex-1 px-4 py-2 border border-gray-200 rounded-lg">返回</button>
                <button @click="doBundleIntake()" class="flex-1 px-4 py-2 bg-primary-600 text-white rounded-lg font-medium">確認入庫</button>
            </div>
        </div>
    </div>

    <!-- Distribute QR Code Modal -->
    <div x-show="showDistributeQRModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showDistributeQRModal = false">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm text-center">
            <h3 class="text-lg font-semibold mb-2">發放成功</h3>
            <p class="text-sm text-gray-600 mb-4">
                <span x-text="lastDistributeResult?.item?.name"></span>
                <span x-show="lastDistributeResult?.item?.specification" class="text-gray-400">(<span x-text="lastDistributeResult?.item?.specification"></span>)</span>
                x <span x-text="lastDistributeResult?.quantity"></span>
            </p>
            <div id="distribute-qrcode" class="flex justify-center mb-4"></div>
            <p class="text-sm text-gray-500 mb-4">讓領取人用 HIRS App 掃描此 QR Code 同步到家庭物資</p>
            <button @click="showDistributeQRModal = false" class="w-full py-2 bg-primary-600 text-white rounded-lg font-medium">關閉</button>
        </div>
    </div>

    <!-- Toast -->
    <div x-show="toast.show" x-cloak
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0 translate-y-2"
         x-transition:enter-end="opacity-100 translate-y-0"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100 translate-y-0"
         x-transition:leave-end="opacity-0 translate-y-2"
         class="fixed bottom-28 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded-lg shadow-lg z-50"
         :class="toast.type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'"
         x-text="toast.message">
    </div>

    <script>
        function cirsApp() {
            return {
                currentTab: 'people',
                currentUser: null,
                token: null,

                // Data
                stats: {},
                broadcast: null,
                inventory: [],
                equipment: [],
                equipmentPending: [],
                expiringItems: [],
                people: [],
                messages: [],
                similarItems: [],
                bundles: [],

                // Filters
                inventorySearch: '',
                inventoryCategory: '',
                peopleSearch: '',
                triageFilter: '',
                messageCategory: '',

                // Zone data
                zones: [],
                zoneTypeFilter: '',
                zoneFilter: '',
                showZoneOverview: false,
                selectedPeople: [],
                zoneTypeLabels: { shelter: '收容', medical: '醫療', service: '服務', restricted: '管制' },

                // Modals
                showLoginModal: false,
                showTriageModal: false,
                showIntakeModal: false,
                showDistributeModal: false,
                showDistributeSelectModal: false,
                showAddInventoryModal: false,
                showEquipmentCheckModal: false,
                showAddEquipmentModal: false,
                showEditEquipmentModal: false,
                showDeleteConfirmModal: false,
                showAddMessage: false,
                showReplyModal: false,
                showDistributeQRModal: false,
                showBundleModal: false,
                showBundleDetailModal: false,
                showBundleManageModal: false,
                showBundleEditModal: false,
                showZoneManageModal: false,
                showBatchMoveModal: false,
                lastDistributeResult: null,
                deleteTarget: null,
                deleteType: null,
                replyTarget: null,
                selectedBundle: null,
                editingBundle: null,

                // Forms
                loginForm: { person_id: '', pin: '' },
                loginError: '',
                triageTarget: null,
                newPerson: { display_name: '', national_id: '', phone: '', current_location: '', triage_status: 'GREEN', photo_data: '', physical_desc: '' },
                intakeForm: { item_id: '', quantity: 1, notes: '' },
                distributeItem: null,
                distributeForm: { person_id: '', quantity: 1, notes: '' },
                newInventory: { name: '', specification: '', category: 'water', quantity: 0, unit: '', location: '', expiry_date: '' },
                checkTarget: null,
                equipmentCheckForm: { status: 'OK', notes: '' },
                newEquipment: { name: '', specification: '', quantity: 1, unit: '台', location: '', check_interval_days: 1 },
                editEquipment: { id: '', name: '', specification: '', quantity: 1, unit: '', location: '', check_interval_days: 1 },
                newMessage: { category: 'general', content: '', author_name: '' },
                replyForm: { content: '', author_name: '' },
                bundleIntakeForm: { bundle_id: '', multiplier: 1, location: '' },
                bundleForm: { name: '', description: '', icon: 'backpack', items: [] },
                newBundleItem: { name: '', specification: '', category: 'other', quantity: 1, unit: '個' },
                batchMoveForm: { target_zone_id: '', notes: '' },
                newZone: { id: '', name: '', zone_type: 'shelter', capacity: 0, description: '' },

                // Search filters
                intakeSearch: '',
                distributeSearch: '',

                // Bundle icon options (heroicons)
                bundleIconOptions: [
                    { id: 'backpack', name: '背包', path: 'M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4' },
                    { id: 'home', name: '居家', path: 'M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6' },
                    { id: 'heart', name: '醫療', path: 'M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z' },
                    { id: 'truck', name: '車用', path: 'M8 7h12m0 0l-4-4m4 4l-4 4m-8 6H4m0 0l4 4m-4-4l4-4' },
                    { id: 'baby', name: '嬰兒', path: 'M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z' },
                    { id: 'elderly', name: '長者', path: 'M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z' },
                    { id: 'office', name: '辦公', path: 'M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z' },
                    { id: 'camping', name: '露營', path: 'M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z' },
                    { id: 'shield', name: '防護', path: 'M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z' },
                    { id: 'fire', name: '消防', path: 'M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z' },
                    { id: 'water', name: '水資源', path: 'M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z' },
                    { id: 'food', name: '糧食', path: 'M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4' },
                    { id: 'sun', name: '戶外', path: 'M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z' },
                    { id: 'bolt', name: '電力', path: 'M13 10V3L4 14h7v7l9-11h-7z' },
                    { id: 'gift', name: '禮物', path: 'M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7' },
                    { id: 'cube', name: '物資', path: 'M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4' }
                ],

                // Toast
                toast: { show: false, message: '', type: 'success' },

                async init() {
                    // Check URL hash for tab
                    const hash = window.location.hash.replace('#', '');
                    if (['people', 'inventory', 'equipment', 'messages'].includes(hash)) {
                        this.currentTab = hash;
                    }

                    // Check for saved token
                    const savedToken = localStorage.getItem('cirs_token');
                    if (savedToken) {
                        this.token = savedToken;
                        await this.verifyToken();
                    }

                    await this.loadStats();
                    await this.loadBroadcast();
                    this.loadTabData();

                    // Polling every 30 seconds
                    setInterval(() => {
                        this.loadStats();
                        this.loadBroadcast();
                    }, 30000);
                },

                switchTab(tab) {
                    this.currentTab = tab;
                    window.location.hash = tab;
                    this.loadTabData();
                },

                loadTabData() {
                    switch(this.currentTab) {
                        case 'people': this.loadPeople(); this.loadZones(); break;
                        case 'inventory': this.loadInventory(); this.loadExpiringItems(); this.loadBundles(); break;
                        case 'equipment': this.loadEquipment(); this.loadEquipmentPending(); break;
                        case 'messages': this.loadMessages(); break;
                    }
                },

                get pageTitle() {
                    const titles = { 'people': '人員管理', 'inventory': '物資管理', 'equipment': '設備檢查', 'messages': '互助留言板' };
                    return titles[this.currentTab] || 'CIRS';
                },

                get filteredInventory() {
                    return this.inventory.filter(item => {
                        if (item.category === 'equipment') return false;
                        const matchSearch = !this.inventorySearch || item.name.toLowerCase().includes(this.inventorySearch.toLowerCase());
                        const matchCategory = !this.inventoryCategory || item.category === this.inventoryCategory;
                        return matchSearch && matchCategory;
                    });
                },

                get filteredPeople() {
                    return this.people.filter(p => {
                        if (p.role !== 'public') return false;
                        const matchSearch = !this.peopleSearch || p.display_name.toLowerCase().includes(this.peopleSearch.toLowerCase()) || p.id.includes(this.peopleSearch);
                        const matchTriage = !this.triageFilter || p.triage_status === this.triageFilter;
                        const matchZone = !this.zoneFilter || p.current_location === this.zoneFilter;
                        return matchSearch && matchTriage && matchZone;
                    });
                },

                get filteredZones() {
                    return this.zones.filter(z => !this.zoneTypeFilter || z.zone_type === this.zoneTypeFilter);
                },

                get filteredMessages() {
                    return this.messages.filter(m => !this.messageCategory || m.category === this.messageCategory);
                },

                async apiCall(url, options = {}) {
                    if (this.token) {
                        options.headers = { ...options.headers, 'Authorization': `Bearer ${this.token}` };
                    }
                    if (options.body && typeof options.body === 'object') {
                        options.headers = { ...options.headers, 'Content-Type': 'application/json' };
                        options.body = JSON.stringify(options.body);
                    }
                    return await fetch(url, options);
                },

                async verifyToken() {
                    try {
                        const res = await this.apiCall('/api/auth/verify', { method: 'POST' });
                        if (res.ok) {
                            const data = await res.json();
                            if (data.valid) this.currentUser = data.person;
                            else this.logout();
                        }
                    } catch (e) { console.error('Token verify failed:', e); }
                },

                async doLogin() {
                    this.loginError = '';
                    try {
                        const res = await fetch('/api/auth/login', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.loginForm)
                        });
                        const data = await res.json();
                        if (res.ok) {
                            this.token = data.token;
                            this.currentUser = data.person;
                            localStorage.setItem('cirs_token', data.token);
                            this.showLoginModal = false;
                            this.showToast('登入成功', 'success');
                        } else {
                            this.loginError = data.detail || '登入失敗';
                        }
                    } catch (e) { this.loginError = '網路錯誤'; }
                },

                logout() {
                    this.token = null;
                    this.currentUser = null;
                    localStorage.removeItem('cirs_token');
                },

                async loadStats() {
                    try {
                        const res = await fetch('/api/stats');
                        if (res.ok) this.stats = await res.json();
                    } catch (e) {}
                },

                async loadBroadcast() {
                    try {
                        const res = await fetch('/api/messages/broadcast');
                        if (res.ok) {
                            const data = await res.json();
                            this.broadcast = data.broadcast?.content || null;
                        }
                    } catch (e) {}
                },

                async loadInventory() {
                    try {
                        const res = await fetch('/api/inventory');
                        if (res.ok) {
                            const data = await res.json();
                            this.inventory = data.items || [];
                        }
                    } catch (e) {}
                },

                async loadExpiringItems() {
                    try {
                        const res = await fetch('/api/inventory/expiring?days=7');
                        if (res.ok) {
                            const data = await res.json();
                            this.expiringItems = data.items || [];
                        }
                    } catch (e) {}
                },

                async loadEquipment() {
                    try {
                        const res = await fetch('/api/inventory?category=equipment');
                        if (res.ok) {
                            const data = await res.json();
                            this.equipment = data.items || [];
                        }
                    } catch (e) {}
                },

                async loadEquipmentPending() {
                    try {
                        const res = await fetch('/api/inventory/equipment-pending');
                        if (res.ok) {
                            const data = await res.json();
                            this.equipmentPending = data.items || [];
                        }
                    } catch (e) {}
                },

                async loadPeople() {
                    try {
                        const res = await this.apiCall('/api/person');
                        if (res.ok) {
                            const data = await res.json();
                            this.people = data.persons || [];
                        }
                    } catch (e) {}
                },

                async loadMessages() {
                    try {
                        const res = await fetch('/api/messages');
                        if (res.ok) {
                            const data = await res.json();
                            this.messages = data.messages || [];
                        }
                    } catch (e) {}
                },

                async loadBundles() {
                    try {
                        const res = await fetch('/api/inventory/bundles');
                        if (res.ok) {
                            const data = await res.json();
                            this.bundles = data.bundles || [];
                        }
                    } catch (e) {}
                },

                // Zone methods
                async loadZones() {
                    try {
                        const res = await fetch('/api/zone');
                        if (res.ok) {
                            const data = await res.json();
                            this.zones = data.zones || [];
                        }
                    } catch (e) { console.error('Failed to load zones:', e); }
                },

                // Heroicon SVG map for zone icons
                getZoneIcon(iconName) {
                    const icons = {
                        'moon': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>',
                        'cake': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 15.546c-.523 0-1.046.151-1.5.454a2.704 2.704 0 01-3 0 2.704 2.704 0 00-3 0 2.704 2.704 0 01-3 0 2.704 2.704 0 00-3 0 2.704 2.704 0 01-3 0A1.75 1.75 0 003 15.546v3.954a1.5 1.5 0 001.5 1.5h15a1.5 1.5 0 001.5-1.5v-3.954zM3 15.546v-3.796a1.5 1.5 0 011.5-1.5h15a1.5 1.5 0 011.5 1.5v3.796M12 3v6"/></svg>',
                        'user-group': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>',
                        'heart': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>',
                        'face-smile': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>',
                        'clipboard-document-check': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>',
                        'check-circle': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>',
                        'exclamation-triangle': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>',
                        'exclamation-circle': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>',
                        'eye': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>',
                        'clipboard-document-list': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/></svg>',
                        'cube': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>',
                        'information-circle': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>',
                        'building-storefront': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.5 21v-7.5a.75.75 0 01.75-.75h3a.75.75 0 01.75.75V21m-4.5 0H2.36m11.14 0H18m0 0h3.64m-1.39 0V9.349m-16.5 11.65V9.35m0 0a3.001 3.001 0 003.75-.615A2.993 2.993 0 009.75 9.75c.896 0 1.7-.393 2.25-1.016a2.993 2.993 0 002.25 1.016c.896 0 1.7-.393 2.25-1.016a3.001 3.001 0 003.75.614m-16.5 0a3.004 3.004 0 01-.621-4.72L4.318 3.44A1.5 1.5 0 015.378 3h13.243a1.5 1.5 0 011.06.44l1.19 1.189a3 3 0 01-.621 4.72m-13.5 8.65h3.75a.75.75 0 00.75-.75V13.5a.75.75 0 00-.75-.75H6.75a.75.75 0 00-.75.75v3.75c0 .415.336.75.75.75z"/></svg>',
                        'building-office': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>',
                        'cog-6-tooth': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>',
                        'home': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>',
                        'lock-closed': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>'
                    };
                    return icons[iconName] || icons['home'];
                },

                filterByZone(zoneId) {
                    this.zoneFilter = this.zoneFilter === zoneId ? '' : zoneId;
                },

                openZoneManageModal() {
                    this.showZoneManageModal = true;
                },

                openBatchMoveModal() {
                    this.batchMoveForm = { target_zone_id: '', notes: '' };
                    this.showBatchMoveModal = true;
                },

                async doBatchMove() {
                    if (!this.batchMoveForm.target_zone_id) {
                        this.showToast('請選擇目標區域', 'error');
                        return;
                    }
                    if (this.selectedPeople.length === 0) {
                        this.showToast('請選擇要移動的人員', 'error');
                        return;
                    }
                    try {
                        const res = await this.apiCall('/api/zone/move', {
                            method: 'POST',
                            body: {
                                person_ids: this.selectedPeople,
                                target_zone_id: this.batchMoveForm.target_zone_id,
                                operator_id: this.currentUser.id,
                                notes: this.batchMoveForm.notes
                            }
                        });
                        if (res.ok) {
                            const data = await res.json();
                            this.showToast(data.message, 'success');
                            this.showBatchMoveModal = false;
                            this.selectedPeople = [];
                            await this.loadPeople();
                            await this.loadZones();
                        } else {
                            const err = await res.json();
                            this.showToast(err.detail || '移動失敗', 'error');
                        }
                    } catch (e) { this.showToast('移動失敗', 'error'); }
                },

                togglePersonSelect(personId) {
                    const idx = this.selectedPeople.indexOf(personId);
                    if (idx > -1) {
                        this.selectedPeople.splice(idx, 1);
                    } else {
                        this.selectedPeople.push(personId);
                    }
                },

                selectAllFiltered() {
                    const filtered = this.filteredPeople.map(p => p.id);
                    if (filtered.every(id => this.selectedPeople.includes(id))) {
                        this.selectedPeople = this.selectedPeople.filter(id => !filtered.includes(id));
                    } else {
                        this.selectedPeople = [...new Set([...this.selectedPeople, ...filtered])];
                    }
                },

                async createZone() {
                    if (!this.newZone.id || !this.newZone.name) {
                        this.showToast('請輸入區域代碼和名稱', 'error');
                        return;
                    }
                    try {
                        const res = await this.apiCall('/api/zone', {
                            method: 'POST',
                            body: this.newZone
                        });
                        if (res.ok) {
                            this.showToast('區域新增成功', 'success');
                            this.newZone = { id: '', name: '', zone_type: 'shelter', capacity: 0, description: '' };
                            await this.loadZones();
                        } else {
                            const err = await res.json();
                            this.showToast(err.detail || '新增失敗', 'error');
                        }
                    } catch (e) { this.showToast('新增失敗', 'error'); }
                },

                async deleteZone(zoneId) {
                    if (!confirm('確定要刪除此區域嗎？')) return;
                    try {
                        const res = await this.apiCall(`/api/zone/${zoneId}`, { method: 'DELETE' });
                        if (res.ok) {
                            this.showToast('區域已刪除', 'success');
                            await this.loadZones();
                        } else {
                            const err = await res.json();
                            this.showToast(err.detail || '刪除失敗', 'error');
                        }
                    } catch (e) { this.showToast('刪除失敗', 'error'); }
                },

                // Quick check-in with triage
                async doQuickCheckIn() {
                    if (!this.newPerson.display_name) {
                        this.showToast('請輸入姓名', 'error');
                        return;
                    }
                    try {
                        const res = await this.apiCall('/api/person', {
                            method: 'POST',
                            body: {
                                display_name: this.newPerson.display_name,
                                national_id: this.newPerson.national_id || null,
                                phone: this.newPerson.phone || null,
                                current_location: this.newPerson.current_location,
                                triage_status: this.newPerson.triage_status,
                                photo_data: this.newPerson.photo_data || null,
                                physical_desc: this.newPerson.physical_desc || null
                            }
                        });
                        if (res.ok) {
                            const data = await res.json();
                            const msg = data.existing
                                ? `已登記: ${data.id} (${data.message})`
                                : `報到成功 序號: ${data.id}`;
                            this.showToast(msg, data.existing ? 'info' : 'success');
                            this.newPerson = { display_name: '', national_id: '', phone: '', current_location: '', triage_status: 'GREEN', photo_data: '', physical_desc: '' };
                            await this.loadPeople();
                            await this.loadStats();
                        }
                    } catch (e) { this.showToast('操作失敗', 'error'); }
                },

                // Capture photo for unidentified person
                async capturePhoto() {
                    try {
                        const input = document.createElement('input');
                        input.type = 'file';
                        input.accept = 'image/*';
                        input.capture = 'environment';
                        input.onchange = async (e) => {
                            const file = e.target.files[0];
                            if (file) {
                                // Compress and convert to base64
                                const canvas = document.createElement('canvas');
                                const ctx = canvas.getContext('2d');
                                const img = new Image();
                                img.onload = () => {
                                    // Max 400px for thumbnail
                                    const maxSize = 400;
                                    let w = img.width, h = img.height;
                                    if (w > h && w > maxSize) { h = h * maxSize / w; w = maxSize; }
                                    else if (h > maxSize) { w = w * maxSize / h; h = maxSize; }
                                    canvas.width = w;
                                    canvas.height = h;
                                    ctx.drawImage(img, 0, 0, w, h);
                                    this.newPerson.photo_data = canvas.toDataURL('image/jpeg', 0.7);
                                };
                                img.src = URL.createObjectURL(file);
                            }
                        };
                        input.click();
                    } catch (e) {
                        this.showToast('無法存取相機', 'error');
                    }
                },

                startTriage(person) {
                    this.triageTarget = person;
                    this.showTriageModal = true;
                },

                async doTriage(status) {
                    try {
                        const res = await this.apiCall(`/api/person/${this.triageTarget.id}/triage`, {
                            method: 'POST',
                            body: { status }
                        });
                        if (res.ok) {
                            this.showTriageModal = false;
                            this.showToast('檢傷分類完成', 'success');
                            await this.loadPeople();
                            await this.loadStats();
                        }
                    } catch (e) { this.showToast('操作失敗', 'error'); }
                },

                // Inventory operations
                quickIntake(item) {
                    this.intakeForm = { item_id: item.id, quantity: 1, notes: '' };
                    this.showIntakeModal = true;
                },

                async doIntake() {
                    if (!this.intakeForm.item_id) {
                        this.showToast('請選擇物資', 'error');
                        return;
                    }
                    try {
                        const res = await this.apiCall(`/api/inventory/${this.intakeForm.item_id}/intake`, {
                            method: 'POST',
                            body: { quantity: this.intakeForm.quantity, notes: this.intakeForm.notes }
                        });
                        if (res.ok) {
                            this.showIntakeModal = false;
                            this.showToast('入庫成功', 'success');
                            await this.loadInventory();
                        } else {
                            const err = await res.json();
                            this.showToast(err.detail || '入庫失敗', 'error');
                        }
                    } catch (e) { this.showToast('操作失敗', 'error'); }
                },

                startDistribute(item) {
                    this.distributeItem = item;
                    this.distributeForm = { person_id: '', quantity: 1, notes: '' };
                    this.showDistributeModal = true;
                },

                async doDistribute() {
                    if (!this.distributeForm.person_id) {
                        this.showToast('請輸入領取人 ID', 'error');
                        return;
                    }
                    try {
                        const res = await this.apiCall(`/api/inventory/${this.distributeItem.id}/distribute`, {
                            method: 'POST',
                            body: this.distributeForm
                        });
                        if (res.ok) {
                            const result = await res.json();
                            this.showDistributeModal = false;

                            // 儲存發放結果，準備產生 QR Code
                            this.lastDistributeResult = {
                                item: this.distributeItem,
                                quantity: this.distributeForm.quantity,
                                person_id: this.distributeForm.person_id,
                                timestamp: new Date().toISOString()
                            };

                            // 顯示 QR Code modal
                            this.generateDistributeQR();

                            await this.loadInventory();
                            await this.loadStats();
                        } else {
                            const err = await res.json();
                            this.showToast(err.detail || '發放失敗', 'error');
                        }
                    } catch (e) { this.showToast('操作失敗', 'error'); }
                },

                generateDistributeQR() {
                    if (!this.lastDistributeResult) return;

                    const r = this.lastDistributeResult;
                    // 產生 HIRS 相容的封包格式
                    const data = {
                        type: 'cirs_distribute',
                        source: 'CIRS 社區物資站',
                        timestamp: r.timestamp,
                        recipient: r.person_id,
                        inventory: [{
                            name: r.item.name,
                            qty: r.quantity,
                            unit: r.item.unit || '個',
                            category: r.item.category,
                            expiry: r.item.expiry_date || null,
                            spec: r.item.specification || null
                        }]
                    };

                    const jsonStr = JSON.stringify(data);

                    try {
                        const qr = qrcode(0, 'L');
                        qr.addData(jsonStr, 'Byte');
                        qr.make();

                        const container = document.getElementById('distribute-qrcode');
                        if (container) {
                            container.innerHTML = qr.createImgTag(5);
                        }
                        this.showDistributeQRModal = true;
                    } catch (e) {
                        console.error('QR generation error:', e);
                        this.showToast('發放成功，QR Code 產生失敗', 'info');
                    }
                },

                async checkSimilarItems() {
                    if (this.newInventory.name.length < 2) {
                        this.similarItems = [];
                        return;
                    }
                    try {
                        const res = await fetch(`/api/inventory/similar?name=${encodeURIComponent(this.newInventory.name)}`);
                        if (res.ok) {
                            const data = await res.json();
                            this.similarItems = data.items || [];
                        }
                    } catch (e) {}
                },

                async doAddInventory() {
                    if (!this.newInventory.name) {
                        this.showToast('請輸入名稱', 'error');
                        return;
                    }
                    try {
                        const res = await this.apiCall('/api/inventory', {
                            method: 'POST',
                            body: this.newInventory
                        });
                        if (res.ok) {
                            this.showAddInventoryModal = false;
                            this.newInventory = { name: '', specification: '', category: 'water', quantity: 0, unit: '', location: '', expiry_date: '' };
                            this.similarItems = [];
                            this.showToast('新增成功', 'success');
                            await this.loadInventory();
                        }
                    } catch (e) { this.showToast('操作失敗', 'error'); }
                },

                // Bundle operations
                openBundleModal() {
                    this.bundleIntakeForm = { bundle_id: '', multiplier: 1, location: '' };
                    this.showBundleModal = true;
                },

                selectBundle(bundle) {
                    this.selectedBundle = bundle;
                    this.bundleIntakeForm.bundle_id = bundle.id;
                    this.showBundleDetailModal = true;
                },

                async doBundleIntake() {
                    if (!this.bundleIntakeForm.bundle_id) {
                        this.showToast('請選擇組套', 'error');
                        return;
                    }
                    try {
                        const res = await this.apiCall('/api/inventory/bundles/intake', {
                            method: 'POST',
                            body: this.bundleIntakeForm
                        });
                        if (res.ok) {
                            const data = await res.json();
                            this.showBundleDetailModal = false;
                            this.showBundleModal = false;
                            this.showToast(`${this.selectedBundle.name} 入庫成功 (${data.total_items} 項物資)`, 'success');
                            await this.loadInventory();
                        } else {
                            const err = await res.json();
                            this.showToast(err.detail || '入庫失敗', 'error');
                        }
                    } catch (e) { this.showToast('操作失敗', 'error'); }
                },

                // Bundle Management (Admin)
                openBundleManage() {
                    this.showBundleManageModal = true;
                },

                startCreateBundle() {
                    this.editingBundle = null;
                    this.bundleForm = { name: '', description: '', icon: 'backpack', items: [] };
                    this.showBundleManageModal = false;
                    this.showBundleEditModal = true;
                },

                startEditBundle(bundle) {
                    this.editingBundle = bundle;
                    // Convert emoji icon to heroicon id if needed
                    let iconId = bundle.icon || 'backpack';
                    if (iconId.length > 10 || /[\u{1F300}-\u{1F9FF}]/u.test(iconId)) {
                        iconId = 'backpack'; // Default if old emoji format
                    }
                    this.bundleForm = {
                        name: bundle.name,
                        description: bundle.description || '',
                        icon: iconId,
                        items: JSON.parse(JSON.stringify(bundle.items || []))
                    };
                    this.showBundleManageModal = false;
                    this.showBundleEditModal = true;
                },

                addBundleItem() {
                    if (!this.newBundleItem.name) {
                        this.showToast('請輸入物資名稱', 'error');
                        return;
                    }
                    this.bundleForm.items.push({...this.newBundleItem});
                    this.newBundleItem = { name: '', specification: '', category: 'other', quantity: 1, unit: '個' };
                },

                removeBundleItem(index) {
                    this.bundleForm.items.splice(index, 1);
                },

                moveBundleItem(index, direction) {
                    const newIndex = index + direction;
                    if (newIndex < 0 || newIndex >= this.bundleForm.items.length) return;
                    const items = [...this.bundleForm.items];
                    const [item] = items.splice(index, 1);
                    items.splice(newIndex, 0, item);
                    this.bundleForm.items = items;
                },

                // Get bundle icon SVG path by id
                getBundleIconPath(iconId) {
                    const icon = this.bundleIconOptions.find(i => i.id === iconId);
                    return icon ? icon.path : this.bundleIconOptions[0].path;
                },

                async saveBundle() {
                    if (!this.bundleForm.name) {
                        this.showToast('請輸入組套名稱', 'error');
                        return;
                    }
                    if (this.bundleForm.items.length === 0) {
                        this.showToast('請至少新增一項物資', 'error');
                        return;
                    }

                    try {
                        let res;
                        if (this.editingBundle) {
                            // Update existing
                            res = await this.apiCall(`/api/inventory/bundles/${this.editingBundle.id}`, {
                                method: 'PUT',
                                body: this.bundleForm
                            });
                        } else {
                            // Create new
                            res = await this.apiCall('/api/inventory/bundles', {
                                method: 'POST',
                                body: this.bundleForm
                            });
                        }

                        if (res.ok) {
                            this.showBundleEditModal = false;
                            this.showToast(this.editingBundle ? '組套更新成功' : '組套建立成功', 'success');
                            await this.loadBundles();
                            this.showBundleManageModal = true;
                        } else {
                            const err = await res.json();
                            this.showToast(err.detail || '儲存失敗', 'error');
                        }
                    } catch (e) { this.showToast('操作失敗', 'error'); }
                },

                confirmDeleteBundle(bundle) {
                    this.deleteTarget = bundle;
                    this.deleteType = 'bundle';
                    this.showDeleteConfirmModal = true;
                },

                async doDeleteBundle() {
                    try {
                        const res = await this.apiCall(`/api/inventory/bundles/${this.deleteTarget.id}`, {
                            method: 'DELETE'
                        });
                        if (res.ok) {
                            this.showDeleteConfirmModal = false;
                            this.showToast('組套刪除成功', 'success');
                            await this.loadBundles();
                        } else {
                            const err = await res.json();
                            this.showToast(err.detail || '刪除失敗', 'error');
                        }
                    } catch (e) { this.showToast('操作失敗', 'error'); }
                },

                // Equipment operations
                startEquipmentCheck(eq) {
                    this.checkTarget = eq;
                    this.equipmentCheckForm = { status: eq.check_status || 'OK', notes: '' };
                    this.showEquipmentCheckModal = true;
                },

                async doEquipmentCheck() {
                    try {
                        const res = await this.apiCall(`/api/inventory/${this.checkTarget.id}/check`, {
                            method: 'POST',
                            body: this.equipmentCheckForm
                        });
                        if (res.ok) {
                            this.showEquipmentCheckModal = false;
                            this.showToast('檢查完成', 'success');
                            await this.loadEquipment();
                            await this.loadEquipmentPending();
                            await this.loadStats();
                        }
                    } catch (e) { this.showToast('操作失敗', 'error'); }
                },

                async doAddEquipment() {
                    if (!this.newEquipment.name) {
                        this.showToast('請輸入名稱', 'error');
                        return;
                    }
                    try {
                        const res = await this.apiCall('/api/inventory', {
                            method: 'POST',
                            body: {
                                ...this.newEquipment,
                                category: 'equipment',
                                check_status: 'OK'
                            }
                        });
                        if (res.ok) {
                            this.showAddEquipmentModal = false;
                            this.newEquipment = { name: '', specification: '', quantity: 1, unit: '台', location: '', check_interval_days: 1 };
                            this.showToast('新增成功', 'success');
                            await this.loadEquipment();
                            await this.loadEquipmentPending();
                        }
                    } catch (e) { this.showToast('操作失敗', 'error'); }
                },

                startEditEquipment(eq) {
                    this.editEquipment = {
                        id: eq.id,
                        name: eq.name,
                        specification: eq.specification || '',
                        quantity: eq.quantity,
                        unit: eq.unit || '台',
                        location: eq.location || '',
                        check_interval_days: eq.check_interval_days || 1
                    };
                    this.showEditEquipmentModal = true;
                },

                async doEditEquipment() {
                    if (!this.editEquipment.name) {
                        this.showToast('請輸入名稱', 'error');
                        return;
                    }
                    try {
                        const res = await this.apiCall(`/api/inventory/${this.editEquipment.id}`, {
                            method: 'PUT',
                            body: {
                                name: this.editEquipment.name,
                                specification: this.editEquipment.specification,
                                quantity: this.editEquipment.quantity,
                                unit: this.editEquipment.unit,
                                location: this.editEquipment.location,
                                check_interval_days: this.editEquipment.check_interval_days
                            }
                        });
                        if (res.ok) {
                            this.showEditEquipmentModal = false;
                            this.showToast('更新成功', 'success');
                            await this.loadEquipment();
                            await this.loadEquipmentPending();
                        } else {
                            const err = await res.json();
                            this.showToast(err.detail || '更新失敗', 'error');
                        }
                    } catch (e) { this.showToast('操作失敗', 'error'); }
                },

                confirmDeleteEquipment(eq) {
                    this.deleteTarget = eq;
                    this.deleteType = 'equipment';
                    this.showDeleteConfirmModal = true;
                },

                async doDelete() {
                    // Handle bundle deletion separately
                    if (this.deleteType === 'bundle') {
                        await this.doDeleteBundle();
                        return;
                    }

                    try {
                        const endpoint = this.deleteType === 'message'
                            ? `/api/messages/${this.deleteTarget.id}`
                            : `/api/inventory/${this.deleteTarget.id}`;
                        const res = await this.apiCall(endpoint, {
                            method: 'DELETE'
                        });
                        if (res.ok) {
                            this.showDeleteConfirmModal = false;
                            this.showToast('刪除成功', 'success');
                            if (this.deleteType === 'equipment') {
                                await this.loadEquipment();
                                await this.loadEquipmentPending();
                            } else if (this.deleteType === 'message') {
                                await this.loadMessages();
                            }
                        } else {
                            const err = await res.json();
                            this.showToast(err.detail || '刪除失敗', 'error');
                        }
                    } catch (e) { this.showToast('操作失敗', 'error'); }
                },

                // Messages
                async doAddMessage() {
                    if (!this.newMessage.content) {
                        this.showToast('請輸入內容', 'error');
                        return;
                    }
                    try {
                        const res = await fetch('/api/messages', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.newMessage)
                        });
                        if (res.ok) {
                            this.showAddMessage = false;
                            this.newMessage = { category: 'general', content: '', author_name: '' };
                            this.showToast('發布成功', 'success');
                            await this.loadMessages();
                        }
                    } catch (e) { this.showToast('操作失敗', 'error'); }
                },

                startReply(msg) {
                    this.replyTarget = msg;
                    this.replyForm = { content: '', author_name: '' };
                    this.showReplyModal = true;
                },

                async doReply() {
                    if (!this.replyForm.content) {
                        this.showToast('請輸入內容', 'error');
                        return;
                    }
                    try {
                        const res = await fetch(`/api/messages/${this.replyTarget.id}/reply`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.replyForm)
                        });
                        if (res.ok) {
                            this.showReplyModal = false;
                            this.replyForm = { content: '', author_name: '' };
                            this.showToast('回覆成功', 'success');
                            await this.loadMessages();
                        } else {
                            const err = await res.json();
                            this.showToast(err.detail || '回覆失敗', 'error');
                        }
                    } catch (e) { this.showToast('操作失敗', 'error'); }
                },

                confirmDeleteMessage(msg) {
                    this.deleteTarget = msg;
                    this.deleteType = 'message';
                    this.showDeleteConfirmModal = true;
                },

                async toggleMessageResolved(msg) {
                    try {
                        const res = await this.apiCall(`/api/messages/${msg.id}/resolve`, {
                            method: 'POST',
                            body: { is_resolved: !msg.is_resolved }
                        });
                        if (res.ok) {
                            this.showToast(msg.is_resolved ? '已取消解決' : '已標為解決', 'success');
                            await this.loadMessages();
                        }
                    } catch (e) { this.showToast('操作失敗', 'error'); }
                },

                // Helpers
                getCategoryName(cat) {
                    const names = { 'seek_person': '尋人', 'seek_item': '尋物', 'offer_help': '互助', 'report': '回報', 'general': '一般' };
                    return names[cat] || '一般';
                },

                getCheckStatusText(status) {
                    const texts = { 'OK': '正常', 'NEEDS_REPAIR': '待修', 'OUT_OF_SERVICE': '停用' };
                    return texts[status] || '未檢查';
                },

                formatTime(isoStr) {
                    if (!isoStr) return '';
                    const d = new Date(isoStr);
                    const now = new Date();
                    const diff = (now - d) / 1000;
                    if (diff < 60) return '剛剛';
                    if (diff < 3600) return `${Math.floor(diff/60)} 分鐘前`;
                    if (diff < 86400) return `${Math.floor(diff/3600)} 小時前`;
                    return `${Math.floor(diff/86400)} 天前`;
                },

                showToast(message, type = 'success') {
                    this.toast = { show: true, message, type };
                    setTimeout(() => this.toast.show = false, 3000);
                }
            };
        }
    </script>
</body>
</html>
