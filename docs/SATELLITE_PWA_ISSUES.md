# Satellite PWA 問題與開發規格

> 基於 2024-12 實機測試回饋

---

## 問題總覽

| # | 問題 | 嚴重度 | 狀態 |
|---|------|--------|------|
| 1 | QR Scanner 無法使用 | Critical | 待修 |
| 2 | 手動輸入 UX 差 | High | 待修 |
| 3 | 查看庫存功能未實作 | Medium | 待開發 |
| 4 | UI 風格不一致 | Medium | 待修 |
| 5 | App Icon 需重新設計 | Low | 待設計 |
| 6 | 報到流程設計不清 | High | 需釐清 |
| 7 | 志工 ID 與同步記錄 | Medium | 需設計 |

---

## Issue 1: QR Scanner 無法使用 [Critical]

### 現象
- PWA 內的 QR 掃描按鈕點擊後無反應或功能壞掉
- 報到、領取物資的 QR 掃描都無法使用
- 需要重新整理才能回到原畫面

### 根本原因
- 目前使用的 QR Scanner library 可能有相容性問題
- iOS Safari 的 camera API 權限處理不正確
- 可能缺少 HTTPS（iOS 要求 HTTPS 才能使用相機）

### 解決方案

```
方案 A: 使用原生相機 + URL Scheme（推薦）
┌─────────────────────────────────────────────┐
│  點擊「掃描 QR」                             │
│       ↓                                      │
│  開啟系統相機 App                            │
│       ↓                                      │
│  掃描 QR Code                                │
│       ↓                                      │
│  QR 內容為 URL: cirs://checkin?id=P0001     │
│       ↓                                      │
│  自動跳轉回 PWA 並帶入參數                   │
└─────────────────────────────────────────────┘

方案 B: 改用手動輸入為主（備案）
- QR Scanner 作為輔助
- 手動輸入 ID 為主要方式
```

### 開發任務

- [ ] B1.1: 移除/修復現有 QR Scanner 程式碼
- [ ] B1.2: 改用手動輸入 ID 為主要操作方式
- [ ] B1.3: 加入 ID 輸入欄位（支援掃描器外接鍵盤輸入）
- [ ] B1.4: 錯誤處理：掃描失敗時自動顯示手動輸入

---

## Issue 2: 手動連接 UX 差 [High]

### 現象
- 「手動連接資訊」顯示一大串 URL+Token
- 使用者需要自己分開網址和 Token
- 沒有複製按鈕

### 解決方案

```
改進前：
┌─────────────────────────────────────────────┐
│ 手動連接資訊                                 │
│ http://172.20.10.2:8090/mobile/?token=eyJ... │
└─────────────────────────────────────────────┘

改進後：
┌─────────────────────────────────────────────┐
│ 手動連接                                     │
│                                              │
│ Hub 網址: http://172.20.10.2:8090           │
│           [複製]                             │
│                                              │
│ 配對碼:   eyJhbG...                         │
│           [複製]                             │
│                                              │
│ 或直接複製完整連結：                         │
│ [複製完整連結]                               │
└─────────────────────────────────────────────┘
```

### 開發任務

- [ ] B2.1: 分離顯示 Hub URL 和 Token
- [ ] B2.2: 加入複製按鈕（使用 Clipboard API）
- [ ] B2.3: 加入「複製完整連結」按鈕

---

## Issue 3: 查看庫存功能未實作 [Medium]

### 現象
- 「查看庫存」按鈕點擊無反應或報錯

### 解決方案

需要實作 API 和前端：

```
API: GET /api/satellite/inventory
Response: {
  "categories": [
    {
      "name": "水",
      "items": [
        {"name": "礦泉水 600ml", "quantity": 500, "unit": "瓶"},
        {"name": "礦泉水 1.5L", "quantity": 200, "unit": "瓶"}
      ]
    },
    ...
  ],
  "last_updated": "2024-12-14T10:00:00Z"
}
```

### 開發任務

- [ ] B3.1: 後端實作 GET /api/satellite/inventory
- [ ] B3.2: 前端實作庫存列表 UI（唯讀）
- [ ] B3.3: 加入分類篩選
- [ ] B3.4: 加入搜尋功能

---

## Issue 4: UI 風格不一致 [Medium]

### 現象
- Satellite PWA 使用 Heroicons
- 主 CIRS 系統風格不同
- 視覺不統一

### 解決方案

統一使用 CIRS 的設計系統：

| 項目 | 現況 | 目標 |
|------|------|------|
| Icons | Heroicons | 與 CIRS 統一 |
| 色彩 | 混用 | primary-600: #0284c7 |
| 圓角 | 混用 | rounded-xl (12px) |
| 字體 | 預設 | system-ui |
| 按鈕 | 混用 | 統一高度 44px (mobile touch) |

### 開發任務

- [ ] B4.1: 審查並統一所有 icon
- [ ] B4.2: 統一色彩變數
- [ ] B4.3: 統一按鈕樣式
- [ ] B4.4: 統一卡片/容器樣式

---

## Issue 5: App Icon 需重新設計 [Low]

### 現象
- 目前 icon 設計不佳

### 設計規格

```
設計概念：衛星環繞房屋
┌─────────────────────┐
│                     │
│      ◉             │  ← 衛星（實心圓點）
│    ╭───╮            │  ← 軌道（圓圈缺口）
│   │  🏠 │           │  ← 房屋（Hub）
│    ╰───╯            │
│                     │
└─────────────────────┘

顏色：
- 房屋：#0284c7 (primary)
- 軌道：#0284c7 (primary) 或 #64748b (gray)
- 衛星：#f97316 (orange) 強調色

尺寸需求：
- 72x72, 96x96, 128x128, 144x144
- 152x152, 192x192, 384x384, 512x512
```

### 開發任務

- [ ] B5.1: 設計新 icon（等待使用者提供設計稿）
- [ ] B5.2: 產生各尺寸 PNG
- [ ] B5.3: 更新 manifest.json

---

## Issue 6: 報到流程設計釐清 [High]

### 問題
- 新到場人員如何取得 QR Code？
- Satellite PWA 的角色是什麼？

### 流程設計

```
場景：災民報到

方案 A: 集中報到（推薦）
═══════════════════════════════════════════════
1. 災民到「報到櫃台」
2. 櫃台人員用 CIRS Hub (筆電/平板) 登記
3. 系統產生災民 ID (如 P0001)
4. 列印/顯示 QR Code 給災民
5. 之後領物資時，志工用 Satellite 掃災民 QR

方案 B: 分散報到（Satellite 報到）
═══════════════════════════════════════════════
1. 災民到「報到區」（可能有多個入口）
2. 志工用 Satellite PWA 快速登記
3. 登記資訊同步到 Hub
4. 災民 ID 顯示在志工手機上
5. （問題：如何給災民 QR？需要印表機）
```

### 建議

**Phase 1: 採用方案 A（集中報到）**
- Satellite PWA 主要用於：
  - 物資發放確認
  - 人員進出確認（掃已登記者的 QR）
- 報到登記仍在 Hub 完成

**Phase 2: 擴展方案 B（可選）**
- 加入 Satellite 報到功能
- 需搭配行動印表機

### 開發任務

- [ ] B6.1: 確認 Phase 1 流程
- [ ] B6.2: Hub 端加入「列印災民 QR」功能
- [ ] B6.3: Satellite 實作「掃描災民 QR → 確認報到」
- [ ] B6.4: Satellite 實作「掃描災民 QR → 發放物資」

---

## Issue 7: 志工 ID 與同步記錄 [Medium]

### 問題
- 志工 ID 從哪來？
- 同步操作要有記錄嗎？
- 記錄 UI 放哪裡？

### 設計規格

```
志工識別流程：
┌─────────────────────────────────────────────┐
│ 1. Hub 管理員建立志工帳號                    │
│    - ID: V001                               │
│    - 姓名: 王小明                            │
│    - 角色: staff                             │
│    - PIN: 1234                              │
├─────────────────────────────────────────────┤
│ 2. 管理員產生「志工配對 QR」                  │
│    - 包含志工專屬 token                      │
│    - 或使用通用 satellite token              │
├─────────────────────────────────────────────┤
│ 3. 志工掃碼連接                              │
│    - Satellite 記錄志工 ID                   │
│    - 所有操作都帶上志工 ID                   │
├─────────────────────────────────────────────┤
│ 4. 操作記錄                                  │
│    - 時間、操作類型、志工 ID、對象 ID        │
│    - 同步狀態（pending/synced/failed）       │
└─────────────────────────────────────────────┘
```

### 同步記錄 UI

```
┌─────────────────────────────────────────────┐
│ ≡ CIRS Satellite           志工: 王小明 V001│
├─────────────────────────────────────────────┤
│                                              │
│  [人員報到]  [物資發放]  [查看庫存]          │
│                                              │
├─────────────────────────────────────────────┤
│ 最近操作                          [查看全部] │
│ ─────────────────────────────────────────── │
│ ✓ 10:30 發放 礦泉水x2 → P0015              │
│ ✓ 10:28 報到確認 P0015                      │
│ ⟳ 10:25 發放 餅乾x1 → P0014    同步中...   │
└─────────────────────────────────────────────┘
```

### 開發任務

- [ ] B7.1: 設計志工身份驗證機制
- [ ] B7.2: 實作操作記錄 IndexedDB 儲存
- [ ] B7.3: 實作「最近操作」UI 區塊
- [ ] B7.4: 實作「查看全部記錄」頁面
- [ ] B7.5: 同步時帶上志工 ID

---

## 優先順序

### Phase 1: 核心功能修復（必要）
1. [x] Issue 1: QR Scanner → 改用手動輸入
2. [ ] Issue 6: 報到流程確認
3. [ ] Issue 3: 查看庫存實作

### Phase 2: UX 改善
4. [ ] Issue 2: 手動連接 UX
5. [ ] Issue 4: UI 風格統一
6. [ ] Issue 7: 志工 ID 與記錄

### Phase 3: 視覺優化
7. [ ] Issue 5: App Icon

---

## API 規格補充

### Satellite 專用 API（需實作）

```
# 人員操作
POST /api/satellite/checkin
  Body: { person_id: "P0001", volunteer_id: "V001" }
  Response: { success: true, person: {...} }

POST /api/satellite/checkout
  Body: { person_id: "P0001", volunteer_id: "V001" }
  Response: { success: true }

# 物資操作
POST /api/satellite/dispense
  Body: {
    person_id: "P0001",
    items: [{ item_id: "I001", quantity: 2 }],
    volunteer_id: "V001"
  }
  Response: { success: true, transaction_id: "T001" }

GET /api/satellite/inventory
  Response: { categories: [...], last_updated: "..." }

# 同步
POST /api/satellite/sync
  Body: {
    operations: [
      { type: "checkin", person_id: "P0001", timestamp: "...", volunteer_id: "V001" },
      { type: "dispense", ... }
    ]
  }
  Response: {
    synced: 5,
    failed: 0,
    results: [...]
  }

GET /api/satellite/status
  Response: {
    hub_name: "...",
    online: true,
    last_sync: "...",
    pending_count: 3
  }
```

---

*Last Updated: 2024-12-14*
