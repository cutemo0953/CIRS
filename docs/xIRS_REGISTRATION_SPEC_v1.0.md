# xIRS æ›è™Ÿç³»çµ±è¦æ ¼ v1.2

**Version**: 1.2
**Date**: 2025-12-22
**Status**: In Development
**Author**: Claude

**v1.2 æ›´æ–°:**
- é‡æ¸…ã€Œç­‰å€™å®¤ã€vsã€Œç—…æ‚£ã€Tab çš„å€åˆ¥
- æ–°å¢æ‰‹å‹•ç—…æ‚£åˆªé™¤æµç¨‹ï¼ˆå«åŸå› è¨˜éŒ„ï¼‰
- ä¿®æ­£è™•æ–¹è¡¨å–®ç‹€æ…‹éš”é›¢å•é¡Œ
- æ–°å¢è—¥å“æ¸¬è©¦æµç¨‹æ–‡ä»¶

**v1.1 æ›´æ–°:**
- æ–°å¢å¤šé†«å¸«å ´æ™¯æ”¯æ´ (claim/çœ‹è¨º æ©Ÿåˆ¶)
- æ–°å¢åŒæ­¥ API (`/api/registrations/waiting/list`)
- æ–°å¢è—¥å“åº«å­˜ API (`/api/medications/status`)
- æ›´æ–° Doctor PWA é¡è‰²ä¸»é¡Œ

---

## 1. èƒŒæ™¯èˆ‡ç›®çš„

### 1.1 å•é¡Œæè¿°

ç›®å‰ xIRS Doctor PWA éœ€è¦é†«å¸«æ‰‹å‹•è¼¸å…¥ç—…æ‚£è³‡è¨Šï¼Œé€™åœ¨ç½é›£ç¾å ´æ˜¯ä¸å¯¦éš›çš„ï¼š
- é†«å¸«æ™‚é–“å¯¶è²´ï¼Œæ‡‰å°ˆæ³¨æ–¼è¨ºç™‚
- æ‰‹å‹•è¼¸å…¥å®¹æ˜“å‡ºéŒ¯
- ç¼ºä¹èˆ‡ CIRS å ±åˆ°ç³»çµ±çš„æ•´åˆ

### 1.2 è§£æ±ºæ–¹æ¡ˆ

åœ¨ CIRS å ±åˆ°æµç¨‹ä¸­æ–°å¢ã€Œæ›è™Ÿã€åŠŸèƒ½ï¼Œè®“è¡Œæ”¿äººå“¡å¯ä»¥ï¼š
1. å¾å·²å ±åˆ°çš„ç½æ°‘ä¸­é¸æ“‡éœ€è¦çœ‹è¨ºçš„äºº
2. å»ºç«‹æ›è™Ÿç´€éŒ„
3. ç”¢ç”Ÿæ›è™Ÿ QR Code è®“ Doctor PWA æƒæ

---

## 2. è³‡æ–™æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PATIENT REGISTRATION FLOW                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  [CIRS Admin / Check-in Staff]           [xIRS Doctor PWA]           â”‚
â”‚           â”‚                                     â”‚                   â”‚
â”‚      1. ç½æ°‘å ±åˆ°                                â”‚                   â”‚
â”‚           â”‚                                     â”‚                   â”‚
â”‚      2. é»æ“Šã€Œæ›è™Ÿã€                            â”‚                   â”‚
â”‚           â”‚                                     â”‚                   â”‚
â”‚      3. é¸æ“‡çœ‹è¨ºç§‘åˆ¥/å„ªå…ˆç­‰ç´š                   â”‚                   â”‚
â”‚           â”‚                                     â”‚                   â”‚
â”‚      4. ç”¢ç”Ÿæ›è™Ÿå–® QR Code                      â”‚                   â”‚
â”‚           â”‚                                     â”‚                   â”‚
â”‚           â”‚ â”€â”€â”€â”€â”€â”€â”€ QR Code â”€â”€â”€â”€â”€â”€â”€â”€â–º          â”‚                   â”‚
â”‚           â”‚                                     â”‚                   â”‚
â”‚           â”‚                               5. æƒæ QR Code           â”‚
â”‚           â”‚                               6. è§£æç—…æ‚£è³‡æ–™           â”‚
â”‚           â”‚                               7. åŠ å…¥å¾…è¨ºæ¸…å–®           â”‚
â”‚           â”‚                                     â”‚                   â”‚
â”‚           â”‚                               8. çœ‹è¨ºã€é–‹è™•æ–¹           â”‚
â”‚           â”‚                                     â”‚                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. è³‡æ–™çµæ§‹

### 3.1 æ›è™Ÿå–® QR Code Payload

```json
{
  "type": "PATIENT_REGISTRATION",
  "ver": 1,
  "reg_id": "REG-20251222-001",
  "patient_ref": "***0042",           // Masked ID (Class C)
  "display_name": "ç‹å°æ˜",            // å¯é¸ï¼Œé¡¯ç¤ºç”¨
  "age_group": "adult",               // infant/child/adult/elderly
  "gender": "M",                      // M/F/U
  "triage": "YELLOW",                 // GREEN/YELLOW/RED (from CIRS triage)
  "chief_complaint": "é ­ç—›ã€ç™¼ç‡’",     // ä¸»è¨´ (ç°¡çŸ­)
  "priority": "ROUTINE",              // STAT/URGENT/ROUTINE
  "registered_at": "2025-12-22T10:30:00Z",
  "registered_by": "admin001",
  "hmac": "..."                       // HMAC-SHA256 é©—è­‰
}
```

### 3.2 CIRS è³‡æ–™åº«æ–°å¢ Table

```sql
CREATE TABLE registrations (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    reg_id TEXT UNIQUE NOT NULL,           -- REG-YYYYMMDD-NNN
    person_id TEXT NOT NULL,               -- Reference to person table
    patient_ref TEXT NOT NULL,             -- Masked ID for Doctor PWA
    priority TEXT DEFAULT 'ROUTINE',       -- STAT/URGENT/ROUTINE
    chief_complaint TEXT,                  -- ä¸»è¨´
    status TEXT DEFAULT 'WAITING',         -- WAITING/IN_PROGRESS/COMPLETED/CANCELLED
    registered_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    registered_by TEXT,
    called_at DATETIME,                    -- å«è™Ÿæ™‚é–“
    completed_at DATETIME,
    notes TEXT,
    FOREIGN KEY (person_id) REFERENCES person(id)
);
```

---

## 4. UI/UX è¨­è¨ˆ

### 4.1 CIRS Admin - å ±åˆ°é é¢æ–°å¢

åœ¨ç½æ°‘è©³æƒ…é  (person detail) æˆ–å ±åˆ°é é¢æ–°å¢æŒ‰éˆ•ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç‹å°æ˜  (ID: P-0042)                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  å ±åˆ°æ™‚é–“: 2025-12-22 10:00            â”‚
â”‚  å€åŸŸ: A å€                             â”‚
â”‚  æª¢å‚·: ğŸŸ¡ YELLOW                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚   ğŸ“ ç·¨è¼¯   â”‚  â”‚  ğŸ¥ æ›è™Ÿ    â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 æ›è™Ÿ Modal

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ¥ æ–°å¢æ›è™Ÿ                     [X]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  ç—…æ‚£: ç‹å°æ˜ (***0042)                 â”‚
â”‚  æª¢å‚·: ğŸŸ¡ YELLOW                        â”‚
â”‚                                         â”‚
â”‚  çœ‹è¨ºå„ªå…ˆç­‰ç´š                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ STAT â”‚ â”‚URGENTâ”‚ â”‚ROUTINEâ”‚           â”‚
â”‚  â”‚ ç·Šæ€¥ â”‚ â”‚ æ€¥  â”‚ â”‚ ä¸€èˆ¬ â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                         â”‚
â”‚  ä¸»è¨´ (é¸å¡«)                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ é ­ç—›ã€ç™¼ç‡’                      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                         â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚        â”‚    ç”¢ç”Ÿæ›è™Ÿå–®     â”‚            â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 æ›è™Ÿå–® QR Code é¡¯ç¤º

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ›è™Ÿå–®                           [X]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚           â”‚   QR CODE    â”‚             â”‚
â”‚           â”‚              â”‚             â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                         â”‚
â”‚  æ›è™Ÿè™Ÿç¢¼: REG-20251222-001            â”‚
â”‚  ç—…æ‚£: ***0042 (ç‹å°æ˜)                 â”‚
â”‚  å„ªå…ˆ: ğŸŸ¡ URGENT                        â”‚
â”‚  ä¸»è¨´: é ­ç—›ã€ç™¼ç‡’                       â”‚
â”‚                                         â”‚
â”‚  è«‹è®“é†«å¸«æƒææ­¤ QR Code                 â”‚
â”‚                                         â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚        â”‚      é—œé–‰        â”‚            â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.4 Doctor PWA - å¾…è¨ºæ¸…å–® (Waiting Room)

**é‡è¦è¨­è¨ˆè€ƒé‡** (Gemini/ChatGPT å»ºè­°):
- é†«å¸«å¯èƒ½ä¸€æ¬¡æƒæå¤šå€‹æ›è™Ÿå–® (é å…ˆæ›è™Ÿ)
- éœ€è¦ã€Œå€™è¨ºæ¸…å–®ã€ä»‹é¢ï¼Œä¸æ˜¯æƒæå¾Œç›´æ¥é€²å…¥çœ‹è¨º
- æ”¯æ´æ‰¹æ¬¡æƒæ â†’ ä¾å„ªå…ˆé †åºæ’åº â†’ é€ä¸€çœ‹è¨º

æ–°å¢ã€Œæƒææ›è™Ÿã€åŠŸèƒ½ï¼Œå–ä»£æ‰‹å‹•æ–°å¢ç—…æ‚£ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  xIRS Doctor              ä»Šæ—¥: 5 å¼µ   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  å¾…è¨ºæ¸…å–® (3)                  [ğŸ”„åŒæ­¥] â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ ğŸ”´ ***0015 - èƒ¸ç—›ã€å‘¼å¸å›°é›£   â”‚    â”‚
â”‚  â”‚    STAT Â· 10:15 æ›è™Ÿ      [çœ‹è¨º]â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ ğŸŸ¡ ***0042 - é ­ç—›ã€ç™¼ç‡’       â”‚    â”‚
â”‚  â”‚    URGENT Â· 10:30 æ›è™Ÿ    [çœ‹è¨º]â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ ğŸŸ¢ ***0088 - è¼•å¾®æ“¦å‚·         â”‚    â”‚
â”‚  â”‚    ROUTINE Â· 10:45 æ›è™Ÿ   [çœ‹è¨º]â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  ğŸ“· æƒææ›è™Ÿå–®                 â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å¾…è¨ºæ¸…å–®åŠŸèƒ½:**
- è‡ªå‹•ä¾å„ªå…ˆé †åºæ’åº: STAT > URGENT > ROUTINE
- åŒå„ªå…ˆç­‰ç´šä¾æ›è™Ÿæ™‚é–“æ’åº
- é»æ“Š [çœ‹è¨º] é€²å…¥è™•æ–¹é–‹ç«‹ç•«é¢
- çœ‹è¨ºå®Œæˆå¾Œè‡ªå‹•ç§»è‡³ã€Œå·²çœ‹è¨ºã€å€åŸŸ
- æ”¯æ´å¾æ¸…å–®ç§»é™¤ (å–æ¶ˆæ›è™Ÿ)

---

## 5. API è¨­è¨ˆ

### 5.1 å»ºç«‹æ›è™Ÿ

```
POST /api/registrations
Authorization: Bearer <admin_token>

Request:
{
  "person_id": "P-0042",
  "priority": "URGENT",
  "chief_complaint": "é ­ç—›ã€ç™¼ç‡’"
}

Response:
{
  "reg_id": "REG-20251222-001",
  "patient_ref": "***0042",
  "display_name": "ç‹å°æ˜",
  "qr_payload": { ... },
  "qr_url": "..."
}
```

### 5.2 æŸ¥è©¢æ›è™Ÿæ¸…å–®

```
GET /api/registrations?status=WAITING
Authorization: Bearer <admin_token>

Response:
{
  "registrations": [
    {
      "reg_id": "REG-20251222-001",
      "patient_ref": "***0042",
      "display_name": "ç‹å°æ˜",
      "priority": "URGENT",
      "chief_complaint": "é ­ç—›ã€ç™¼ç‡’",
      "status": "WAITING",
      "registered_at": "2025-12-22T10:30:00Z"
    }
  ]
}
```

### 5.3 æ›´æ–°æ›è™Ÿç‹€æ…‹

```
PATCH /api/registrations/{reg_id}
Authorization: Bearer <admin_token>

Request:
{
  "status": "COMPLETED"
}
```

---

## 6. å®‰å…¨è€ƒé‡

### 6.1 è³‡æ–™åˆ†ç´šéµå¾ª

| è³‡æ–™é …ç›® | åˆ†ç´š | è™•ç†æ–¹å¼ |
|---------|------|---------|
| å®Œæ•´å§“å | Class A | åƒ…é¡¯ç¤ºæ–¼ CIRS Adminï¼Œä¸å‚³è‡³ Doctor |
| patient_ref | Class C | Masked IDï¼Œå¯å®‰å…¨å‚³è¼¸ |
| ä¸»è¨´ | Class B | åŠ å…¥ QR payloadï¼ŒDoctor æœ¬åœ°å„²å­˜ |
| å„ªå…ˆç­‰ç´š | Class C | å¯å®‰å…¨å‚³è¼¸ |

### 6.2 QR Code é©—è­‰

- ä½¿ç”¨ HMAC-SHA256 ç°½ç« é©—è­‰ QR Code å®Œæ•´æ€§
- æ›è™Ÿå–®æœ‰æ•ˆæœŸé™ï¼š24 å°æ™‚
- é˜²æ­¢é‡è¤‡æƒæï¼ˆDoctor PWA è¨˜éŒ„å·²è™•ç†çš„ reg_idï¼‰

---

## 7. å¯¦ä½œå„ªå…ˆé †åº

### Phase 1: åŸºç¤åŠŸèƒ½
1. [ ] CIRS å¾Œç«¯ï¼šæ–°å¢ registrations table
2. [ ] CIRS å¾Œç«¯ï¼šæ–°å¢ /api/registrations endpoints
3. [ ] CIRS Adminï¼šå ±åˆ°é é¢æ–°å¢ã€Œæ›è™Ÿã€æŒ‰éˆ•
4. [ ] CIRS Adminï¼šæ›è™Ÿ Modal èˆ‡ QR Code ç”¢ç”Ÿ

### Phase 2: Doctor PWA æ•´åˆ
5. [ ] Doctor PWAï¼šæ–°å¢ã€Œæƒææ›è™Ÿå–®ã€åŠŸèƒ½
6. [ ] Doctor PWAï¼šè§£æ PATIENT_REGISTRATION QR
7. [ ] Doctor PWAï¼šå¾…è¨ºæ¸…å–® UI
8. [ ] Doctor PWAï¼šå„ªå…ˆé †åºæ’åº

### Phase 3: é€²éšåŠŸèƒ½
9. [ ] å«è™Ÿç³»çµ± (æ•¸ä½çœ‹æ¿)
10. [ ] æ›è™Ÿç‹€æ…‹è¿½è¹¤
11. [ ] çµ±è¨ˆå ±è¡¨

---

## 8. èˆ‡ç¾æœ‰ç³»çµ±æ•´åˆ

### 8.1 èˆ‡ MIRS è—¥å“è³‡æ–™åº«

Doctor PWA çš„è—¥å“æ¸…å–®å¯ä»¥é€éä»¥ä¸‹æ–¹å¼å–å¾—ï¼š
1. **é›¢ç·šé è¼‰**: éƒ¨ç½²æ™‚é è¼‰å¸¸ç”¨è—¥å“æ¸…å–®
2. **CIRS Hub åŒæ­¥**: Hub ç¶­è­·è—¥å“ä¸»æª”ï¼ŒDoctor PWA é…å°æ™‚ä¸‹è¼‰
3. **æ‰‹å‹•åŒ¯å…¥**: å¾ MIRS åŒ¯å‡º JSONï¼ŒDoctor PWA åŒ¯å…¥

å»ºè­°æ¡ç”¨æ–¹æ¡ˆ 2ï¼Œåœ¨ CIRS Hub ç¶­è­·è—¥å“ä¸»æª”ã€‚

### 8.2 èˆ‡æª¢å‚·ç³»çµ±

æ›è™Ÿæ™‚å¯è‡ªå‹•å¸¶å…¥ CIRS æª¢å‚·çµæœ (triage color)ï¼Œä½œç‚ºçœ‹è¨ºå„ªå…ˆé †åºåƒè€ƒã€‚

---

## 9. v1.1 å¤šé†«å¸«å ´æ™¯ API

### 9.1 åŒæ­¥å¾…è¨ºæ¸…å–® (Doctor PWA ç”¨)

```
GET /api/registrations/waiting/list
(ç„¡éœ€æˆæ¬Š - ç½é›£å ´æ™¯ç°¡åŒ–è¨­è¨ˆ)

Response:
{
  "count": 2,
  "registrations": [
    {
      "reg_id": "REG-20251222-001",
      "patient_ref": "***0042",
      "display_name": "ç‹å°æ˜",
      "priority": "URGENT",
      "chief_complaint": "é ­ç—›ã€ç™¼ç‡’",
      "status": "WAITING",
      "triage": "YELLOW",
      "registered_at": "2025-12-22T10:30:00Z",
      "claimed_by": null
    }
  ]
}
```

### 9.2 æ¥è¨º (Claim)

é†«å¸«é»æ“Šã€Œçœ‹è¨ºã€æ™‚ï¼Œå°‡ç—…æ‚£å¾å…¬å…±ç­‰å€™å€ç§»è‡³è©²é†«å¸«çš„ç—…æ‚£æ¸…å–®ï¼š

```
POST /api/registrations/{reg_id}/claim
Content-Type: application/json

Request:
{
  "doctor_id": "DOC-001",
  "doctor_name": "æé†«å¸«"
}

Response (200 OK):
{
  "success": true,
  "reg_id": "REG-20251222-001",
  "claimed_by": "DOC-001"
}

Response (409 Conflict - å·²è¢«å…¶ä»–é†«å¸«æ¥è¨º):
{
  "detail": "Already claimed by DOC-002"
}
```

### 9.3 æŸ¥è©¢æˆ‘çš„ç—…æ‚£

```
GET /api/registrations/doctor/{doctor_id}/patients

Response:
{
  "doctor_id": "DOC-001",
  "count": 2,
  "patients": [
    {
      "reg_id": "REG-20251222-001",
      "patient_ref": "***0042",
      "status": "IN_PROGRESS",
      "claimed_at": "2025-12-22T10:35:00Z"
    }
  ]
}
```

### 9.4 å®Œæˆçœ‹è¨º

```
POST /api/registrations/{reg_id}/complete
Content-Type: application/json

Request:
{
  "doctor_id": "DOC-001"
}
```

### 9.5 é‡‹æ”¾ç—…æ‚£ (æ”¾å›ç­‰å€™å€)

```
POST /api/registrations/{reg_id}/release
Content-Type: application/json

Request:
{
  "doctor_id": "DOC-001"
}
```

---

## 10. v1.1 è—¥å“åº«å­˜ API

### 10.1 è—¥å“æ¸…å–®

```
GET /api/medications/list

Response:
{
  "count": 16,
  "medications": [
    {
      "code": "ACETAMINOPHEN_500_TAB",
      "name": "Acetaminophen 500mg éŒ ",
      "category": "è§£ç†±é®ç—›",
      "form": "TAB",
      "is_controlled": false,
      "substitution_group": "APAP"
    }
  ]
}
```

### 10.2 åº«å­˜ç‹€æ…‹ (R/Y/G)

```
GET /api/medications/status?station_id=PHARM-01

Response:
{
  "as_of": 1734860000,
  "ttl_seconds": 1800,
  "station_id": "PHARM-01",
  "source": "DEMO",
  "medications": [
    {
      "code": "ACETAMINOPHEN_500_TAB",
      "name": "Acetaminophen 500mg éŒ ",
      "stock_status": "OK",
      "is_controlled": false
    },
    {
      "code": "AMOXICILLIN_500_CAP",
      "name": "Amoxicillin 500mg è† å›Š",
      "stock_status": "LOW",
      "is_controlled": false
    },
    {
      "code": "OMEPRAZOLE_20_CAP",
      "name": "Omeprazole 20mg è† å›Š",
      "stock_status": "OUT",
      "is_controlled": false
    }
  ]
}
```

**åº«å­˜ç‹€æ…‹å®šç¾©:**
| Status | æ¢ä»¶ | UI é¡¯ç¤º |
|--------|------|---------|
| OK | qty >= min_stock | âœ“ æœ‰åº«å­˜ (ç¶ ) |
| LOW | 0 < qty < min_stock | âš  ä½åº«å­˜ (é»ƒ) |
| OUT | qty == 0 | âœ— ç¼ºè²¨ (ç´…) |

---

## 11. v1.2 UI æ¶æ§‹é‡æ¸…

### 11.1 Doctor PWA å…©ç¨®ç—…æ‚£ä¾†æº

| Tab | ä¾†æº | ç”¨é€” | è³‡æ–™å„²å­˜ |
|-----|------|------|----------|
| **ç­‰å€™å®¤** | CIRS æ›è™Ÿç³»çµ± | æ­£å¼æµç¨‹ - å¾ Admin æ›è™Ÿå¾ŒåŒæ­¥ | Server-side (registrations table) |
| **ç—…æ‚£** | æ‰‹å‹•è¼¸å…¥ | å‚™ç”¨æµç¨‹ - ç„¡æ³•ä½¿ç”¨æ›è™Ÿç³»çµ±æ™‚ | Client-side (IndexedDB) |

**ç­‰å€™å®¤æµç¨‹:**
```
CIRS Admin æ›è™Ÿ â†’ ç—…æ‚£å‡ºç¾åœ¨ã€Œç­‰å€™å®¤ã€å…±ç”¨æ¸…å–®
                â†’ é†«å¸«é»æ“Šã€Œçœ‹è¨ºã€claim ç—…æ‚£
                â†’ ç—…æ‚£ç§»è‡³è©²é†«å¸«çš„ã€Œæˆ‘çš„ç—…æ‚£ã€
                â†’ å…¶ä»–é†«å¸«çœ‹ä¸åˆ°æ­¤ç—…æ‚£
```

**ç—…æ‚£ Tab æµç¨‹:**
```
é†«å¸«æ‰‹å‹•è¼¸å…¥ç—…æ‚£è³‡æ–™ â†’ å­˜å…¥æœ¬æ©Ÿ IndexedDB
                    â†’ åƒ…è©²è¨­å‚™å¯è¦‹
                    â†’ é©ç”¨æ–¼ç¶²è·¯æ–·ç·šæˆ–ç·Šæ€¥æƒ…æ³
```

### 11.2 æ‰‹å‹•ç—…æ‚£åˆªé™¤æµç¨‹

æ‰‹å‹•è¼¸å…¥çš„ç—…æ‚£éœ€è¦æœ‰åˆªé™¤æ©Ÿåˆ¶ï¼Œä½†å¿…é ˆè¨˜éŒ„åŸå› ï¼š

**åˆªé™¤åŸå› é¸é …:**
- `INPUT_ERROR` - è¼¸å…¥éŒ¯èª¤
- `DUPLICATE` - é‡è¤‡å»ºç«‹
- `PATIENT_LEFT` - ç—…æ‚£é›¢é–‹
- `OTHER` - å…¶ä»– (éœ€å¡«å¯«èªªæ˜)

**è³‡æ–™çµæ§‹ (IndexedDB):**
```javascript
{
  patient_id: "MANUAL-001",
  name: "...",
  // ... other fields
  deleted_at: "2025-12-22T10:30:00Z",  // null if not deleted
  delete_reason: "INPUT_ERROR",
  delete_note: "å§“åè¼¸å…¥éŒ¯èª¤"
}
```

**UI:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åˆªé™¤ç—…æ‚£                        [X]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  ç¢ºå®šè¦åˆªé™¤æ­¤ç—…æ‚£è³‡æ–™ï¼Ÿ                 â”‚
â”‚  ç—…æ‚£: MANUAL-001 (ç‹å°æ˜)              â”‚
â”‚                                         â”‚
â”‚  åˆªé™¤åŸå›  *                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ â–¼ è¼¸å…¥éŒ¯èª¤                     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                         â”‚
â”‚  å‚™è¨»                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                                â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                         â”‚
â”‚  âš ï¸ æ­¤æ“ä½œæœƒæ¨™è¨˜åˆªé™¤ï¼Œä¸æœƒçœŸæ­£ç§»é™¤      â”‚
â”‚                                         â”‚
â”‚  [å–æ¶ˆ]              [ç¢ºèªåˆªé™¤]         â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 11.3 è™•æ–¹è¡¨å–®ç‹€æ…‹éš”é›¢

**å•é¡Œ:** åˆ‡æ›ç—…æ‚£æ™‚ï¼Œè™•æ–¹å…§å®¹æœªé‡ç½®

**ä¿®æ­£æ–¹æ¡ˆ:**
```javascript
// åˆ‡æ›ç—…æ‚£æ™‚å¿…é ˆå‘¼å«
selectPatient(patient) {
    this.selectedPatient = patient;
    this.resetRxForm();  // é‡ç½®è™•æ–¹è¡¨å–®
    this.currentScreen = 'prescription';
}

resetRxForm() {
    this.rxForm = {
        diagnosis: this.selectedPatient?.chief_complaint || '',
        items: [],  // æ¸…ç©ºè—¥å“æ¸…å–®
        priority: 'ROUTINE',
        note: ''
    };
}
```

---

## 12. v1.2 è—¥å“ç³»çµ±æ¸¬è©¦æµç¨‹

### 12.1 æ¸¬è©¦å‰æ
- Server å·²å•Ÿå‹• (`python3 backend/main.py`)
- Doctor PWA å·²è¨­å®šé†«å¸«æ†‘è­‰

### 12.2 æ¸¬è©¦æ­¥é©Ÿ

**Step 1: ç¢ºèªè—¥å“ API å¯ç”¨**
```bash
# è—¥å“æ¸…å–®
curl http://localhost:8090/api/medications/list | jq '.medications[:3]'

# åº«å­˜ç‹€æ…‹
curl http://localhost:8090/api/medications/status | jq '.medications[:5]'
```

**Step 2: åœ¨ Doctor PWA æ¸¬è©¦**
1. é–‹å•Ÿ http://localhost:8090/doctor/
2. è¨­å®šé†«å¸«æ†‘è­‰ (è¨­å®š â†’ å¡«å…¥ prescriber_id)
3. åŒæ­¥æ›è™Ÿ æˆ– æ‰‹å‹•æ–°å¢ç—…æ‚£
4. é»æ“Šã€Œçœ‹è¨ºã€æˆ–é¸æ“‡ç—…æ‚£
5. é»æ“Šã€Œæ–°å¢è—¥å“ã€
6. è§€å¯Ÿï¼š
   - åº«å­˜ç‹€æ…‹æ¨™ç±¤ (OK/LOW/OUT)
   - éæœŸè­¦ç¤º (å¦‚æœ TTL è¶…é)
   - é»æ“Šåˆ·æ–°æŒ‰éˆ•æ›´æ–°åº«å­˜

**Step 3: é©—è­‰åº«å­˜ç‹€æ…‹é¡¯ç¤º**

| è—¥å“ | é æœŸç‹€æ…‹ | é¡è‰² |
|------|----------|------|
| Acetaminophen 500mg | OK | ç¶ è‰² |
| Amoxicillin 500mg | LOW | é»ƒè‰² |
| Omeprazole 20mg | OUT | ç´…è‰² |
| Loperamide 2mg | OUT | ç´…è‰² |

### 12.3 Demo è³‡æ–™èªªæ˜

ç›®å‰è—¥å“ API ä½¿ç”¨ç¡¬ç·¨ç¢¼çš„ Demo è³‡æ–™ (`backend/routes/medications.py`)ï¼š
- 16 ç¨®å¸¸è¦‹è—¥å“
- æ¨¡æ“¬åº«å­˜ç‹€æ…‹ (OK/LOW/OUT)
- ç®¡åˆ¶è—¥å“æ¨™è¨˜ (Diazepam, Morphine, Tramadol)

**ç”Ÿç”¢ç’°å¢ƒæ•´åˆ:**
æœªä¾†éœ€è¦å¾ MIRS åŒæ­¥å¯¦éš›è—¥å“è³‡æ–™ã€‚

---

## 13. Doctor PWA v1.2 é¡è‰²ä¸»é¡Œ

æ›´æ–°çš„é¡è‰²é…ç½®ï¼ˆåŸºæ–¼ç”¨æˆ¶è¦æ±‚ï¼‰:

```javascript
tailwind.config = {
  theme: {
    extend: {
      colors: {
        doctor: {
          50: '#f0f7f9',
          100: '#d2dcdc',
          200: '#afdfe4',
          300: '#8dc5cc',
          400: '#6aa8b2',
          500: '#597594',
          600: '#4a6680',
          700: '#0f5474',  // Primary
          800: '#0c4460',
          900: '#09354c',
        }
      }
    }
  }
}
```

---

## 9. æœªä¾†æ“´å±•

- é ç´„æ›è™Ÿ
- è¤‡è¨ºè¿½è¹¤
- è½‰è¨ºåŠŸèƒ½
- èˆ‡ HIRS (å®¶åº­å¥åº·ç´€éŒ„) æ•´åˆ
