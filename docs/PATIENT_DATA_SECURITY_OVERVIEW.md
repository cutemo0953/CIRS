# xIRS/CIRS 病患資訊安全架構說明

**版本**: 1.0
**日期**: 2025-12-22
**對象**: 醫師、管理階層、資訊安全人員
**系統**: CIRS (社區韌性物資管理系統) / xIRS (分散式物流系統)

---

## 執行摘要

xIRS/CIRS 系統採用 **「隱私優先設計 (Privacy by Design)」** 架構，確保在災難醫療應變期間：

1. **病患可識別資訊 (PHI) 不會外洩**至物流端設備
2. **臨床資料全程加密**，只有授權角色可存取
3. **離線運作時仍維持資安邊界**
4. **完整稽核軌跡**支援事後追溯

**核心原則**：即使設備遺失或被竊，攻擊者也無法取得病患身分資訊。

---

## 1. 資料分級制度

### 1.1 三級分類模型

| 分級 | 名稱 | 定義 | 範例 |
|------|------|------|------|
| **Class A** | 高敏感 PHI | 可直接識別個人身分 | 姓名、身分證字號、電話、地址、完整病歷 |
| **Class B** | 臨床資料 | 最小化臨床必要資訊 | 遮蔽病患代號、處方內容、SOAP 紀錄 |
| **Class C** | 運作資料 | 無隱私敏感性 | 物品代碼、數量、站點 ID、時間戳 |

### 1.2 各級資料的存取規則

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          資料存取矩陣                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   Class A (高敏感)         Class B (臨床)           Class C (運作)        │
│   ═══════════════         ══════════════           ═══════════════       │
│                                                                          │
│   ┌───────────┐           ┌───────────┐           ┌───────────┐         │
│   │  Hub 主機 │           │ 醫師 PWA  │           │ 物資站    │         │
│   │  (加密)   │           │ 藥局 PWA  │           │ Runner    │         │
│   └───────────┘           │  (加密)   │           │  (明文)   │         │
│                           └───────────┘           └───────────┘         │
│                                                                          │
│   存取：僅 Hub 管理員      存取：醫師/藥師          存取：所有人員         │
│   傳輸：永不離開 Hub       傳輸：加密封包           傳輸：QR / Runner      │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 病患識別碼遮蔽機制

### 2.1 問題：為什麼不能直接傳遞病患 ID？

在災難現場，QR Code 和 Runner（物資運送志工）是主要的資料傳輸媒介。若 QR Code 包含病患姓名或完整 ID：

- **QR 被拍照** → 病患隱私外洩
- **Runner 手機遺失** → 批次隱私外洩
- **物資站螢幕被偷看** → 隱私外洩

### 2.2 解決方案：patient_ref 遮蔽格式

```
原始 ID:     P0042-陳小華
遮蔽格式:    ***0042

規則:        *** + 最後 4 個字元
用途:        足夠口頭核對，不足以識別身分
```

### 2.3 遮蔽前後對照

| 欄位 | 原始值 | QR/傳輸值 | 說明 |
|------|--------|-----------|------|
| 病患 ID | P0042 | ***0042 | 遮蔽前 5 碼 |
| 病患姓名 | 陳小華 | ❌ 不傳輸 | 完全移除 |
| 身分證字號 | A123456789 | ❌ 不傳輸 | 完全移除 |
| 年齡/體重 | 35歲/65kg | ❌ 不傳輸 | 移除（可能用於識別） |
| 診斷 | 上呼吸道感染 | ⚠️ 選擇性 | 僅必要時傳輸 |

---

## 3. 系統架構與資安邊界

### 3.1 設備角色與資料權限

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        xIRS 系統架構                                     │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                     Hub 主機 (Raspberry Pi)                      │    │
│  │                                                                  │    │
│  │   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐          │    │
│  │   │  Class A    │   │  Class B    │   │  Class C    │          │    │
│  │   │  完整病患   │   │  臨床紀錄   │   │  物流資料   │          │    │
│  │   │  資料庫     │   │  (加密)     │   │             │          │    │
│  │   └─────────────┘   └─────────────┘   └─────────────┘          │    │
│  │                                                                  │    │
│  │   🔐 SQLite 加密 + 存取控制 + 稽核日誌                          │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                              │                                           │
│              ┌───────────────┼───────────────┐                          │
│              │               │               │                          │
│              ▼               ▼               ▼                          │
│  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐               │
│  │   醫師 PWA    │  │   藥局 PWA    │  │   物資站 PWA  │               │
│  │               │  │               │  │               │               │
│  │ ✅ Class B    │  │ ✅ Class B    │  │ ❌ Class A    │               │
│  │ ✅ Class C    │  │ ✅ Class C    │  │ ❌ Class B    │               │
│  │               │  │               │  │ ✅ Class C    │               │
│  │ 🔐 加密儲存   │  │ 🔐 加密儲存   │  │               │               │
│  └───────────────┘  └───────────────┘  └───────────────┘               │
│         │                  │                  │                         │
│         │                  │                  │                         │
│         └──────────────────┼──────────────────┘                         │
│                            │                                            │
│                            ▼                                            │
│                   ┌───────────────┐                                     │
│                   │    Runner     │                                     │
│                   │   (志工手機)  │                                     │
│                   │               │                                     │
│                   │ ❌ Class A    │  ← 完全看不到病患資訊               │
│                   │ ❌ Class B    │                                     │
│                   │ ✅ Class C    │                                     │
│                   │               │                                     │
│                   │ 僅傳輸加密    │                                     │
│                   │ 封包 (Blind)  │                                     │
│                   └───────────────┘                                     │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 各設備的資安定位

| 設備 | 使用者 | 可見資料 | 資安措施 |
|------|--------|----------|----------|
| **Hub 主機** | 管理員 | 全部 | SQLite 加密、存取控制、稽核日誌 |
| **醫師 PWA** | 醫師 | Class B + C | Ed25519 簽章、IndexedDB 加密 |
| **藥局 PWA** | 藥師 | Class B + C | 隱私模式、加密儲存、憑證驗證 |
| **物資站 PWA** | 志工 | Class C only | HMAC 驗證、無 PHI 存取 |
| **Runner** | 志工 | 加密封包 | Blind Carrier、無解密能力 |

---

## 4. 臨床資料傳輸安全

### 4.1 處方傳輸流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      處方傳輸安全流程                                    │
│                                                                          │
│   醫師 PWA                Runner                    藥局 PWA             │
│   ════════                ══════                    ════════             │
│                                                                          │
│   ┌──────────┐                                                          │
│   │ 開立處方 │                                                          │
│   │          │                                                          │
│   │ 病患:    │                                                          │
│   │ P0042    │  ──┐                                                     │
│   │ 陳小華   │    │                                                     │
│   └──────────┘    │                                                     │
│        │          │                                                     │
│        ▼          │                                                     │
│   ┌──────────┐    │                                                     │
│   │ 產生 QR  │    │  病患姓名、完整 ID                                  │
│   │          │    │  在此步驟被移除                                     │
│   │ 內容:    │    │                                                     │
│   │ ***0042  │ ◄──┘                                                     │
│   │ (無姓名) │                                                          │
│   └──────────┘                                                          │
│        │                                                                │
│        │ QR Code                                                        │
│        ▼                                                                │
│   ┌──────────┐         ┌──────────┐         ┌──────────┐               │
│   │ Ed25519  │ ──────► │ 只看到   │ ──────► │ 驗證簽章 │               │
│   │ 數位簽章 │         │ QR 圖案  │         │ 顯示處方 │               │
│   └──────────┘         │          │         │          │               │
│                        │ 無法解讀 │         │ ***0042  │               │
│                        │ 內容     │         │ (無姓名) │               │
│                        └──────────┘         └──────────┘               │
│                                                                          │
│   ✅ 病患姓名只存在醫師 PWA 的加密資料庫中                              │
│   ✅ Runner 完全無法得知病患身分                                        │
│   ✅ 藥局僅看到遮蔽 ID，口頭核對後發藥                                  │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 4.2 加密技術規格

| 用途 | 演算法 | 金鑰管理 |
|------|--------|----------|
| 數位簽章 | Ed25519 | 醫師私鑰存於 PWA 加密區 |
| 資料傳輸加密 | NaCl SealedBox (X25519 + XSalsa20-Poly1305) | Hub 公鑰，站點私鑰 |
| 完整性驗證 | HMAC-SHA256 | 站點 secret（配對時取得） |
| 本地儲存加密 | AES-256-GCM | 設備綁定金鑰 |

---

## 5. 處置與庫存的隱私分離

### 5.1 問題：臨床處置如何與庫存連結？

當醫師開立「插管」醫囑，物資站需要扣除「氣管內管」庫存。但：
- 物資站志工**不應該知道**是哪位病患
- 物資站志工**不應該知道**是什麼處置

### 5.2 解決方案：event_ref 匿名連結

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     處置-庫存隱私分離架構                                │
│                                                                          │
│   臨床端 (醫師/護理師)              物資端 (物資站)                      │
│   ════════════════════              ══════════════════                   │
│                                                                          │
│   ┌────────────────────┐            ┌────────────────────┐              │
│   │ PROCEDURE_ORDER    │            │ CONSUMPTION_RECORD │              │
│   │                    │            │                    │              │
│   │ patient_ref: ***42 │            │ patient_ref: ❌    │              │
│   │ procedure: 插管    │            │ procedure: ❌      │              │
│   │ performer: DOC-001 │            │ performer: ❌      │              │
│   │                    │            │                    │              │
│   │ event_ref: evt_abc │◄──────────►│ event_ref: evt_abc │              │
│   │        ▲           │            │        ▲           │              │
│   └────────┼───────────┘            └────────┼───────────┘              │
│            │                                  │                          │
│            │      唯一連結點                  │                          │
│            │      (匿名 UUID)                 │                          │
│            │                                  │                          │
│            └──────────────┬───────────────────┘                          │
│                           │                                              │
│                           ▼                                              │
│                   ┌───────────────┐                                      │
│                   │      Hub      │                                      │
│                   │               │                                      │
│                   │  對帳時才能   │                                      │
│                   │  看到完整     │                                      │
│                   │  關聯         │                                      │
│                   └───────────────┘                                      │
│                                                                          │
│   ✅ 物資站只知道「有人要領這些東西」                                   │
│   ✅ 物資站不知道「是誰、做什麼處置」                                   │
│   ✅ Hub 管理員可以完整追溯（稽核用）                                   │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 6. 藥局 PWA 隱私模式

### 6.1 功能說明

藥局 PWA 內建「隱私模式」，預設開啟：

| 功能 | 隱私模式 ON | 隱私模式 OFF |
|------|------------|--------------|
| 病患代號 | `*******` (模糊) | `***0042` (可見末4碼) |
| 藥品名稱 | 模糊顯示 | 完整顯示 |
| 處方詳情 | 需點擊展開 | 直接顯示 |

### 6.2 使用情境

- **開啟**：公共空間、有旁觀者時
- **關閉**：獨立調劑區、確認發藥時

```
┌─────────────────────────────────────────┐
│  💊 藥局                   🔒 隱私模式  │
├─────────────────────────────────────────┤
│                                         │
│  待調劑:                                │
│  ┌─────────────────────────────────┐   │
│  │ RX-0099 ******* STAT 管制藥    ▶│   │  ← 病患代號完全遮蔽
│  ├─────────────────────────────────┤   │
│  │ RX-0098 ******* URGENT         ▶│   │
│  └─────────────────────────────────┘   │
│                                         │
│  點擊展開以查看詳情                     │
│                                         │
└─────────────────────────────────────────┘
```

---

## 7. 稽核與追溯能力

### 7.1 稽核日誌記錄項目

所有涉及病患資料的操作都會記錄：

| 記錄項目 | 範例 |
|----------|------|
| 操作者 ID | DOC-001, PHARM-001 |
| 操作時間 | 2025-12-22T14:30:00Z |
| 操作類型 | CREATE_RX, DISPENSE, VIEW_RECORD |
| 對象 ID | RX-0042, ***0042 |
| 來源 IP/設備 | 192.168.1.100, iPad-PHARM |
| 結果 | SUCCESS, DENIED |

### 7.2 追溯能力

即使採用遮蔽機制，Hub 管理員仍可進行完整追溯：

```sql
-- 查詢特定處方的完整軌跡
SELECT
  p.name AS patient_name,        -- 只有 Hub 能看到
  r.rx_id,
  r.prescriber_id,
  d.pharmacist_id,
  d.dispensed_at
FROM patients p
JOIN rx_orders r ON p.id = r.patient_id
JOIN dispense_records d ON r.rx_id = d.rx_id
WHERE r.rx_id = 'RX-DOC001-20251222-0042';
```

---

## 8. 風險評估與緩解

### 8.1 威脅模型

| 威脅 | 可能性 | 影響 | 緩解措施 |
|------|--------|------|----------|
| Runner 手機遺失 | 高 | 低 | Runner 無法解密，僅傳輸加密封包 |
| 物資站平板被竊 | 中 | 低 | 無 PHI 儲存，僅 Class C 資料 |
| QR Code 被拍照 | 高 | 低 | 無病患姓名，僅遮蔽 ID |
| 藥局 PWA 被偷看 | 中 | 中 | 隱私模式遮蔽、螢幕鎖定 |
| Hub 主機被駭 | 低 | 高 | SQLite 加密、存取控制、實體隔離 |
| 醫師 PWA 遺失 | 中 | 中 | 設備加密、PIN 保護、遠端清除 |

### 8.2 最壞情況分析

**情境**: 攻擊者取得物資站平板

**結果**:
- ❌ 無法取得任何病患姓名
- ❌ 無法取得任何身分證字號
- ❌ 無法關聯處置與病患
- ✅ 只能看到物資進出數量（非敏感）

**結論**: 即使物資站設備完全失陷，病患隱私仍受保護。

---

## 9. 法規遵循對照

### 9.1 個資法對照

| 個資法要求 | xIRS 實作 |
|------------|-----------|
| 最小蒐集原則 | 物資站僅蒐集 Class C，不含 PHI |
| 目的限制原則 | 各 PWA 僅存取業務必要資料 |
| 安全維護義務 | 加密儲存、傳輸加密、存取控制 |
| 告知義務 | 透過本文件說明 |

### 9.2 災難醫療例外

本系統設計用於**災難醫療緊急應變**，依據：
- 緊急醫療救護法
- 災害防救法

在緊急狀態下，為搶救生命可簡化部分行政程序，但仍須：
- 維護病患基本隱私
- 保留稽核軌跡
- 事後可追溯

---

## 10. 總結

### 10.1 設計原則

| 原則 | 說明 |
|------|------|
| **Privacy by Design** | 隱私保護內建於架構，非事後加裝 |
| **Least Privilege** | 各角色只能存取業務必要資料 |
| **Defense in Depth** | 多層防護（加密+存取控制+稽核） |
| **Fail Secure** | 設備遺失時，預設保護病患隱私 |

### 10.2 關鍵保障

```
┌─────────────────────────────────────────────────────────────────────────┐
│                                                                          │
│   ✅ 物資站志工「永遠看不到」病患姓名或身分證字號                       │
│                                                                          │
│   ✅ Runner（運送志工）「只是傳遞加密封包」，無法解讀內容               │
│                                                                          │
│   ✅ 藥師看到的是「遮蔽 ID」，足夠核對但不足以識別                      │
│                                                                          │
│   ✅ 即使設備遺失，攻擊者也「無法取得」病患可識別資訊                   │
│                                                                          │
│   ✅ Hub 管理員保有「完整追溯能力」，支援稽核與改善                     │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 附錄 A：名詞對照

| 英文 | 中文 | 說明 |
|------|------|------|
| PHI | 受保護健康資訊 | Protected Health Information |
| patient_ref | 病患參照碼 | 遮蔽後的病患識別碼 |
| event_ref | 事件參照碼 | 連結臨床與物流的匿名 UUID |
| Blind Carrier | 盲傳遞者 | Runner 無法解讀傳輸內容 |
| HMAC | 訊息驗證碼 | 確保資料完整性 |
| Ed25519 | 數位簽章演算法 | 確保資料來源可信 |

---

## 附錄 B：相關規格文件

| 文件 | 內容 |
|------|------|
| `xIRS_LITE_CPOE_SPEC_v1.0.md` | 處方系統規格（含 Section 4.6 隱私要求） |
| `PHARMACY_RX_WORKFLOW_SPEC_v1.0.md` | 藥局工作流程 |
| `xIRS_PROCEDURE_INVENTORY_BRIDGE_SPEC_v1.0.md` | 處置-庫存橋接（隱私分離架構） |
| `STATION_PWA_DEV_SPEC_v2.3.md` | 物資站規格（資料分級模型） |

---

*文件版本: 1.0*
*建立日期: 2025-12-22*
*適用系統: CIRS v2.3+ / xIRS v2.0+*
*審閱狀態: 待審閱*
