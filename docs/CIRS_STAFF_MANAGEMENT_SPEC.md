# CIRS Staff Management Specification v1.0

> ç¤¾å€é¿é›£ä¸­å¿ƒéŸŒæ€§ç³»çµ± - å·¥ä½œäººå“¡ç®¡ç†è¦æ ¼æ›¸

## 1. æ¦‚è¿°

### 1.1 ç›®çš„

æœ¬è¦æ ¼æ›¸å®šç¾© CIRS ç³»çµ±çš„å·¥ä½œäººå“¡ç®¡ç†æ©Ÿåˆ¶ï¼Œè§£æ±ºä»¥ä¸‹å•é¡Œï¼š

1. **è§’è‰²ç³»çµ±ä¸çµ±ä¸€**ï¼š`person.role` èˆ‡ `staffing_rules.role_code` æœªå°é½Š
2. **ç¼ºä¹å·¥ä½œäººå“¡ç™»éŒ„æµç¨‹**ï¼šç›®å‰ PWA ä¸»è¦ç”¨æ–¼æ”¶å®¹æ°‘çœ¾å ±åˆ°
3. **éŸŒæ€§è¨ˆç®—æ–·å±¤**ï¼šäººåŠ›è©•åˆ†ç„¡æ³•å¾å¯¦éš›äººå“¡è³‡æ–™å–å¾—

### 1.2 ç›®æ¨™

- çµ±ä¸€è§’è‰²å®šç¾©ï¼Œæ”¯æ´éŸŒæ€§è¨ˆç®—
- æä¾›å·¥ä½œäººå“¡ç™»éŒ„èˆ‡ç®¡ç† UI
- å³æ™‚é€£å‹•éŸŒæ€§å„€è¡¨æ¿äººåŠ›ç‹€æ…‹
- æ”¯æ´ç½å‰é ç™»èˆ‡ç·Šæ€¥æ‹›å‹Ÿå…©ç¨®æƒ…å¢ƒ

---

## 2. ç¾æ³åˆ†æ

### 2.1 ç¾æœ‰ Person è§’è‰²

```sql
-- person.role æ¬„ä½
'admin'   -- ç³»çµ±ç®¡ç†å“¡
'staff'   -- ä¸€èˆ¬å·¥ä½œäººå“¡
'medic'   -- é†«è­·äººå“¡
'public'  -- æ”¶å®¹æ°‘çœ¾
```

### 2.2 éŸŒæ€§è¨ˆç®—äººåŠ›è¦å‰‡

```sql
-- staffing_rules.role_code
'MEDIC'      -- é†«è­·äººå“¡ (æ¯ 50 äººéœ€ 1 å)
'VOLUNTEER'  -- å¿—å·¥ (æ¯ 20 äººéœ€ 1 å)
'ADMIN'      -- è¡Œæ”¿äººå“¡ (æ¯ç«™æœ€å°‘ 2 å)
'SECURITY'   -- ä¿å…¨äººå“¡ (æ¯ç«™æœ€å°‘ 1 å)
```

### 2.3 å•é¡Œé»

| å•é¡Œ | å½±éŸ¿ |
|------|------|
| `person.role` ç„¡ `volunteer`, `security`, `nurse` | éŸŒæ€§å¼•æ“ç„¡æ³•æ­£ç¢ºè¨ˆç®—äººåŠ› |
| è§’è‰²å¤§å°å¯«ä¸ä¸€è‡´ (`medic` vs `MEDIC`) | æŸ¥è©¢é‚è¼¯éœ€é¡å¤–è½‰æ› |
| ç„¡å·¥ä½œäººå“¡å°ˆå±¬ç™»éŒ„æµç¨‹ | å·¥ä½œäººå“¡èˆ‡æ°‘çœ¾æ··ç”¨åŒä¸€å ±åˆ°ä»‹é¢ |
| ç„¡ç­è¡¨/å‡ºå‹¤ç‹€æ…‹ | ç„¡æ³•å€åˆ†ã€Œå·²ç™»è¨˜ã€èˆ‡ã€Œåœ¨å€¼ã€äººå“¡ |

---

## 3. è§’è‰²ç³»çµ±è¨­è¨ˆ

### 3.1 çµ±ä¸€è§’è‰²å®šç¾©

æ–°å¢ `staff_role` æ¬„ä½ï¼Œèˆ‡ `staffing_rules.role_code` å°é½Šï¼š

```sql
ALTER TABLE person ADD COLUMN staff_role TEXT;
-- å¯é¸å€¼: 'MEDIC', 'NURSE', 'VOLUNTEER', 'ADMIN', 'SECURITY', 'COORDINATOR'
-- NULL è¡¨ç¤ºéå·¥ä½œäººå“¡ (ä¸€èˆ¬æ°‘çœ¾)
```

### 3.2 è§’è‰²å°ç…§è¡¨

| staff_role | ä¸­æ–‡åç¨± | èªªæ˜ | éŸŒæ€§è¨ˆç®—æ¬Šé‡ |
|------------|----------|------|--------------|
| `MEDIC` | é†«å¸« | å…·é†«å¸«è³‡æ ¼ | è¨ˆå…¥é†«è­· |
| `NURSE` | è­·ç†å¸« | å…·è­·ç†è³‡æ ¼ | è¨ˆå…¥é†«è­· |
| `VOLUNTEER` | å¿—å·¥ | ä¸€èˆ¬å¿—å·¥ | è¨ˆå…¥å¿—å·¥ |
| `ADMIN` | è¡Œæ”¿äººå“¡ | ç™»è¨˜ã€ç‰©è³‡ç®¡ç† | è¨ˆå…¥è¡Œæ”¿ |
| `SECURITY` | ä¿å…¨äººå“¡ | å®‰å…¨ç¶­è­· | è¨ˆå…¥ä¿å…¨ |
| `COORDINATOR` | ç«™é•·/å‰¯ç«™é•· | æŒ‡æ®çµ±ç±Œ | è¨ˆå…¥è¡Œæ”¿ |
| `NULL` | æ”¶å®¹æ°‘çœ¾ | éå·¥ä½œäººå“¡ | ä¸è¨ˆå…¥ |

### 3.3 ä¿ç•™ `role` æ¬„ä½

åŸæœ‰ `role` æ¬„ä½ä¿ç•™ä½œç‚º**ç³»çµ±æ¬Šé™**æ§åˆ¶ï¼š

```
role = 'admin'  â†’ å¯å­˜å–ç®¡ç†åŠŸèƒ½
role = 'staff'  â†’ å¯å­˜å–å·¥ä½œäººå“¡åŠŸèƒ½
role = 'medic'  â†’ å¯å­˜å–é†«ç™‚åŠŸèƒ½
role = 'public' â†’ åƒ…åŸºæœ¬åŠŸèƒ½
```

**é—œä¿‚**ï¼š
- `staff_role` = äººå“¡**è·èƒ½é¡åˆ¥**ï¼ˆç”¨æ–¼éŸŒæ€§è¨ˆç®—ï¼‰
- `role` = ç³»çµ±**å­˜å–æ¬Šé™**ï¼ˆç”¨æ–¼ UI æ¬Šé™æ§åˆ¶ï¼‰

---

## 4. å·¥ä½œäººå“¡ç‹€æ…‹ç®¡ç†

### 4.1 æ–°å¢æ¬„ä½

```sql
ALTER TABLE person ADD COLUMN staff_role TEXT;           -- è·èƒ½é¡åˆ¥
ALTER TABLE person ADD COLUMN staff_status TEXT;         -- 'ACTIVE', 'OFF_DUTY', 'ON_LEAVE'
ALTER TABLE person ADD COLUMN certification TEXT;        -- è­‰ç…§è³‡è¨Š JSON
ALTER TABLE person ADD COLUMN shift_start DATETIME;      -- æœ¬ç­é–‹å§‹æ™‚é–“
ALTER TABLE person ADD COLUMN shift_end DATETIME;        -- æœ¬ç­é è¨ˆçµæŸ
ALTER TABLE person ADD COLUMN emergency_contact TEXT;    -- ç·Šæ€¥è¯çµ¡äºº
```

### 4.2 ç‹€æ…‹å®šç¾©

| staff_status | èªªæ˜ | è¨ˆå…¥éŸŒæ€§ |
|--------------|------|----------|
| `ACTIVE` | åœ¨å€¼ä¸­ | âœ“ |
| `OFF_DUTY` | é›¢ç­/ä¼‘æ¯ | âœ— |
| `ON_LEAVE` | è«‹å‡ä¸­ | âœ— |
| `STANDBY` | å¾…å‘½ (å¯å¬å›) | éƒ¨åˆ†è¨ˆå…¥ |

### 4.3 éŸŒæ€§è¨ˆç®—é‚è¼¯ä¿®æ­£

```python
# ä¿®æ”¹ resilience_service.py
def _calculate_staff(self):
    # åªè¨ˆç®— staff_status = 'ACTIVE' çš„äººå“¡
    cursor = self.conn.execute("""
        SELECT staff_role, COUNT(*) as count
        FROM person
        WHERE staff_role IS NOT NULL
          AND staff_status = 'ACTIVE'
        GROUP BY staff_role
    """)
    ...
```

---

## 5. å·¥ä½œäººå“¡ç™»éŒ„æµç¨‹

### 5.1 æƒ…å¢ƒä¸€ï¼šç½å‰é ç™»

é©ç”¨æ–¼ç¤¾å€é˜²ç½æ¼”ç·´ã€å¿—å·¥åŸ¹è¨“å¾Œç™»éŒ„ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç½å‰é ç™»æµç¨‹                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. ç®¡ç†å“¡é–‹å•Ÿã€Œäººå“¡ç®¡ç†ã€â†’ã€Œæ–°å¢å·¥ä½œäººå“¡ã€           â”‚
â”‚  2. å¡«å¯«åŸºæœ¬è³‡æ–™ + é¸æ“‡ staff_role                   â”‚
â”‚  3. (é¸å¡«) ä¸Šå‚³è­‰ç…§ç…§ç‰‡                              â”‚
â”‚  4. ç³»çµ±ç”¢ç”Ÿ IDï¼Œç‹€æ…‹è¨­ç‚º OFF_DUTY                   â”‚
â”‚  5. ç½å®³ç™¼ç”Ÿæ™‚ï¼Œäººå“¡å ±åˆ° â†’ ç‹€æ…‹æ”¹ç‚º ACTIVE           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 æƒ…å¢ƒäºŒï¼šç·Šæ€¥æ‹›å‹Ÿ

ç½å®³ç™¼ç”Ÿå¾Œï¼Œè‡¨æ™‚æ‹›å‹Ÿå¿—å·¥æˆ–å°ˆæ¥­äººå“¡ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç·Šæ€¥æ‹›å‹Ÿæµç¨‹                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. ç«™é•·/ç®¡ç†å“¡é»é¸ã€Œç·Šæ€¥æ‹›å‹Ÿã€                       â”‚
â”‚  2. å¿«é€Ÿç™»è¨˜ï¼šå§“å + é›»è©± + å°ˆé•·                     â”‚
â”‚  3. é¸æ“‡ staff_role (é è¨­ VOLUNTEER)                â”‚
â”‚  4. ç³»çµ±ç”¢ç”Ÿ IDï¼Œç‹€æ…‹ç›´æ¥è¨­ç‚º ACTIVE                 â”‚
â”‚  5. éŸŒæ€§å„€è¡¨æ¿å³æ™‚æ›´æ–°äººåŠ›ç‹€æ…‹                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.3 å ±åˆ°/é›¢ç­æµç¨‹

```
å·¥ä½œäººå“¡å ±åˆ° (Check-in)
  POST /api/staff/{id}/clock-in
  â†’ staff_status = 'ACTIVE'
  â†’ shift_start = NOW()
  â†’ è¨˜éŒ„ event_log

å·¥ä½œäººå“¡é›¢ç­ (Check-out)
  POST /api/staff/{id}/clock-out
  â†’ staff_status = 'OFF_DUTY'
  â†’ shift_end = NOW()
  â†’ è¨˜éŒ„ event_log
```

---

## 6. API è¨­è¨ˆ

### 6.1 æ–°å¢ç«¯é»

| Method | Endpoint | èªªæ˜ |
|--------|----------|------|
| GET | `/api/staff` | åˆ—å‡ºæ‰€æœ‰å·¥ä½œäººå“¡ |
| POST | `/api/staff` | æ–°å¢å·¥ä½œäººå“¡ |
| GET | `/api/staff/{id}` | å–å¾—å·¥ä½œäººå“¡è©³æƒ… |
| PUT | `/api/staff/{id}` | æ›´æ–°å·¥ä½œäººå“¡è³‡æ–™ |
| POST | `/api/staff/{id}/clock-in` | å ±åˆ°ä¸Šç­ |
| POST | `/api/staff/{id}/clock-out` | é›¢ç­ä¸‹ç­ |
| GET | `/api/staff/summary` | äººåŠ›æ‘˜è¦ (ä¾›éŸŒæ€§å„€è¡¨æ¿) |
| GET | `/api/staff/on-duty` | ç›®å‰åœ¨å€¼äººå“¡ |

### 6.2 è³‡æ–™æ¨¡å‹

```python
class StaffCreate(BaseModel):
    display_name: str
    national_id: Optional[str] = None
    phone: Optional[str] = None
    staff_role: str  # 'MEDIC', 'NURSE', 'VOLUNTEER', 'ADMIN', 'SECURITY', 'COORDINATOR'
    certification: Optional[str] = None  # JSON string
    emergency_contact: Optional[str] = None
    notes: Optional[str] = None

class StaffClockIn(BaseModel):
    expected_hours: Optional[float] = 8  # é è¨ˆå·¥ä½œæ™‚æ•¸
    notes: Optional[str] = None

class StaffSummary(BaseModel):
    total_registered: int      # å·²ç™»è¨˜ç¸½æ•¸
    active_on_duty: int        # åœ¨å€¼äººæ•¸
    by_role: Dict[str, int]    # å„è·èƒ½äººæ•¸
    shortages: List[dict]      # äººåŠ›ç¼ºå£
```

### 6.3 äººåŠ›æ‘˜è¦ API å›æ‡‰ç¯„ä¾‹

```json
GET /api/staff/summary

{
  "total_registered": 15,
  "active_on_duty": 8,
  "by_role": {
    "MEDIC": 1,
    "NURSE": 2,
    "VOLUNTEER": 3,
    "ADMIN": 1,
    "SECURITY": 1
  },
  "required": {
    "MEDIC": 2,
    "NURSE": 0,
    "VOLUNTEER": 5,
    "ADMIN": 2,
    "SECURITY": 1
  },
  "shortages": [
    {"role": "MEDIC", "required": 2, "actual": 1, "gap": 1},
    {"role": "VOLUNTEER", "required": 5, "actual": 3, "gap": 2},
    {"role": "ADMIN", "required": 2, "actual": 1, "gap": 1}
  ],
  "coverage_score": 65.0
}
```

---

## 7. UI è¨­è¨ˆ

### 7.1 PWA æ–°å¢é é¢

åœ¨å·¥ä½œäººå“¡ PWA (`/frontend`) æ–°å¢ã€Œäººå“¡ç®¡ç†ã€åˆ†é ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ‘¥ äººå“¡ç®¡ç†                              [+ æ–°å¢]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ äººåŠ›ç‹€æ…‹                                     â”‚   â”‚
â”‚  â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘ 65%  (8/12 åœ¨å€¼)               â”‚   â”‚
â”‚  â”‚                                              â”‚   â”‚
â”‚  â”‚ ğŸ©º é†«è­·: 3/2 âœ“   ğŸ‘· å¿—å·¥: 3/5 âš             â”‚   â”‚
â”‚  â”‚ ğŸ“‹ è¡Œæ”¿: 1/2 âš    ğŸ›¡ï¸ ä¿å…¨: 1/1 âœ“            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                     â”‚
â”‚  [åœ¨å€¼ä¸­] [å…¨éƒ¨] [å¾…å‘½]                 ğŸ” æœå°‹     â”‚
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸŸ¢ ç‹å°æ˜        MEDIC     åœ¨å€¼ 09:00~      â”‚   â”‚
â”‚  â”‚ ğŸŸ¢ æè­·ç†        NURSE     åœ¨å€¼ 08:30~      â”‚   â”‚
â”‚  â”‚ ğŸŸ¡ å¼µå¿—å·¥        VOLUNTEER å¾…å‘½             â”‚   â”‚
â”‚  â”‚ âš« é™³è¡Œæ”¿        ADMIN     é›¢ç­             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 æ–°å¢å·¥ä½œäººå“¡è¡¨å–®

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ–°å¢å·¥ä½œäººå“¡                              [âœ• é—œé–‰] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚  å§“å *                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ç‹å¤§æ˜                                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                     â”‚
â”‚  è·èƒ½é¡åˆ¥ *                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â–¼ è«‹é¸æ“‡                                    â”‚   â”‚
â”‚  â”‚   ğŸ©º é†«å¸« (MEDIC)                           â”‚   â”‚
â”‚  â”‚   ğŸ’‰ è­·ç†å¸« (NURSE)                         â”‚   â”‚
â”‚  â”‚   ğŸ‘· å¿—å·¥ (VOLUNTEER)                       â”‚   â”‚
â”‚  â”‚   ğŸ“‹ è¡Œæ”¿äººå“¡ (ADMIN)                       â”‚   â”‚
â”‚  â”‚   ğŸ›¡ï¸ ä¿å…¨äººå“¡ (SECURITY)                    â”‚   â”‚
â”‚  â”‚   ğŸ‘” ç«™é•·/å‰¯ç«™é•· (COORDINATOR)              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                     â”‚
â”‚  è¯çµ¡é›»è©±                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 0912-345-678                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                     â”‚
â”‚  è­‰ç…§/å°ˆé•· (é¸å¡«)                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ EMT-1 åˆç´šæ•‘è­·å“¡                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                     â”‚
â”‚  â˜‘ ç«‹å³å ±åˆ° (ç‹€æ…‹è¨­ç‚ºã€Œåœ¨å€¼ã€)                     â”‚
â”‚                                                     â”‚
â”‚              [å–æ¶ˆ]  [ç¢ºèªæ–°å¢]                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.3 Portal äººåŠ›ç‹€æ…‹å¡ç‰‡

åœ¨ Portal å…¬å…±çœ‹æ¿æ–°å¢äººåŠ›ç‹€æ…‹æŒ‡ç¤ºï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ‘¥ æœå‹™äººåŠ›                                        â”‚
â”‚                                                     â”‚
â”‚     ğŸŸ¢ å……è¶³                                         â”‚
â”‚     8 ä½å·¥ä½œäººå“¡åœ¨å€¼                                â”‚
â”‚                                                     â”‚
â”‚  é†«è­· â—â—â—â—‹  å¿—å·¥ â—â—â—â—‹â—‹  è¡Œæ”¿ â—â—‹                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 8. éŸŒæ€§å¼•æ“æ•´åˆ

### 8.1 ä¿®æ”¹ `_calculate_staff()`

```python
def _calculate_staff(self) -> dict:
    """è¨ˆç®—äººåŠ›éŸŒæ€§ - ä½¿ç”¨ staff_role å’Œ staff_status"""

    # å–å¾—åœ¨å€¼äººå“¡çµ±è¨ˆ
    cursor = self.conn.execute("""
        SELECT staff_role, COUNT(*) as count
        FROM person
        WHERE staff_role IS NOT NULL
          AND staff_status = 'ACTIVE'
        GROUP BY staff_role
    """)
    actual_staff = {row['staff_role']: row['count'] for row in cursor.fetchall()}

    # åˆä½µé†«è­·é¡åˆ¥
    medical_count = actual_staff.get('MEDIC', 0) + actual_staff.get('NURSE', 0)

    # å–å¾—éœ€æ±‚äººæ•¸ (å¾ staffing_rules)
    required = self._get_required_staff()

    # è¨ˆç®—è¦†è“‹ç‡
    coverage = {}
    for role, req in required.items():
        if role == 'MEDIC':
            actual = medical_count
        else:
            actual = actual_staff.get(role, 0)
        coverage[role] = min(100, (actual / req * 100)) if req > 0 else 100

    # æœ€ä½è¦†è“‹ç‡ç‚ºåˆ†æ•¸
    min_coverage = min(coverage.values()) if coverage else 0

    return {
        'category': 'STAFF',
        'score': round(min_coverage, 1),
        'status': self._score_to_status(min_coverage),
        'actual': actual_staff,
        'required': required,
        'coverage': coverage,
        'hours_remaining': self.target_hours if min_coverage >= 100 else 0
    }
```

### 8.2 å³æ™‚æ›´æ–°è§¸ç™¼

ç•¶å·¥ä½œäººå“¡å ±åˆ°/é›¢ç­æ™‚ï¼Œå¯é¸æ“‡è§¸ç™¼éŸŒæ€§é‡ç®—ï¼š

```python
@router.post("/{staff_id}/clock-in")
async def staff_clock_in(staff_id: str, request: StaffClockIn):
    # ... æ›´æ–°ç‹€æ…‹ ...

    # è§¸ç™¼éŸŒæ€§é‡ç®— (å¯é¸)
    if settings.AUTO_RECALC_RESILIENCE:
        engine = CIRSResilienceEngine(conn)
        engine.calculate('default')  # æœƒè‡ªå‹•å­˜å…¥ history

    return {"message": "å ±åˆ°æˆåŠŸ", "staff_status": "ACTIVE"}
```

---

## 9. è³‡æ–™åº«é·ç§»

### 9.1 Schema è®Šæ›´

```sql
-- migrations/003_staff_management.sql

-- 1. æ–°å¢æ¬„ä½
ALTER TABLE person ADD COLUMN staff_role TEXT;
ALTER TABLE person ADD COLUMN staff_status TEXT DEFAULT 'OFF_DUTY';
ALTER TABLE person ADD COLUMN certification TEXT;
ALTER TABLE person ADD COLUMN shift_start DATETIME;
ALTER TABLE person ADD COLUMN shift_end DATETIME;
ALTER TABLE person ADD COLUMN emergency_contact TEXT;

-- 2. å»ºç«‹ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_person_staff_role ON person(staff_role);
CREATE INDEX IF NOT EXISTS idx_person_staff_status ON person(staff_status);

-- 3. é·ç§»ç¾æœ‰è³‡æ–™
UPDATE person SET staff_role = 'MEDIC' WHERE role = 'medic';
UPDATE person SET staff_role = 'ADMIN' WHERE role = 'admin';
UPDATE person SET staff_role = 'VOLUNTEER' WHERE role = 'staff';

-- 4. è¨­å®šå·²å ±åˆ°çš„å·¥ä½œäººå“¡ç‚º ACTIVE
UPDATE person
SET staff_status = 'ACTIVE'
WHERE staff_role IS NOT NULL AND checked_in_at IS NOT NULL;
```

---

## 10. å¯¦ä½œéšæ®µ

### Phase 1: è³‡æ–™å±¤ (1-2 å¤©)
- [ ] åŸ·è¡Œ schema é·ç§»
- [ ] ä¿®æ”¹ `resilience_service.py` ä½¿ç”¨æ–°æ¬„ä½
- [ ] æ–°å¢ `routes/staff.py` API

### Phase 2: å¾Œç«¯ API (1-2 å¤©)
- [ ] å¯¦ä½œ `/api/staff` CRUD
- [ ] å¯¦ä½œ clock-in/clock-out
- [ ] å¯¦ä½œ `/api/staff/summary`
- [ ] æ•´åˆéŸŒæ€§å¼•æ“

### Phase 3: PWA UI (2-3 å¤©)
- [ ] æ–°å¢ã€Œäººå“¡ç®¡ç†ã€åˆ†é 
- [ ] æ–°å¢å·¥ä½œäººå“¡è¡¨å–®
- [ ] äººåŠ›ç‹€æ…‹å„€è¡¨æ¿
- [ ] å ±åˆ°/é›¢ç­æŒ‰éˆ•

### Phase 4: Portal æ•´åˆ (0.5 å¤©)
- [ ] Portal æ–°å¢äººåŠ›ç‹€æ…‹å¡ç‰‡
- [ ] éŸŒæ€§æŒ‡æ•¸é€£å‹•é¡¯ç¤º

### Phase 5: æ¸¬è©¦èˆ‡æ–‡ä»¶ (1 å¤©)
- [ ] API æ¸¬è©¦
- [ ] UI æ¸¬è©¦
- [ ] æ›´æ–°ä½¿ç”¨æ‰‹å†Š

---

## 11. æœªä¾†æ“´å±•

### 11.1 ç­è¡¨ç®¡ç† (v2.0)
- é æ’ç­è¡¨
- è‡ªå‹•æé†’æ›ç­
- åŠ ç­æ™‚æ•¸è¿½è¹¤

### 11.2 æŠ€èƒ½é…å° (v2.0)
- å·¥ä½œäººå“¡æŠ€èƒ½æ¨™ç±¤
- ä»»å‹™æŒ‡æ´¾å»ºè­°
- è¨“ç·´éœ€æ±‚åˆ†æ

### 11.3 è·¨ç«™æ”¯æ´ (v2.0)
- å¤šç«™äººåŠ›èª¿åº¦
- æ”¯æ´è«‹æ±‚å»£æ’­
- äººåŠ›å…±äº«æ©Ÿåˆ¶

---

## é™„éŒ„ A: è§’è‰²æ¬Šé™å°ç…§

| staff_role | å»ºè­° role | å¯ç”¨åŠŸèƒ½ |
|------------|-----------|----------|
| COORDINATOR | admin | å…¨éƒ¨ |
| ADMIN | admin | å…¨éƒ¨ |
| MEDIC | medic | é†«ç™‚ + äººå“¡ |
| NURSE | medic | é†«ç™‚ + äººå“¡ |
| VOLUNTEER | staff | äººå“¡ + ç‰©è³‡ |
| SECURITY | staff | äººå“¡ç®¡ç† |

---

## é™„éŒ„ B: ç›¸é—œæ–‡ä»¶

- [CIRS_RESILIENCE_SPEC_v2.md](./CIRS_RESILIENCE_SPEC_v2.md) - éŸŒæ€§è¨ˆç®—è¦æ ¼
- [schema.sql](../backend/schema.sql) - è³‡æ–™åº«çµæ§‹

---

*æ–‡ä»¶ç‰ˆæœ¬: v1.0*
*å»ºç«‹æ—¥æœŸ: 2025-12-17*
*ä½œè€…: Claude Code*
