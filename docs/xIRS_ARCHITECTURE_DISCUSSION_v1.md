# xIRS 架構討論文件 v1.0

**版本**: 1.0
**日期**: 2025-12-21
**狀態**: 討論草案
**目的**: 釐清 CIRS/MIRS 整合、任務指派、病患記錄歸屬等架構問題

---

## 1. 當前實作進度總覽

### 1.1 xIRS Distributed Logistics (v1.8) 實作狀態

| 階段 | 項目 | 狀態 | 位置 |
|------|------|------|------|
| **Phase 1-2** | Hub Backend API | ✅ 完成 | `/backend/routes/logistics.py` |
| **Phase 3** | Station PWA (分站模式) | ✅ 完成 | `/frontend/station/` |
| **Phase 4** | Runner PWA (Blind Carrier) | ✅ 完成 | `/frontend/runner/` |
| **Phase 5A** | Lite CPOE 核心協議 | ✅ 完成 | `/shared/js/xirs-rx.js`, `xirs-dispense.js` |
| **Phase 5B** | Doctor PWA (開藥) | ✅ 完成 | `/frontend/doctor/` |
| **Phase 5C** | Pharmacy Station Extension | ⏳ 待實作 | - |
| **Phase 5D** | Hub Rx/Dispense 整合 | ⏳ 待實作 | - |

### 1.2 現有 PWA 端點

| 端點 | 用途 | 目標使用者 |
|------|------|-----------|
| `/frontend/` | CIRS 主控台 (庫存+人員) | 避難所管理員 |
| `/mobile/` | CIRS 行動版 | 志工/工作人員 |
| `/station/` | xIRS 分站 (物資接收/發放) | 分站管理員 |
| `/runner/` | xIRS Runner (Blind Carrier) | 物資運送員 |
| `/doctor/` | xIRS Doctor (開立處方) | 醫師 |
| `/portal/` | 公開狀態看板 | 公眾 |

---

## 2. 核心問題討論

### 2.1 CIRS vs MIRS 的定位

```
┌─────────────────────────────────────────────────────────────────────┐
│                        概念釐清                                      │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  CIRS (Community IRS)          MIRS (Municipal IRS)                 │
│  ────────────────────          ─────────────────────                │
│  單一避難所/社區               多避難所/區域協調                     │
│  人員+物資+任務                跨站點物資調度                        │
│  直接面對公眾                  面對各 CIRS 站點                     │
│                                                                      │
│  ┌─────────────┐              ┌─────────────────┐                   │
│  │   CIRS-A    │◄────────────►│                 │                   │
│  └─────────────┘              │      MIRS       │                   │
│  ┌─────────────┐              │   (Regional     │                   │
│  │   CIRS-B    │◄────────────►│     Hub)        │                   │
│  └─────────────┘              │                 │                   │
│  ┌─────────────┐              │                 │                   │
│  │   CIRS-C    │◄────────────►│                 │                   │
│  └─────────────┘              └─────────────────┘                   │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

**現狀問題**:
- 目前 CIRS 和 MIRS 共用相同的 codebase
- xIRS 加入後，兩者功能定位需要更清楚區分

### 2.2 病患記錄歸屬問題

**問題**: CIRS 把醫師當 messenger，病患記錄會在 CIRS、不會在 MIRS 對嗎？

```
┌─────────────────────────────────────────────────────────────────────┐
│                      資料歸屬建議                                    │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  CIRS (避難所層級)                                                   │
│  ├── person (避難者登記)         ← 病患基本資料在這                 │
│  ├── rx_orders (收到的處方)      ← 處方記錄在這                     │
│  ├── dispense_records (發藥記錄) ← 發藥記錄在這                     │
│  ├── inventory (物資+藥品庫存)                                       │
│  └── messages (包含醫療需求)                                         │
│                                                                      │
│  MIRS (區域層級)                                                     │
│  ├── prescribers (醫師註冊)      ← 醫師憑證管理                     │
│  ├── rx_audit_log (處方審計)     ← 跨站處方追蹤                     │
│  └── dispense_summary (發藥彙總) ← 統計報表                         │
│                                                                      │
│  Doctor PWA (離線)                                                   │
│  ├── credentials (醫師私鑰)      ← 本地保存                         │
│  ├── recent_patients (最近病患)  ← 便利快取                         │
│  └── issued_rx (已開處方)        ← 本地紀錄                         │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

**建議**:
1. **病患資料主檔在 CIRS** (person table)
2. **處方和發藥記錄在 CIRS** (是該避難所的業務)
3. **MIRS 收集彙總資料** (用於區域調度和審計)
4. **醫師憑證由 MIRS 發行** (作為信任根)

### 2.3 任務指派問題

**問題**: 目前需要一個獨立頁面來做任務指派，對嗎？

**分析現有任務場景**:

| 任務類型 | 當前機制 | 問題 |
|----------|----------|------|
| **物資運送** (Runner) | Runner PWA 自行接取 | ✅ 已有機制 |
| **物資發放** (Station Lead) | 手動分配 | ❌ 無系統化指派 |
| **藥品調配** (Pharmacist) | 待實作 | ⏳ Phase 5C |
| **醫療看診** (Doctor) | 自主行動 | ❓ 需排程？ |
| **一般工作** (Staff/Volunteer) | CIRS Staff Management | ✅ 已有機制 |

**建議方案**:

```
┌─────────────────────────────────────────────────────────────────────┐
│                    任務指派架構選項                                  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  Option A: 整合到 CIRS 主控台                                        │
│  ─────────────────────────────                                       │
│  - 新增「任務中心」頁籤                                              │
│  - 優點: 統一介面                                                    │
│  - 缺點: 主控台可能過於複雜                                          │
│                                                                      │
│  Option B: 獨立任務指派 PWA                                          │
│  ─────────────────────────────                                       │
│  - 新建 /dispatch/ PWA                                               │
│  - 優點: 職責分離，可獨立使用                                        │
│  - 缺點: 需維護另一個 PWA                                            │
│                                                                      │
│  Option C: 擴展 Station PWA                                          │
│  ─────────────────────────────                                       │
│  - Station Lead 兼任任務指派                                         │
│  - 優點: 符合分散式理念                                              │
│  - 缺點: Station Lead 職責增加                                       │
│                                                                      │
│  【建議】: Option A + 簡化                                           │
│  - CIRS 主控台加入「工作派遣」功能                                   │
│  - 只處理 Staff/Volunteer 類任務                                     │
│  - 物流相關任務由 xIRS 自動協調                                      │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.4 Station 連結放置

**問題**: 在目前 CIRS 和 MIRS 頁面要怎麼放 Station 頁面連結？

**建議 UI 配置**:

```
┌─────────────────────────────────────────────────────────────────────┐
│                        CIRS 主控台                                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  [現有選單]                     [新增 xIRS 區塊]                     │
│  ├── 儀表板                     ┌─────────────────────┐             │
│  ├── 人員                       │  📦 xIRS 物流       │             │
│  ├── 物資                       │  ├── 分站管理       │ → /station  │
│  ├── 訊息                       │  ├── Runner 管理    │ → /runner   │
│  ├── 韌性                       │  └── 藥局模式       │ → /pharmacy │
│  └── 設定                       │                     │             │
│                                 │  👨‍⚕️ 醫療模組      │             │
│                                 │  └── 醫師模式       │ → /doctor   │
│                                 └─────────────────────┘             │
│                                                                      │
│  【實作方式】                                                        │
│  - 在 Dashboard 加入「快捷入口」卡片                                 │
│  - 或在 Header 加入下拉選單「切換模式」                              │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

**建議加入位置**:
1. **Dashboard 首頁**: 新增「xIRS 快捷入口」區塊
2. **Header 右上角**: 新增「模式切換」下拉選單
3. **設定頁**: 新增「xIRS 設定」區塊 (配對資訊等)

### 2.5 CIRS/MIRS 任務衝突分析

**問題**: CIRS 和 MIRS 任務是否有衝突？

```
┌─────────────────────────────────────────────────────────────────────┐
│                     任務職責對照表                                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  功能領域        CIRS                   MIRS                        │
│  ─────────────────────────────────────────────────────              │
│  人員登記        ✓ 主要負責             △ 彙總統計                  │
│  物資管理        ✓ 本站庫存             △ 跨站調度                  │
│  訊息/求援       ✓ 本站處理             △ 跨站協調                  │
│  韌性評估        ✓ 本站計算             △ 區域總覽                  │
│  工作人員        ✓ 本站排班             △ 人力調度                  │
│                                                                      │
│  xIRS 物流       ✓ Station 端           ✓ Hub 端                    │
│  Lite CPOE       ✓ Pharmacy 端          ✓ 醫師憑證管理              │
│                                                                      │
│  ─────────────────────────────────────────────────────              │
│  ✓ = 主要負責   △ = 彙總/協調                                       │
│                                                                      │
│  【無衝突結論】                                                      │
│  - CIRS 處理「本站」業務                                             │
│  - MIRS 處理「跨站」協調                                             │
│  - xIRS 橋接兩者 (Hub 在 MIRS, Station 在 CIRS)                     │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

**潛在衝突點與解決方案**:

| 衝突點 | 說明 | 解決方案 |
|--------|------|----------|
| 庫存同步 | CIRS 本站庫存 vs MIRS 區域視圖 | xIRS Report 單向上報 |
| 人員歸屬 | 人員可能跨站移動 | 以當前 check-in 站點為準 |
| 醫師身份 | 醫師可能巡迴多站 | 憑證由 MIRS 發行，各站信任 |
| 藥品調度 | 藥品可能跨站調撥 | 透過 MIRS 的 RESTOCK_MANIFEST |

---

## 3. 建議實作順序

### 3.1 短期 (Phase 5 完成)

1. **Phase 5C**: Pharmacy Station Extension
   - 擴展 `/station/` 加入處方掃描和調劑功能
   - 或建立獨立 `/pharmacy/` PWA

2. **Phase 5D**: Hub Rx/Dispense Integration
   - 在 MIRS (Hub) 加入醫師憑證管理
   - 處方/發藥記錄同步

3. **CIRS 整合**: Dashboard 快捷入口
   - 在 CIRS 主控台加入 xIRS 入口連結

### 3.2 中期

4. **任務指派**:
   - 評估是否需要獨立 Dispatch PWA
   - 或整合到 CIRS Staff Management

5. **MIRS 彙總**:
   - 實作跨站統計儀表板
   - 處方審計功能

### 3.3 長期

6. **完整 xIRS 2.0**:
   - 更複雜的物流路由
   - 多層級 Hub 架構

---

## 4. 待討論問題

### 4.1 架構決策

| # | 問題 | 選項 | 建議 |
|---|------|------|------|
| 1 | Pharmacy 是獨立 PWA 還是 Station 擴展？ | A) 獨立 /pharmacy/<br>B) 擴展 /station/ | B) 擴展較佳 |
| 2 | 醫師憑證由誰發行？ | A) MIRS (區域)<br>B) CIRS (本站) | A) MIRS |
| 3 | 病患 ID 格式？ | A) 站內流水號 P0001<br>B) 全區唯一 CIRS-A-P0001 | B) 全區唯一 |
| 4 | Runner 是否需要登入？ | A) 匿名使用<br>B) 需識別身份 | A) 匿名 (Blind Carrier) |

### 4.2 UI/UX 決策

| # | 問題 | 選項 | 建議 |
|---|------|------|------|
| 5 | CIRS xIRS 入口位置？ | A) Dashboard 卡片<br>B) Header 選單<br>C) 側邊欄 | A) Dashboard |
| 6 | 模式切換如何實現？ | A) 不同 URL<br>B) 同頁切換 tab | A) 不同 URL |
| 7 | Doctor PWA 獨立還是整合？ | A) 完全獨立<br>B) 可從 CIRS 進入 | A) 獨立較佳 |

### 4.3 資料決策

| # | 問題 | 選項 | 建議 |
|---|------|------|------|
| 8 | 處方存放位置？ | A) 只在 CIRS<br>B) CIRS + 複製到 MIRS | B) 複製 |
| 9 | 醫師是否需要登入 CIRS？ | A) 需要 (staff role)<br>B) 不需要 (獨立運作) | B) 獨立 |
| 10 | 發藥記錄何時同步？ | A) 即時<br>B) 批次 (Runner) | B) 批次 |

---

## 5. 附錄

### 5.1 現有檔案結構

```
/Users/QmoMBA/Downloads/CIRS/
├── backend/
│   ├── main.py              # FastAPI 入口 (已更新 /doctor mount)
│   ├── routes/
│   │   ├── logistics.py     # xIRS Hub API
│   │   └── ...
│   └── database.py
│
├── frontend/
│   ├── index.html           # CIRS 主控台
│   ├── mobile/              # CIRS 行動版
│   ├── station/             # xIRS Station PWA
│   ├── runner/              # xIRS Runner PWA
│   └── doctor/              # xIRS Doctor PWA (新)
│
├── shared/
│   └── js/
│       ├── xirs-crypto.js   # 加密工具
│       ├── xirs-protocol.js # 協議處理
│       ├── xirs-storage.js  # Station 儲存
│       ├── xirs-runner.js   # Runner 儲存
│       ├── xirs-rx.js       # 處方協議 (新)
│       ├── xirs-dispense.js # 調劑協議 (新)
│       ├── xirs-pharmacy-db.js  # 藥局儲存 (新)
│       └── xirs-doctor-db.js    # 醫師儲存 (新)
│
└── docs/
    ├── xIRS_DISTRIBUTED_LOGISTICS_SPEC_v1.8.md
    ├── xIRS_LITE_CPOE_SPEC_v1.0.md
    └── xIRS_ARCHITECTURE_DISCUSSION_v1.md (本文件)
```

### 5.2 API 端點彙總

```
/api/logistics/
├── /hub/keys               # Hub 公鑰
├── /manifest/create        # 建立出貨單
├── /manifest/{id}          # 查詢出貨單
├── /report/receive         # 接收回報
├── /station/provision      # 配對分站
└── /station/list           # 分站列表

/api/prescriber/  (待實作 Phase 5D)
├── /register               # 註冊醫師
├── /{id}/cert              # 取得憑證
└── /certs                  # 憑證列表

/api/rx/  (待實作 Phase 5D)
├── /ingest                 # 收取處方
└── /audit                  # 審計日誌

/api/dispense/  (待實作 Phase 5D)
└── /ingest                 # 收取發藥記錄
```

---

**文件版本**: 1.0
**建立日期**: 2025-12-21
**作者**: Claude (AI)
**狀態**: 待討論
